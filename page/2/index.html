<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="ZJH"><meta name="copyright" content="ZJH"><title>Zany's Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '7.3.0'
} </script><meta name="generator" content="Hexo 7.3.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">ZJH</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">12</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">19</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">8</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Zany's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="site-info"><div id="site-title">Zany's Blog</div><div id="site-sub-title"></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2021/04/03/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E5%8F%82%E8%80%83/">系统架构参考</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-04-04</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E5%85%B6%E4%BB%96/">其他</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/">系统架构</a></span><div class="content"><h1 id="系统架构参考"><a href="#系统架构参考" class="headerlink" title="系统架构参考"></a>系统架构参考</h1><h2 id="企业级分布式应用服务EDAS"><a href="#企业级分布式应用服务EDAS" class="headerlink" title="企业级分布式应用服务EDAS"></a>企业级分布式应用服务EDAS</h2><p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/p232673.png" alt="img"></p>
<h2 id="阿里中台架构图"><a href="#阿里中台架构图" class="headerlink" title="阿里中台架构图"></a>阿里中台架构图</h2><p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/v2-8623f0835181951bc40bcac5ab8713cf_720w.jpg" alt="img"></p>
<h2 id="淘宝服务端高并发分布式架构"><a href="#淘宝服务端高并发分布式架构" class="headerlink" title="淘宝服务端高并发分布式架构"></a>淘宝服务端高并发分布式架构</h2><ul>
<li>架构特点：负载均衡、正向代理和反向代理、分布式、高可用</li>
<li>MPP数据库</li>
<li>使用LVS或F5来使多个Nginx负载均衡（可使用keepalived软件模拟出虚拟IP，然后把虚拟IP绑定到多台LVS服务器上）</li>
<li>通过DNS轮询实现机房间的负载均衡（系统可做到机房级别的水平扩展）</li>
<li><h5 id="引入NoSQL数据库和搜索引擎等技术"><a href="#引入NoSQL数据库和搜索引擎等技术" class="headerlink" title="引入NoSQL数据库和搜索引擎等技术+"></a>引入NoSQL数据库和搜索引擎等技术+</h5></li>
</ul>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/v2-65d4f75b68cd095805bafceb8c2e4a2c_720w.jpg" alt="img"></p>
<h2 id="JUST-DB"><a href="#JUST-DB" class="headerlink" title="JUST-DB"></a>JUST-DB</h2><p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/image-20210701102643136.png" alt="image-20210701102643136"></p>
<h2 id="云原生技术架构"><a href="#云原生技术架构" class="headerlink" title="云原生技术架构"></a>云原生技术架构</h2><p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/v2-4df5f78230cda29a2a28bb789562f522_720w.jpg" alt="img"></p>
<h2 id="全空间混合数据服务引擎"><a href="#全空间混合数据服务引擎" class="headerlink" title="全空间混合数据服务引擎"></a>全空间混合数据服务引擎</h2><p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/image-20210701144211306.png" alt="image-20210701144211306"></p>
<h2 id="Ganos"><a href="#Ganos" class="headerlink" title="Ganos"></a>Ganos</h2><p>Ganos是包含SQL + NoSQL云数据库的时空引擎。</p>
<ul>
<li>公有云原生架构的空间、时空、遥感一体化NoSQL大数据引擎产品，开箱即用；</li>
<li>PB级存储、高并发写入、百亿级时空查询秒级响应；</li>
<li>支持数据冷热分离存储和数据高效压缩算法，海量数据存储成本低；</li>
<li>与云上Spark无缝集成，快速搭建空间大数据仓库和空间大数据分析平台；</li>
<li>基于OGC标准设计，便于系统间的集成与互操作；</li>
<li>基于阿里云HBase、XPack专业运维，全托管方式，提供可靠稳定的服务。</li>
</ul>
<h3 id="Ganos中的时空模型"><a href="#Ganos中的时空模型" class="headerlink" title="Ganos中的时空模型"></a>Ganos中的时空模型</h3><p>除了支持传统的几何模型、栅格模型和拓扑网络模型，还扩充支持了网格模型、时空轨迹模型以及点云模型。</p>
<p><img src="https://ucc.alicdn.com/pic/developer-ecology/6bc55a54abb944289c4ef6d99db99adf.png" alt="image.png"></p>
<h3 id="PG-Ganos"><a href="#PG-Ganos" class="headerlink" title="PG Ganos"></a>PG Ganos</h3><ol>
<li><strong>如何管理PB级遥感影像：PostgresSQL + Ganos + OSS</strong></li>
</ol>
<p>通过“PostgresSQL + Ganos + OSS”组合，可实现 PB级遥感影像的管理。源数据和部分金字塔数据可以存储在数据库内部，遥感原始数据存放在OOS中，由于OOS存储价格低廉，使得用户的使用成本也有所降低。</p>
<ol start="2">
<li><strong>遥感影像注册（入库）</strong></li>
</ol>
<p>需要按照insertSQL语句直接写入到数据库，将OSS地址传给createrast接口即可。</p>
<ol start="3">
<li><strong>矢量数据入库</strong></li>
</ol>
<p>主要依赖空间开源的工具，包括Ogr2ogr、shp2pgsql、QGIS、pg_dump&#x2F;pg_restore等。</p>
<ol start="4">
<li><strong>PG Ganos如何管理轨迹数据</strong></li>
</ol>
<p>Ganos管理轨迹数据主要通过轨迹构造、轨迹压缩和轨迹相似性判断。</p>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/d83b6862464d47b3959d224890ab323f.png" alt="image.png"></p>
<ol start="5">
<li><strong>Ganos与开源工具</strong></li>
</ol>
<p>Ganos无缝对接兼容PostGIS的各类GIS软件，显示和编辑包括GeoServer、QGIS、uDig、OpenJump等，PGAdmin4。</p>
<h3 id="示例：某位置服务平台"><a href="#示例：某位置服务平台" class="headerlink" title="示例：某位置服务平台"></a>示例：某位置服务平台</h3><p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/4594052-c1342ad1e96c0079.png" alt="img"></p>
<h3 id="示例：遥感大数据管理与智能服务平台"><a href="#示例：遥感大数据管理与智能服务平台" class="headerlink" title="示例：遥感大数据管理与智能服务平台"></a>示例：遥感大数据管理与智能服务平台</h3><p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/184a2ace18314d57a5b3b40b15676cac.png" alt="图片 6.png"></p>
<h2 id="名词解释："><a href="#名词解释：" class="headerlink" title="名词解释："></a>名词解释：</h2><ul>
<li><p>NoSQL</p>
<ul>
<li>\1. 键值数据库：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/crs?from=10680">Redis</a>、Memcached、Riak、Cassandra、LevelDB</li>
<li>\2. 列族数据库：Bigtable、<a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/hbase?from=10680">HBase</a>、Cassandra、Druid</li>
<li>\3. 文档数据库：MongoDB、CouchDB、MarkLogic</li>
<li>\4. 图形数据库：Neo4j（知识图谱）、InfoGrid、ArangoDB</li>
</ul>
</li>
<li><p>MPP (Massively Parallel Processing)大规模并行处理架构。比较流行的有Greenplum、TiDB、Postgresql XC、HAWQ等，商用的如南大通用的GBase、睿帆科技的雪球DB、华为的LibrA</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/148621151">https://zhuanlan.zhihu.com/p/148621151</a></p>
</li>
<li><p>LVS(Linux Virtual Server)：本质上是一个软件。是一种集群(Cluster)技术，采用IP负载均衡技术和基于内容请求分发技术。</p>
<ul>
<li>VS&#x2F;NAT 负载均衡策略：</li>
<li>VS&#x2F;TUN 负载均衡策略：</li>
<li>VS&#x2F;NAT 负载均衡策略：</li>
<li><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/v2-9a56981b5fe5a218bb41a684d96b5d4f_720w.jpg" alt="img"></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/87109094#:~:text=%E9%A6%96%E5%85%88%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D%E4%B8%80%E4%B8%8BLVS%20%28Linux%20Virtual,Server%29%E5%88%B0%E5%BA%95%E6%98%AF%E4%BB%80%E4%B9%88%E4%B8%9C%E8%A5%BF%EF%BC%8C%E5%85%B6%E5%AE%9E%E5%AE%83%E6%98%AF%E4%B8%80%E7%A7%8D%E9%9B%86%E7%BE%A4%20%28Cluster%29%E6%8A%80%E6%9C%AF%EF%BC%8C%E9%87%87%E7%94%A8IP%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%8A%80%E6%9C%AF%E5%92%8C%E5%9F%BA%E4%BA%8E%E5%86%85%E5%AE%B9%E8%AF%B7%E6%B1%82%E5%88%86%E5%8F%91%E6%8A%80%E6%9C%AF%E3%80%82%20%E8%B0%83%E5%BA%A6%E5%99%A8%E5%85%B7%E6%9C%89%E5%BE%88%E5%A5%BD%E7%9A%84%E5%90%9E%E5%90%90%E7%8E%87%EF%BC%8C%E5%B0%86%E8%AF%B7%E6%B1%82%E5%9D%87%E8%A1%A1%E5%9C%B0%E8%BD%AC%E7%A7%BB%E5%88%B0%E4%B8%8D%E5%90%8C%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E6%89%A7%E8%A1%8C%EF%BC%8C%E4%B8%94%E8%B0%83%E5%BA%A6%E5%99%A8%E8%87%AA%E5%8A%A8%E5%B1%8F%E8%94%BD%E6%8E%89%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E6%95%85%E9%9A%9C%EF%BC%8C%E4%BB%8E%E8%80%8C%E5%B0%86%E4%B8%80%E7%BB%84%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%9E%84%E6%88%90%E4%B8%80%E4%B8%AA%E9%AB%98%E6%80%A7%E8%83%BD%E7%9A%84%E3%80%81%E9%AB%98%E5%8F%AF%E7%94%A8%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%8D%E5%8A%A1%E5%99%A8%E3%80%82">链接</a></li>
</ul>
</li>
<li><p>F5是一种负载均衡硬件，与LVS提供的能力类似，性能比LVS更高，但价格昂贵。</p>
</li>
<li><p>如对于海量文件存储，可通过分布式文件系统HDFS解决，对于key value类型的数据，可通过HBase和Redis等方案解决，对于全文检索场景，可通过搜索引擎如ElasticSearch解决，对于多维分析场景，可通过Kylin或Druid等方案解决。</p>
</li>
<li><p>geoTrellis：处理栅格数据。生成金字塔图层、渲染切片、GeoJson的序列化与反序列化</p>
</li>
<li><p>geoMesa：处理矢量数据。由locationtech开源的一套地理大数据处理工具套件。 GeoMesa目前支持的NoSQL数据库包括Accumulo、HBase、Google Bigtable和Cassandra等。</p>
</li>
<li><p>DLI：数据湖探索</p>
</li>
<li><p>DLA：数据湖分析</p>
</li>
<li><p>Apache Kylin™是一个开源的、分布式的分析型数据仓库。提供<code>Hadoop/Spark</code>之上的<code>SQL</code>查询接口及多维分析(<code>OLAP</code>)能力以支持超大规模数据，它能在亚秒内查询巨大的<code>Hive</code>表。其核心是预计算，计算结果存在<code>HBase</code>中。</p>
<p>作为大数据分析神器，它也需要站在巨人的肩膀上，依赖<code>HDFS</code>、<code>MapReduce/Spark</code>、<code>Hive/Kafka</code>、<code>HBase</code>等服务。</p>
</li>
<li><p>Apache Flink并不提供自己的数据存储系统，但为<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Amazon_Web_Services#Analytics">Amazon Kinesis</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Apache_Kafka">Apache Kafka</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Alluxio">Alluxio</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/HDFS">HDFS</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Apache_Cassandra">Apache Cassandra</a>和<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Elasticsearch">Elasticsearch</a>等系统提供了数据源和接收器。</p>
</li>
<li><p><strong>Presto</strong>是一种用于大数据的高性能分布式<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/SQL">SQL</a>查询引擎。其架构允许用户查询各种数据源，如Hadoop、AWS S3、Alluxio、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/MySQL">MySQL</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Cassandra">Cassandra</a>、Kafka和MongoDB。</p>
</li>
<li><p>Drill：<strong>Drill</strong> is an Apache open-source SQL query engine for Big Data exploration. </p>
</li>
<li><p>LSM-tree 最大的特点就是写入速度快，主要利用了磁盘的顺序写，pk掉了需要随机写入的 B-tree。关于磁盘的顺序和随机写可以参考：《硬盘的各种概念》</p>
</li>
</ul>
<h1 id="全时空信息系统架构设计"><a href="#全时空信息系统架构设计" class="headerlink" title="全时空信息系统架构设计"></a>全时空信息系统架构设计</h1><h2 id="数据底层分类"><a href="#数据底层分类" class="headerlink" title="数据底层分类"></a>数据底层分类</h2><h2 id="数据库引擎"><a href="#数据库引擎" class="headerlink" title="数据库引擎"></a>数据库引擎</h2><p>NewSQL 见文档-NewSQL主流数据库对比</p>
<hr>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/clip_image002.jpg" alt="img"></p>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/0%7EGT%5D37GOLTO7XQ%5BNKI4%60VQ.png" alt="img"></p>
<h2 id="检索引擎"><a href="#检索引擎" class="headerlink" title="检索引擎"></a>检索引擎</h2><h2 id="计算引擎"><a href="#计算引擎" class="headerlink" title="计算引擎"></a>计算引擎</h2><h2 id="容器化、微服务、DevOps"><a href="#容器化、微服务、DevOps" class="headerlink" title="容器化、微服务、DevOps"></a>容器化、微服务、DevOps</h2><h2 id="可视化引擎"><a href="#可视化引擎" class="headerlink" title="可视化引擎"></a>可视化引擎</h2><h1 id="参考连接"><a href="#参考连接" class="headerlink" title="参考连接"></a>参考连接</h1><h2 id="1-淘宝服务端高并发分布式架构演进之路"><a href="#1-淘宝服务端高并发分布式架构演进之路" class="headerlink" title="1. 淘宝服务端高并发分布式架构演进之路"></a>1. 淘宝服务端高并发分布式架构演进之路</h2><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/69999325">https://zhuanlan.zhihu.com/p/69999325</a></p>
<h2 id="2-微服务网关Zuul、Gateway、nginx的区别"><a href="#2-微服务网关Zuul、Gateway、nginx的区别" class="headerlink" title="2. 微服务网关Zuul、Gateway、nginx的区别"></a>2. 微服务网关Zuul、Gateway、nginx的区别</h2><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/8d82c6c2e5ee">https://www.jianshu.com/p/8d82c6c2e5ee</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/lizz861109/article/details/103575186">https://blog.csdn.net/lizz861109/article/details/103575186</a></p>
<h2 id="3-Hive、Hbase、mysql的区别"><a href="#3-Hive、Hbase、mysql的区别" class="headerlink" title="3. Hive、Hbase、mysql的区别"></a>3. Hive、Hbase、mysql的区别</h2><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/137458844">https://zhuanlan.zhihu.com/p/137458844</a></p>
<h2 id="4-解惑图数据库！你知道什么是图数据库吗？"><a href="#4-解惑图数据库！你知道什么是图数据库吗？" class="headerlink" title="4. 解惑图数据库！你知道什么是图数据库吗？"></a>4. 解惑图数据库！你知道什么是图数据库吗？</h2><p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1634337">https://cloud.tencent.com/developer/article/1634337</a></p>
<h2 id="5-图数据库选型对比：HugeGraph、JanusGraph、Neo4j"><a href="#5-图数据库选型对比：HugeGraph、JanusGraph、Neo4j" class="headerlink" title="5. 图数据库选型对比：HugeGraph、JanusGraph、Neo4j"></a>5. 图数据库选型对比：HugeGraph、JanusGraph、Neo4j</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/hellohiworld/article/details/104824764">https://blog.csdn.net/hellohiworld/article/details/104824764</a></p>
<h2 id="6-JanusGraph-Neo4j-TigerGraph简单对比"><a href="#6-JanusGraph-Neo4j-TigerGraph简单对比" class="headerlink" title="6. JanusGraph&#x2F;Neo4j&#x2F;TigerGraph简单对比"></a>6. JanusGraph&#x2F;Neo4j&#x2F;TigerGraph简单对比</h2><p>目前TigerGraph的生态不是很全，编程api等能力也有一定限制</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/74424421">https://zhuanlan.zhihu.com/p/74424421</a></p>
<h2 id="7-全文搜索引擎-ElasticSearch-还是-Solr？"><a href="#7-全文搜索引擎-ElasticSearch-还是-Solr？" class="headerlink" title="7. 全文搜索引擎 ElasticSearch 还是 Solr？"></a>7. 全文搜索引擎 ElasticSearch 还是 Solr？</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jajian/p/9801154.html">https://www.cnblogs.com/jajian/p/9801154.html</a></p>
<h2 id="8-9个基于Java的搜索引擎框架-转"><a href="#8-9个基于Java的搜索引擎框架-转" class="headerlink" title="8. 9个基于Java的搜索引擎框架 转"></a>8. 9个基于Java的搜索引擎框架 转</h2><p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1184216?from=article.detail.1178714">https://cloud.tencent.com/developer/article/1184216?from=article.detail.1178714</a></p>
<h2 id="9-什么是CIM？究竟和BIM有什么关系？"><a href="#9-什么是CIM？究竟和BIM有什么关系？" class="headerlink" title="9. 什么是CIM？究竟和BIM有什么关系？"></a>9. 什么是CIM？究竟和BIM有什么关系？</h2><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/359816845">https://zhuanlan.zhihu.com/p/359816845</a></p>
<h2 id="10-BIM-GIS应用的八大挑战"><a href="#10-BIM-GIS应用的八大挑战" class="headerlink" title="10. BIM+GIS应用的八大挑战"></a>10. BIM+GIS应用的八大挑战</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/supermapsupport/article/details/95048023">https://blog.csdn.net/supermapsupport/article/details/95048023</a></p>
<h2 id="11-HBase-Ganos简介"><a href="#11-HBase-Ganos简介" class="headerlink" title="11. HBase Ganos简介"></a>11. HBase Ganos简介</h2><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/cad5467cc67d">https://www.jianshu.com/p/cad5467cc67d</a></p>
<h2 id="12-对比五款数据库，告诉你-NewSQL-的独到之处"><a href="#12-对比五款数据库，告诉你-NewSQL-的独到之处" class="headerlink" title="12. 对比五款数据库，告诉你 NewSQL 的独到之处"></a>12. 对比五款数据库，告诉你 NewSQL 的独到之处</h2><p><a target="_blank" rel="noopener" href="https://www.techug.com/post/what-is-new-about-newsql.html">https://www.techug.com/post/what-is-new-about-newsql.html</a></p>
<h2 id="13-NewSQL究竟新在哪里？"><a href="#13-NewSQL究竟新在哪里？" class="headerlink" title="13. NewSQL究竟新在哪里？"></a>13. NewSQL究竟新在哪里？</h2><p><a target="_blank" rel="noopener" href="http://oserror.com/distributed/newsql/">http://oserror.com/distributed/newsql/</a></p>
<h2 id="14-分布式-NewSQL-对比"><a href="#14-分布式-NewSQL-对比" class="headerlink" title="14. 分布式 NewSQL 对比"></a>14. 分布式 NewSQL 对比</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/GO-NO-1/p/9935195.html">https://www.cnblogs.com/GO-NO-1/p/9935195.html</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/10/17/java/%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F/">高并发系统</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-10-18</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/java/">java</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F/">高并发系统</a></span><div class="content"><h1 id="Java高并发"><a href="#Java高并发" class="headerlink" title="Java高并发"></a>Java高并发</h1><p>[TOC]</p>
<h2 id="业务分析与DAO层"><a href="#业务分析与DAO层" class="headerlink" title="业务分析与DAO层"></a>业务分析与DAO层</h2><h3 id="一、创建项目和依赖"><a href="#一、创建项目和依赖" class="headerlink" title="一、创建项目和依赖"></a>一、创建项目和依赖</h3><p><strong>1.maven命令创建web骨架项目</strong></p>
<p>官网资源地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">logback配置：http://logback.qos.ch/manual/configuration.html</span><br><span class="line">spring配置：http://docs.spring.io/spring/docs/</span><br><span class="line">mybatis配置：http://mybatis.github.io/mybatis-3/zh/index.html </span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn archetype:create -DgroupId=org.seckill -DartifactId=seckill -DarchetypeArtifactId=maven-archetype-webapp</span><br></pre></td></tr></table></figure>
<p>项目依赖</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0.</span>单元测试：junit4</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span>java日志：slf4j,log4j,logback,common-logging</span><br><span class="line">    slf4j是规范/接口 其余是日志实现</span><br><span class="line">    dependency:slf4j-api,logback-core,logback-classic</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>数据库</span><br><span class="line">    数据库驱动 mysql-connector-java</span><br><span class="line">    数据库连接池 c3p0</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>DAO框架：Mybatis依赖</span><br><span class="line">    dependency:mybatis,mybatis-spring</span><br><span class="line">    </span><br><span class="line"><span class="number">4.</span>Servlet Web相关依赖</span><br><span class="line">    dependency:standard,jstl,jackson-databind,javax.servlet-api</span><br><span class="line">    </span><br><span class="line"><span class="number">5.</span>spring依赖</span><br><span class="line">    spring 核心依赖:spring-core,spring-beans,spring-context</span><br><span class="line">    spring DAO依赖:spirng-jdbc,spring-tx</span><br><span class="line">    spring web依赖:spring-web,spring-webmvc</span><br><span class="line">    spring test依赖:spring-test</span><br></pre></td></tr></table></figure>

<h3 id="二、数据库设计与编码"><a href="#二、数据库设计与编码" class="headerlink" title="二、数据库设计与编码"></a>二、数据库设计与编码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">-- 创建数据库</span><br><span class="line">CREATE DATABASE seckill;</span><br><span class="line">--使用数据库</span><br><span class="line">USE seckill;</span><br><span class="line">--创建秒杀库存表</span><br><span class="line">CREATE TABLE <span class="title function_">seckill</span><span class="params">(</span></span><br><span class="line"><span class="params">seckill_id BIGINT NOT NULL AUTO_INCREMENT COMMENT <span class="string">&#x27;商品库存表&#x27;</span>,</span></span><br><span class="line"><span class="params">name VARCHAR(<span class="number">120</span>)</span> NOT NULL COMMENT <span class="string">&#x27;商品名称&#x27;</span>,</span><br><span class="line">number <span class="type">int</span> NOT NULL COMMENT <span class="string">&#x27;库存数量&#x27;</span>,</span><br><span class="line">create_time TIMESTAMP NOT NULL DEFAULT current_timestamp COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">start_time TIMESTAMP NOT NULL COMMENT <span class="string">&#x27;秒杀开始时间&#x27;</span>,</span><br><span class="line">end_time TIMESTAMP NOT NULL COMMENT <span class="string">&#x27;秒杀结束时间&#x27;</span>,</span><br><span class="line">PRIMARY <span class="title function_">KEY</span> <span class="params">(seckill_id)</span>,</span><br><span class="line">KEY <span class="title function_">idx_start_time</span><span class="params">(start_time)</span>,</span><br><span class="line">KEY <span class="title function_">idx_end_time</span><span class="params">(end_time)</span>,</span><br><span class="line">KEY <span class="title function_">idx_create_time</span><span class="params">(create_time)</span></span><br><span class="line">)ENGINE=InnoDB AUTO_INCREMENT=<span class="number">1000</span> <span class="type">DEFAULT</span> <span class="variable">CHARSET</span> <span class="operator">=</span><span class="type">utf8</span> <span class="variable">COMMENT</span> <span class="operator">=</span><span class="string">&#x27;秒杀库存表&#x27;</span>;</span><br><span class="line">--初始化数据</span><br><span class="line">INSERT INTO <span class="title function_">seckill</span><span class="params">(name, number, start_time, end_time)</span> VALUES();</span><br><span class="line">--秒杀成功明细表</span><br><span class="line">create table <span class="title function_">success_killed</span><span class="params">(</span></span><br><span class="line"><span class="params">seckill_id BIGINT NOT NULL COMMENT <span class="string">&#x27;秒杀商品id&#x27;</span>,</span></span><br><span class="line"><span class="params">user_phone BIGINT NOT NULL COMMENT <span class="string">&#x27;用户手机号&#x27;</span>,</span></span><br><span class="line"><span class="params">state TINYINT NOT NULL  NOT NULL DEFAULT -<span class="number">1</span> COMMENT <span class="string">&#x27;标识状态 -1 无效 0成功 1已付款 2 已发货 &#x27;</span>,</span></span><br><span class="line"><span class="params">create_time TIMESTAMP NOT NULL COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span></span><br><span class="line"><span class="params">PRIMARY KEY (seckill_id,user_phone)</span>,</span><br><span class="line">KEY <span class="title function_">idx_create_time</span><span class="params">(create_time)</span></span><br><span class="line">)ENGINE=InnoDB <span class="type">DEFAULT</span> <span class="variable">CHARSET</span> <span class="operator">=</span><span class="type">utf8</span> <span class="variable">COMMENT</span> <span class="operator">=</span><span class="string">&#x27;秒杀成功明细&#x27;</span>;</span><br><span class="line">--连接数据库控制台</span><br><span class="line">mysql -uroot -p</span><br></pre></td></tr></table></figure>
<h3 id="三、DAO层实体与编码"><a href="#三、DAO层实体与编码" class="headerlink" title="三、DAO层实体与编码"></a>三、DAO层实体与编码</h3><p>创建对应表的实体类，在java包下创建cn.codingxiaxw.entity包，创建一个Seckill.java实体类，代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Seckill</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> seckillId;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> number;</span><br><span class="line">    <span class="keyword">private</span> Date startTime;</span><br><span class="line">    <span class="keyword">private</span> Date endTime;</span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getSeckillId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSeckillId</span><span class="params">(<span class="type">long</span> seckillId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.seckillId = seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getNumber</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNumber</span><span class="params">(<span class="type">int</span> number)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.number = number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getStartTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> startTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setStartTime</span><span class="params">(Date startTime)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.startTime = startTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getEndTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> endTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEndTime</span><span class="params">(Date endTime)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.endTime = endTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getCreateTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCreateTime</span><span class="params">(Date createTime)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.createTime = createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Seckill&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;seckillId=&quot;</span> + seckillId +</span><br><span class="line">                <span class="string">&quot;, name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, number=&quot;</span> + number +</span><br><span class="line">                <span class="string">&quot;, startTime=&quot;</span> + startTime +</span><br><span class="line">                <span class="string">&quot;, endTime=&quot;</span> + endTime +</span><br><span class="line">                <span class="string">&quot;, createTime=&quot;</span> + createTime +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>和一个SuccessKilled.java，代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SuccessKilled</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> seckillId;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> userPhone;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">short</span> state;</span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//多对一，因为一件商品在库存中有很多数量，对应的购买明细也有很多。</span></span><br><span class="line">    <span class="keyword">private</span> Seckill seckill;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getSeckillId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSeckillId</span><span class="params">(<span class="type">long</span> seckillId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.seckillId = seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getUserPhone</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userPhone;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserPhone</span><span class="params">(<span class="type">long</span> userPhone)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userPhone = userPhone;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">short</span> <span class="title function_">getState</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setState</span><span class="params">(<span class="type">short</span> state)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.state = state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getCreateTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCreateTime</span><span class="params">(Date createTime)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.createTime = createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Seckill <span class="title function_">getSeckill</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> seckill;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSeckill</span><span class="params">(Seckill seckill)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.seckill = seckill;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;SuccessKilled&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;seckillId=&quot;</span> + seckillId +</span><br><span class="line">                <span class="string">&quot;, userPhone=&quot;</span> + userPhone +</span><br><span class="line">                <span class="string">&quot;, state=&quot;</span> + state +</span><br><span class="line">                <span class="string">&quot;, createTime=&quot;</span> + createTime +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>然后针对实体创建出对应dao层的接口，在cn.codingxiaxw.dao包下创建Seckill.java:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SeckillDao</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 减库存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> killTime</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 如果影响行数&gt;1，表示更新库存的记录行数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">reduceNumber</span><span class="params">(<span class="type">long</span> seckillId, Date killTime)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id查询秒杀的商品信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Seckill <span class="title function_">queryById</span><span class="params">(<span class="type">long</span> seckillId)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据偏移量查询秒杀商品列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> off</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> limit</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;Seckill&gt; <span class="title function_">queryAll</span><span class="params">(<span class="type">int</span> off,<span class="type">int</span> limit)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>和SuccessKilled.java:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SuccessKilledDao</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入购买明细,可过滤重复</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userPhone</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>插入的行数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">insertSuccessKilled</span><span class="params">(<span class="type">long</span> seckillId,<span class="type">long</span> userPhone)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据秒杀商品的id查询明细SuccessKilled对象(该对象携带了Seckill秒杀产品对象)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SuccessKilled <span class="title function_">queryByIdWithSeckill</span><span class="params">(<span class="type">long</span> seckillId,<span class="type">long</span> userPhone)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="四、基于MyBatis实现DAO理论"><a href="#四、基于MyBatis实现DAO理论" class="headerlink" title="四、基于MyBatis实现DAO理论"></a>四、基于MyBatis实现DAO理论</h3><p><strong>Mybatis 特点</strong></p>
<p>1、参数自由提供</p>
<p>2、mybatis和hibernate最大的区别就是mybatis的sql完全由自己写，所以这就提供了一个非常健壮的灵活性，可以充分的发挥你的sql的技巧。</p>
<p>3、mybatis的sql写在哪？</p>
<pre><code>1.第一个是写在xml的配置文件里

2.第二个是可以通过注解的形式写sql，java5.0之后提供的新特性。
</code></pre>
<p>4、一些简单的sql可以通过注解的形式去实现，但是遇到一些复杂的sql的时候注解来实现的话就会显的很繁琐。xml配置文件为我们提供很多标签，来完成复杂逻辑sql的拼接，可以很方便的去帮我们完成封装。</p>
<p>5、如何实现DAO接口？</p>
<pre><code>1.第一种，mybatis提供了mapper的机制，通过这种机制自动的去实现DAO接口。也就是说DAO接口只需要实现接口，不需要去实现类。

2.第二种那mybatis通过API编程的方式实现DAO接口。mybatis同样也提供了很多的api，这点和其他的ORmapping，JDBC很像，我可以直接通过开启一个connection，创建一个statement，然后那拿到一个resultSet,这是jdbc的API。同样的mybatis也有同样的API去帮我们实现，但是在实际的开发中，我们一般都是通过mapper自动实现DAO接口，这样的话我们就可以只关注我们的sql如何编写，如何去设计我们的DAO接口，帮我们节省了很多需要维护的程序。
</code></pre>
<p>​<br>接下来<strong>基于MyBatis来实现我们之前设计的Dao层接口</strong>。首先需要配置我们的MyBatis，在resources包下创建MyBatis全局配置文件mybatis-config.xml文件，并新建包mapper,在浏览器中输入<a target="_blank" rel="noopener" href="http://mybatis.github.io/mybatis-3/zh/index.html%E6%89%93%E5%BC%80MyBatis%E7%9A%84%E5%AE%98%E7%BD%91%E6%96%87%E6%A1%A3%EF%BC%8C%E7%82%B9%E5%87%BB%E5%B7%A6%E8%BE%B9%E7%9A%84%E2%80%9D%E5%85%A5%E9%97%A8%E2%80%9D%E6%A0%8F%E6%A1%86%EF%BC%8C%E6%89%BE%E5%88%B0mybatis%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%EF%BC%8C%E5%9C%A8%E8%BF%99%E9%87%8C%E6%9C%89xml%E7%9A%84%E4%B8%80%E4%B8%AA%E8%A7%84%E8%8C%83%EF%BC%8C%E4%B9%9F%E5%B0%B1%E6%98%AF%E5%AE%83%E7%9A%84%E4%B8%80%E4%B8%AAxml%E7%BA%A6%E6%9D%9F%EF%BC%8C%E6%8B%B7%E8%B4%9D">http://mybatis.github.io/mybatis-3/zh/index.html打开MyBatis的官网文档，点击左边的”入门”栏框，找到mybatis全局配置文件，在这里有xml的一个规范，也就是它的一个xml约束，拷贝</a>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="line">&lt;!DOCTYPE configuration</span><br><span class="line">  PUBLIC <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span><br><span class="line">  <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>到我们的项目mybatis全局配置文件中，然后在全局配置文件中加入如下配置信息:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="line">&lt;!DOCTYPE configuration</span><br><span class="line">        PUBLIC <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span><br><span class="line">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;!--配置全局属性--&gt;</span><br><span class="line">    &lt;settings&gt;</span><br><span class="line">        &lt;!--使用jdbc的getGeneratekeys获取自增主键值--&gt;</span><br><span class="line">        &lt;setting name=<span class="string">&quot;useGeneratedKeys&quot;</span> value=<span class="string">&quot;true&quot;</span>/&gt;</span><br><span class="line">        &lt;!--使用列别名替换列名　　默认值为<span class="literal">true</span></span><br><span class="line">        select name as <span class="title function_">title</span><span class="params">(实体中的属性名是title)</span> form table;</span><br><span class="line">        开启后mybatis会自动帮我们把表中name的值赋到对应实体的title属性中</span><br><span class="line">        --&gt;</span><br><span class="line">        &lt;setting name=<span class="string">&quot;useColumnLabel&quot;</span> value=<span class="string">&quot;true&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!--开启驼峰命名转换Table:create_time到 Entity(createTime)--&gt;</span><br><span class="line">        &lt;setting name=<span class="string">&quot;mapUnderscoreToCamelCase&quot;</span> value=<span class="string">&quot;true&quot;</span>/&gt;</span><br><span class="line">    &lt;/settings&gt;</span><br><span class="line"></span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>
<p>配置文件创建好后我们需要关注的是Dao接口该如何实现，mybatis为我们提供了mapper动态代理开发的方式为我们自动实现Dao的接口。在mapper包下创建对应Dao接口的xml映射文件，里面用于编写我们操作数据库的sql语句，SeckillDao.xml和SuccessKilledDao.xml。既然又是一个xml文件，我们肯定需要它的dtd文件，在官方文档中，点击左侧”XML配置”，在它的一些事例中，找到它的xml约束:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE mapper</span><br><span class="line">    PUBLIC <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="line">    <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br></pre></td></tr></table></figure>
<p>加入到两个mapper映射xml文件中，然后对照Dao层方法编写我们的映射文件内容如下:</p>
<p>SeckillDao.xml:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE mapper</span><br><span class="line">        PUBLIC <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="line">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="line">&lt;mapper namespace=<span class="string">&quot;cn.codingxiaxw.dao.SeckillDao&quot;</span>&gt;</span><br><span class="line">    &lt;!--目的:为dao接口方法提供sql语句配置</span><br><span class="line">    即针对dao接口中的方法编写我们的sql语句--&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;update id=<span class="string">&quot;reduceNumber&quot;</span>&gt;</span><br><span class="line">        UPDATE seckill</span><br><span class="line">        <span class="type">SET</span> <span class="variable">number</span> <span class="operator">=</span> number-<span class="number">1</span></span><br><span class="line">        WHERE seckill_id=#&#123;seckillId&#125;</span><br><span class="line">        AND start_time &lt;![CDATA[ &lt;= ]]&gt; #&#123;killTime&#125;</span><br><span class="line">        AND end_time &gt;= #&#123;killTime&#125;</span><br><span class="line">        AND number &gt; <span class="number">0</span>;</span><br><span class="line">    &lt;/update&gt;</span><br><span class="line"></span><br><span class="line">    &lt;select id=<span class="string">&quot;queryById&quot;</span> resultType=<span class="string">&quot;Seckill&quot;</span> parameterType=<span class="string">&quot;long&quot;</span>&gt;</span><br><span class="line">        SELECT *</span><br><span class="line">        FROM seckill</span><br><span class="line">        WHERE seckill_id=#&#123;seckillId&#125;</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line"></span><br><span class="line">    &lt;select id=<span class="string">&quot;queryAll&quot;</span> resultType=<span class="string">&quot;Seckill&quot;</span>&gt;</span><br><span class="line">        SELECT *</span><br><span class="line">        FROM seckill</span><br><span class="line">        ORDER BY create_time DESC</span><br><span class="line">        limit #&#123;offset&#125;,#&#123;limit&#125;</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line"></span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>
<p>SuccessKilledDao.xml:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE mapper</span><br><span class="line">        PUBLIC <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="line">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="line">&lt;mapper namespace=<span class="string">&quot;cn.codingxiaxw.dao.SuccessKilledDao&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;insert id=<span class="string">&quot;insertSuccessKilled&quot;</span>&gt;</span><br><span class="line">        &lt;!--当出现主键冲突时(即重复秒杀时)，会报错;不想让程序报错，加入ignore--&gt;</span><br><span class="line">        INSERT ignore INTO <span class="title function_">success_killed</span><span class="params">(seckill_id,user_phone,state)</span></span><br><span class="line">        VALUES (#&#123;seckillId&#125;,#&#123;userPhone&#125;,<span class="number">0</span>)</span><br><span class="line">    &lt;/insert&gt;</span><br><span class="line"></span><br><span class="line">    &lt;select id=<span class="string">&quot;queryByIdWithSeckill&quot;</span> resultType=<span class="string">&quot;SuccessKilled&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!--根据seckillId查询SuccessKilled对象，并携带Seckill对象--&gt;</span><br><span class="line">        &lt;!--如何告诉mybatis把结果映射到SuccessKill属性同时映射到Seckill属性--&gt;</span><br><span class="line">        &lt;!--可以自由控制SQL语句--&gt;</span><br><span class="line">        SELECT</span><br><span class="line">            sk.seckill_id,</span><br><span class="line">            sk.user_phone,</span><br><span class="line">            sk.create_time,</span><br><span class="line">            sk.state,</span><br><span class="line">            s.seckill_id <span class="string">&quot;seckill.seckill_id&quot;</span>,</span><br><span class="line">            s.name <span class="string">&quot;seckill.name&quot;</span>,</span><br><span class="line">            s.number <span class="string">&quot;seckill&quot;</span>,</span><br><span class="line">            s.start_time <span class="string">&quot;seckill.start_time&quot;</span>,</span><br><span class="line">            s.end_time <span class="string">&quot;seckill.end_time&quot;</span>,</span><br><span class="line">            s.create_time <span class="string">&quot;seckill.create_time&quot;</span></span><br><span class="line">        FROM success_killed sk</span><br><span class="line">        INNER JOIN seckill s ON sk.seckill_id=s.seckill_id</span><br><span class="line">        WHERE sk.seckill_id=#&#123;seckillId&#125;</span><br><span class="line">        AND sk.user_phone=#&#123;userPhone&#125;</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line"></span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>
<h3 id="五、MyBatis和Spring的整合"><a href="#五、MyBatis和Spring的整合" class="headerlink" title="五、MyBatis和Spring的整合"></a>五、MyBatis和Spring的整合</h3><p>mybatis与Spring的整合目标：</p>
<p>1、更少的编码</p>
<pre><code>1). 只需要接口，不需要实现(Mybatis 自动完成)
</code></pre>
<p>2、更少的配置</p>
<pre><code>1). 别名(Mybatis可以扫描对应包，因此使用一些类的时候不需要使用包名+类名)

2). 配置扫描

3). dao的实现
</code></pre>
<p>3、足够的灵活性</p>
<pre><code>1). 自己定制SQL语句

2). 自由传参
</code></pre>
<p>接下来我们开始MyBatis和Spring的整合，整合目标:1.更少的编码:只写接口，不写实现类。2.更少的配置:别名、配置扫描映射xml文件、dao实现。3.足够的灵活性:自由定制SQL语句、自由传结果集自动赋值。</p>
<p>在resources包下创建一个spring包，里面放置spring对Dao、Service、transaction的配置文件。在浏览器中输入<a target="_blank" rel="noopener" href="http://docs.spring.io/spring/docs/%E8%BF%9B%E5%85%A5%E5%88%B0Spring%E7%9A%84%E5%AE%98%E7%BD%91%E4%B8%AD%E4%B8%8B%E8%BD%BD%E5%85%B6pdf%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%EF%BC%8C%E5%9C%A8%E5%85%B6%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E4%B8%AD%E6%89%BE%E5%88%B0%E5%AE%83%E7%9A%84xml%E7%9A%84%E5%AE%9A%E4%B9%89%E5%86%85%E5%AE%B9%E5%A4%B4%E9%83%A8">http://docs.spring.io/spring/docs/进入到Spring的官网中下载其pdf官方文档，在其官方文档中找到它的xml的定义内容头部</a>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xmlns:context=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span><br></pre></td></tr></table></figure>
<p>在spring包下创建一个spring配置dao层对象的配置文件spring-dao.xml，加入上述dtd约束，然后添加二者整合的配置，内容如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xmlns:context=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--配置整合mybatis过程</span><br><span class="line">    <span class="number">1.</span>配置数据库相关参数--&gt;</span><br><span class="line">    &lt;context:property-placeholder location=<span class="string">&quot;classpath:jdbc.properties&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--<span class="number">2.</span>数据库连接池--&gt;</span><br><span class="line">    &lt;bean id=<span class="string">&quot;dataSource&quot;</span> class=<span class="string">&quot;com.mchange.v2.c3p0.ComboPooledDataSource&quot;</span>&gt;</span><br><span class="line">        &lt;!--配置连接池属性--&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;driverClass&quot;</span> value=<span class="string">&quot;$&#123;driver&#125;&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- 基本属性 url、user、password --&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;jdbcUrl&quot;</span> value=<span class="string">&quot;$&#123;url&#125;&quot;</span> /&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;user&quot;</span> value=<span class="string">&quot;$&#123;username&#125;&quot;</span> /&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;password&quot;</span> value=<span class="string">&quot;$&#123;password&#125;&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!--c3p0私有属性--&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;maxPoolSize&quot;</span> value=<span class="string">&quot;30&quot;</span>/&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;minPoolSize&quot;</span> value=<span class="string">&quot;10&quot;</span>/&gt;</span><br><span class="line">        &lt;!--关闭连接后不自动commit--&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;autoCommitOnClose&quot;</span> value=<span class="string">&quot;false&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!--获取连接超时时间--&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;checkoutTimeout&quot;</span> value=<span class="string">&quot;1000&quot;</span>/&gt;</span><br><span class="line">        &lt;!--当获取连接失败重试次数--&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;acquireRetryAttempts&quot;</span> value=<span class="string">&quot;2&quot;</span>/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--约定大于配置--&gt;</span><br><span class="line">    &lt;!--３.配置SqlSessionFactory对象--&gt;</span><br><span class="line">    &lt;bean id=<span class="string">&quot;sqlSessionFactory&quot;</span> class=<span class="string">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span>&gt;</span><br><span class="line">        &lt;!--往下才是mybatis和spring真正整合的配置--&gt;</span><br><span class="line">        &lt;!--注入数据库连接池--&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;dataSource&quot;</span> ref=<span class="string">&quot;dataSource&quot;</span>/&gt;</span><br><span class="line">        &lt;!--配置mybatis全局配置文件:mybatis-config.xml--&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;configLocation&quot;</span> value=<span class="string">&quot;classpath:mybatis-config.xml&quot;</span>/&gt;</span><br><span class="line">        &lt;!--扫描entity包,使用别名,多个用;隔开--&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;typeAliasesPackage&quot;</span> value=<span class="string">&quot;cn.codingxiaxw.entity&quot;</span>/&gt;</span><br><span class="line">        &lt;!--扫描sql配置文件:mapper需要的xml文件--&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;mapperLocations&quot;</span> value=<span class="string">&quot;classpath:mapper/*.xml&quot;</span>/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--４:配置扫描Dao接口包,动态实现DAO接口,注入到spring容器--&gt;</span><br><span class="line">    &lt;bean class=<span class="string">&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;</span>&gt;</span><br><span class="line">        &lt;!--注入SqlSessionFactory--&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;sqlSessionFactoryBeanName&quot;</span> value=<span class="string">&quot;sqlSessionFactory&quot;</span>/&gt;</span><br><span class="line">        &lt;!-- 给出需要扫描的Dao接口--&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;basePackage&quot;</span> value=<span class="string">&quot;cn.codingxiaxw.dao&quot;</span>/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>
<p>需要我们在resources包下创建jdbc.properties用于配置数据库的连接信息，内容如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">driver=com.mysql.jdbc.Driver</span><br><span class="line">url=jdbc:mysql:<span class="comment">//localhost:3306/seckill?useUnicode=true&amp;characterEncoding=utf-8</span></span><br><span class="line">username=root</span><br><span class="line">password=xiaxunwu1996.</span><br></pre></td></tr></table></figure>
<h3 id="六、DAO单元测试"><a href="#六、DAO单元测试" class="headerlink" title="六、DAO单元测试"></a>六、DAO单元测试</h3><p>这样我们便完成了Dao层编码的开发，接下来就可以利用junit进行我们Dao层编码的测试了。首先测试SeckillDao.java，利用IDEA快捷键shift+command+T对SeckillDao.java进行测试，然后IDEA会自动在test包的java包下为我们生成对SeckillDao.java中所有方法的测试类SeckillDaoTest.java,内容如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeckillDaoTest</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reduceNumber</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryById</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryAll</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后便可以在这个测试类中对SeckillDao接口的所有方法进行测试了,先测试queryById()方法，在该方法中添加内容:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by codingBoy on 16/11/27.</span></span><br><span class="line"><span class="comment"> * 配置spring和junit整合，这样junit在启动时就会加载spring容器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner.class)</span></span><br><span class="line"><span class="comment">//告诉junit spring的配置文件</span></span><br><span class="line"><span class="meta">@ContextConfiguration(&#123;&quot;classpath:spring/spring-dao.xml&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeckillDaoTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注入Dao实现类依赖</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SeckillDao seckillDao;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryById</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">long</span> seckillId=<span class="number">1000</span>;</span><br><span class="line">        Seckill seckill=seckillDao.queryById(seckillId);</span><br><span class="line">        System.out.println(seckill.getName());</span><br><span class="line">        System.out.println(seckill);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>右键选择”debug queryById()”，测试台成功输入该id为1000的商品信息，证明Dao的该方法正确，然后测试queryAll()方法，在该方法中添加如下内容:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryAll</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">       List&lt;Seckill&gt; seckills=seckillDao.queryAll(<span class="number">0</span>,<span class="number">100</span>);</span><br><span class="line">       <span class="keyword">for</span> (Seckill seckill : seckills)</span><br><span class="line">       &#123;</span><br><span class="line">           System.out.println(seckill);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>然后运行该方法，程序报错，报错信息如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Caused by: org.apache.ibatis.binding.BindingException: Parameter &#x27;offset&#x27; not found. Available parameters are [1, 0, param1, param2</span><br></pre></td></tr></table></figure>
<p>意思就是无法完成offset参数的绑定，这也是我们java编程语言的一个问题，也就是java没有保存行参的记录，java在运行的时候会把<code>List&lt;Seckill&gt; queryAll(int offset,int limit);</code>中的参数变成这样:<code>queryAll(int arg0,int arg1)</code>,这样我们就没有办法去传递多个参数。需要在SeckillDao接口中修改方法:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Seckill&gt; queryAll(@Param(&quot;offset&quot;) int offset,@Param(&quot;limit&quot;) int limit);</span><br></pre></td></tr></table></figure>
<p>这样才能使我们的MyBatis识别offset和limit两个参数，将Dao层方法中的这两个参数与xml映射文件中sql语句的传入参数完成映射。然后重新测试，发现测试通过。然后测试reduceNumber()方法，在该方法中加入如下内容:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reduceNumber</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">      <span class="type">long</span> seckillId=<span class="number">1000</span>;</span><br><span class="line">      Date date=<span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">      <span class="type">int</span> updateCount=seckillDao.reduceNumber(seckillId,date);</span><br><span class="line">      System.out.println(updateCount);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>运行该方法，报错:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Caused by: org.apache.ibatis.binding.BindingException: Parameter &#x27;seckillId&#x27; not found. Available parameters are [1, 0, param1, param2]</span><br></pre></td></tr></table></figure>
<p>发现依然是我们之前那个错误，更改SeckillDao接口的reduceNumber()方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">reduceNumber</span><span class="params">(<span class="meta">@Param(&quot;seckillId&quot;)</span> <span class="type">long</span> seckillId, <span class="meta">@Param(&quot;killTime&quot;)</span> Date killTime)</span>;</span><br></pre></td></tr></table></figure>
<p>然后重新运行，测试通过，可是我们查询数据库发现该库存表的商品数量没有减少，是因为我们当前时间没有达到秒杀商品要求的时间，所以不会成功秒杀。接下来进行SuccessKilledDao接口相关方法的测试，依旧使用IDEA快捷键<code>shift+command+T</code>快速生成其方法的相应测试类:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public class SuccessKilledDaoTest &#123;</span><br><span class="line">    @Test</span><br><span class="line">    public void insertSuccessKilled() throws Exception 	&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void queryByIdWithSeckill() throws Exception 	&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>依然要在SuccessKilledDao的方法中用@Param注解完成参数的绑定，首先完成insertSuccessKilled()的测试:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner.class)</span></span><br><span class="line"><span class="comment">//告诉junit spring的配置文件</span></span><br><span class="line"><span class="meta">@ContextConfiguration(&#123;&quot;classpath:spring/spring-dao.xml&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SuccessKilledDaoTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SuccessKilledDao successKilledDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertSuccessKilled</span><span class="params">()</span> <span class="keyword">throws</span> Exception 	&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> seckillId=<span class="number">1000</span>;</span><br><span class="line">        <span class="type">long</span> userPhone=<span class="number">13476191877L</span>;</span><br><span class="line">        <span class="type">int</span> insertCount=successKilledDao.insertSuccessKilled(seckillId,userPhone);</span><br><span class="line">        System.out.println(<span class="string">&quot;insertCount=&quot;</span>+insertCount);</span><br><span class="line">    &#125;</span><br><span class="line">｝</span><br></pre></td></tr></table></figure>
<p>运行成功，测试台打印出insertCount&#x3D;1的信息，即我们修改了表中的一条记录，这时查看秒杀成功明细表，发现该用户的信息已经被插入。然后再次运行该测试方法，程序没有报主键异常的错，是因为我们在编写我们的明细表的时候添加了一个联合主键的字段，它保证我们明细表中的seckillId和userPhone不能重复插入，另外在SuccessDao.xml中写的插入语句的ignore关键字也保证了这点。控制台输出0，表示没有对明细表做插入操作。然后进行queryByIdWithSeckill()方法的测试,需要在Dao层的方法中添加@Param注解:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SuccessKilled queryByIdWithSeckill(@Param(&quot;seckillId&quot;) long seckillId,@Param(&quot;userPhone&quot;) long userPhone);</span><br></pre></td></tr></table></figure>
<p>然后进行该方法的测试:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryByIdWithSeckill</span><span class="params">()</span> <span class="keyword">throws</span> Exception 	&#123;</span><br><span class="line">        <span class="type">long</span> seckillId=<span class="number">1000L</span>;</span><br><span class="line">        <span class="type">long</span> userPhone=<span class="number">13476191877L</span>;</span><br><span class="line">        SuccessKilled successKilled=successKilledDao.queryByIdWithSeckill(seckillId,userPhone);</span><br><span class="line">        System.out.println(successKilled);</span><br><span class="line">        System.out.println(successKilled.getSeckill());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>运行，成功查询出我们明细表中id为1000且手机号码为13476191877的用户信息，并将表中对应的信息映射到SuccessKilled对象和Seckill对象的属性中。</p>
<h2 id="Service层"><a href="#Service层" class="headerlink" title="Service层"></a>Service层</h2><p>Dao就是数据访问的缩写，它只进行数据的访问操作，接下来我们便进行Service层代码的编写</p>
<h3 id="一、Service接口设计与实现"><a href="#一、Service接口设计与实现" class="headerlink" title="一、Service接口设计与实现"></a>一、Service接口设计与实现</h3><p>在org.seckill包下创建一个service包用于存放我们的Service接口和其实现类，创建一个exception包用于存放service层出现的异常例如重复秒杀商品异常、秒杀已关闭等异常，一个dto包作为传输层,dto和entity的区别在于:entity用于业务数据的封装，而dto用于完成web和service层的数据传递。</p>
<p><strong>接口设计</strong></p>
<p>首先创建我们Service接口，里面的方法应该是按”使用者”(程序员)的角度去设计，SeckillService.java，代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SeckillService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询全部的秒杀记录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;Seckill&gt; <span class="title function_">getSeckillList</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *查询单个秒杀记录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Seckill <span class="title function_">getById</span><span class="params">(<span class="type">long</span> seckillId)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//再往下，是我们最重要的行为的一些接口</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在秒杀开启时输出秒杀接口的地址，否则输出系统时间和秒杀时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Exposer <span class="title function_">exportSeckillUrl</span><span class="params">(<span class="type">long</span> seckillId)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行秒杀操作，有可能失败，有可能成功，所以要抛出我们允许的异常</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userPhone</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> md5</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SeckillExecution <span class="title function_">executeSeckill</span><span class="params">(<span class="type">long</span> seckillId,<span class="type">long</span> userPhone,String md5)</span></span><br><span class="line">            <span class="keyword">throws</span> SeckillException,RepeatKillException,SeckillCloseException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该接口中前面两个方法返回的都是跟我们业务相关的对象，而后两个方法返回的对象与业务不相关，这两个对象我们用于封装service和web层传递的数据，方法的作用我们已在注释中给出。相应在的dto包中创建Exposer.java，用于封装秒杀的地址信息，各个属性的作用在代码中已给出注释，代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by codingBoy on 16/11/27.</span></span><br><span class="line"><span class="comment"> * 暴露秒杀地址(接口)DTO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exposer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//是否开启秒杀</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> exposed;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//对秒杀地址加密措施</span></span><br><span class="line">    <span class="keyword">private</span> String md5;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//id为seckillId的商品的秒杀地址</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> seckillId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//系统当前时间(毫秒)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> now;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//秒杀的开启时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> start;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//秒杀的结束时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> end;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Exposer</span><span class="params">(<span class="type">boolean</span> exposed, String md5, <span class="type">long</span> seckillId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.exposed = exposed;</span><br><span class="line">        <span class="built_in">this</span>.md5 = md5;</span><br><span class="line">        <span class="built_in">this</span>.seckillId = seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Exposer</span><span class="params">(<span class="type">boolean</span> exposed, <span class="type">long</span> seckillId,<span class="type">long</span> now, <span class="type">long</span> start, <span class="type">long</span> end)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.exposed = exposed;</span><br><span class="line">        <span class="built_in">this</span>.seckillId=seckillId;</span><br><span class="line">        <span class="built_in">this</span>.now = now;</span><br><span class="line">        <span class="built_in">this</span>.start = start;</span><br><span class="line">        <span class="built_in">this</span>.end = end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Exposer</span><span class="params">(<span class="type">boolean</span> exposed, <span class="type">long</span> seckillId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.exposed = exposed;</span><br><span class="line">        <span class="built_in">this</span>.seckillId = seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isExposed</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> exposed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setExposed</span><span class="params">(<span class="type">boolean</span> exposed)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.exposed = exposed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMd5</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> md5;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMd5</span><span class="params">(String md5)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.md5 = md5;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getSeckillId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSeckillId</span><span class="params">(<span class="type">long</span> seckillId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.seckillId = seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getNow</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> now;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNow</span><span class="params">(<span class="type">long</span> now)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.now = now;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getStart</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> start;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setStart</span><span class="params">(<span class="type">long</span> start)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.start = start;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getEnd</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEnd</span><span class="params">(<span class="type">long</span> end)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.end = end;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>和SeckillExecution.java，用于判断秒杀是否成功，成功就返回秒杀成功的所有信息(包括秒杀的商品id、秒杀成功状态、成功信息、用户明细)，失败就抛出一个我们允许的异常(重复秒杀异常、秒杀结束异常),代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 封装执行秒杀后的结果:是否秒杀成功</span></span><br><span class="line"><span class="comment"> * Created by codingBoy on 16/11/27.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeckillExecution</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> seckillId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//秒杀执行结果的状态</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> state;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//状态的明文标识</span></span><br><span class="line">    <span class="keyword">private</span> String stateInfo;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当秒杀成功时，需要传递秒杀成功的对象回去</span></span><br><span class="line">    <span class="keyword">private</span> SuccessKilled successKilled;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//秒杀成功返回所有信息</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SeckillExecution</span><span class="params">(<span class="type">long</span> seckillId, <span class="type">int</span> state, String stateInfo, SuccessKilled successKilled)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.seckillId = seckillId;</span><br><span class="line">        <span class="built_in">this</span>.state = state;</span><br><span class="line">        <span class="built_in">this</span>.stateInfo = stateInfo;</span><br><span class="line">        <span class="built_in">this</span>.successKilled = successKilled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//秒杀失败</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SeckillExecution</span><span class="params">(<span class="type">long</span> seckillId, <span class="type">int</span> state, String stateInfo)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.seckillId = seckillId;</span><br><span class="line">        <span class="built_in">this</span>.state = state;</span><br><span class="line">        <span class="built_in">this</span>.stateInfo = stateInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getSeckillId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSeckillId</span><span class="params">(<span class="type">long</span> seckillId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.seckillId = seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getState</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setState</span><span class="params">(<span class="type">int</span> state)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.state = state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getStateInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> stateInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setStateInfo</span><span class="params">(String stateInfo)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stateInfo = stateInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SuccessKilled <span class="title function_">getSuccessKilled</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> successKilled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSuccessKilled</span><span class="params">(SuccessKilled successKilled)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.successKilled = successKilled;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后需要创建我们在秒杀业务过程中允许的异常，重复秒杀异常RepeatKillException.java:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 重复秒杀异常，是一个运行期异常，不需要我们手动try catch</span></span><br><span class="line"><span class="comment"> * Mysql只支持运行期异常的回滚操作</span></span><br><span class="line"><span class="comment"> * Created by codingBoy on 16/11/27.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RepeatKillException</span> <span class="keyword">extends</span> <span class="title class_">SeckillException</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RepeatKillException</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RepeatKillException</span><span class="params">(String message, Throwable cause)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message, cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>秒杀关闭异常SeckillCloseException.java:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 秒杀关闭异常，当秒杀结束时用户还要进行秒杀就会出现这个异常</span></span><br><span class="line"><span class="comment"> * Created by codingBoy on 16/11/27.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeckillCloseException</span> <span class="keyword">extends</span> <span class="title class_">SeckillException</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SeckillCloseException</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SeckillCloseException</span><span class="params">(String message, Throwable cause)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message, cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>和一个异常包含与秒杀业务所有出现的异常SeckillException.java:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 秒杀相关的所有业务异常</span></span><br><span class="line"><span class="comment"> * Created by codingBoy on 16/11/27.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeckillException</span> <span class="keyword">extends</span> <span class="title class_">RuntimeException</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SeckillException</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SeckillException</span><span class="params">(String message, Throwable cause)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message, cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到此，接口的工作便完成，接下来进行接口实现类的编码工作。</p>
<p><strong>接口实现</strong><br>在service包下创建impl包存放它的实现类，SeckillServiceImpl.java，内容如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeckillServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">SeckillService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//日志对象</span></span><br><span class="line">    <span class="keyword">private</span> Logger logger= LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加入一个混淆字符串(秒杀接口)的salt，为了我避免用户猜出我们的md5值，值任意给，越复杂越好</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String salt=<span class="string">&quot;shsdssljdd&#x27;l.&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注入Service依赖</span></span><br><span class="line">    <span class="meta">@Autowired</span> <span class="comment">//@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SeckillDao seckillDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span> <span class="comment">//@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SuccessKilledDao successKilledDao;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Seckill&gt; <span class="title function_">getSeckillList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> seckillDao.queryAll(<span class="number">0</span>,<span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Seckill <span class="title function_">getById</span><span class="params">(<span class="type">long</span> seckillId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> seckillDao.queryById(seckillId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Exposer <span class="title function_">exportSeckillUrl</span><span class="params">(<span class="type">long</span> seckillId)</span> &#123;</span><br><span class="line">        Seckill seckill=seckillDao.queryById(seckillId);</span><br><span class="line">        <span class="keyword">if</span> (seckill==<span class="literal">null</span>) <span class="comment">//说明查不到这个秒杀产品的记录</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Exposer</span>(<span class="literal">false</span>,seckillId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//若是秒杀未开启</span></span><br><span class="line">        Date startTime=seckill.getStartTime();</span><br><span class="line">        Date endTime=seckill.getEndTime();</span><br><span class="line">        <span class="comment">//系统当前时间</span></span><br><span class="line">        Date nowTime=<span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">        <span class="keyword">if</span> (startTime.getTime()&gt;nowTime.getTime() || endTime.getTime()&lt;nowTime.getTime())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Exposer</span>(<span class="literal">false</span>,seckillId,nowTime.getTime(),startTime.getTime(),endTime.getTime());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//秒杀开启，返回秒杀商品的id、用给接口加密的md5</span></span><br><span class="line">        String md5=getMD5(seckillId);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Exposer</span>(<span class="literal">true</span>,md5,seckillId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getMD5</span><span class="params">(<span class="type">long</span> seckillId)</span></span><br><span class="line">    &#123;</span><br><span class="line">        String base=seckillId+<span class="string">&quot;/&quot;</span>+salt;</span><br><span class="line">        String md5= DigestUtils.md5DigestAsHex(base.getBytes());</span><br><span class="line">        <span class="keyword">return</span> md5;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//秒杀是否成功，成功:减库存，增加明细；失败:抛出异常，事务回滚</span></span><br><span class="line">    <span class="keyword">public</span> SeckillExecution <span class="title function_">executeSeckill</span><span class="params">(<span class="type">long</span> seckillId, <span class="type">long</span> userPhone, String md5)</span></span><br><span class="line">            <span class="keyword">throws</span> SeckillException, RepeatKillException, SeckillCloseException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (md5==<span class="literal">null</span>||!md5.equals(getMD5(seckillId)))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SeckillException</span>(<span class="string">&quot;seckill data rewrite&quot;</span>);<span class="comment">//秒杀数据被重写了</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//执行秒杀逻辑:减库存+增加购买明细</span></span><br><span class="line">        Date nowTime=<span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//减库存</span></span><br><span class="line">            <span class="type">int</span> updateCount=seckillDao.reduceNumber(seckillId,nowTime);</span><br><span class="line">            <span class="keyword">if</span> (updateCount&lt;=<span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//没有更新库存记录，说明秒杀结束</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SeckillCloseException</span>(<span class="string">&quot;seckill is closed&quot;</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//否则更新了库存，秒杀成功,增加明细</span></span><br><span class="line">                <span class="type">int</span> insertCount=successKilledDao.insertSuccessKilled(seckillId,userPhone);</span><br><span class="line">                <span class="comment">//看是否该明细被重复插入，即用户是否重复秒杀</span></span><br><span class="line">                <span class="keyword">if</span> (insertCount&lt;=<span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RepeatKillException</span>(<span class="string">&quot;seckill repeated&quot;</span>);</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//秒杀成功,得到成功插入的明细记录,并返回成功秒杀的信息</span></span><br><span class="line">                    SuccessKilled successKilled=successKilledDao.queryByIdWithSeckill(seckillId,userPhone);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SeckillExecution</span>(seckillId,<span class="number">1</span>,<span class="string">&quot;秒杀成功&quot;</span>,successKilled);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (SeckillCloseException e1)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> e1;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (RepeatKillException e2)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> e2;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            logger.error(e.getMessage(),e);</span><br><span class="line">            <span class="comment">//所以编译期异常转化为运行期异常</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SeckillException</span>(<span class="string">&quot;seckill inner error :&quot;</span>+e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对上述代码进行分析一下，在<code>return new SeckillExecution(seckillId,1,&quot;秒杀成功&quot;,successKilled);</code>代码中，我们返回的state和stateInfo参数信息应该是输出给前端的，但是我们不想在我们的return代码中硬编码这两个参数，所以我们应该考虑用枚举的方式将这些常量封装起来，在org.seckill包下新建一个枚举包enums，创建一个枚举类型SeckillStatEnum.java，内容如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">SeckillStatEnum</span> &#123;</span><br><span class="line"></span><br><span class="line">    SUCCESS(<span class="number">1</span>,<span class="string">&quot;秒杀成功&quot;</span>),</span><br><span class="line">    END(<span class="number">0</span>,<span class="string">&quot;秒杀结束&quot;</span>),</span><br><span class="line">    REPEAT_KILL(-<span class="number">1</span>,<span class="string">&quot;重复秒杀&quot;</span>),</span><br><span class="line">    INNER_ERROR(-<span class="number">2</span>,<span class="string">&quot;系统异常&quot;</span>),</span><br><span class="line">    DATE_REWRITE(-<span class="number">3</span>,<span class="string">&quot;数据篡改&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> state;</span><br><span class="line">    <span class="keyword">private</span> String info;</span><br><span class="line"></span><br><span class="line">    SeckillStatEnum(<span class="type">int</span> state, String info) &#123;</span><br><span class="line">        <span class="built_in">this</span>.state = state;</span><br><span class="line">        <span class="built_in">this</span>.info = info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getState</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SeckillStatEnum <span class="title function_">stateOf</span><span class="params">(<span class="type">int</span> index)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (SeckillStatEnum state : values())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (state.getState()==index)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> state;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后修改执行秒杀操作的非业务类SeckillExecution.java里面涉及到state和stateInfo参数的构造方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//秒杀成功返回所有信息</span></span><br><span class="line"> <span class="keyword">public</span> <span class="title function_">SeckillExecution</span><span class="params">(<span class="type">long</span> seckillId, SeckillStatEnum statEnum, SuccessKilled successKilled)</span> &#123;</span><br><span class="line">     <span class="built_in">this</span>.seckillId = seckillId;</span><br><span class="line">     <span class="built_in">this</span>.state = statEnum.getState();</span><br><span class="line">     <span class="built_in">this</span>.stateInfo = statEnum.getInfo();</span><br><span class="line">     <span class="built_in">this</span>.successKilled = successKilled;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//秒杀失败</span></span><br><span class="line"> <span class="keyword">public</span> <span class="title function_">SeckillExecution</span><span class="params">(<span class="type">long</span> seckillId, SeckillStatEnum statEnum)</span> &#123;</span><br><span class="line">     <span class="built_in">this</span>.seckillId = seckillId;</span><br><span class="line">     <span class="built_in">this</span>.state = statEnum.getState();</span><br><span class="line">     <span class="built_in">this</span>.stateInfo = statEnum.getInfo();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>然后便可修改实现类方法中的返回语句为:<code>return new SeckillExecution(seckillId, SeckillStatEnum.SUCCESS,successKilled);</code>，保证了一些常用常量数据被封装在枚举类型里。</p>
<p>目前为止我们Service的实现全部完成，接下来要将Service交给Spring的容器托管，进行一些配置。</p>
<h3 id="二、Spring托管Service实现类"><a href="#二、Spring托管Service实现类" class="headerlink" title="二、Spring托管Service实现类"></a>二、Spring托管Service实现类</h3><p>Spring-IOC注入方式和场景</p>
<pre><code>1、XML方式：主要用于配置第三方类库或需要命名空间配置

2、注解：自己编写的类，直接在代码中使用注解，如@Service，@Controller

3、Java配置类：需要通过代码控制对象创建逻辑的场景，如自定义修改依赖类库
</code></pre>
<p>在spring包下创建一个spring-service.xml文件，内容如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xmlns:context=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/context</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--扫描service包下所有使用注解的类型--&gt;</span><br><span class="line">    &lt;context:component-scan base-<span class="keyword">package</span>=<span class="string">&quot;cn.codingxiaxw.service&quot;</span>/&gt;</span><br><span class="line">    </span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>
<p>然后采用注解的方式将Service的实现类加入到Spring IOC容器中:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@Component @Service @Dao @Controller</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeckillServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">SeckillService</span></span><br></pre></td></tr></table></figure>
<p>下面我们来运用Spring的声明式事务对我们项目中的事务进行管理。</p>
<h3 id="三、配置并使用spring声明式事务"><a href="#三、配置并使用spring声明式事务" class="headerlink" title="三、配置并使用spring声明式事务"></a>三、配置并使用spring声明式事务</h3><p>声明式事务的使用方式:</p>
<pre><code>1.早期使用的方式:ProxyFactoryBean+XMl.

2.tx:advice+aop命名空间，这种配置的好处就是一次配置永久生效。

3.注解@Transactional的方式。在实际开发中，建议使用第三种对我们的事务进行控制，优点见下面代码中的注释。
</code></pre>
<p> Spring在抛出运行期异常时会回滚事务，两点注意：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> 非运行期异常时要注意，防止出现部分成功部分失败的情况（所以自己封装异常时，在需要的地方要<span class="keyword">implements</span> <span class="title class_">RuntimeException</span>）。</span><br><span class="line"></span><br><span class="line"><span class="number">2</span> 小心使用<span class="keyword">try</span>-<span class="keyword">catch</span>：被<span class="keyword">try</span>-<span class="keyword">catch</span>块包裹起来的异常Spring也是感觉不到的   </span><br></pre></td></tr></table></figure>

<p>下面让我们来配置声明式事务，在spring-service.xml中添加对事务的配置:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--配置事务管理器--&gt;</span><br><span class="line">  &lt;bean id=<span class="string">&quot;transactionManager&quot;</span> class=<span class="string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span><br><span class="line">      &lt;!--注入数据库连接池--&gt;</span><br><span class="line">      &lt;property name=<span class="string">&quot;dataSource&quot;</span> ref=<span class="string">&quot;dataSource&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">  &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">  &lt;!--配置基于注解的声明式事务</span><br><span class="line">  默认使用注解来管理事务行为--&gt;</span><br><span class="line">  &lt;tx:annotation-driven transaction-manager=<span class="string">&quot;transactionManager&quot;</span>/&gt;</span><br></pre></td></tr></table></figure>
<p>然后在Service实现类的方法中，在需要进行事务声明的方法上加上事务的注解:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//秒杀是否成功，成功:减库存，增加明细；失败:抛出异常，事务回滚</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用注解控制事务方法的优点:</span></span><br><span class="line"><span class="comment"> * 1.开发团队达成一致约定，明确标注事务方法的编程风格</span></span><br><span class="line"><span class="comment"> * 2.保证事务方法的执行时间尽可能短，不要穿插其他网络操作RPC/HTTP请求或者剥离到事务方法外部</span></span><br><span class="line"><span class="comment"> * 3.不是所有的方法都需要事务，如只有一条修改操作、只读操作不要事务控制</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> SeckillExecution <span class="title function_">executeSeckill</span><span class="params">(<span class="type">long</span> seckillId, <span class="type">long</span> userPhone, String md5)</span></span><br><span class="line">        <span class="keyword">throws</span> SeckillException, RepeatKillException, SeckillCloseException &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>下面针对我们之前做的业务实现类来做集成测试。</p>
<h3 id="四、完成Service集成测试"><a href="#四、完成Service集成测试" class="headerlink" title="四、完成Service集成测试"></a>四、完成Service集成测试</h3><p>在SeckillService接口中使用IDEA快捷键shift+command+T，快速生成junit测试类。Service实现类中前面两个方法很好实现，获取列表或者列表中的一个商品的信息即可，测试如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner.class)</span></span><br><span class="line"><span class="comment">//告诉junit spring的配置文件</span></span><br><span class="line"><span class="meta">@ContextConfiguration(&#123;&quot;classpath:spring/spring-dao.xml&quot;,</span></span><br><span class="line"><span class="meta">                        &quot;classpath:spring/spring-service.xml&quot;&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeckillServiceTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger= LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SeckillService seckillService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getSeckillList</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        List&lt;Seckill&gt; seckills=seckillService.getSeckillList();</span><br><span class="line">        System.out.println(seckills);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getById</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> seckillId=<span class="number">1000</span>;</span><br><span class="line">        Seckill seckill=seckillService.getById(seckillId);</span><br><span class="line">        System.out.println(seckill);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重点就是<code>exportSeckillUrl()</code>方法和<code>executeSeckill()</code>方法的测试，接下来我们进行<code>exportSeckillUrl()</code>方法的测试，如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exportSeckillUrl</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> seckillId=<span class="number">1000</span>;</span><br><span class="line">    Exposer exposer=seckillService.exportSeckillUrl(seckillId);</span><br><span class="line">    System.out.println(exposer);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>控制台中输入如下信息:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exposer&#123;exposed=false, md5=&#x27;null&#x27;, seckillId=1000, now=1480322072410, start=1451577600000, end=1451664000000&#125;</span><br></pre></td></tr></table></figure>
<p>没有给我们返回id为1000的商品秒杀地址，是因为我们当前的时间并不在秒杀时间开启之内，所以该商品还没有开启。需要修改数据库中该商品秒杀活动的时间在我们测试时的当前时间之内，然后再进行该方法的测试，控制台中输出如下信息:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exposer&#123;exposed=true, md5=&#x27;bf204e2683e7452aa7db1a50b5713bae&#x27;, seckillId=1000, now=0, start=0, end=0&#125;</span><br></pre></td></tr></table></figure>
<p>可知开启了id为1000的商品的秒杀，并给我们输出了该商品的秒杀地址。而第四个方法的测试就需要传入该地址让用户得到才能判断该用户是否秒杀到该地址的商品，然后进行第四个方法的测试,如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeSeckill</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> seckillId=<span class="number">1000</span>;</span><br><span class="line">    <span class="type">long</span> userPhone=<span class="number">13476191876L</span>;</span><br><span class="line">    String md5=<span class="string">&quot;bf204e2683e7452aa7db1a50b5713bae&quot;</span>;</span><br><span class="line"></span><br><span class="line">    SeckillExecution seckillExecution=seckillService.executeSeckill(seckillId,userPhone,md5);</span><br><span class="line"></span><br><span class="line">    System.out.println(seckillExecution);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>控制台输出信息:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SeckillExecution&#123;seckillId=1000, state=1, stateInfo=&#x27;秒杀成功&#x27;, successKilled=SuccessKilled&#123;seckillId=1000, userPhone=13476191876, state=0, createTime=Mon Nov 28 16:45:38 CST 2016&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>证明电话为13476191876的用户成功秒杀到了该商品，查看数据库，该用户秒杀商品的明细信息已经被插入明细表，说明我们的业务逻辑没有问题。但其实这样写测试方法还有点问题，此时再次执行该方法，控制台报错，因为用户重复秒杀了。我们应该在该测试方法中添加try catch,将程序允许的异常包起来而不去向上抛给junit，更改测试代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeSeckill</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">     <span class="type">long</span> seckillId=<span class="number">1000</span>;</span><br><span class="line">     <span class="type">long</span> userPhone=<span class="number">13476191876L</span>;</span><br><span class="line">     String md5=<span class="string">&quot;bf204e2683e7452aa7db1a50b5713bae&quot;</span>;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="type">SeckillExecution</span> <span class="variable">seckillExecution</span> <span class="operator">=</span> seckillService.executeSeckill(seckillId, userPhone, md5);</span><br><span class="line"></span><br><span class="line">         System.out.println(seckillExecution);</span><br><span class="line">     &#125;<span class="keyword">catch</span> (RepeatKillException e)</span><br><span class="line">     &#123;</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">     &#125;<span class="keyword">catch</span> (SeckillCloseException e1)</span><br><span class="line">     &#123;</span><br><span class="line">         e1.printStackTrace();</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>这样再测试该方法，junit便不会再在控制台中报错，而是认为这是我们系统允许出现的异常。由上分析可知，第四个方法只有拿到了第三个方法暴露的秒杀商品的地址后才能进行测试，也就是说只有在第三个方法运行后才能运行测试第四个方法，而实际开发中我们不是这样的，需要将第三个测试方法和第四个方法合并到一个方法从而组成一个完整的逻辑流程:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span><span class="comment">//完整逻辑代码测试，注意可重复执行</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSeckillLogic</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">long</span> seckillId=<span class="number">1000</span>;</span><br><span class="line">        Exposer exposer=seckillService.exportSeckillUrl(seckillId);</span><br><span class="line">        <span class="keyword">if</span> (exposer.isExposed())</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            System.out.println(exposer);</span><br><span class="line"></span><br><span class="line">            <span class="type">long</span> userPhone=<span class="number">13476191876L</span>;</span><br><span class="line">            String md5=exposer.getMd5();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">SeckillExecution</span> <span class="variable">seckillExecution</span> <span class="operator">=</span> seckillService.executeSeckill(seckillId, userPhone, md5);</span><br><span class="line">                System.out.println(seckillExecution);</span><br><span class="line">            &#125;<span class="keyword">catch</span> (RepeatKillException e)</span><br><span class="line">            &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;<span class="keyword">catch</span> (SeckillCloseException e1)</span><br><span class="line">            &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//秒杀未开启</span></span><br><span class="line">            System.out.println(exposer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>运行该测试类，控制台成功输出信息，库存会减少，明细表也会增加内容。重复执行，控制台不会报错，只是会抛出一个允许的重复秒杀异常。</p>
<h2 id="Web层"><a href="#Web层" class="headerlink" title="Web层"></a>Web层</h2><h3 id="一、前端交互流程设计"><a href="#一、前端交互流程设计" class="headerlink" title="一、前端交互流程设计"></a>一、前端交互流程设计</h3><p>对于一个系统，需要产品经理、前端工程师和后端工程师的参数，产品经理将用户的需求做成一个开发文档交给前端工程师和后端工程师，前端工程师为系统完成页面的开发，后端工程师为系统完成业务逻辑的开发。对于我们这个秒杀系统，它的前端交互流程设计如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">列表页-&gt;详情页-&gt;login-no-&gt;登录操作-&gt;写入cookie-yes-&gt;展示逻辑</span><br><span class="line">                     -yes-&gt;展示逻辑</span><br><span class="line"></span><br><span class="line">获取标准系统时间-&gt;时间判断（开始时间/结束时间）-结束-&gt;秒杀结束</span><br><span class="line">                                               -未开始-&gt;倒计时\</span><br><span class="line">                                               -已开始-------&gt;秒杀地址-&gt;执行秒杀</span><br><span class="line">                                               </span><br></pre></td></tr></table></figure>

<p>这个流程图就告诉了我们详情页的流程逻辑，前端工程师根据这个流程图设计页面，而我们后端工程师根据这个流程图开发我们对应的代码。前端交互流程是系统开发中很重要的一部分，接下来进行Restful接口设计的学习</p>
<h3 id="二、Restful接口设计"><a href="#二、Restful接口设计" class="headerlink" title="二、Restful接口设计"></a>二、Restful接口设计</h3><p>什么是Restful:</p>
<pre><code>1、很早以前就已经出现的的一个设计理念，真正被发扬广大是通过Ruby on Rails这个框架，他的设计规范里边就非常友好的去把hb,最前端的内个url如何表示、如何提交形成了一个规范，那么这个规范那就是restful。

2、本质上是一个优雅的URL表述方式。

3、他的意义就是他是一种资源的状态或者是状态转移，比如说当我们要去查询一个列表页的时候，其实他就要看这个资源，列表页的状态，我们用get请求去表述；当我们要去查询详情页的时候，也是详情页这个资源的一个状态；当我们要删除一个秒杀或者修改一个相关的操作的时候就涉及到状态的转移，这时候我们需要用到put或者 post这样的方式提交。
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/模块/资源/&#123;标示&#125;/集合1</span><br></pre></td></tr></table></figure>

<h3 id="三、SpringMVC"><a href="#三、SpringMVC" class="headerlink" title="三、SpringMVC"></a>三、SpringMVC</h3><h4 id="SpringMVC理论"><a href="#SpringMVC理论" class="headerlink" title="SpringMVC理论"></a>SpringMVC理论</h4><p>运行流程如下</p>
<p><img src="C:\Users\86187\AppData\Roaming\Typora\typora-user-images\image-20200624090352357.png" alt="image-20200624090352357"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> 1、首先用户会发送一个请求，所有的请求都会映射到DispatcherServlet(中央控制器，SpringMVC的核心)，这个servlet会拦截所有的请求，</span><br><span class="line"></span><br><span class="line">2、默认会用到DefaultAnnotation HandlerMapping，这个的作用是用来映射我们的URL,具体就是我们的内一个URL对应到我们的内个Handler。</span><br><span class="line"></span><br><span class="line">3、映射完了之后那，会默认用到DefaultAnnotation HandlerAdapter，这个的目的那是做handler适配，</span><br><span class="line"></span><br><span class="line">4、然后会衔接到我们的controller。如果其中用到intercept（拦截器）的话他也会把拦截器绑定到我们的流程当中。</span><br><span class="line"></span><br><span class="line">5、最终他的产出就是 ModelAndView,view可以理解成jsp页面，同时他会交付到中央处理器DispatchServlet当中。</span><br><span class="line"></span><br><span class="line">6、他会发现你应用的是一个InternalResource ViewResolver,这个就是默认的jsp的一个view。</span><br><span class="line"></span><br><span class="line">7、他就会把我们的Model和jsp页面相结合，最终返回给我们的用户。</span><br><span class="line"></span><br><span class="line">如果你输出的是json的话，把jsp换成json就可以了。 </span><br></pre></td></tr></table></figure>



<p><strong>HTTP请求地质映射原理</strong></p>
<p><img src="C:\Users\86187\AppData\Roaming\Typora\typora-user-images\image-20200624091145089.png" alt="image-20200624091145089"></p>
<p><strong>注解映射技巧</strong></p>
<p><img src="C:\Users\86187\AppData\Roaming\Typora\typora-user-images\image-20200624091544482.png" alt="image-20200624091544482"></p>
<p><strong>请求方法细节处理</strong></p>
<p><img src="C:\Users\86187\AppData\Roaming\Typora\typora-user-images\image-20200624091715790.png" alt="image-20200624091715790"></p>
<p><img src="C:\Users\86187\AppData\Roaming\Typora\typora-user-images\image-20200624091922286.png" alt="image-20200624091922286"></p>
<p><img src="C:\Users\86187\AppData\Roaming\Typora\typora-user-images\image-20200624092009114.png" alt="image-20200624092009114"></p>
<h4 id="配置SpringMVC"><a href="#配置SpringMVC" class="headerlink" title="配置SpringMVC"></a>配置SpringMVC</h4><p>首先在WEB-INF的web.xml中进行我们前端控制器DispatcherServlet的配置，如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;web-app xmlns=<span class="string">&quot;http://java.sun.com/xml/ns/javaee&quot;</span></span><br><span class="line">         xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">         xsi:schemaLocation=<span class="string">&quot;http://java.sun.com/xml/ns/javaee</span></span><br><span class="line"><span class="string">                      http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span></span><br><span class="line">         version=<span class="string">&quot;3.0&quot;</span></span><br><span class="line">         metadata-complete=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line">&lt;!--用maven创建的web-app需要修改servlet的版本为<span class="number">3.1</span>--&gt;</span><br><span class="line">&lt;!--配置DispatcherServlet--&gt;</span><br><span class="line">    &lt;servlet&gt;</span><br><span class="line">        &lt;servlet-name&gt;seckill-dispatcher&lt;/servlet-name&gt;</span><br><span class="line">        &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt;</span><br><span class="line">        &lt;!--</span><br><span class="line">            配置SpringMVC 需要配置的文件</span><br><span class="line">            spring-dao.xml，spring-service.xml,spring-web.xml</span><br><span class="line">            Mybatis -&gt; spring -&gt; springMvc</span><br><span class="line">        --&gt;</span><br><span class="line">        &lt;init-param&gt;</span><br><span class="line">            &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;</span><br><span class="line">            &lt;param-value&gt;classpath:spring/spring-*.xml&lt;/param-value&gt;</span><br><span class="line">        &lt;/init-param&gt;</span><br><span class="line">    &lt;/servlet&gt;</span><br><span class="line">    &lt;servlet-mapping&gt;</span><br><span class="line">        &lt;servlet-name&gt;seckill-dispatcher&lt;/servlet-name&gt;</span><br><span class="line">        &lt;!--默认匹配所有请求--&gt;</span><br><span class="line">        &lt;url-pattern&gt;/&lt;/url-pattern&gt;</span><br><span class="line">    &lt;/servlet-mapping&gt;</span><br><span class="line">&lt;/web-app&gt;</span><br></pre></td></tr></table></figure>

<p>然后在spring容器中进行web层相关bean(即Controller)的配置，在spring包下创建一个spring-web.xml，内容如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xmlns:context=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="line">       xmlns:mvc=<span class="string">&quot;http://www.springframework.org/schema/mvc&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/context </span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/context/spring-context.xsd</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/mvc </span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/mvc/spring-mvc.xsd&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--配置spring mvc--&gt;</span><br><span class="line">    &lt;!--<span class="number">1</span>,开启springmvc注解模式</span><br><span class="line">    a.自动注册DefaultAnnotationHandlerMapping,AnnotationMethodHandlerAdapter</span><br><span class="line">    b.默认提供一系列的功能:数据绑定，数字和日期的format<span class="meta">@NumberFormat</span>,<span class="meta">@DateTimeFormat</span></span><br><span class="line">    c:xml,json的默认读写支持--&gt;</span><br><span class="line">    &lt;mvc:annotation-driven/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--<span class="number">2.</span>静态资源默认servlet配置--&gt;</span><br><span class="line">    &lt;!--</span><br><span class="line">        <span class="number">1</span>).加入对静态资源处理：js,gif,png</span><br><span class="line">        <span class="number">2</span>).允许使用 <span class="string">&quot;/&quot;</span> 做整体映射</span><br><span class="line">    --&gt;</span><br><span class="line">    &lt;mvc:<span class="keyword">default</span>-servlet-handler/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--<span class="number">3</span>：配置JSP 显示ViewResolver--&gt;</span><br><span class="line">    &lt;bean class=<span class="string">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span>&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;viewClass&quot;</span> value=<span class="string">&quot;org.springframework.web.servlet.view.JstlView&quot;</span>/&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;prefix&quot;</span> value=<span class="string">&quot;/WEB-INF/jsp/&quot;</span>/&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;suffix&quot;</span> value=<span class="string">&quot;.jsp&quot;</span>/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--<span class="number">4</span>:扫描web相关的bean--&gt;</span><br><span class="line">    &lt;context:component-scan base-<span class="keyword">package</span>=<span class="string">&quot;cn.codingxiaxw.web&quot;</span>/&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>

<p>这样我们便完成了Spring MVC的相关配置(即将Spring MVC框架整合到了我们的项目中)，接下来就要基于Restful接口进行我们项目的Controller开发工作了。</p>
<h3 id="三、Contreller开发"><a href="#三、Contreller开发" class="headerlink" title="三、Contreller开发"></a>三、Contreller开发</h3><p>Controller中的每一个方法都对应我们系统中的一个资源URL，其设计应该遵循Restful接口的设计风格。在cn.codingxiaxw包下创建一个web包用于放web层Controller开发的代码，在该包下创建一个SeckillController.java，内容如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/seckill&quot;)</span><span class="comment">//url:模块/资源/&#123;&#125;/细分</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeckillController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SeckillService seckillService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/list&quot;,method = RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">list</span><span class="params">(Model model)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//list.jsp+mode=ModelAndView</span></span><br><span class="line">        <span class="comment">//获取列表页</span></span><br><span class="line">        List&lt;Seckill&gt; list=seckillService.getSeckillList();</span><br><span class="line">        model.addAttribute(<span class="string">&quot;list&quot;</span>,list);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;list&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/&#123;seckillId&#125;/detail&quot;,method = RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">detail</span><span class="params">(<span class="meta">@PathVariable(&quot;seckillId&quot;)</span> Long seckillId, Model model)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (seckillId == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;redirect:/seckill/list&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Seckill seckill=seckillService.getById(seckillId);</span><br><span class="line">        <span class="keyword">if</span> (seckill==<span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;forward:/seckill/list&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        model.addAttribute(<span class="string">&quot;seckill&quot;</span>,seckill);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;detail&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ajax ,json暴露秒杀接口的方法</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/&#123;seckillId&#125;/exposer&quot;,</span></span><br><span class="line"><span class="meta">                    method = RequestMethod.POST,</span></span><br><span class="line"><span class="meta">                    produces = &#123;&quot;application/json;charset=UTF-8&quot;&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> SeckillResult&lt;Exposer&gt; <span class="title function_">exposer</span><span class="params">(Long seckillId)</span></span><br><span class="line">    &#123;</span><br><span class="line">        SeckillResult&lt;Exposer&gt; result;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Exposer exposer=seckillService.exportSeckillUrl(seckillId);</span><br><span class="line">            result=<span class="keyword">new</span> <span class="title class_">SeckillResult</span>&lt;Exposer&gt;(<span class="literal">true</span>,exposer);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            result=<span class="keyword">new</span> <span class="title class_">SeckillResult</span>&lt;Exposer&gt;(<span class="literal">false</span>,e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">     <span class="meta">@RequestMapping(value = &quot;/&#123;seckillId&#125;/&#123;md5&#125;/execution&quot;,</span></span><br><span class="line"><span class="meta">            method = RequestMethod.POST,</span></span><br><span class="line"><span class="meta">            produces = &#123;&quot;application/json;charset=UTF-8&quot;&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> SeckillResult&lt;SeckillExecution&gt; <span class="title function_">execute</span><span class="params">(<span class="meta">@PathVariable(&quot;seckillId&quot;)</span> Long seckillId,</span></span><br><span class="line"><span class="params">                                                   <span class="meta">@PathVariable(&quot;md5&quot;)</span> String md5,</span></span><br><span class="line"><span class="params">                                                   <span class="meta">@CookieValue(value = &quot;killPhone&quot;,required = false)</span> Long phone)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (phone==<span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SeckillResult</span>&lt;SeckillExecution&gt;(<span class="literal">false</span>,<span class="string">&quot;未注册&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        SeckillResult&lt;SeckillExecution&gt; result;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">SeckillExecution</span> <span class="variable">execution</span> <span class="operator">=</span> seckillService.executeSeckill(seckillId, phone, md5);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SeckillResult</span>&lt;SeckillExecution&gt;(<span class="literal">true</span>, execution);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (RepeatKillException e1)</span><br><span class="line">        &#123;</span><br><span class="line">            SeckillExecution execution=<span class="keyword">new</span> <span class="title class_">SeckillExecution</span>(seckillId, SeckillStatEnum.REPEAT_KILL);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SeckillResult</span>&lt;SeckillExecution&gt;(<span class="literal">false</span>,execution);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (SeckillCloseException e2)</span><br><span class="line">        &#123;</span><br><span class="line">            SeckillExecution execution=<span class="keyword">new</span> <span class="title class_">SeckillExecution</span>(seckillId, SeckillStatEnum.END);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SeckillResult</span>&lt;SeckillExecution&gt;(<span class="literal">false</span>,execution);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            SeckillExecution execution=<span class="keyword">new</span> <span class="title class_">SeckillExecution</span>(seckillId, SeckillStatEnum.INNER_ERROR);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SeckillResult</span>&lt;SeckillExecution&gt;(<span class="literal">false</span>,execution);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取系统时间</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/time/now&quot;,method = RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> SeckillResult&lt;Long&gt; <span class="title function_">time</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Date now=<span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SeckillResult</span>&lt;Long&gt;(<span class="literal">true</span>,now.getTime());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Controller开发中的方法完全是对照Service接口方法进行开发的，第一个方法用于访问我们商品的列表页，第二个方法访问商品的详情页，第三个方法用于返回一个json数据，数据中封装了我们商品的秒杀地址，第四个方法用于封装用户是否秒杀成功的信息，第五个方法用于返回系统当前时间。代码中涉及到一个将返回秒杀商品地址封装为json数据的一个Vo类，即SeckillResult.java，在dto包中创建它，内容如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将所有的ajax请求返回类型，全部封装成json数据</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeckillResult</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> success;</span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line">    <span class="keyword">private</span> String error;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SeckillResult</span><span class="params">(<span class="type">boolean</span> success, T data)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.success = success;</span><br><span class="line">        <span class="built_in">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SeckillResult</span><span class="params">(<span class="type">boolean</span> success, String error)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.success = success;</span><br><span class="line">        <span class="built_in">this</span>.error = error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isSuccess</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSuccess</span><span class="params">(<span class="type">boolean</span> success)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.success = success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">getData</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setData</span><span class="params">(T data)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getError</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setError</span><span class="params">(String error)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.error = error;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到此，Controller的开发任务完成，接下来进行我们的页面开发。</p>
<h3 id="四、页面开发"><a href="#四、页面开发" class="headerlink" title="四、页面开发"></a>四、页面开发</h3><p>新建Jsp包，使用Bootstrap进行开发即可</p>
<p><img src="C:\Users\86187\AppData\Roaming\Typora\typora-user-images\image-20200624105135131.png" alt="image-20200624105135131"></p>
<p><img src="C:\Users\86187\AppData\Roaming\Typora\typora-user-images\image-20200624105047625.png" alt="image-20200624105047625">·</p>
<p><img src="C:\Users\86187\AppData\Roaming\Typora\typora-user-images\image-20200624105004600.png" alt="image-20200624105004600"></p>
<p><img src="C:\Users\86187\AppData\Roaming\Typora\typora-user-images\image-20200624105022654.png" alt="image-20200624105022654"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//存放主要交互逻辑的js代码</span></span><br><span class="line"><span class="comment">// javascript 模块化(package.类.方法)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> seckill = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装秒杀相关ajax的url</span></span><br><span class="line">    <span class="attr">URL</span>: &#123;</span><br><span class="line">        <span class="attr">now</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;/seckill/time/now&#x27;</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">exposer</span>: <span class="keyword">function</span> (<span class="params">seckillId</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;/seckill/&#x27;</span> + seckillId + <span class="string">&#x27;/exposer&#x27;</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">execution</span>: <span class="keyword">function</span> (<span class="params">seckillId, md5</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;/seckill/&#x27;</span> + seckillId + <span class="string">&#x27;/&#x27;</span> + md5 + <span class="string">&#x27;/execution&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//验证手机号</span></span><br><span class="line">    <span class="attr">validatePhone</span>: <span class="keyword">function</span> (<span class="params">phone</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (phone &amp;&amp; phone.<span class="property">length</span> == <span class="number">11</span> &amp;&amp; !<span class="built_in">isNaN</span>(phone)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;<span class="comment">//直接判断对象会看对象是否为空,空就是undefine就是false; isNaN 非数字返回true</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//详情页秒杀逻辑</span></span><br><span class="line">    <span class="attr">detail</span>: &#123;</span><br><span class="line">        <span class="comment">//详情页初始化</span></span><br><span class="line">        <span class="attr">init</span>: <span class="keyword">function</span> (<span class="params">params</span>) &#123;</span><br><span class="line">            <span class="comment">//手机验证和登录,计时交互</span></span><br><span class="line">            <span class="comment">//规划我们的交互流程</span></span><br><span class="line">            <span class="comment">//在cookie中查找手机号</span></span><br><span class="line">            <span class="keyword">var</span> userPhone = $.<span class="title function_">cookie</span>(<span class="string">&#x27;userPhone&#x27;</span>);</span><br><span class="line">            <span class="comment">//验证手机号</span></span><br><span class="line">            <span class="keyword">if</span> (!seckill.<span class="title function_">validatePhone</span>(userPhone)) &#123;</span><br><span class="line">                <span class="comment">//绑定手机 控制输出</span></span><br><span class="line">                <span class="keyword">var</span> killPhoneModal = $(<span class="string">&#x27;#killPhoneModal&#x27;</span>);</span><br><span class="line">                killPhoneModal.<span class="title function_">modal</span>(&#123;</span><br><span class="line">                    <span class="attr">show</span>: <span class="literal">true</span>,<span class="comment">//显示弹出层</span></span><br><span class="line">                    <span class="attr">backdrop</span>: <span class="string">&#x27;static&#x27;</span>,<span class="comment">//禁止位置关闭</span></span><br><span class="line">                    <span class="attr">keyboard</span>: <span class="literal">false</span><span class="comment">//关闭键盘事件</span></span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">                $(<span class="string">&#x27;#killPhoneBtn&#x27;</span>).<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> inputPhone = $(<span class="string">&#x27;#killPhoneKey&#x27;</span>).<span class="title function_">val</span>();</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;inputPhone: &quot;</span> + inputPhone);</span><br><span class="line">                    <span class="keyword">if</span> (seckill.<span class="title function_">validatePhone</span>(inputPhone)) &#123;</span><br><span class="line">                        <span class="comment">//电话写入cookie(7天过期)</span></span><br><span class="line">                        $.<span class="title function_">cookie</span>(<span class="string">&#x27;userPhone&#x27;</span>, inputPhone, &#123;<span class="attr">expires</span>: <span class="number">7</span>, <span class="attr">path</span>: <span class="string">&#x27;/seckill&#x27;</span>&#125;);</span><br><span class="line">                        <span class="comment">//验证通过　　刷新页面</span></span><br><span class="line">                        <span class="variable language_">window</span>.<span class="property">location</span>.<span class="title function_">reload</span>();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">//todo 错误文案信息抽取到前端字典里</span></span><br><span class="line">                        $(<span class="string">&#x27;#killPhoneMessage&#x27;</span>).<span class="title function_">hide</span>().<span class="title function_">html</span>(<span class="string">&#x27;&lt;label class=&quot;label label-danger&quot;&gt;手机号错误!&lt;/label&gt;&#x27;</span>).<span class="title function_">show</span>(<span class="number">300</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//已经登录</span></span><br><span class="line">            <span class="comment">//计时交互</span></span><br><span class="line">            <span class="keyword">var</span> startTime = params[<span class="string">&#x27;startTime&#x27;</span>];</span><br><span class="line">            <span class="keyword">var</span> endTime = params[<span class="string">&#x27;endTime&#x27;</span>];</span><br><span class="line">            <span class="keyword">var</span> seckillId = params[<span class="string">&#x27;seckillId&#x27;</span>];</span><br><span class="line">            $.<span class="title function_">get</span>(seckill.<span class="property">URL</span>.<span class="title function_">now</span>(), &#123;&#125;, <span class="keyword">function</span> (<span class="params">result</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (result &amp;&amp; result[<span class="string">&#x27;success&#x27;</span>]) &#123;</span><br><span class="line">                    <span class="keyword">var</span> nowTime = result[<span class="string">&#x27;data&#x27;</span>];</span><br><span class="line">                    <span class="comment">//时间判断 计时交互</span></span><br><span class="line">                    seckill.<span class="title function_">countDown</span>(seckillId, nowTime, startTime, endTime);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;result: &#x27;</span> + result);</span><br><span class="line">                    <span class="title function_">alert</span>(<span class="string">&#x27;result: &#x27;</span> + result);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="attr">handlerSeckill</span>: <span class="keyword">function</span> (<span class="params">seckillId, node</span>) &#123;</span><br><span class="line">        <span class="comment">//获取秒杀地址,控制显示器,执行秒杀</span></span><br><span class="line">        node.<span class="title function_">hide</span>().<span class="title function_">html</span>(<span class="string">&#x27;&lt;button class=&quot;btn btn-primary btn-lg&quot; id=&quot;killBtn&quot;&gt;开始秒杀&lt;/button&gt;&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        $.<span class="title function_">get</span>(seckill.<span class="property">URL</span>.<span class="title function_">exposer</span>(seckillId), &#123;&#125;, <span class="keyword">function</span> (<span class="params">result</span>) &#123;</span><br><span class="line">            <span class="comment">//在回调函数种执行交互流程</span></span><br><span class="line">            <span class="keyword">if</span> (result &amp;&amp; result[<span class="string">&#x27;success&#x27;</span>]) &#123;</span><br><span class="line">                <span class="keyword">var</span> exposer = result[<span class="string">&#x27;data&#x27;</span>];</span><br><span class="line">                <span class="keyword">if</span> (exposer[<span class="string">&#x27;exposed&#x27;</span>]) &#123;</span><br><span class="line">                    <span class="comment">//开启秒杀</span></span><br><span class="line">                    <span class="comment">//获取秒杀地址</span></span><br><span class="line">                    <span class="keyword">var</span> md5 = exposer[<span class="string">&#x27;md5&#x27;</span>];</span><br><span class="line">                    <span class="keyword">var</span> killUrl = seckill.<span class="property">URL</span>.<span class="title function_">execution</span>(seckillId, md5);</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;killUrl: &quot;</span> + killUrl);</span><br><span class="line">                    <span class="comment">//绑定一次点击事件</span></span><br><span class="line">                    $(<span class="string">&#x27;#killBtn&#x27;</span>).<span class="title function_">one</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">                        <span class="comment">//执行秒杀请求</span></span><br><span class="line">                        <span class="comment">//1.先禁用按钮</span></span><br><span class="line">                        $(<span class="variable language_">this</span>).<span class="title function_">addClass</span>(<span class="string">&#x27;disabled&#x27;</span>);<span class="comment">//,&lt;-$(this)===(&#x27;#killBtn&#x27;)-&gt;</span></span><br><span class="line">                        <span class="comment">//2.发送秒杀请求执行秒杀</span></span><br><span class="line">                        $.<span class="title function_">post</span>(killUrl, &#123;&#125;, <span class="keyword">function</span> (<span class="params">result</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (result &amp;&amp; result[<span class="string">&#x27;success&#x27;</span>]) &#123;</span><br><span class="line">                                <span class="keyword">var</span> killResult = result[<span class="string">&#x27;data&#x27;</span>];</span><br><span class="line">                                <span class="keyword">var</span> state = killResult[<span class="string">&#x27;state&#x27;</span>];</span><br><span class="line">                                <span class="keyword">var</span> stateInfo = killResult[<span class="string">&#x27;stateInfo&#x27;</span>];</span><br><span class="line">                                <span class="comment">//显示秒杀结果</span></span><br><span class="line">                                node.<span class="title function_">html</span>(<span class="string">&#x27;&lt;span class=&quot;label label-success&quot;&gt;&#x27;</span> + stateInfo + <span class="string">&#x27;&lt;/span&gt;&#x27;</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;);</span><br><span class="line">                    node.<span class="title function_">show</span>();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//未开启秒杀(浏览器计时偏差)</span></span><br><span class="line">                    <span class="keyword">var</span> now = exposer[<span class="string">&#x27;now&#x27;</span>];</span><br><span class="line">                    <span class="keyword">var</span> start = exposer[<span class="string">&#x27;start&#x27;</span>];</span><br><span class="line">                    <span class="keyword">var</span> end = exposer[<span class="string">&#x27;end&#x27;</span>];</span><br><span class="line">                    seckill.<span class="title function_">countDown</span>(seckillId, now, start, end);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;result: &#x27;</span> + result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="attr">countDown</span>: <span class="keyword">function</span> (<span class="params">seckillId, nowTime, startTime, endTime</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(seckillId + <span class="string">&#x27;_&#x27;</span> + nowTime + <span class="string">&#x27;_&#x27;</span> + startTime + <span class="string">&#x27;_&#x27;</span> + endTime);</span><br><span class="line">        <span class="keyword">var</span> seckillBox = $(<span class="string">&#x27;#seckill-box&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (nowTime &gt; endTime) &#123;</span><br><span class="line">            <span class="comment">//秒杀结束</span></span><br><span class="line">            seckillBox.<span class="title function_">html</span>(<span class="string">&#x27;秒杀结束!&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nowTime &lt; startTime) &#123;</span><br><span class="line">            <span class="comment">//秒杀未开始,计时事件绑定</span></span><br><span class="line">            <span class="keyword">var</span> killTime = <span class="keyword">new</span> <span class="title class_">Date</span>(startTime + <span class="number">1000</span>);<span class="comment">//todo 防止时间偏移</span></span><br><span class="line">            seckillBox.<span class="title function_">countdown</span>(killTime, <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span><br><span class="line">                <span class="comment">//时间格式</span></span><br><span class="line">                <span class="keyword">var</span> format = event.<span class="title function_">strftime</span>(<span class="string">&#x27;秒杀倒计时: %D天 %H时 %M分 %S秒 &#x27;</span>);</span><br><span class="line">                seckillBox.<span class="title function_">html</span>(format);</span><br><span class="line">            &#125;).<span class="title function_">on</span>(<span class="string">&#x27;finish.countdown&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">                <span class="comment">//时间完成后回调事件</span></span><br><span class="line">                <span class="comment">//获取秒杀地址,控制现实逻辑,执行秒杀</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;______fininsh.countdown&#x27;</span>);</span><br><span class="line">                seckill.<span class="title function_">handlerSeckill</span>(seckillId, seckillBox);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//秒杀开始</span></span><br><span class="line">            seckill.<span class="title function_">handlerSeckill</span>(seckillId, seckillBox);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="高并发优化"><a href="#高并发优化" class="headerlink" title="高并发优化"></a>高并发优化</h2><h3 id="一、高并发优化分析"><a href="#一、高并发优化分析" class="headerlink" title="一、高并发优化分析"></a>一、高并发优化分析</h3><p><strong>CDN</strong></p>
<p><img src="D:\ZJU\Notebook\Java\5de0cb5200018d5105000321.jpg" alt="http://img1.sycdn.imooc.com/5de0cb5200018d5108040516.jpg"></p>
<p>CDN只能缓存url固定的资源：</p>
<ul>
<li>秒杀地址是变化的，无法用CDN进行缓存</li>
<li>大部分写操作和最核心的数据的请求，无法用CDN</li>
</ul>
<p>不能在缓存里减库存，因为并发，会有不一致的问题</p>
<p>——&gt;通过mysql的事务来保证数据的一致性；</p>
<p>难点：一瞬间大量用户参与热门商品竞争，MySQL一行数据会有大量竞争，有大量的updata减库存竞争</p>
<p><img src="C:\Users\86187\AppData\Roaming\Typora\typora-user-images\image-20200628101808334.png" alt="image-20200628101808334"></p>
<p>上图使用的方案的缺点：运维成本和稳定性、开发成本、幂等性（重复秒杀问题）、不适合新手</p>
<p><strong>瓶颈分析</strong></p>
<p><img src="C:\Users\86187\AppData\Roaming\Typora\typora-user-images\image-20200628102330027.png" alt="image-20200628102330027"></p>
<p><strong>优化：</strong></p>
<p>前端： 动静态数据做分离，减少请求与响应时间；按钮防重复，防止用户发送无效的重复请求，因为秒杀活动一般都会有购买数量的限制，敲的次数再多，最后还是要查看是否已购。影响了效率，可有前端代为处理并优化</p>
<p>后端：使用CDN换存重要的静态资源等；在后端对活动结束时间、商品选购时间、业务的相关逻辑要求都放在后端代码中，并调用缓存来进行暂存，已减少对DB的直接操作，提高效率</p>
<p><img src="C:\Users\86187\AppData\Roaming\Typora\typora-user-images\image-20200702095239456.png" alt="image-20200702095239456"></p>
<p>  1,前端控制触发次数，比如限制控制按钮的触发</p>
<p>  2,使用CDN和缓存机制达到动静分离</p>
<p>  3,减少行级锁和GC的时间，将事物控制在mysql中进行，比如存储过程</p>
<h3 id="二、redis后端缓存优化编码"><a href="#二、redis后端缓存优化编码" class="headerlink" title="二、redis后端缓存优化编码"></a>二、redis后端缓存优化编码</h3><p>后端缓存流程：先在pom文件中引入相关redis依赖，java一般通过jedis来访问redis，然后创建一个redisDao的类，写入jedispool，从jedispool中获取到jedis对象。主要是在写两个方法，一个是从redis中get对象，另一个是向jedis中存入对象，因为redis并没有实现自动序列化功能，所以实际put对象的时候是将数据库中取到的对象序列化成二级制数组，然后根据对象类的反射得到的scheme序列化对象并存到redis中。同样redis取出对象的时候取到的是一个二进制数组，需要根据scheme和一个空对象将二进制数组转换成相应的对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by codingBoy on 17/2/17.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisDao</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JedisPool jedisPool;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisDao</span><span class="params">(String ip, <span class="type">int</span> port)</span> &#123;</span><br><span class="line">        jedisPool = <span class="keyword">new</span> <span class="title class_">JedisPool</span>(ip, port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RuntimeSchema&lt;Seckill&gt; schema = RuntimeSchema.createFrom(Seckill.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Seckill <span class="title function_">getSeckill</span><span class="params">(<span class="type">long</span> seckillId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getSeckill(seckillId, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从redis获取信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 如果不存在，则返回null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Seckill <span class="title function_">getSeckill</span><span class="params">(<span class="type">long</span> seckillId, Jedis jedis)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">hasJedis</span> <span class="operator">=</span> jedis != <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">//redis操作逻辑</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!hasJedis) &#123;</span><br><span class="line">                jedis = jedisPool.getResource();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> getSeckillRedisKey(seckillId);</span><br><span class="line">                <span class="comment">//并没有实现哪部序列化操作</span></span><br><span class="line">                <span class="comment">//采用自定义序列化</span></span><br><span class="line">                <span class="comment">//protostuff: pojo.</span></span><br><span class="line">                <span class="type">byte</span>[] bytes = jedis.get(key.getBytes());</span><br><span class="line">                <span class="comment">//缓存重获取到</span></span><br><span class="line">                <span class="keyword">if</span> (bytes != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">Seckill</span> <span class="variable">seckill</span> <span class="operator">=</span> schema.newMessage();</span><br><span class="line">                    ProtostuffIOUtil.mergeFrom(bytes, seckill, schema);</span><br><span class="line">                    <span class="comment">//seckill被反序列化</span></span><br><span class="line">                    <span class="keyword">return</span> seckill;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!hasJedis) &#123;</span><br><span class="line">                    jedis.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从缓存获取，如果没有，则从数据库获取</span></span><br><span class="line"><span class="comment">     * 会用到分布式锁</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId     id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> getDataFromDb 从数据库获取的方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回商品信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Seckill <span class="title function_">getOrPutSeckill</span><span class="params">(<span class="type">long</span> seckillId, Function&lt;Long, Seckill&gt; getDataFromDb)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> <span class="string">&quot;seckill:locks:getSeckill:&quot;</span> + seckillId;</span><br><span class="line">        <span class="type">String</span> <span class="variable">lockRequestId</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> jedisPool.getResource();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 循环直到获取到数据</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">Seckill</span> <span class="variable">seckill</span> <span class="operator">=</span> getSeckill(seckillId, jedis);</span><br><span class="line">                <span class="keyword">if</span> (seckill != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> seckill;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 尝试获取锁。</span></span><br><span class="line">                <span class="comment">// 锁过期时间是防止程序突然崩溃来不及解锁，而造成其他线程不能获取锁的问题。过期时间是业务容忍最长时间。</span></span><br><span class="line">                <span class="type">boolean</span> <span class="variable">getLock</span> <span class="operator">=</span> JedisUtils.tryGetDistributedLock(jedis, lockKey, lockRequestId, <span class="number">1000</span>);</span><br><span class="line">                <span class="keyword">if</span> (getLock) &#123;</span><br><span class="line">                    <span class="comment">// 获取到锁，从数据库拿数据, 然后存redis</span></span><br><span class="line">                    seckill = getDataFromDb.apply(seckillId);</span><br><span class="line">                    putSeckill(seckill, jedis);</span><br><span class="line">                    <span class="keyword">return</span> seckill;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 获取不到锁，睡一下，等会再出发。sleep的时间需要斟酌，主要看业务处理速度</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException ignored) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ignored) &#123;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 无论如何，最后要去解锁</span></span><br><span class="line">            JedisUtils.releaseDistributedLock(jedis, lockKey, lockRequestId);</span><br><span class="line">            jedis.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id获取redis的key</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId 商品id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> redis的key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getSeckillRedisKey</span><span class="params">(<span class="type">long</span> seckillId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;seckill:&quot;</span> + seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">putSeckill</span><span class="params">(Seckill seckill)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> putSeckill(seckill, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">putSeckill</span><span class="params">(Seckill seckill, Jedis jedis)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">hasJedis</span> <span class="operator">=</span> jedis != <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!hasJedis) &#123;</span><br><span class="line">                jedis = jedisPool.getResource();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> getSeckillRedisKey(seckill.getSeckillId());</span><br><span class="line">                <span class="type">byte</span>[] bytes = ProtostuffIOUtil.toByteArray(seckill, schema,</span><br><span class="line">                        LinkedBuffer.allocate(LinkedBuffer.DEFAULT_BUFFER_SIZE));</span><br><span class="line">                <span class="comment">//超时缓存，1小时</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">timeout</span> <span class="operator">=</span> <span class="number">60</span> * <span class="number">60</span>;</span><br><span class="line">                <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> jedis.setex(key.getBytes(), timeout, bytes);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!hasJedis) &#123;</span><br><span class="line">                    jedis.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="三、并发优化"><a href="#三、并发优化" class="headerlink" title="三、并发优化"></a>三、并发优化</h3><p><img src="C:\Users\86187\AppData\Roaming\Typora\typora-user-images\image-20200702103739378.png" alt="image-20200702103739378"></p>
<p><img src="C:\Users\86187\AppData\Roaming\Typora\typora-user-images\image-20200702103807647.png" alt="image-20200702103807647"></p>
<p>insert和update代码调换顺序的原因:insert不涉及到行级锁的竞争，所以可以放在前面执行其实降低了一半的行级锁持有时间，因为行级锁的开始时间是从update语句开始的。同时不用担心insert会先插入大量数据，因为insert和update是控制在一个事务当中的，只有update成功后insert才会真正的插入一条数据。</p>
<p>利用存储过程将执行秒杀的一条事务逻辑放到mysql服务端去执行，减少了客户端和服务端之间的延迟和gc时间，客户端只需要传入参数执行存储过程并根据得到的返回结果做相应的逻辑处理。存储过程比较适合于简单的逻辑。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 秒杀执行存储过程</span></span><br><span class="line">DELIMITER $$ </span><br><span class="line"><span class="comment">--console ; 转换为 $$ 作为结束执行语句的标志</span></span><br><span class="line"><span class="comment">-- 定义存储过程</span></span><br><span class="line"><span class="comment">-- 参数：in 输入参数；out 输出参数</span></span><br><span class="line"><span class="comment">-- row_count();返回上一条修改类型sql(delete,insert,update)的影响行数</span></span><br><span class="line"><span class="comment">-- row_count:return 0:未修改数据 &gt;0:表示修改的行数 &lt;0：sql错误/未执行修改sql</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> <span class="string">&#x27;seckill&#x27;</span>.<span class="string">&#x27;execute_seckill&#x27;</span></span><br><span class="line">(<span class="keyword">in</span> v_seckill <span class="type">bigint</span>, <span class="keyword">in</span> v_phone <span class="type">bigint</span>, <span class="keyword">in</span> v_kill_time <span class="type">timestamp</span>, <span class="keyword">out</span> r_result <span class="type">int</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">DECLARE</span> insert_count <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">START</span> TRANSANCTION;</span><br><span class="line">	<span class="keyword">insert</span> ignore <span class="keyword">into</span> success_killed</span><br><span class="line">		(seckill_id,user_phone,create_time)</span><br><span class="line">		<span class="keyword">values</span>(v_seckill_id,v_phone,v_kill_time);</span><br><span class="line">	<span class="keyword">select</span> row_count() <span class="keyword">into</span> insert_count;</span><br><span class="line">	IF (insert_count <span class="operator">=</span> <span class="number">0</span>) <span class="keyword">THEN</span></span><br><span class="line">    	<span class="keyword">ROLLBACK</span>;</span><br><span class="line">    	<span class="keyword">set</span> r_result <span class="operator">=</span> <span class="number">-1</span>;</span><br><span class="line">    ELSEIF(insert_count <span class="operator">&lt;</span> <span class="number">0</span>) <span class="keyword">THEN</span></span><br><span class="line">    	<span class="keyword">ROLLBACK</span>;</span><br><span class="line">    	<span class="keyword">set</span> r_result <span class="operator">=</span> <span class="number">-2</span>;</span><br><span class="line">    <span class="keyword">ELSE</span></span><br><span class="line">    	<span class="keyword">update</span> seckill</span><br><span class="line">    	<span class="keyword">set</span> number <span class="operator">=</span> number<span class="number">-1</span></span><br><span class="line">    	<span class="keyword">where</span> seckill_id <span class="operator">=</span> v_seckill_id</span><br><span class="line">    	  <span class="keyword">and</span> end_time <span class="operator">&gt;</span> v_kill_time</span><br><span class="line">    	  <span class="keyword">and</span> start_time <span class="operator">&lt;</span> v_kill_time</span><br><span class="line">    	  <span class="keyword">and</span> number <span class="operator">&gt;</span> <span class="number">0</span>;</span><br><span class="line">    	<span class="keyword">select</span> row_count() <span class="keyword">into</span> insert_count;</span><br><span class="line">    	IF (insert_count <span class="operator">=</span> <span class="number">0</span>) <span class="keyword">THEN</span></span><br><span class="line">    		<span class="keyword">ROLLBACK</span>;</span><br><span class="line">    		<span class="keyword">SET</span> r_result <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    	ELSEIF (insert_count <span class="operator">&lt;</span> <span class="number">0</span>) <span class="keyword">THEN</span></span><br><span class="line">        	<span class="keyword">ROLLBACK</span>;</span><br><span class="line">        	<span class="keyword">set</span> r_result <span class="operator">=</span> <span class="number">-2</span>;</span><br><span class="line">        <span class="keyword">ELSE</span> </span><br><span class="line">        	<span class="keyword">COMMIT</span>;</span><br><span class="line">        	<span class="keyword">set</span> r_result <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">END</span> IF;	</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line">$$</span><br><span class="line"><span class="comment">-- 存储过程定义结束</span></span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> <span class="variable">@r_result</span> <span class="operator">=</span> <span class="number">-3</span>;</span><br><span class="line"><span class="comment">-- 执行存储过程</span></span><br><span class="line"><span class="keyword">call</span> execute_seckill(<span class="number">1003</span>,<span class="number">13567098891</span>,now(),<span class="variable">@r_result</span>)</span><br><span class="line"><span class="comment">--获取结果</span></span><br><span class="line"><span class="keyword">select</span> <span class="variable">@r_result</span>;</span><br></pre></td></tr></table></figure>

<p>在Java中调用事务接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Date</span> <span class="variable">killTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">Map&lt;String,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">map.put(<span class="string">&quot;seckillId&quot;</span>,seckillId);</span><br><span class="line">map.put(<span class="string">&quot;phone&quot;</span>,userPhone);</span><br><span class="line">map.put(<span class="string">&quot;killTime&quot;</span>,killTime);</span><br><span class="line">map.put(<span class="string">&quot;result&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">seckillDao.killByProcedure(map);</span><br><span class="line"><span class="comment">//执行存储过程，result被复制</span></span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    seckillDao.killByProcedure(map);</span><br><span class="line">    <span class="comment">//获取result</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> MapUtils.getInteger(map,<span class="string">&quot;result&quot;</span>,-<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span>(result == <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="type">SuccesssKilled</span> <span class="variable">sk</span> <span class="operator">=</span> successkilledDao.</span><br><span class="line">            queryByIdWithSeckill(seckillId,userPhone);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SeckillExecution</span>(seckillId, SeckillStatEnum.SUCCESS, sk);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SeckillExecution</span>(seckillId, SeckillStatEnum.stateOf(result));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">    logger.error(e.getMessage(),e);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SeckillExecution</span>(seckillId, SeckillStatEnum.INNER_ERROR);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="四、系统部署架构"><a href="#四、系统部署架构" class="headerlink" title="四、系统部署架构"></a>四、系统部署架构</h3><p>秒杀系统架构：</p>
<p>1、CDN缓存</p>
<p>2、智能DNS解析：Nginx</p>
<p>3、逻辑集群：jetty</p>
<p>4、分库分表：Mycat</p>
<p>5、统计分析：生成报表 </p>
<p>一部分流量已经被cdn缓存锁拦截 不过秒杀的操作,秒杀的地址获取这样的请求不方便放入cdn中,所以访问到我们的服务器 我们的服务器会通过我们的dns查找到我们的地址 一般找到的是nginx地址,nginx一般部署到不同的机房,比如电信,移动,联通 这样的话智能的dns会根据用户的请求ip地址来智能的dns解析来请求最近的Nginx服务器 nginx还会给我们的服务器做负载均衡</p>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2026 By ZJH</div><div class="framework-info"><span>驱动 - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.1"></script><script src="/js/fancybox.js?version=1.9.1"></script><script src="/js/sidebar.js?version=1.9.1"></script><script src="/js/copy.js?version=1.9.1"></script><script src="/js/fireworks.js?version=1.9.1"></script><script src="/js/transition.js?version=1.9.1"></script><script src="/js/scroll.js?version=1.9.1"></script><script src="/js/head.js?version=1.9.1"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>