<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="ZJH"><meta name="copyright" content="ZJH"><title>Zany's Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '5.4.0'
} </script><meta name="generator" content="Hexo 5.4.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">ZJH</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">9</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">14</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">7</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Zany's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="site-info"><div id="site-title">Zany's Blog</div><div id="site-sub-title"></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2022/10/29/%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/cnn_captcha/">卷积神经网络实现图片验证码</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-10-30</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/">神经网络</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/">神经网络</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/cnn/">cnn</a></span><div class="content"><h1 id="cnn-captcha"><a href="#cnn-captcha" class="headerlink" title="cnn_captcha"></a>cnn_captcha</h1><p>use CNN recognize captcha by tensorflow.<br>本项目针对字符型图片验证码，使用tensorflow实现卷积神经网络，进行验证码识别。<br>项目封装了比较通用的<strong>校验、训练、验证、识别、API模块</strong>，极大的减少了识别字符型验证码花费的时间和精力。 </p>
<p>项目已经帮助很多同学高效完成了验证码识别任务。<br>如果你在使用过程中出现了bug和做了良好的改进，欢迎提出issue和PR，作者会尽快回复，希望能和你共同完善项目。 </p>
<p>如果你需要识别点选、拖拽类验证码，或者有目标检测需求，也可以参考这个项目<a target="_blank" rel="noopener" href="https://github.com/nickliqian/darknet_captcha">nickliqian/darknet_captcha</a>。</p>
<h1 id="时间表"><a href="#时间表" class="headerlink" title="时间表"></a>时间表</h1><h4 id="2018-11-12"><a href="#2018-11-12" class="headerlink" title="2018.11.12"></a>2018.11.12</h4><p>初版Readme.md  </p>
<h4 id="2018-11-21"><a href="#2018-11-21" class="headerlink" title="2018.11.21"></a>2018.11.21</h4><p>加入关于验证码识别的一些说明  </p>
<h4 id="2018-11-24"><a href="#2018-11-24" class="headerlink" title="2018.11.24"></a>2018.11.24</h4><p>优化校验数据集图片的规则  </p>
<h4 id="2018-11-26"><a href="#2018-11-26" class="headerlink" title="2018.11.26"></a>2018.11.26</h4><p>新增<code>train_model_v2.py</code>文件，训练过程中同时输出训练集和验证集的准确率  </p>
<h4 id="2018-12-06"><a href="#2018-12-06" class="headerlink" title="2018.12.06"></a>2018.12.06</h4><p>新增多模型部署支持，修复若干bug  </p>
<h4 id="2018-12-08"><a href="#2018-12-08" class="headerlink" title="2018.12.08"></a>2018.12.08</h4><p>优化模型识别速度，支持api压力测试和统计耗时  </p>
<h4 id="2019-02-19"><a href="#2019-02-19" class="headerlink" title="2019.02.19"></a>2019.02.19</h4><ol>
<li>新增一种准确率计算方式    </li>
<li>TAG: v1.0<h4 id="2019-04-12"><a href="#2019-04-12" class="headerlink" title="2019.04.12"></a>2019.04.12</h4></li>
<li>只保留一种<code>train_model.py</code>文件</li>
<li>优化代码结构</li>
<li>把通用配置抽取到<code>sample_config.json</code>和<code>captcha_config.json</code></li>
<li>修复若干大家在issue提出的问题<h4 id="2019-06-01"><a href="#2019-06-01" class="headerlink" title="2019.06.01"></a>2019.06.01</h4></li>
<li>完善readme文档，文档不长，请大家一定要读完~</li>
<li>使用cnnlib目录存放神经网络结构代码</li>
<li>做了一版训练数据统计，大家可以参考我们的训练次数、时长和准确率</li>
<li>TAG: v2.0  </li>
</ol>
<h1 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h1><p>[toc]</p>
<h1 id="1-项目介绍"><a href="#1-项目介绍" class="headerlink" title="1 项目介绍"></a>1 项目介绍</h1><h2 id="1-1-关于验证码识别"><a href="#1-1-关于验证码识别" class="headerlink" title="1.1 关于验证码识别"></a>1.1 关于验证码识别</h2><p>验证码识别大多是爬虫会遇到的问题，也可以作为图像识别的入门案例。目前通常使用如下几种方法：  </p>
<table>
<thead>
<tr>
<th>方法名称</th>
<th>相关要点</th>
</tr>
</thead>
<tbody><tr>
<td>tesseract</td>
<td>仅适合识别没有干扰和扭曲的图片，训练起来很麻烦</td>
</tr>
<tr>
<td>其他开源识别库</td>
<td>不够通用，识别率未知</td>
</tr>
<tr>
<td>付费OCR API</td>
<td>需求量大的情形成本很高</td>
</tr>
<tr>
<td>图像处理+机器学习分类算法</td>
<td>涉及多种技术，学习成本高，且不通用</td>
</tr>
<tr>
<td>卷积神经网络</td>
<td>一定的学习成本，算法适用于多类验证码</td>
</tr>
</tbody></table>
<p>这里说一下使用传统的<strong>图像处理和机器学习算法</strong>，涉及多种技术：  </p>
<ol>
<li>图像处理</li>
</ol>
<ul>
<li>前处理（灰度化、二值化）</li>
<li>图像分割</li>
<li>裁剪（去边框）</li>
<li>图像滤波、降噪</li>
<li>去背景</li>
<li>颜色分离</li>
<li>旋转</li>
</ul>
<ol start="2">
<li>机器学习</li>
</ol>
<ul>
<li>KNN</li>
<li>SVM</li>
</ul>
<p>使用这类方法对使用者的要求较高，且由于图片的变化类型较多，处理的方法不够通用，经常花费很多时间去调整处理步骤和相关算法。<br>而使用<strong>卷积神经网络</strong>，只需要通过简单的前处理，就可以实现大部分静态字符型验证码的端到端识别，效果很好，通用性很高。  </p>
<p>这里列出目前<strong>常用的验证码</strong>生成库：</p>
<blockquote>
<p>参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/cynchanpin/p/6912301.html">Java验证全家桶</a>  </p>
</blockquote>
<table>
<thead>
<tr>
<th>语言</th>
<th>验证码库名称</th>
<th>链接</th>
<th>样例</th>
</tr>
</thead>
<tbody><tr>
<td>Java</td>
<td>JCaptcha</td>
<td><a target="_blank" rel="noopener" href="https://jcaptcha.atlassian.net/wiki/spaces/general/pages/1212427/Samples+tests">示例</a></td>
<td><img src="./readme_image/jcaptcha1.jpg" alt="效果1"> <img src="./readme_image/jcaptcha2.jpg" alt="效果2"> <img src="./readme_image/jcaptcha3.jpg" alt="效果3"></td>
</tr>
<tr>
<td>Java</td>
<td>JCaptcha4Struts2</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Java</td>
<td>SimpleCaptcha</td>
<td><a target="_blank" rel="noopener" href="https://www.oschina.net/p/simplecaptcha">例子</a></td>
<td><img src="./readme_image/SimpleCaptcha_1.jpg" alt="效果1"> <img src="./readme_image/SimpleCaptcha_2.jpg" alt="效果2"> <img src="./readme_image/SimpleCaptcha_3.jpg" alt="效果3"></td>
</tr>
<tr>
<td>Java</td>
<td>kaptcha</td>
<td><a target="_blank" rel="noopener" href="https://github.com/linghushaoxia/kaptcha">例子</a></td>
<td><img src="./readme_image/Kaptcha_5.png" alt="水纹效果"> <img src="./readme_image/Kaptcha_2.png" alt="鱼眼效果"> <img src="./readme_image/Kaptcha_3.png" alt="阴影效果"></td>
</tr>
<tr>
<td>Java</td>
<td>patchca</td>
<td></td>
<td><img src="./readme_image/patchca_1.png" alt="效果1"></td>
</tr>
<tr>
<td>Java</td>
<td>imageRandom</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Java</td>
<td>iCaptcha</td>
<td></td>
<td><img src="./readme_image/iCaptcha.jpg" alt="效果1"></td>
</tr>
<tr>
<td>Java</td>
<td>SkewPassImage</td>
<td></td>
<td><img src="./readme_image/SkewPassImage.jpg" alt="效果1"></td>
</tr>
<tr>
<td>Java</td>
<td>Cage</td>
<td></td>
<td><img src="./readme_image/Cage1.jpg" alt="效果1"> <img src="./readme_image/Cage2.jpg" alt="效果2"></td>
</tr>
<tr>
<td>Python</td>
<td>captcha</td>
<td><a target="_blank" rel="noopener" href="https://github.com/nickliqian/cnn_captcha/blob/master/gen_image/gen_sample_by_captcha.py">例子</a></td>
<td><img src="./readme_image/py_Captcha-1.jpg" alt="py_Captcha"></td>
</tr>
<tr>
<td>Python</td>
<td>pycapt</td>
<td><a target="_blank" rel="noopener" href="https://github.com/aboutmydreams/pycapt">例子</a></td>
<td><img src="https://github.com/aboutmydreams/pycapt/raw/master/img/do4.png" alt="pycapt"></td>
</tr>
<tr>
<td>PHP</td>
<td>Gregwar/Captcha</td>
<td><a target="_blank" rel="noopener" href="https://github.com/Gregwar/Captcha">文档</a></td>
<td></td>
</tr>
<tr>
<td>PHP</td>
<td>mewebstudio/captcha</td>
<td><a target="_blank" rel="noopener" href="https://github.com/mewebstudio/captcha">文档</a></td>
<td></td>
</tr>
</tbody></table>
<h2 id="1-2-目录结构"><a href="#1-2-目录结构" class="headerlink" title="1.2 目录结构"></a>1.2 目录结构</h2><h3 id="1-2-1-基本配置"><a href="#1-2-1-基本配置" class="headerlink" title="1.2.1 基本配置"></a>1.2.1 基本配置</h3><table>
<thead>
<tr>
<th>序号</th>
<th>文件名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td><code>conf/</code></td>
<td>配置文件目录</td>
</tr>
<tr>
<td>2</td>
<td><code>sample/</code></td>
<td>数据集目录</td>
</tr>
<tr>
<td>3</td>
<td><code>model/</code></td>
<td>模型文件目录</td>
</tr>
<tr>
<td>4</td>
<td><code>cnnlib/</code></td>
<td>封装CNN的相关代码目录</td>
</tr>
</tbody></table>
<h3 id="1-2-2-训练模型"><a href="#1-2-2-训练模型" class="headerlink" title="1.2.2 训练模型"></a>1.2.2 训练模型</h3><table>
<thead>
<tr>
<th>序号</th>
<th>文件名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>verify_and_split_data.py</td>
<td>验证数据集、拆分数据为训练集和测试集</td>
</tr>
<tr>
<td>2</td>
<td>network.py</td>
<td>cnn网络基类</td>
</tr>
<tr>
<td>3</td>
<td>train_model.py</td>
<td>训练模型</td>
</tr>
<tr>
<td>4</td>
<td>test_batch.py</td>
<td>批量验证</td>
</tr>
<tr>
<td>5</td>
<td>gen_image/gen_sample_by_captcha.py</td>
<td>生成验证码的脚本</td>
</tr>
<tr>
<td>6</td>
<td>gen_image/collect_labels.py</td>
<td>用于统计验证码标签（常用于中文验证码）</td>
</tr>
</tbody></table>
<h3 id="1-2-3-web接口"><a href="#1-2-3-web接口" class="headerlink" title="1.2.3 web接口"></a>1.2.3 web接口</h3><table>
<thead>
<tr>
<th>序号</th>
<th>文件名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>webserver_captcha_image.py</td>
<td>获取验证码接口</td>
</tr>
<tr>
<td>2</td>
<td>webserver_recognize_api.py</td>
<td>提供在线识别验证码接口</td>
</tr>
<tr>
<td>3</td>
<td>recognize_online.py</td>
<td>使用接口识别的例子</td>
</tr>
<tr>
<td>4</td>
<td>recognize_local.py</td>
<td>测试本地图片的例子</td>
</tr>
<tr>
<td>5</td>
<td>recognize_time_test.py</td>
<td>压力测试识别耗时和请求响应耗时</td>
</tr>
</tbody></table>
<h2 id="1-3-依赖"><a href="#1-3-依赖" class="headerlink" title="1.3 依赖"></a>1.3 依赖</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -r requirements.txt</span><br></pre></td></tr></table></figure>
<p>注意：如果需要使用GPU进行训练，请把文件中的tenforflow修改为tensorflow-gpu</p>
<h2 id="1-4-模型结构"><a href="#1-4-模型结构" class="headerlink" title="1.4 模型结构"></a>1.4 模型结构</h2><table>
<thead>
<tr>
<th align="center">序号</th>
<th align="center">层级</th>
</tr>
</thead>
<tbody><tr>
<td align="center">输入</td>
<td align="center">input</td>
</tr>
<tr>
<td align="center">1</td>
<td align="center">卷积层 + 池化层 + 降采样层 + ReLU</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">卷积层 + 池化层 + 降采样层 + ReLU</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">卷积层 + 池化层 + 降采样层 + ReLU</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">全连接 + 降采样层 + Relu</td>
</tr>
<tr>
<td align="center">5</td>
<td align="center">全连接 + softmax</td>
</tr>
<tr>
<td align="center">输出</td>
<td align="center">output</td>
</tr>
</tbody></table>
<h1 id="2-如何使用"><a href="#2-如何使用" class="headerlink" title="2 如何使用"></a>2 如何使用</h1><h2 id="2-1-数据集"><a href="#2-1-数据集" class="headerlink" title="2.1 数据集"></a>2.1 数据集</h2><p>原始数据集可以存放在<code>./sample/origin</code>目录中。<br>为了便于处理，图片最好以<code>2e8j_17322d3d4226f0b5c5a71d797d2ba7f7.jpg</code>格式命名（标签_序列号.后缀）。 </p>
<p>如果你没有训练集，你可以使用<code>gen_sample_by_captcha.py</code>文件生成训练集文件。<br>生成之前你需要修改相关配置<code>conf/captcha_config.json</code>（路径、文件后缀、字符集等）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;root_dir&quot;: &quot;sample/origin/&quot;,  # 验证码保存路径</span><br><span class="line">  &quot;image_suffix&quot;: &quot;png&quot;,         # 验证码图片后缀</span><br><span class="line">  &quot;characters&quot;: &quot;0123456789&quot;,    # 生成验证码的可选字符</span><br><span class="line">  &quot;count&quot;: 1000,                 # 生成验证码的图片数量</span><br><span class="line">  &quot;char_count&quot;: 4,               # 每张验证码图片上的字符数量</span><br><span class="line">  &quot;width&quot;: 100,                  # 图片宽度</span><br><span class="line">  &quot;height&quot;: 60                   # 图片高度</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-2-配置文件"><a href="#2-2-配置文件" class="headerlink" title="2.2 配置文件"></a>2.2 配置文件</h2><p>创建一个新项目前，需要自行<strong>修改相关配置文件</strong><code>conf/sample_config.json</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;origin_image_dir&quot;: &quot;sample/origin/&quot;,  # 原始文件</span><br><span class="line">  &quot;new_image_dir&quot;: &quot;sample/new_train/&quot;,  # 新的训练样本</span><br><span class="line">  &quot;train_image_dir&quot;: &quot;sample/train/&quot;,    # 训练集</span><br><span class="line">  &quot;test_image_dir&quot;: &quot;sample/test/&quot;,      # 测试集</span><br><span class="line">  &quot;api_image_dir&quot;: &quot;sample/api/&quot;,        # api接收的图片储存路径</span><br><span class="line">  &quot;online_image_dir&quot;: &quot;sample/online/&quot;,  # 从验证码url获取的图片的储存路径</span><br><span class="line">  &quot;local_image_dir&quot;: &quot;sample/local/&quot;,    # 本地保存图片的路径</span><br><span class="line">  &quot;model_save_dir&quot;: &quot;model/&quot;,            # 从验证码url获取的图片的储存路径</span><br><span class="line">  &quot;image_width&quot;: 100,                    # 图片宽度</span><br><span class="line">  &quot;image_height&quot;: 60,                    # 图片高度</span><br><span class="line">  &quot;max_captcha&quot;: 4,                      # 验证码字符个数</span><br><span class="line">  &quot;image_suffix&quot;: &quot;png&quot;,                 # 图片文件后缀</span><br><span class="line">  &quot;char_set&quot;: &quot;0123456789abcdefghijklmnopqrstuvwxyz&quot;,  # 验证码识别结果类别</span><br><span class="line">  &quot;use_labels_json_file&quot;: false,                       # 是否开启读取`labels.json`内容</span><br><span class="line">  &quot;remote_url&quot;: &quot;http://127.0.0.1:6100/captcha/&quot;,      # 验证码远程获取地址</span><br><span class="line">  &quot;cycle_stop&quot;: 3000,                                  # 启动任务后的训练指定次数后停止</span><br><span class="line">  &quot;acc_stop&quot;: 0.99,                                    # 训练到指定准确率后停止</span><br><span class="line">  &quot;cycle_save&quot;: 500,                                   # 训练指定次数后定时保存模型</span><br><span class="line">  &quot;enable_gpu&quot;: 0,                                     # 是否开启GUP训练</span><br><span class="line">  &quot;train_batch_size&quot;: 128,                             # 训练时每次使用的图片张数，如果CPU或者GPU内存太小可以减少这个参数</span><br><span class="line">  &quot;test_batch_size&quot;: 100                               # 每批次测试时验证的图片张数，不要超过验证码集的总数</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>关于<code>验证码识别结果类别</code>，假设你的样本是中文验证码，你可以使用<code>tools/collect_labels.py</code>脚本进行标签的统计。<br>会生成文件<code>gen_image/labels.json</code>存放所有标签，在配置文件中设置<code>use_labels_json_file = True</code>开启读取<code>labels.json</code>内容作为<code>结果类别</code>。</p>
<h2 id="2-3-验证和拆分数据集"><a href="#2-3-验证和拆分数据集" class="headerlink" title="2.3 验证和拆分数据集"></a>2.3 验证和拆分数据集</h2><p>此功能会校验原始图片集的尺寸和测试图片是否能打开，并按照19:1的比例拆分出训练集和测试集。<br>所以需要分别创建和指定三个文件夹：origin，train，test用于存放相关文件。</p>
<p>也可以修改为不同的目录，但是最好修改为绝对路径。<br>文件夹创建好之后，执行以下命令即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 verify_and_split_data.py</span><br></pre></td></tr></table></figure>
<p>一般会有类似下面的提示</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; 开始校验目录：[sample/origin/]</span><br><span class="line">开始校验原始图片集</span><br><span class="line">原始集共有图片: 1001张</span><br><span class="line">====以下1张图片有异常====</span><br><span class="line">[第0张图片] [.DStore] [文件后缀不正确]</span><br><span class="line">========end</span><br><span class="line">开始分离原始图片集为：测试集（5%）和训练集（95%）</span><br><span class="line">共分配1000张图片到训练集和测试集，其中1张为异常留在原始目录</span><br><span class="line">测试集数量为：50</span><br><span class="line">训练集数量为：950</span><br><span class="line">&gt;&gt;&gt; 开始校验目录：[sample/new_train/]</span><br><span class="line">【警告】找不到目录sample/new_train/，即将创建</span><br><span class="line">开始校验原始图片集</span><br><span class="line">原始集共有图片: 0张</span><br><span class="line">====以下0张图片有异常====</span><br><span class="line">未发现异常（共 0 张图片）</span><br><span class="line">========end</span><br><span class="line">开始分离原始图片集为：测试集（5%）和训练集（95%）</span><br><span class="line">共分配0张图片到训练集和测试集，其中0张为异常留在原始目录</span><br><span class="line">测试集数量为：0</span><br><span class="line">训练集数量为：0</span><br></pre></td></tr></table></figure>
<p>程序会同时校验和分割<code>origin_image_dir</code>和<code>new_image_dir</code>两个目录中的图片；后续有了更多的样本，可以把样本放在<code>new_image_dir</code>目录中再次执行<code>verify_and_split_data</code>。<br>程序会把无效的文件留在原文件夹。  </p>
<p>此外，当你有新的样本需要一起训练，可以放在<code>sample/new</code>目录下，再次运行<code>python3 verify_and_split_data.py</code>即可。<br>需要注意的是，如果新的样本中有新增的标签，你需要把新的标签增加到<code>char_set</code>配置中或者<code>labels.json</code>文件中。 </p>
<h2 id="2-4-训练模型"><a href="#2-4-训练模型" class="headerlink" title="2.4 训练模型"></a>2.4 训练模型</h2><p>创建好训练集和测试集之后，就可以开始训练模型了。<br>训练的过程中会输出日志，日志展示当前的训练轮数、准确率和loss。<br><strong>此时的准确率是训练集图片的准确率，代表训练集的图片识别情况</strong><br>例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">第10次训练 &gt;&gt;&gt; </span><br><span class="line">[训练集] 字符准确率为 0.03000 图片准确率为 0.00000 &gt;&gt;&gt; loss 0.1698757857</span><br><span class="line">[验证集] 字符准确率为 0.04000 图片准确率为 0.00000 &gt;&gt;&gt; loss 0.1698757857</span><br></pre></td></tr></table></figure>
<p>字符准确率和图片准确率的解释：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">假设：有100张图片，每张图片四个字符，共400个字符。我们这里把任务拆分为为需要识别400个字符</span><br><span class="line">字符准确率：识别400的字符中，正确字符的占比。</span><br><span class="line">图片准确率：100张图片中，4个字符完全识别准确的图片占比。</span><br></pre></td></tr></table></figure>
<p>这里不具体介绍tensorflow安装相关问题，直奔主题。<br>确保图片相关参数和目录设置正确后，执行以下命令开始训练：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 train_model.py</span><br></pre></td></tr></table></figure>
<p>也可以根据<code>train_model.py</code>的<code>main</code>函数中的代码调用类开始训练或执行一次简单的识别演示。  </p>
<p>由于训练集中常常不包含所有的样本特征，所以会出现训练集准确率是100%而测试集准确率不足100%的情况，此时提升准确率的一个解决方案是增加正确标记后的负样本。</p>
<h2 id="2-5-批量验证"><a href="#2-5-批量验证" class="headerlink" title="2.5 批量验证"></a>2.5 批量验证</h2><p>使用测试集的图片进行验证，输出准确率。  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 test_batch.py</span><br></pre></td></tr></table></figure>
<p>同样可以根据<code>main</code>函数中的代码调用类开始验证。</p>
<h2 id="2-6-启动WebServer"><a href="#2-6-启动WebServer" class="headerlink" title="2.6 启动WebServer"></a>2.6 启动WebServer</h2><p>项目已经封装好加载模型和识别图片的类，启动<code>web server</code>后调用接口就可以使用识别服务。<br>启动<code>web server</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 webserver_recognize_api.py</span><br></pre></td></tr></table></figure>
<p>接口url为<code>http://127.0.0.1:6000/b</code></p>
<h2 id="2-7-调用接口识别"><a href="#2-7-调用接口识别" class="headerlink" title="2.7 调用接口识别"></a>2.7 调用接口识别</h2><p>使用requests调用接口:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">url = &quot;http://127.0.0.1:6000/b&quot;</span><br><span class="line">files = &#123;&#x27;image_file&#x27;: (image_file_name, open(&#x27;captcha.jpg&#x27;, &#x27;rb&#x27;), &#x27;application&#x27;)&#125;</span><br><span class="line">r = requests.post(url=url, files=files)</span><br></pre></td></tr></table></figure>
<p>返回的结果是一个json：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &#x27;time&#x27;: &#x27;1542017705.9152594&#x27;,</span><br><span class="line">    &#x27;value&#x27;: &#x27;jsp1&#x27;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>文件<code>recognize_local.py</code>是使用接口识别本地的例子，这个例子运行成功，那么识别验证码的一套流程基本上是走了一遍了。<br>在线识别验证码是显示中常用场景，文件<code>recognize_online.py</code>是使用接口在线识别的例子，参见：<code>## 2.11 在线识别</code>。</p>
<h2 id="2-8-部署"><a href="#2-8-部署" class="headerlink" title="2.8 部署"></a>2.8 部署</h2><p>部署的时候，把<code>webserver_recognize_api.py</code>文件的最后一行修改为如下内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.run(host=&#x27;0.0.0.0&#x27;,port=5000,debug=False)</span><br></pre></td></tr></table></figure>
<p>然后开启端口访问权限，就可以通过外网访问了。<br>另外为了开启多进程处理请求，可以使用uwsgi+nginx组合进行部署。<br>这部分可以参考：<a target="_blank" rel="noopener" href="http://docs.jinkan.org/docs/flask/deploying/index.html">Flask部署选择</a></p>
<h2 id="2-9-部署多个模型"><a href="#2-9-部署多个模型" class="headerlink" title="2.9 部署多个模型"></a>2.9 部署多个模型</h2><p>部署多个模型:<br>在<code>webserver_recognize_api.py</code>文件汇总，新建一个Recognizer对象；<br>并参照原有<code>up_image</code>函数编写的路由和识别逻辑。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Q = Recognizer(image_height, image_width, max_captcha, char_set, model_save_dir)</span><br></pre></td></tr></table></figure>
<p>注意修改这一行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">value = Q.rec_image(img)</span><br></pre></td></tr></table></figure>

<h2 id="2-10-在线识别"><a href="#2-10-在线识别" class="headerlink" title="2.10 在线识别"></a>2.10 在线识别</h2><p>在线识别验证码是显示中常用场景，即实时获取目标验证码来调用接口进行识别。<br>为了测试的完整性，这里搭建了一个验证码获取接口，通过执行下面的命令启动：  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python webserver_captcha_image.py</span><br></pre></td></tr></table></figure>
<p>启动后通过访问此地址：<code>http://127.0.0.1:6100/captcha/</code>可以接收到验证码图片的二进制流文件。<br>具体进行在线识别任务的demo参见：<code>recognize_online.py</code>。  </p>
<h1 id="3-数据统计"><a href="#3-数据统计" class="headerlink" title="3 数据统计"></a>3 数据统计</h1><h2 id="3-1-训练数据统计"><a href="#3-1-训练数据统计" class="headerlink" title="3.1 训练数据统计"></a>3.1 训练数据统计</h2><p>由于很多同学提出，“需要训练多久呀？”、“准确率可以达到多少？”、“为什么我的准确率一直是0？”类似的疑问。<br>这一小节，使用默认配置（2019.06.02），把训练过程中的数据做了统计，给大家做一个展示。<br>本次测试条件如下：</p>
<ul>
<li>验证码：本项目自带生成验证码程序，数字+小写英文</li>
<li>数量：20000张</li>
<li>计算引擎：GPU</li>
<li>GPU型号：笔记本，GTX 950X 2G显卡</li>
</ul>
<p>经过测试：<br>5000次，25分钟，<strong>训练集</strong>字符准确率84%，图片准确率51%；<br>9190次，46分钟，<strong>训练集</strong>字符准确率100%，图片准确率100%；<br>12000，60分钟，<strong>测试集</strong>的准确率基本上已经跑不动了。  </p>
<p>使用<code>test_batch.py</code>测试，日志如下：  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">100个样本识别耗时6.513171672821045秒，准确率37.0%</span><br></pre></td></tr></table></figure>
<p>有37%的准确率，可以说是识别成功的第一步了。  </p>
<p>曲线图如下：<br>训练集-<br><img src="readme_image/train_acc.png" alt="train_acc"> </p>
<p>测试集-<br><img src="readme_image/test_acc.png" alt="test_acc">  </p>
<h2 id="3-2-压力测试和统计数据"><a href="#3-2-压力测试和统计数据" class="headerlink" title="3.2 压力测试和统计数据"></a>3.2 压力测试和统计数据</h2><p>提供了一个简易的压力测试脚本，可以统计api运行过程中识别耗时和请求耗时的相关数据，不过图需要自己用Excel拉出来。<br>打开文件<code>recognize_time_test.py</code>，修改<code>main</code>函数下的<code>test_file</code>路径，这里会重复使用一张图片来访问是被接口。<br>最后数据会储存在test.csv文件中。<br>使用如下命令运行：  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">python3 recognize_time_test.py</span><br><span class="line">----输出如下</span><br><span class="line">2938,5150,13:30:25,总耗时：29ms,识别：15ms,请求：14ms</span><br><span class="line">2939,5150,13:30:25,总耗时：41ms,识别：21ms,请求：20ms</span><br><span class="line">2940,5150,13:30:25,总耗时：47ms,识别：16ms,请求：31ms</span><br></pre></td></tr></table></figure>
<p>这里对一个模型进行了两万次测试后，一组数据test.csv。<br>把test.csv使用箱线图进行分析后可以看到：<br><img src="readme_image/%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C.png" alt="压力测试结果">  </p>
<ul>
<li>单次请求API总耗时（平均值）：27ms  </li>
<li>单次识别耗时（平均值）：12ms  </li>
<li>每次请求耗时（平均值）：15ms<br>其中有：请求API总耗时 = 识别耗时 + 请求耗时  </li>
</ul>
<h1 id="4-开发说明"><a href="#4-开发说明" class="headerlink" title="4 开发说明"></a>4 开发说明</h1><ul>
<li>20190209  </li>
</ul>
<ol>
<li>目前tensorboard展示支持的不是很好。</li>
</ol>
<ul>
<li>20190601</li>
</ul>
<ol>
<li>最近比较忙，issue回的有点慢，请大家见谅</li>
<li>dev分支开发到一半一直没时间弄，今天儿童节花了一下午时间更新了一下:)</li>
<li>感谢看到这里的你，谢谢你的支持</li>
</ol>
<h1 id="4-已知BUG"><a href="#4-已知BUG" class="headerlink" title="4 已知BUG"></a>4 已知BUG</h1><ol>
<li><p>使用pycharm启动recognize_api.py文件报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2018-12-01 00:35:15.106333: W T:\src\github\tensorflow\tensorflow\core\framework\op_kernel.cc:1273] OP_REQUIRES failed at save_restore_tensor.cc:170 : Invalid argument: Unsuccessful TensorSliceReader constructor: Failed to get matching files on ./model/: Not found: FindFirstFile failed for: ./model : ϵͳ�Ҳ���ָ����·����</span><br><span class="line">; No such process</span><br><span class="line">......</span><br><span class="line">tensorflow.python.framework.errors_impl.InvalidArgumentError: Unsuccessful TensorSliceReader constructor: Failed to get matching files on ./model/: Not found: FindFirstFile failed for: ./model : ϵͳ\udcd5Ҳ\udcbb\udcb5\udcbdָ\udcb6\udca8\udcb5\udcc4·\udcbe\udcb6\udca1\udca3</span><br><span class="line">; No such process</span><br><span class="line">	 [[Node: save/RestoreV2 = RestoreV2[dtypes=[DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT, DT_FLOAT], _device=&quot;/job:localhost/replica:0/task:0/device:CPU:0&quot;](_arg_save/Const_0_0, save/RestoreV2/tensor_names, save/RestoreV2/shape_and_slices)]]</span><br></pre></td></tr></table></figure>
<p>由pycharm默认设置了工作空间，导致读取相对路径的model文件夹出错。<br>解决办法：编辑运行配置，设置工作空间为项目目录即可。<br><img src="readme_image/bug_api%E5%90%AF%E5%8A%A8%E5%A4%B1%E8%B4%A5.png" alt="bug_api启动失败"></p>
</li>
<li><p>FileNotFoundError: [Errno 2] No such file or directory: ‘xxxxxx’<br>目录下有文件夹不存在，在指定目录创建好文件夹即可。</p>
</li>
<li><p>api程序在运行过程中内存越占越大<br>结果查阅资料：<a target="_blank" rel="noopener" href="https://blog.csdn.net/The_lastest/article/details/81130500">链接</a><br>在迭代循环时，不能再包含任何张量的计算表达式，否在会内存溢出。<br>将张量的计算表达式放到init初始化执行后，识别速度得到极大的提升。</p>
</li>
<li><p>加载多个模型报错<br>原因是两个Recognizer对象都使用了默认的Graph。<br>解决办法是在创建对象的时候不使用默认Graph，新建graph，这样每个Recognizer都使用不同的graph，就不会冲突了。</p>
</li>
<li><p>Flask程序用于生产<br>可以参考官方文档：<a target="_blank" rel="noopener" href="http://docs.jinkan.org/docs/flask/config.html">Flask的生产配置</a></p>
</li>
<li><p>OOM happens</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Hint: If you want to see a list of allocated tensors when OOM happens,</span><br><span class="line">add report_tensor_allocations_upon_oom to RunOptions for current allocation info.</span><br></pre></td></tr></table></figure>
<p>尽可能关闭其他占用GPU或者CPU的任务，或者减小<code>sample_config.json</code>中的<code>train_batch_size</code>参数。</p>
</li>
</ol>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/09/16/%E8%84%9A%E6%9C%AC/DingDing-Automatic-Clock-in-master/DingDing-Automatic-Clock-in/">钉钉全自动打卡</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-09-17</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E8%84%9A%E6%9C%AC/">脚本</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/autojs/">autojs</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/%E9%92%89%E9%92%89/">钉钉</a></span><div class="content"><h1 id="声明"><a href="#声明" class="headerlink" title="声明"></a>声明</h1><p>本篇文章为摘录自GitHub，自己修改了部分代码，仅作为参考，详见原文</p>
<h2 id="⏰-定时脚本"><a href="#⏰-定时脚本" class="headerlink" title="⏰ 定时脚本"></a>⏰ 定时脚本</h2><p>同时兼容定时和通知两种功能</p>
<ul>
<li>发送 “开启循环” 开启定时功能</li>
<li>发送 “关闭循环” 关闭定时功能</li>
<li>修正 “日志” 功能BUG，发送日志文件到邮箱中</li>
<li>添加 “连接” 功能，实现远程连接电脑 AutoJs Server</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @Author: George Huan</span></span><br><span class="line"><span class="comment"> * @Date: 2020-08-03 09:30:30</span></span><br><span class="line"><span class="comment"> * @LastEditTime: 2022-03-26 10:56:25</span></span><br><span class="line"><span class="comment"> * @Description: DingDing-Automatic-Clock-in (Run on AutoJs)</span></span><br><span class="line"><span class="comment"> * @URL: https://github.com/georgehuan1994/DingDing-Automatic-Clock-in</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ACCOUNT = <span class="string">&quot;15868141080&quot;</span></span><br><span class="line"><span class="keyword">const</span> PASSWORD = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> QQ =              <span class="string">&quot;2757412961&quot;</span></span><br><span class="line"><span class="keyword">const</span> EMAILL_ADDRESS =  <span class="string">&quot;2757412961@qq.com&quot;</span></span><br><span class="line"><span class="keyword">const</span> SERVER_CHAN =     <span class="string">&quot;SCT171904TfSMLDvHz2oGuB8NU9NdMg1W0&quot;</span></span><br><span class="line"><span class="keyword">const</span> PUSH_DEER =       <span class="string">&quot;PushDeer发送密钥&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PUSH_METHOD = &#123;<span class="attr">QQ</span>: <span class="number">1</span>, <span class="attr">Email</span>: <span class="number">2</span>, <span class="attr">ServerChan</span>: <span class="number">3</span>, <span class="attr">PushDeer</span>: <span class="number">4</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 默认通信方式：</span></span><br><span class="line"><span class="comment">// PUSH_METHOD.QQ -- QQ</span></span><br><span class="line"><span class="comment">// PUSH_METHOD.Email -- Email </span></span><br><span class="line"><span class="comment">// PUSH_METHOD.ServerChan -- Server酱</span></span><br><span class="line"><span class="comment">// PUSH_METHOD.PushDeer -- Push Deer</span></span><br><span class="line"><span class="keyword">var</span> DEFAULT_MESSAGE_DELIVER = PUSH_METHOD.QQ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PACKAGE_ID_QQ = <span class="string">&quot;com.tencent.mobileqq&quot;</span>                <span class="comment">// QQ</span></span><br><span class="line"><span class="comment">// const PACKAGE_ID_DD = &quot;com.alibaba.android.rimet&quot;           // 钉钉</span></span><br><span class="line"><span class="keyword">const</span> PACKAGE_ID_DD = <span class="string">&quot;com.alibaba.android.rimet.zju&quot;</span>       <span class="comment">// 浙大钉</span></span><br><span class="line"><span class="keyword">const</span> PACKAGE_ID_XMSF = <span class="string">&quot;com.xiaomi.xmsf&quot;</span>                   <span class="comment">// 小米推送服务</span></span><br><span class="line"><span class="keyword">const</span> PACKAGE_ID_TASKER = <span class="string">&quot;net.dinglisch.android.taskerm&quot;</span>   <span class="comment">// Tasker</span></span><br><span class="line"><span class="keyword">const</span> PACKAGE_ID_MAIL_163 = <span class="string">&quot;com.netease.mail&quot;</span>              <span class="comment">// 网易邮箱大师</span></span><br><span class="line"><span class="keyword">const</span> PACKAGE_ID_MAIL_ANDROID = <span class="string">&quot;com.android.email&quot;</span>         <span class="comment">// 系统内置邮箱</span></span><br><span class="line"><span class="keyword">const</span> PACKAGE_ID_PUSHDEER = <span class="string">&quot;com.pushdeer.os&quot;</span>               <span class="comment">// Push Deer</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> LOWER_BOUND = <span class="number">1</span> * <span class="number">60</span> * <span class="number">1000</span> <span class="comment">// 最小等待时间：1min</span></span><br><span class="line"><span class="keyword">const</span> UPPER_BOUND = <span class="number">5</span> * <span class="number">60</span> * <span class="number">1000</span> <span class="comment">// 最大等待时间：5min</span></span><br><span class="line"><span class="keyword">const</span> ONE_MIN = <span class="number">1</span> * <span class="number">60</span> * <span class="number">1000</span> <span class="comment">// 等待时间：1min</span></span><br><span class="line"><span class="keyword">const</span> FIF_MIN = <span class="number">15</span> * <span class="number">60</span> * <span class="number">1000</span> <span class="comment">// 等待时间：0.5h</span></span><br><span class="line"><span class="keyword">const</span> HALF_AN_HOUR = <span class="number">30</span> * <span class="number">60</span> * <span class="number">1000</span> <span class="comment">// 等待时间：0.5h</span></span><br><span class="line"><span class="keyword">const</span> AN_HOUR = <span class="number">1</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span> <span class="comment">// 等待时间：1h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行时的屏幕亮度（0-255）, 需要&quot;修改系统设置&quot;权限</span></span><br><span class="line"><span class="keyword">const</span> SCREEN_BRIGHTNESS = <span class="number">20</span>    </span><br><span class="line"></span><br><span class="line"><span class="comment">// 是否过滤通知</span></span><br><span class="line"><span class="keyword">const</span> NOTIFICATIONS_FILTER = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// PackageId白名单</span></span><br><span class="line"><span class="keyword">const</span> PACKAGE_ID_WHITE_LIST = [PACKAGE_ID_QQ,PACKAGE_ID_DD,PACKAGE_ID_XMSF,PACKAGE_ID_MAIL_163,PACKAGE_ID_TASKER,PACKAGE_ID_PUSHDEER]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 公司的钉钉CorpId, 获取方法见 2020-09-24 更新日志。如果只加入了一家公司, 可以不填</span></span><br><span class="line"><span class="comment">// dingtalk://dingtalkclient/page/link?url=&#x27;https://attend.dingtalk.com/attend/index.html?corpId=dingca07f56daee3def1bc961a6cb783455b&#x27;</span></span><br><span class="line"><span class="keyword">const</span> CORP_ID = <span class="string">&quot;dingca07f56daee3def1bc961a6cb783455b&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">// 锁屏意图, 配合 Tasker 完成锁屏动作, 具体配置方法见 2021-03-09 更新日志</span></span><br><span class="line"><span class="keyword">const</span> ACTION_LOCK_SCREEN = <span class="string">&quot;autojs.intent.action.LOCK_SCREEN&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听音量+键, 开启后无法通过音量+键调整音量, 按下音量+键：结束所有子线程</span></span><br><span class="line"><span class="keyword">const</span> OBSERVE_VOLUME_KEY = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> WEEK_DAY = [<span class="string">&quot;Sunday&quot;</span>,<span class="string">&quot;Monday&quot;</span>,<span class="string">&quot;Tuesday&quot;</span>,<span class="string">&quot;Wednesday&quot;</span>,<span class="string">&quot;Thursday&quot;</span>,<span class="string">&quot;Friday&quot;</span>,<span class="string">&quot;Saturday&quot;</span>,]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// =================== ↓↓↓ 主线程：监听通知 ↓↓↓ ====================</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> currentDate = <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 是否暂停循环打卡</span></span><br><span class="line"><span class="keyword">var</span> recursiveCard = <span class="literal">false</span></span><br><span class="line"><span class="keyword">var</span> timeAnchorPoints = [<span class="number">8</span>,<span class="number">11</span>,<span class="number">13</span>,<span class="number">17</span>,<span class="number">19</span>,<span class="number">22</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 是否暂停定时打卡</span></span><br><span class="line"><span class="keyword">var</span> suspend = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 本次打开钉钉前是否需要等待</span></span><br><span class="line"><span class="keyword">var</span> needWaiting = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行日志路径</span></span><br><span class="line"><span class="keyword">var</span> globalLogFilePath = <span class="string">&quot;/sdcard/脚本/Archive/&quot;</span> + getCurrentDate() + <span class="string">&quot;-log.txt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查无障碍权限</span></span><br><span class="line">auto.waitFor(<span class="string">&quot;normal&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查Autojs版本</span></span><br><span class="line">requiresAutojsVersion(<span class="string">&quot;4.1.0&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建运行日志</span></span><br><span class="line"><span class="built_in">console</span>.setGlobalLogConfig(&#123;</span><br><span class="line">    <span class="attr">file</span>: <span class="string">&quot;/sdcard/脚本/Archive/&quot;</span> + getCurrentDate() + <span class="string">&quot;-log.txt&quot;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听本机通知</span></span><br><span class="line">events.observeNotification()    </span><br><span class="line">events.on(<span class="string">&quot;notification&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">    notificationHandler(n)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">events.setKeyInterceptionEnabled(<span class="string">&quot;volume_up&quot;</span>, OBSERVE_VOLUME_KEY)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (OBSERVE_VOLUME_KEY) &#123;</span><br><span class="line">    events.observeKey()</span><br><span class="line">&#125;;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 监听音量+键</span></span><br><span class="line">events.onKeyDown(<span class="string">&quot;volume_up&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">    threads.shutDownAll()</span><br><span class="line">    device.setBrightnessMode(<span class="number">1</span>)</span><br><span class="line">    device.cancelKeepingAwake()</span><br><span class="line">    toast(<span class="string">&quot;已中断所有子线程!&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可以在此调试各个方法</span></span><br><span class="line">    <span class="comment">// doClock()</span></span><br><span class="line">    <span class="comment">// sendQQMsg(&quot;测试文本&quot;)</span></span><br><span class="line">    <span class="comment">// sendEmail(&quot;测试主题&quot;, &quot;测试文本&quot;, null)</span></span><br><span class="line">    <span class="comment">// sendServerChan(测试主题, 测试文本)</span></span><br><span class="line">    <span class="comment">// sendPushDeer(测试主题, 测试文本)</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">toastLog(<span class="string">&quot;监听中, 请在日志中查看记录的通知及其内容&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// =================== ↑↑↑ 主线程：监听通知 ↑↑↑ =====================</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// =================== ↑↑↑ 副线程：循环打卡 ↑↑↑ =====================</span></span><br><span class="line">startRecursiveCard();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">startRecursiveCard</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(recursiveCard)&#123;</span><br><span class="line">        <span class="keyword">var</span> hour = <span class="keyword">new</span> <span class="built_in">Date</span>().getHours()</span><br><span class="line">        <span class="comment">// 直到打卡时间点 启动钉钉</span></span><br><span class="line">        <span class="keyword">while</span>(recursiveCard &amp;&amp; !existsInArray(timeAnchorPoints, hour))&#123;</span><br><span class="line">            <span class="keyword">var</span> randomTime = random(ONE_MIN, FIF_MIN)</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;【循环打卡】未到时间点，进行&quot;</span> + <span class="built_in">Math</span>.floor(randomTime / <span class="number">1000</span>) + <span class="string">&quot;秒随机睡眠...&quot;</span>)</span><br><span class="line">            sleep(randomTime)</span><br><span class="line">            hour = <span class="keyword">new</span> <span class="built_in">Date</span>().getHours()</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        doClock(); <span class="comment">// 打卡</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">Date</span>() + <span class="string">&quot; 【循环打卡】打卡成功&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span>(DEFAULT_MESSAGE_DELIVER == PUSH_METHOD.QQ)&#123;</span><br><span class="line">            sleep(<span class="number">10000</span>) <span class="comment">// 等待默认消息通知程序发送</span></span><br><span class="line">            sendQQMsg(<span class="keyword">new</span> <span class="built_in">Date</span>() + <span class="string">&quot; 【循环打卡】打卡成功&quot;</span>)</span><br><span class="line">            sendServerChan(<span class="string">&quot;【循环打卡】打卡结果&quot;</span>, <span class="keyword">new</span> <span class="built_in">Date</span>() + <span class="string">&quot; 打卡成功&quot;</span>)</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;【循环打卡】QQ&amp;ServerChan 消息发送成功...&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 直到打卡时间点 启动钉钉</span></span><br><span class="line">        <span class="keyword">while</span>(recursiveCard &amp;&amp; existsInArray(timeAnchorPoints, hour))&#123;</span><br><span class="line">            <span class="keyword">var</span> randomTime = random(ONE_MIN, FIF_MIN)</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;【循环打卡】已打卡，进行&quot;</span> + <span class="built_in">Math</span>.floor(randomTime / <span class="number">1000</span>) + <span class="string">&quot;秒随机睡眠...&quot;</span>)</span><br><span class="line">            sleep(randomTime)</span><br><span class="line">            hour = <span class="keyword">new</span> <span class="built_in">Date</span>().getHours()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// =================== ↑↑↑ 副线程：循环打卡 ↑↑↑ =====================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>处理通知</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">notificationHandler</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> packageId = n.getPackageName()  <span class="comment">// 获取通知包名</span></span><br><span class="line">    <span class="keyword">var</span> abstract = n.tickerText         <span class="comment">// 获取通知摘要</span></span><br><span class="line">    <span class="keyword">var</span> text = n.getText()              <span class="comment">// 获取通知文本</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 过滤 PackageId 白名单之外的应用所发出的通知</span></span><br><span class="line">    <span class="keyword">if</span> (!filterNotification(packageId, abstract, text)) &#123; </span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听摘要为 &quot;定时打卡&quot; 的通知, 不一定要从 Tasker 中发出通知, 日历、定时器等App均可实现</span></span><br><span class="line">    <span class="keyword">if</span> (abstract == <span class="string">&quot;定时打卡&quot;</span> &amp;&amp; !suspend) &#123; </span><br><span class="line">        needWaiting = <span class="literal">true</span></span><br><span class="line">        threads.shutDownAll()</span><br><span class="line">        threads.start(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            doClock()</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>(text) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;打卡&quot;</span>: <span class="comment">// 监听文本为 &quot;打卡&quot; 的通知</span></span><br><span class="line">            needWaiting = <span class="literal">false</span></span><br><span class="line">            <span class="comment">// threads.shutDownAll()</span></span><br><span class="line">            threads.start(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                doClock()</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;查询&quot;</span>: <span class="comment">// 监听文本为 &quot;查询&quot; 的通知</span></span><br><span class="line">            <span class="comment">// threads.shutDownAll()</span></span><br><span class="line">            threads.start(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="keyword">switch</span>(DEFAULT_MESSAGE_DELIVER) &#123;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.QQ:</span><br><span class="line">                        sendQQMsg(getStorageData(<span class="string">&quot;dingding&quot;</span>, <span class="string">&quot;clockResult&quot;</span>))</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.Email:</span><br><span class="line">                        sendEmail(<span class="string">&quot;考勤结果&quot;</span>, getStorageData(<span class="string">&quot;dingding&quot;</span>, <span class="string">&quot;clockResult&quot;</span>), <span class="literal">null</span>)</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.ServerChan:</span><br><span class="line">                        sendServerChan(<span class="string">&quot;考勤结果&quot;</span>, getStorageData(<span class="string">&quot;dingding&quot;</span>, <span class="string">&quot;clockResult&quot;</span>))</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.PushDeer:</span><br><span class="line">                        sendPushDeer(<span class="string">&quot;考勤结果&quot;</span>, getStorageData(<span class="string">&quot;dingding&quot;</span>, <span class="string">&quot;clockResult&quot;</span>))</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;暂停&quot;</span>: <span class="comment">// 监听文本为 &quot;暂停&quot; 的通知</span></span><br><span class="line">            suspend = <span class="literal">true</span></span><br><span class="line">            <span class="built_in">console</span>.warn(<span class="string">&quot;暂停定时打卡&quot;</span>)</span><br><span class="line">            threads.shutDownAll()</span><br><span class="line">            threads.start(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="keyword">switch</span>(DEFAULT_MESSAGE_DELIVER) &#123;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.QQ:</span><br><span class="line">                        sendQQMsg(<span class="string">&quot;修改成功, 已暂停定时打卡功能&quot;</span>)</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.Email:</span><br><span class="line">                        sendEmail(<span class="string">&quot;修改成功&quot;</span>, <span class="string">&quot;已暂停定时打卡功能&quot;</span>, <span class="literal">null</span>)</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.ServerChan:</span><br><span class="line">                        sendServerChan(<span class="string">&quot;修改成功&quot;</span>, <span class="string">&quot;已暂停定时打卡功能&quot;</span>)</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.PushDeer:</span><br><span class="line">                        sendPushDeer(<span class="string">&quot;修改成功&quot;</span>, <span class="string">&quot;已暂停定时打卡功能&quot;</span>)</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;恢复&quot;</span>: <span class="comment">// 监听文本为 &quot;恢复&quot; 的通知</span></span><br><span class="line">            suspend = <span class="literal">false</span></span><br><span class="line">            <span class="built_in">console</span>.warn(<span class="string">&quot;恢复定时打卡&quot;</span>)</span><br><span class="line">            threads.shutDownAll()</span><br><span class="line">            threads.start(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="keyword">switch</span>(DEFAULT_MESSAGE_DELIVER) &#123;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.QQ:</span><br><span class="line">                        sendQQMsg(<span class="string">&quot;修改成功, 已恢复定时打卡功能&quot;</span>)</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.Email:</span><br><span class="line">                        sendEmail(<span class="string">&quot;修改成功&quot;</span>, <span class="string">&quot;已恢复定时打卡功能&quot;</span>, <span class="literal">null</span>)</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.ServerChan:</span><br><span class="line">                        sendServerChan(<span class="string">&quot;修改成功&quot;</span>, <span class="string">&quot;已恢复定时打卡功能&quot;</span>)</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.PushDeer:</span><br><span class="line">                        sendPushDeer(<span class="string">&quot;修改成功&quot;</span>, <span class="string">&quot;已恢复定时打卡功能&quot;</span>)</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;日志&quot;</span>: <span class="comment">// 监听文本为 &quot;日志&quot; 的通知</span></span><br><span class="line">            <span class="comment">// threads.shutDownAll()</span></span><br><span class="line">            threads.start(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                sendEmail(<span class="string">&quot;获取日志&quot;</span>, globalLogFilePath, globalLogFilePath)</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;连接&quot;</span>: <span class="comment">// 连接到 Autojs Server</span></span><br><span class="line">            <span class="comment">// threads.shutDownAll()</span></span><br><span class="line">            threads.start(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                connectServer()</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;开启循环&quot;</span>: <span class="comment">// 每天循环打卡 早八晚十</span></span><br><span class="line">            recursiveCard = <span class="literal">true</span></span><br><span class="line">            <span class="built_in">console</span>.warn(<span class="string">&quot;每天循环打卡&quot;</span>)</span><br><span class="line">            threads.shutDownAll()</span><br><span class="line">            threads.start(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="keyword">switch</span>(DEFAULT_MESSAGE_DELIVER) &#123;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.QQ:</span><br><span class="line">                        sendQQMsg(<span class="string">&quot;开启每天循环打卡功能（早八晚十），时间点：&quot;</span> + timeAnchorPoints)</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.Email:</span><br><span class="line">                        sendEmail(<span class="string">&quot;开启每天循环打卡功能（早八晚十），时间点：&quot;</span> + timeAnchorPoints, <span class="literal">null</span>)</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.ServerChan:</span><br><span class="line">                        sendServerChan(<span class="string">&quot;开启循环打卡成功&quot;</span>, <span class="string">&quot;开启每天循环打卡功能（早八晚十），时间点：&quot;</span> + timeAnchorPoints)</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.PushDeer:</span><br><span class="line">                        sendPushDeer(<span class="string">&quot;开启循环打卡成功&quot;</span>, <span class="string">&quot;开启每天循环打卡功能（早八晚十），时间点：&quot;</span> + timeAnchorPoints)</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                startRecursiveCard();</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;关闭循环&quot;</span>: <span class="comment">// 每天循环打卡 早八晚十</span></span><br><span class="line">            recursiveCard = <span class="literal">false</span></span><br><span class="line">            <span class="built_in">console</span>.warn(<span class="string">&quot;关闭每天循环打卡&quot;</span>)</span><br><span class="line">            threads.shutDownAll()</span><br><span class="line">            threads.start(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="keyword">switch</span>(DEFAULT_MESSAGE_DELIVER) &#123;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.QQ:</span><br><span class="line">                        sendQQMsg(<span class="string">&quot;关闭每天循环打卡功能&quot;</span>)</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.Email:</span><br><span class="line">                        sendEmail(<span class="string">&quot;关闭每天循环打卡功能&quot;</span>, <span class="literal">null</span>)</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.ServerChan:</span><br><span class="line">                        sendServerChan(<span class="string">&quot;关闭循环打卡成功&quot;</span>, <span class="string">&quot;关闭每天循环打卡功能&quot;</span>)</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.PushDeer:</span><br><span class="line">                        sendPushDeer(<span class="string">&quot;关闭循环打卡成功&quot;</span>, <span class="string">&quot;关闭每天循环打卡功能&quot;</span>)</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (text == <span class="literal">null</span>) </span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 监听钉钉返回的考勤结果</span></span><br><span class="line">    <span class="comment">// if (packageId == PACKAGE_ID_DD &amp;&amp; text.indexOf(&quot;考勤打卡&quot;) &gt;= 0) &#123; </span></span><br><span class="line">    <span class="keyword">if</span> (packageId == PACKAGE_ID_DD) &#123; </span><br><span class="line">        setStorageData(<span class="string">&quot;dingding&quot;</span>, <span class="string">&quot;clockResult&quot;</span>, text)</span><br><span class="line">        <span class="built_in">console</span>.warn(<span class="string">&quot;监听钉钉返回的消息...&quot;</span>)</span><br><span class="line">        <span class="comment">// threads.shutDownAll()</span></span><br><span class="line">        threads.start(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">switch</span>(DEFAULT_MESSAGE_DELIVER) &#123;</span><br><span class="line">                <span class="keyword">case</span> PUSH_METHOD.QQ:</span><br><span class="line">                    sendQQMsg(text)</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> PUSH_METHOD.Email:</span><br><span class="line">                    sendEmail(<span class="string">&quot;考勤结果&quot;</span>, text, cameraFilePath)</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> PUSH_METHOD.ServerChan:</span><br><span class="line">                    sendServerChan(<span class="string">&quot;考勤结果&quot;</span>, text)</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> PUSH_METHOD.PushDeer:</span><br><span class="line">                    sendPushDeer(<span class="string">&quot;考勤结果&quot;</span>, text)</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>打卡流程</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doClock</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    currentDate = <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;本地时间: &quot;</span> + getCurrentDate() + <span class="string">&quot; &quot;</span> + getCurrentTime())</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;开始打卡流程!&quot;</span>)</span><br><span class="line"></span><br><span class="line">    brightScreen()      <span class="comment">// 唤醒屏幕</span></span><br><span class="line">    unlockScreen()      <span class="comment">// 解锁屏幕</span></span><br><span class="line">    holdOn()            <span class="comment">// 随机等待</span></span><br><span class="line">    signIn()            <span class="comment">// 自动登录</span></span><br><span class="line">    handleLate()        <span class="comment">// 处理迟到</span></span><br><span class="line">    attendKaoqin()      <span class="comment">// 考勤打卡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != textContains(<span class="string">&quot;上班打卡&quot;</span>).findOne(<span class="number">1000</span>)) </span><br><span class="line">    clockIn()           <span class="comment">// 上班打卡</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="literal">null</span> != textContains(<span class="string">&quot;下班打卡&quot;</span>).findOne(<span class="number">1000</span>)) </span><br><span class="line">    clockOut()          <span class="comment">// 下班打卡</span></span><br><span class="line">    </span><br><span class="line">    lockScreen()        <span class="comment">// 关闭屏幕</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>发送邮件流程</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>title 邮件主题</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>message 邮件正文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>attachFilePath 要发送的附件路径</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendEmail</span>(<span class="params">title, message, attachFilePath</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;开始发送邮件流程!&quot;</span>)</span><br><span class="line"></span><br><span class="line">    brightScreen()      <span class="comment">// 唤醒屏幕</span></span><br><span class="line">    unlockScreen()      <span class="comment">// 解锁屏幕</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 内置电子邮件</span></span><br><span class="line">    app.launch(<span class="string">&quot;com.android.email&quot;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;等待邮箱启动...&quot;</span>)</span><br><span class="line">    sleep(<span class="number">3000</span>) <span class="comment">// 等待邮箱启动</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(attachFilePath != <span class="literal">null</span> &amp;&amp; files.exists(attachFilePath)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.info(attachFilePath)</span><br><span class="line">        app.sendEmail(&#123;</span><br><span class="line">            <span class="attr">email</span>: [EMAILL_ADDRESS], <span class="attr">subject</span>: title, <span class="attr">text</span>: message, <span class="attr">attachment</span>: <span class="string">&quot;file://&quot;</span> + attachFilePath</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(attachFilePath)</span><br><span class="line">        app.sendEmail(&#123;</span><br><span class="line">            <span class="attr">email</span>: [EMAILL_ADDRESS], <span class="attr">subject</span>: title, <span class="attr">text</span>: message</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 选择邮箱应用，系统默认应用即可</span></span><br><span class="line">    <span class="keyword">var</span> emailText = text(<span class="string">&quot;电子邮件&quot;</span>).findOne(<span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">null</span> == emailText)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;邮箱应用选择失败...&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    emailText.parent().click();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;邮箱应用选择成功...&quot;</span>)</span><br><span class="line">    sleep(<span class="number">1000</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 点击发送按钮</span></span><br><span class="line">    <span class="keyword">var</span> sendBtn = desc(<span class="string">&quot;发送&quot;</span>).findOne(<span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">null</span> == sendBtn)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;邮箱发送失败...&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    sendBtn.click()</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;正在发送邮件...&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// =============================================================================================================</span></span><br><span class="line">    <span class="comment">// console.log(&quot;选择邮件应用&quot;)</span></span><br><span class="line">    <span class="comment">// waitForActivity(&quot;com.android.internal.app.ChooserActivity&quot;) // 等待选择应用界面弹窗出现, 如果设置了默认应用就注释掉</span></span><br><span class="line">    <span class="comment">// id(&quot;compose_send_btn&quot;).findOne().click()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// var emailAppName = app.getAppName(PACKAGE_ID_MAIL_163)</span></span><br><span class="line">    <span class="comment">// if (null != emailAppName) &#123;</span></span><br><span class="line">    <span class="comment">//     if (null != textMatches(emailAppName).findOne(1000)) &#123;</span></span><br><span class="line">    <span class="comment">//         btn_email = textMatches(emailAppName).findOnce().parent()</span></span><br><span class="line">    <span class="comment">//         btn_email.click()</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// else &#123;</span></span><br><span class="line">    <span class="comment">//     console.error(&quot;不存在应用: &quot; + PACKAGE_ID_MAIL_163)</span></span><br><span class="line">    <span class="comment">//     lockScreen()</span></span><br><span class="line">    <span class="comment">//     return;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// // 网易邮箱大师</span></span><br><span class="line">    <span class="comment">// var versoin = getPackageVersion(PACKAGE_ID_MAIL_163)</span></span><br><span class="line">    <span class="comment">// console.log(&quot;应用版本: &quot; + versoin)</span></span><br><span class="line">    <span class="comment">// var sp = versoin.split(&quot;.&quot;)</span></span><br><span class="line">    <span class="comment">// if (sp[0] == 6) &#123;</span></span><br><span class="line">    <span class="comment">//     // 网易邮箱大师 6</span></span><br><span class="line">    <span class="comment">//     waitForActivity(&quot;com.netease.mobimail.activity.MailComposeActivity&quot;)</span></span><br><span class="line">    <span class="comment">//     id(&quot;send&quot;).findOne().click()</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// else &#123;</span></span><br><span class="line">    <span class="comment">//     // 网易邮箱大师 7</span></span><br><span class="line">    <span class="comment">//     waitForActivity(&quot;com.netease.mobimail.module.mailcompose.MailComposeActivity&quot;)</span></span><br><span class="line">    <span class="comment">//     var input_address = id(&quot;input&quot;).findOne()</span></span><br><span class="line">    <span class="comment">//     if (null == input_address.getText()) &#123;</span></span><br><span class="line">    <span class="comment">//         input_address.setText(EMAILL_ADDRESS)</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">//     id(&quot;iv_arrow&quot;).findOne().click()</span></span><br><span class="line">    <span class="comment">//     sleep(1000)</span></span><br><span class="line">    <span class="comment">//     id(&quot;img_send_bg&quot;).findOne().click()</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    home()</span><br><span class="line">    sleep(<span class="number">2000</span>)</span><br><span class="line">    lockScreen()    <span class="comment">// 关闭屏幕</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>发送QQ消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>message 消息内容</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendQQMsg</span>(<span class="params">message</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;发送QQ消息&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    brightScreen()      <span class="comment">// 唤醒屏幕</span></span><br><span class="line">    unlockScreen()      <span class="comment">// 解锁屏幕</span></span><br><span class="line"></span><br><span class="line">    app.startActivity(&#123; </span><br><span class="line">        <span class="attr">action</span>: <span class="string">&quot;android.intent.action.VIEW&quot;</span>, </span><br><span class="line">        <span class="attr">data</span>:<span class="string">&quot;mqq://im/chat?chat_type=wpa&amp;version=1&amp;src_type=web&amp;uin=&quot;</span> + QQ, </span><br><span class="line">        <span class="attr">packageName</span>: <span class="string">&quot;com.tencent.mobileqq&quot;</span>, </span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// waitForActivity(&quot;com.tencent.mobileqq.activity.SplashActivity&quot;)</span></span><br><span class="line"></span><br><span class="line">    id(<span class="string">&quot;input&quot;</span>).findOne().setText(message)</span><br><span class="line">    id(<span class="string">&quot;fun_btn&quot;</span>).findOne().click()</span><br><span class="line"></span><br><span class="line">    home()</span><br><span class="line">    sleep(<span class="number">1000</span>)</span><br><span class="line">    lockScreen()    <span class="comment">// 关闭屏幕</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>ServerChan推送</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>title 标题</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>message 消息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">sendServerChan</span>(<span class="params">title, message</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;向 ServerChan 发起推送请求&quot;</span>)</span><br><span class="line"></span><br><span class="line">    url = <span class="string">&quot;https://sctapi.ftqq.com/&quot;</span> + SERVER_CHAN + <span class="string">&quot;.send&quot;</span>;</span><br><span class="line"></span><br><span class="line">    res = http.post(<span class="built_in">encodeURI</span>(url), &#123;</span><br><span class="line">        <span class="string">&quot;title&quot;</span>: title,</span><br><span class="line">        <span class="string">&quot;desp&quot;</span>: message</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(res)</span><br><span class="line">    sleep(<span class="number">1000</span>)</span><br><span class="line">    lockScreen()    <span class="comment">// 关闭屏幕</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>PushDeer推送</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>title 标题</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>message 消息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">sendPushDeer</span>(<span class="params">title, message</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;向 PushDeer 发起推送请求&quot;</span>)</span><br><span class="line"></span><br><span class="line">    url = <span class="string">&quot;https://api2.pushdeer.com/message/push&quot;</span></span><br><span class="line"></span><br><span class="line">    res = http.post(<span class="built_in">encodeURI</span>(url), &#123;</span><br><span class="line">        <span class="string">&quot;pushkey&quot;</span>: PUSH_DEER,</span><br><span class="line">        <span class="string">&quot;text&quot;</span>: title,</span><br><span class="line">        <span class="string">&quot;desp&quot;</span>: message,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;markdown&quot;</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(res)</span><br><span class="line">    sleep(<span class="number">1000</span>)</span><br><span class="line">    lockScreen()    <span class="comment">// 关闭屏幕</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>唤醒设备</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">brightScreen</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;唤醒设备&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    device.setBrightnessMode(<span class="number">0</span>) <span class="comment">// 手动亮度模式</span></span><br><span class="line">    device.setBrightness(SCREEN_BRIGHTNESS)</span><br><span class="line">    device.wakeUpIfNeeded() <span class="comment">// 唤醒设备</span></span><br><span class="line">    device.keepScreenOn()   <span class="comment">// 保持亮屏</span></span><br><span class="line">    sleep(<span class="number">1000</span>) <span class="comment">// 等待屏幕亮起</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!device.isScreenOn()) &#123;</span><br><span class="line">        <span class="built_in">console</span>.warn(<span class="string">&quot;设备未唤醒, 重试&quot;</span>)</span><br><span class="line">        device.wakeUpIfNeeded()</span><br><span class="line">        brightScreen()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.info(<span class="string">&quot;设备已唤醒&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">1000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>解锁屏幕</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unlockScreen</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;解锁屏幕&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (isDeviceLocked()) &#123;</span><br><span class="line"></span><br><span class="line">        gesture(</span><br><span class="line">            <span class="number">320</span>, <span class="comment">// 滑动时间：毫秒</span></span><br><span class="line">            [</span><br><span class="line">                device.width  * <span class="number">0.5</span>,    <span class="comment">// 滑动起点 x 坐标：屏幕宽度的一半</span></span><br><span class="line">                device.height * <span class="number">0.9</span>     <span class="comment">// 滑动起点 y 坐标：距离屏幕底部 10% 的位置, 华为系统需要往上一些</span></span><br><span class="line">            ],</span><br><span class="line">            [</span><br><span class="line">                device.width / <span class="number">2</span>,       <span class="comment">// 滑动终点 x 坐标：屏幕宽度的一半</span></span><br><span class="line">                device.height * <span class="number">0.1</span>     <span class="comment">// 滑动终点 y 坐标：距离屏幕顶部 10% 的位置</span></span><br><span class="line">            ]</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        sleep(<span class="number">1000</span>) <span class="comment">// 等待解锁动画完成</span></span><br><span class="line">        home()</span><br><span class="line">        sleep(<span class="number">1000</span>) <span class="comment">// 等待返回动画完成</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isDeviceLocked()) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(<span class="string">&quot;上滑解锁失败, 请按脚本中的注释调整 gesture(time, [x1,y1], [x2,y2]) 方法的参数!&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.info(<span class="string">&quot;屏幕已解锁&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>随机等待</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">holdOn</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!needWaiting) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> randomTime = random(LOWER_BOUND, UPPER_BOUND)</span><br><span class="line">    toastLog(<span class="built_in">Math</span>.floor(randomTime / <span class="number">1000</span>) + <span class="string">&quot;秒后启动&quot;</span> + app.getAppName(PACKAGE_ID_DD) + <span class="string">&quot;...&quot;</span>)</span><br><span class="line">    sleep(randomTime)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>启动并登陆钉钉</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">signIn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    app.launchPackage(PACKAGE_ID_DD)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;正在启动&quot;</span> + app.getAppName(PACKAGE_ID_DD) + <span class="string">&quot;...&quot;</span>)</span><br><span class="line"></span><br><span class="line">    setVolume(<span class="number">0</span>) <span class="comment">// 设备静音</span></span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">10000</span>) <span class="comment">// 等待钉钉启动</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (currentPackage() == PACKAGE_ID_DD &amp;&amp;</span><br><span class="line">        currentActivity() == <span class="string">&quot;com.alibaba.android.user.login.SignUpWithPwdActivity&quot;</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.info(<span class="string">&quot;账号未登录&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> account = id(<span class="string">&quot;et_phone_input&quot;</span>).findOne()</span><br><span class="line">        account.setText(ACCOUNT)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;输入账号&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> password = id(<span class="string">&quot;et_pwd_login&quot;</span>).findOne()</span><br><span class="line">        password.setText(PASSWORD)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;输入密码&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> privacy = id(<span class="string">&quot;cb_privacy&quot;</span>).findOne(<span class="number">1000</span>)</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> != privacy)&#123;</span><br><span class="line">            privacy.click()</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;同意隐私协议&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> btn_login = id(<span class="string">&quot;btn_next&quot;</span>).findOne()</span><br><span class="line">        btn_login.click()</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;正在登陆...&quot;</span>)</span><br><span class="line"></span><br><span class="line">        sleep(<span class="number">3000</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (currentPackage() == PACKAGE_ID_DD &amp;&amp;</span><br><span class="line">        currentActivity() != <span class="string">&quot;com.alibaba.android.user.login.SignUpWithPwdActivity&quot;</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.info(<span class="string">&quot;账号已登录&quot;</span>)</span><br><span class="line">        sleep(<span class="number">1000</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>处理迟到打卡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleLate</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != textMatches(<span class="string">&quot;迟到打卡&quot;</span>).clickable(<span class="literal">true</span>).findOne(<span class="number">1000</span>)) &#123;</span><br><span class="line">        btn_late = textMatches(<span class="string">&quot;迟到打卡&quot;</span>).clickable(<span class="literal">true</span>).findOnce() </span><br><span class="line">        btn_late.click()</span><br><span class="line">        <span class="built_in">console</span>.warn(<span class="string">&quot;迟到打卡&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != descMatches(<span class="string">&quot;迟到打卡&quot;</span>).clickable(<span class="literal">true</span>).findOne(<span class="number">1000</span>)) &#123;</span><br><span class="line">        btn_late = descMatches(<span class="string">&quot;迟到打卡&quot;</span>).clickable(<span class="literal">true</span>).findOnce() </span><br><span class="line">        btn_late.click()</span><br><span class="line">        <span class="built_in">console</span>.warn(<span class="string">&quot;迟到打卡&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>使用 URL Scheme 进入考勤界面</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">attendKaoqin</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> url_scheme = <span class="string">&quot;dingtalk://dingtalkclient/page/link?url=https://attend.dingtalk.com/attend/index.html&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(CORP_ID != <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">        url_scheme = url_scheme + <span class="string">&quot;?corpId=&quot;</span> + CORP_ID</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> a = app.intent(&#123;</span><br><span class="line">        <span class="comment">// action: &quot;VIEW&quot;,</span></span><br><span class="line">        <span class="attr">action</span>: <span class="string">&quot;android.intent.action.VIEW&quot;</span>, </span><br><span class="line">        <span class="attr">data</span>: url_scheme,</span><br><span class="line">        <span class="comment">//flags: [Intent.FLAG_ACTIVITY_NEW_TASK]</span></span><br><span class="line">    &#125;);</span><br><span class="line">    app.startActivity(a);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;正在进入考勤界面...&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    textContains(<span class="string">&quot;申请&quot;</span>).waitFor()</span><br><span class="line">    <span class="built_in">console</span>.info(<span class="string">&quot;已进入考勤界面&quot;</span>)</span><br><span class="line">    sleep(<span class="number">8000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>上班打卡 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">clockIn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;上班打卡...&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if (null != textContains(&quot;已打卡&quot;).findOne(1000)) &#123;</span></span><br><span class="line">    <span class="comment">//     console.info(&quot;已打卡&quot;)</span></span><br><span class="line">    <span class="comment">//     toast(&quot;已打卡&quot;)</span></span><br><span class="line">    <span class="comment">//     home()</span></span><br><span class="line">    <span class="comment">//     sleep(1000)</span></span><br><span class="line">    <span class="comment">//     return;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;等待连接到考勤机...&quot;</span>)</span><br><span class="line">    sleep(<span class="number">2000</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != textContains(<span class="string">&quot;未连接&quot;</span>).findOne(<span class="number">1000</span>)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(<span class="string">&quot;未连接考勤机, 重新进入考勤界面!&quot;</span>)</span><br><span class="line">        back()</span><br><span class="line">        sleep(<span class="number">2000</span>)</span><br><span class="line">        attendKaoqin()</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    textContains(<span class="string">&quot;已连接&quot;</span>).waitFor()</span><br><span class="line">    <span class="built_in">console</span>.info(<span class="string">&quot;已连接考勤机&quot;</span>)</span><br><span class="line">    sleep(<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != textMatches(<span class="string">&quot;上班打卡&quot;</span>).clickable(<span class="literal">true</span>).findOne(<span class="number">1000</span>)) &#123;</span><br><span class="line">        btn_clockin = textMatches(<span class="string">&quot;上班打卡&quot;</span>).clickable(<span class="literal">true</span>).findOnce()</span><br><span class="line">        btn_clockin.click()</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;按下打卡按钮&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        click(device.width / <span class="number">2</span>, device.height * <span class="number">0.560</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;点击打卡按钮坐标&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">1000</span>)</span><br><span class="line">    handleLate() <span class="comment">// 处理迟到打卡</span></span><br><span class="line">    </span><br><span class="line">    home()</span><br><span class="line">    sleep(<span class="number">1000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>下班打卡 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">clockOut</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;下班打卡...&quot;</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;等待连接到考勤机...&quot;</span>)</span><br><span class="line">    sleep(<span class="number">2000</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != textContains(<span class="string">&quot;未连接&quot;</span>).findOne(<span class="number">1000</span>)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(<span class="string">&quot;未连接考勤机, 重新进入考勤界面!&quot;</span>)</span><br><span class="line">        back()</span><br><span class="line">        sleep(<span class="number">2000</span>)</span><br><span class="line">        attendKaoqin()</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    textContains(<span class="string">&quot;已连接&quot;</span>).waitFor()</span><br><span class="line">    <span class="built_in">console</span>.info(<span class="string">&quot;已连接考勤机&quot;</span>)</span><br><span class="line">    sleep(<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != textMatches(<span class="string">&quot;下班打卡&quot;</span>).clickable(<span class="literal">true</span>).findOne(<span class="number">1000</span>)) &#123;</span><br><span class="line">        btn_clockout = textMatches(<span class="string">&quot;下班打卡&quot;</span>).clickable(<span class="literal">true</span>).findOnce()</span><br><span class="line">        btn_clockout.click()</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;按下打卡按钮&quot;</span>)</span><br><span class="line">        sleep(<span class="number">1000</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        click(device.width / <span class="number">2</span>, device.height * <span class="number">0.560</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;点击打卡按钮坐标&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != textContains(<span class="string">&quot;早退打卡&quot;</span>).clickable(<span class="literal">true</span>).findOne(<span class="number">1000</span>)) &#123;</span><br><span class="line">        className(<span class="string">&quot;android.widget.Button&quot;</span>).text(<span class="string">&quot;早退打卡&quot;</span>).clickable(<span class="literal">true</span>).findOnce().parent().click()</span><br><span class="line">        <span class="built_in">console</span>.warn(<span class="string">&quot;早退打卡&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    home()</span><br><span class="line">    sleep(<span class="number">1000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>锁屏</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">lockScreen</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;关闭屏幕&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 锁屏方案1：Root</span></span><br><span class="line">    <span class="comment">// Power()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 锁屏方案2：No Root</span></span><br><span class="line">    <span class="comment">// press(Math.floor(device.width / 2), Math.floor(device.height * 0.973), 1000) // 小米的快捷手势：长按Home键锁屏</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 万能锁屏方案：向Tasker发送广播, 触发系统锁屏动作。配置方法见 2021-03-09 更新日志</span></span><br><span class="line">    app.sendBroadcast(&#123;<span class="attr">action</span>: ACTION_LOCK_SCREEN&#125;);</span><br><span class="line"></span><br><span class="line">    device.setBrightnessMode(<span class="number">1</span>) <span class="comment">// 自动亮度模式</span></span><br><span class="line">    device.cancelKeepingAwake() <span class="comment">// 取消设备常亮</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (isDeviceLocked()) &#123;</span><br><span class="line">        <span class="built_in">console</span>.info(<span class="string">&quot;屏幕已关闭&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(<span class="string">&quot;屏幕未关闭, 请尝试其他锁屏方案, 或等待屏幕自动关闭&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>连接 AutoJs Server</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">connectServer</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;开始连接 AutoJs Server!&quot;</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;本地时间: &quot;</span> + getCurrentDate() + <span class="string">&quot; &quot;</span> + getCurrentTime())</span><br><span class="line"></span><br><span class="line">    brightScreen()      <span class="comment">// 唤醒屏幕</span></span><br><span class="line">    unlockScreen()      <span class="comment">// 解锁屏幕</span></span><br><span class="line"></span><br><span class="line">    connectAutoJsServer() <span class="comment">// 连接 AutoJs Server</span></span><br><span class="line">    </span><br><span class="line">    lockScreen()        <span class="comment">// 关闭屏幕</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>启动 AutoJs Server 整体流程</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">connectAutoJsServer</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    launchApp(<span class="string">&quot;Auto.js&quot;</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;正在启动 Auto.js...&quot;</span>)</span><br><span class="line">    sleep(<span class="number">10000</span>) <span class="comment">// 等待 Auto.js 启动</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打开侧拉菜单</span></span><br><span class="line">    <span class="keyword">var</span> menuBtn = className(<span class="string">&quot;android.widget.ImageButton&quot;</span>).desc(<span class="string">&quot;打开侧拉菜单&quot;</span>).clickable(<span class="literal">true</span>).findOne(<span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">null</span> != menuBtn)&#123;</span><br><span class="line">        menuBtn.click();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;打开侧拉菜单...&quot;</span>)</span><br><span class="line">    sleep(<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 滚动屏幕找到连接电脑按钮</span></span><br><span class="line">    <span class="keyword">var</span> menu = id(<span class="string">&quot;drawer_menu&quot;</span>).findOne(<span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">null</span> == menu)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;滚动屏幕未找到连接电脑按钮...&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    menu.scrollForward()</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;滚动屏幕找到连接电脑按钮...&quot;</span>)</span><br><span class="line">    sleep(<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 连接电脑</span></span><br><span class="line">    <span class="keyword">var</span> textCon = className(<span class="string">&quot;android.widget.TextView&quot;</span>).text(<span class="string">&quot;连接电脑&quot;</span>).findOne(<span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">null</span> != textCon)&#123;</span><br><span class="line">        <span class="comment">// 寻找按钮（Switch）</span></span><br><span class="line">        <span class="keyword">var</span> layerCon = textCon.parent();</span><br><span class="line">        <span class="keyword">var</span> switchBtn = layerCon.children().findOne(className(<span class="string">&quot;android.widget.Switch&quot;</span>));</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;找到连接电脑按钮，按钮状态为：&quot;</span> + switchBtn.text() + <span class="string">&quot; &quot;</span> + switchBtn.checked() +  <span class="string">&quot;...&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span>(switchBtn.checked() == <span class="literal">false</span>)&#123;</span><br><span class="line">            <span class="comment">// 按下按钮</span></span><br><span class="line">            switchBtn.click();</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;开始连接电脑...&quot;</span>)</span><br><span class="line">            sleep(<span class="number">2000</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 点击确定</span></span><br><span class="line">            <span class="keyword">var</span> okBtn = text(<span class="string">&quot;确定&quot;</span>).findOne(<span class="number">1000</span>);</span><br><span class="line">            okBtn.click();</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;连接电脑成功...&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    sleep(<span class="number">1000</span>) <span class="comment">// 等待解锁动画完成</span></span><br><span class="line">    home()</span><br><span class="line">    sleep(<span class="number">1000</span>) <span class="comment">// 等待返回动画完成</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// console.log(&quot;==========================================================&quot;);</span></span><br><span class="line">    <span class="comment">// id(&quot;drawer_menu&quot;).findOne().children().forEach(child =&gt; &#123;</span></span><br><span class="line">    <span class="comment">//     var target = child.findOne(id(&quot;sw&quot;));</span></span><br><span class="line">    <span class="comment">//     console.log(target);</span></span><br><span class="line">    <span class="comment">//     &#125;);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ===================== ↓↓↓ 功能函数 ↓↓↓ =======================</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dateDigitToString</span>(<span class="params">num</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> num &lt; <span class="number">10</span> ? <span class="string">&#x27;0&#x27;</span> + num : num</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCurrentTime</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> currentDate = <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">    <span class="keyword">var</span> hours = dateDigitToString(currentDate.getHours())</span><br><span class="line">    <span class="keyword">var</span> minute = dateDigitToString(currentDate.getMinutes())</span><br><span class="line">    <span class="keyword">var</span> second = dateDigitToString(currentDate.getSeconds())</span><br><span class="line">    <span class="keyword">var</span> formattedTimeString = hours + <span class="string">&#x27;:&#x27;</span> + minute + <span class="string">&#x27;:&#x27;</span> + second</span><br><span class="line">    <span class="keyword">return</span> formattedTimeString</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCurrentDate</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> currentDate = <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">    <span class="keyword">var</span> year = dateDigitToString(currentDate.getFullYear())</span><br><span class="line">    <span class="keyword">var</span> month = dateDigitToString(currentDate.getMonth() + <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">var</span> date = dateDigitToString(currentDate.getDate())</span><br><span class="line">    <span class="keyword">var</span> week = currentDate.getDay()</span><br><span class="line">    <span class="keyword">var</span> formattedDateString = year + <span class="string">&#x27;-&#x27;</span> + month + <span class="string">&#x27;-&#x27;</span> + date + <span class="string">&#x27;-&#x27;</span> + WEEK_DAY[week]</span><br><span class="line">    <span class="keyword">return</span> formattedDateString</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">existsInArray</span>(<span class="params">arr, element</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;arr.length; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(arr[i] == element) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通知过滤器</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filterNotification</span>(<span class="params">bundleId, abstract, text</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> check = PACKAGE_ID_WHITE_LIST.some(<span class="function"><span class="keyword">function</span>(<span class="params">item</span>) </span>&#123;<span class="keyword">return</span> bundleId == item&#125;) </span><br><span class="line">    <span class="keyword">if</span> (!NOTIFICATIONS_FILTER || check) &#123;</span><br><span class="line">        <span class="built_in">console</span>.verbose(bundleId)</span><br><span class="line">        <span class="built_in">console</span>.verbose(abstract)</span><br><span class="line">        <span class="built_in">console</span>.verbose(text)</span><br><span class="line">        <span class="built_in">console</span>.verbose(<span class="string">&quot;---------------------------&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span> </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 保存本地数据</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setStorageData</span>(<span class="params">name, key, value</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> storage = storages.create(name)  <span class="comment">// 创建storage对象</span></span><br><span class="line">    storage.put(key, value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取本地数据</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getStorageData</span>(<span class="params">name, key</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> storage = storages.create(name)</span><br><span class="line">    <span class="keyword">if</span> (storage.contains(key)) &#123;</span><br><span class="line">        <span class="keyword">return</span> storage.get(key, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 默认返回undefined</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除本地数据</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">delStorageData</span>(<span class="params">name, key</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> storage = storages.create(name)</span><br><span class="line">    <span class="keyword">if</span> (storage.contains(key)) &#123;</span><br><span class="line">        storage.remove(key)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取应用版本号</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPackageVersion</span>(<span class="params">bundleId</span>) </span>&#123;</span><br><span class="line">    importPackage(android.content)</span><br><span class="line">    <span class="keyword">var</span> pckMan = context.getPackageManager()</span><br><span class="line">    <span class="keyword">var</span> packageInfo = pckMan.getPackageInfo(bundleId, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> packageInfo.versionName</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 屏幕是否为锁定状态</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isDeviceLocked</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    importClass(android.app.KeyguardManager)</span><br><span class="line">    importClass(android.content.Context)</span><br><span class="line">    <span class="keyword">var</span> km = context.getSystemService(Context.KEYGUARD_SERVICE)</span><br><span class="line">    <span class="keyword">return</span> km.isKeyguardLocked()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置媒体和通知音量</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setVolume</span>(<span class="params">volume</span>) </span>&#123;</span><br><span class="line">    device.setMusicVolume(volume)</span><br><span class="line">    device.setNotificationVolume(volume)</span><br><span class="line">    <span class="built_in">console</span>.verbose(<span class="string">&quot;媒体音量:&quot;</span> + device.getMusicVolume())</span><br><span class="line">    <span class="built_in">console</span>.verbose(<span class="string">&quot;通知音量:&quot;</span> + device.getNotificationVolume())</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="Auto-js-VSCodeExt-README"><a href="#Auto-js-VSCodeExt-README" class="headerlink" title="Auto.js-VSCodeExt README"></a>Auto.js-VSCodeExt README</h1><p>桌面编辑器Visual Studio Code的插件。可以让Visual Studio Code支持<a target="_blank" rel="noopener" href="https://github.com/hyb1996/NoRootScriptDroid">Auto.js</a>开发。</p>
<h2 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h2><p>在VS Code中菜单”查看”-&gt;”扩展”-&gt;输入”Auto.js”或”hyb1996”搜索，即可看到”Auto.js-VSCodeExt”插件，安装即可。插件的更新也可以在这里更新。</p>
<h2 id="Features"><a href="#Features" class="headerlink" title="Features"></a>Features</h2><p>目前功能比较基础，仅支持：</p>
<ul>
<li>在VS Code的开发者工具实时显示Auto.js的日志与输出</li>
<li>在VS Code命令中增加Run, Stop, Rerun, Stop all等选项。可以在手机与电脑连接后把Sublime编辑器中的脚本推送到AutoJs中执行，或者停止AutoJs中运行的脚本。</li>
</ul>
<h2 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h2><h3 id="Step-1"><a href="#Step-1" class="headerlink" title="Step 1"></a>Step 1</h3><p>按 <code>Ctrl+Shift+P</code> 或点击”查看”-&gt;”命令面板”可调出命令面板，输入 <code>Auto.js</code> 可以看到几个命令，移动光标到命令<code>Auto.js: Start Server</code>，按回车键执行该命令。</p>
<p>此时VS Code会在右上角显示”Auto.js server running”，即开启服务成功。</p>
<h3 id="Step-2"><a href="#Step-2" class="headerlink" title="Step 2"></a>Step 2</h3><p>将手机连接到电脑启用的Wifi或者同一局域网中。通过命令行ipconfig(或者其他操作系统的相同功能命令)查看电脑的IP地址。在<a target="_blank" rel="noopener" href="https://github.com/hyb1996/Auto.js">Auto.js</a>的侧拉菜单中启用调试服务，并输入IP地址，等待连接成功。</p>
<h3 id="Step-3"><a href="#Step-3" class="headerlink" title="Step 3"></a>Step 3</h3><p>之后就可以在电脑上编辑JavaScript文件并通过命令<code>Run</code>或者按键<code>F5</code>在手机上运行了。</p>
<h2 id="Commands"><a href="#Commands" class="headerlink" title="Commands"></a>Commands</h2><p>按 <code>Ctrl+Shift+P</code> 或点击”查看”-&gt;”命令面板”可调出命令面板，输入 <code>Auto.js</code> 可以看到几个命令：</p>
<ul>
<li>Start Server: 启动插件服务。之后在确保手机和电脑在同一区域网的情况下，在Auto.js的侧拉菜单中使用连接电脑功能连接。</li>
<li>Stop Server: 停止插件服务。</li>
<li>Run 运行当前编辑器的脚本。如果有多个设备连接，则在所有设备运行。</li>
<li>Rerun 停止当前文件对应的脚本并重新运行。如果有多个设备连接，则在所有设备重新运行。</li>
<li>Stop 停止当前文件对应的脚本。如果有多个设备连接，则在所有设备停止。</li>
<li>StopAll 停止所有正在运行的脚本。如果有多个设备连接，则在所有设备运行所有脚本。</li>
<li>Save 保存当前文件到手机的脚本默认目录（文件名会加上前缀remote)。如果有多个设备连接，则在所有设备保存。</li>
<li>RunOnDevice: 弹出设备菜单并在指定设备运行脚本。</li>
<li>SaveToDevice: 弹出设备菜单并在指定设备保存脚本。</li>
<li>New Project（新建项目）：选择一个空文件夹（或者在文件管理器中新建一个空文件夹），将会自动创建一个项目</li>
<li>Run Project（运行项目）：运行一个项目，需要Auto.js 4.0.4Alpha5以上支持</li>
<li>Save Project（保存项目）：保存一个项目，需要Auto.js 4.0.4Alpha5以上支持</li>
</ul>
<p>以上命令一些有对应的快捷键，参照命令后面的说明即可。</p>
<h2 id="Log"><a href="#Log" class="headerlink" title="Log"></a>Log</h2><p>要显示来自Auto.js的日志，打开 VS Code上面菜单的”帮助”-&gt;”切换开发人员工具”-&gt;”Console”即可。</p>
<h1 id="钉钉打卡脚本原文"><a href="#钉钉打卡脚本原文" class="headerlink" title="钉钉打卡脚本原文"></a>钉钉打卡脚本原文</h1><h2 id="⏰-DingDing-Automatic-Clock-in"><a href="#⏰-DingDing-Automatic-Clock-in" class="headerlink" title="⏰ DingDing-Automatic-Clock-in"></a>⏰ DingDing-Automatic-Clock-in</h2><img width="796" src="https://user-images.githubusercontent.com/49583943/138620009-32d16b4a-d38b-4cb7-9650-db7f45f14520.png"/>

<h2 id="📖-简介"><a href="#📖-简介" class="headerlink" title="📖 简介"></a>📖 简介</h2><p>钉钉全自动打卡 + 远程打卡脚本，无需 root，基于 auto.js，适用于蓝牙考勤机。</p>
<h2 id="💥-功能"><a href="#💥-功能" class="headerlink" title="💥 功能"></a>💥 功能</h2><ul>
<li>定时打卡</li>
<li>远程打卡</li>
<li>发送考勤结果</li>
</ul>
<h2 id="⚙️-工具"><a href="#⚙️-工具" class="headerlink" title="⚙️ 工具"></a>⚙️ 工具</h2><ul>
<li>auto.js</li>
<li>Tasker</li>
<li>一款通讯应用（示例脚本中使用的是 QQ / 网易邮箱大师 / ServerChan / PushDeer，彼此互为备用方案）</li>
</ul>
<h2 id="💡-原理"><a href="#💡-原理" class="headerlink" title="💡 原理"></a>💡 原理</h2><p>通过 auto.js 脚本监听本机通知，在 Tasker 中创建定时任务，发出通知，或在另一设备上发送消息到本机，即可触发脚本中的打卡进程，实现定时打卡和远程打卡。</p>
<p><img src="https://user-images.githubusercontent.com/49583943/163506300-7ef7693b-a273-442f-8449-dcef31063069.png" alt="image"></p>
<p>同理，监听到钉钉发出的打卡成功通知后，将通知文本通过 QQ消息 或 邮件正文 发送，实现发送考勤结果的功能。</p>
<h2 id="📝-脚本"><a href="#📝-脚本" class="headerlink" title="📝 脚本"></a>📝 脚本</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @Author: George Huan</span></span><br><span class="line"><span class="comment"> * @Date: 2020-08-03 09:30:30</span></span><br><span class="line"><span class="comment"> * @LastEditTime: 2022-03-26 10:56:25</span></span><br><span class="line"><span class="comment"> * @Description: DingDing-Automatic-Clock-in (Run on AutoJs)</span></span><br><span class="line"><span class="comment"> * @URL: https://github.com/georgehuan1994/DingDing-Automatic-Clock-in</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ACCOUNT = <span class="string">&quot;钉钉账号&quot;</span></span><br><span class="line"><span class="keyword">const</span> PASSWORD = <span class="string">&quot;钉钉密码&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> QQ =              <span class="string">&quot;用于接收打卡结果的QQ号&quot;</span></span><br><span class="line"><span class="keyword">const</span> EMAILL_ADDRESS =  <span class="string">&quot;用于接收打卡结果的邮箱地址&quot;</span></span><br><span class="line"><span class="keyword">const</span> SERVER_CHAN =     <span class="string">&quot;Server酱发送密钥&quot;</span></span><br><span class="line"><span class="keyword">const</span> PUSH_DEER =       <span class="string">&quot;PushDeer发送密钥&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PUSH_METHOD = &#123;<span class="attr">QQ</span>: <span class="number">1</span>, <span class="attr">Email</span>: <span class="number">2</span>, <span class="attr">ServerChan</span>: <span class="number">3</span>, <span class="attr">PushDeer</span>: <span class="number">4</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 默认通信方式：</span></span><br><span class="line"><span class="comment">// PUSH_METHOD.QQ -- QQ</span></span><br><span class="line"><span class="comment">// PUSH_METHOD.Email -- Email </span></span><br><span class="line"><span class="comment">// PUSH_METHOD.ServerChan -- Server酱</span></span><br><span class="line"><span class="comment">// PUSH_METHOD.PushDeer -- Push Deer</span></span><br><span class="line"><span class="keyword">var</span> DEFAULT_MESSAGE_DELIVER = PUSH_METHOD.QQ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PACKAGE_ID_QQ = <span class="string">&quot;com.tencent.mobileqq&quot;</span>                <span class="comment">// QQ</span></span><br><span class="line"><span class="keyword">const</span> PACKAGE_ID_DD = <span class="string">&quot;com.alibaba.android.rimet&quot;</span>           <span class="comment">// 钉钉</span></span><br><span class="line"><span class="keyword">const</span> PACKAGE_ID_XMSF = <span class="string">&quot;com.xiaomi.xmsf&quot;</span>                   <span class="comment">// 小米推送服务</span></span><br><span class="line"><span class="keyword">const</span> PACKAGE_ID_TASKER = <span class="string">&quot;net.dinglisch.android.taskerm&quot;</span>   <span class="comment">// Tasker</span></span><br><span class="line"><span class="keyword">const</span> PACKAGE_ID_MAIL_163 = <span class="string">&quot;com.netease.mail&quot;</span>              <span class="comment">// 网易邮箱大师</span></span><br><span class="line"><span class="keyword">const</span> PACKAGE_ID_MAIL_ANDROID = <span class="string">&quot;com.android.email&quot;</span>         <span class="comment">// 系统内置邮箱</span></span><br><span class="line"><span class="keyword">const</span> PACKAGE_ID_PUSHDEER = <span class="string">&quot;com.pushdeer.os&quot;</span>               <span class="comment">// Push Deer</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> LOWER_BOUND = <span class="number">1</span> * <span class="number">60</span> * <span class="number">1000</span> <span class="comment">// 最小等待时间：1min</span></span><br><span class="line"><span class="keyword">const</span> UPPER_BOUND = <span class="number">5</span> * <span class="number">60</span> * <span class="number">1000</span> <span class="comment">// 最大等待时间：5min</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行时的屏幕亮度（0-255）, 需要&quot;修改系统设置&quot;权限</span></span><br><span class="line"><span class="keyword">const</span> SCREEN_BRIGHTNESS = <span class="number">20</span>    </span><br><span class="line"></span><br><span class="line"><span class="comment">// 是否过滤通知</span></span><br><span class="line"><span class="keyword">const</span> NOTIFICATIONS_FILTER = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// PackageId白名单</span></span><br><span class="line"><span class="keyword">const</span> PACKAGE_ID_WHITE_LIST = [PACKAGE_ID_QQ,PACKAGE_ID_DD,PACKAGE_ID_XMSF,PACKAGE_ID_MAIL_163,PACKAGE_ID_TASKER,PACKAGE_ID_PUSHDEER]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 公司的钉钉CorpId, 获取方法见 2020-09-24 更新日志。如果只加入了一家公司, 可以不填</span></span><br><span class="line"><span class="keyword">const</span> CORP_ID = <span class="string">&quot;&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">// 锁屏意图, 配合 Tasker 完成锁屏动作, 具体配置方法见 2021-03-09 更新日志</span></span><br><span class="line"><span class="keyword">const</span> ACTION_LOCK_SCREEN = <span class="string">&quot;autojs.intent.action.LOCK_SCREEN&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听音量+键, 开启后无法通过音量+键调整音量, 按下音量+键：结束所有子线程</span></span><br><span class="line"><span class="keyword">const</span> OBSERVE_VOLUME_KEY = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> WEEK_DAY = [<span class="string">&quot;Sunday&quot;</span>,<span class="string">&quot;Monday&quot;</span>,<span class="string">&quot;Tuesday&quot;</span>,<span class="string">&quot;Wednesday&quot;</span>,<span class="string">&quot;Thursday&quot;</span>,<span class="string">&quot;Friday&quot;</span>,<span class="string">&quot;Saturday&quot;</span>,]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// =================== ↓↓↓ 主线程：监听通知 ↓↓↓ ====================</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> currentDate = <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 是否暂停定时打卡</span></span><br><span class="line"><span class="keyword">var</span> suspend = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 本次打开钉钉前是否需要等待</span></span><br><span class="line"><span class="keyword">var</span> needWaiting = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行日志路径</span></span><br><span class="line"><span class="keyword">var</span> globalLogFilePath = <span class="string">&quot;/sdcard/脚本/Archive/&quot;</span> + getCurrentDate() + <span class="string">&quot;-log.txt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查无障碍权限</span></span><br><span class="line">auto.waitFor(<span class="string">&quot;normal&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查Autojs版本</span></span><br><span class="line">requiresAutojsVersion(<span class="string">&quot;4.1.0&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建运行日志</span></span><br><span class="line"><span class="built_in">console</span>.setGlobalLogConfig(&#123;</span><br><span class="line">    <span class="attr">file</span>: <span class="string">&quot;/sdcard/脚本/Archive/&quot;</span> + getCurrentDate() + <span class="string">&quot;-log.txt&quot;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听本机通知</span></span><br><span class="line">events.observeNotification()    </span><br><span class="line">events.on(<span class="string">&quot;notification&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">    notificationHandler(n)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">events.setKeyInterceptionEnabled(<span class="string">&quot;volume_up&quot;</span>, OBSERVE_VOLUME_KEY)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (OBSERVE_VOLUME_KEY) &#123;</span><br><span class="line">    events.observeKey()</span><br><span class="line">&#125;;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 监听音量+键</span></span><br><span class="line">events.onKeyDown(<span class="string">&quot;volume_up&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">    threads.shutDownAll()</span><br><span class="line">    device.setBrightnessMode(<span class="number">1</span>)</span><br><span class="line">    device.cancelKeepingAwake()</span><br><span class="line">    toast(<span class="string">&quot;已中断所有子线程!&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可以在此调试各个方法</span></span><br><span class="line">    <span class="comment">// doClock()</span></span><br><span class="line">    <span class="comment">// sendQQMsg(&quot;测试文本&quot;)</span></span><br><span class="line">    <span class="comment">// sendEmail(&quot;测试主题&quot;, &quot;测试文本&quot;, null)</span></span><br><span class="line">    <span class="comment">// sendServerChan(测试主题, 测试文本)</span></span><br><span class="line">    <span class="comment">// sendPushDeer(测试主题, 测试文本)</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">toastLog(<span class="string">&quot;监听中, 请在日志中查看记录的通知及其内容&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// =================== ↑↑↑ 主线程：监听通知 ↑↑↑ =====================</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>处理通知</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">notificationHandler</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> packageId = n.getPackageName()  <span class="comment">// 获取通知包名</span></span><br><span class="line">    <span class="keyword">var</span> abstract = n.tickerText         <span class="comment">// 获取通知摘要</span></span><br><span class="line">    <span class="keyword">var</span> text = n.getText()              <span class="comment">// 获取通知文本</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 过滤 PackageId 白名单之外的应用所发出的通知</span></span><br><span class="line">    <span class="keyword">if</span> (!filterNotification(packageId, abstract, text)) &#123; </span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听摘要为 &quot;定时打卡&quot; 的通知, 不一定要从 Tasker 中发出通知, 日历、定时器等App均可实现</span></span><br><span class="line">    <span class="keyword">if</span> (abstract == <span class="string">&quot;定时打卡&quot;</span> &amp;&amp; !suspend) &#123; </span><br><span class="line">        needWaiting = <span class="literal">true</span></span><br><span class="line">        threads.shutDownAll()</span><br><span class="line">        threads.start(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            doClock()</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>(text) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;打卡&quot;</span>: <span class="comment">// 监听文本为 &quot;打卡&quot; 的通知</span></span><br><span class="line">            needWaiting = <span class="literal">false</span></span><br><span class="line">            threads.shutDownAll()</span><br><span class="line">            threads.start(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                doClock()</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;查询&quot;</span>: <span class="comment">// 监听文本为 &quot;查询&quot; 的通知</span></span><br><span class="line">            threads.shutDownAll()</span><br><span class="line">            threads.start(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="keyword">switch</span>(DEFAULT_MESSAGE_DELIVER) &#123;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.QQ:</span><br><span class="line">                        sendQQMsg(getStorageData(<span class="string">&quot;dingding&quot;</span>, <span class="string">&quot;clockResult&quot;</span>))</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.Email:</span><br><span class="line">                        sendEmail(<span class="string">&quot;考勤结果&quot;</span>, getStorageData(<span class="string">&quot;dingding&quot;</span>, <span class="string">&quot;clockResult&quot;</span>), <span class="literal">null</span>)</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.ServerChan:</span><br><span class="line">                        sendServerChan(<span class="string">&quot;考勤结果&quot;</span>, getStorageData(<span class="string">&quot;dingding&quot;</span>, <span class="string">&quot;clockResult&quot;</span>))</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.PushDeer:</span><br><span class="line">                        sendPushDeer(<span class="string">&quot;考勤结果&quot;</span>, getStorageData(<span class="string">&quot;dingding&quot;</span>, <span class="string">&quot;clockResult&quot;</span>))</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;暂停&quot;</span>: <span class="comment">// 监听文本为 &quot;暂停&quot; 的通知</span></span><br><span class="line">            suspend = <span class="literal">true</span></span><br><span class="line">            <span class="built_in">console</span>.warn(<span class="string">&quot;暂停定时打卡&quot;</span>)</span><br><span class="line">            threads.shutDownAll()</span><br><span class="line">            threads.start(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="keyword">switch</span>(DEFAULT_MESSAGE_DELIVER) &#123;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.QQ:</span><br><span class="line">                        sendQQMsg(<span class="string">&quot;修改成功, 已暂停定时打卡功能&quot;</span>)</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.Email:</span><br><span class="line">                        sendEmail(<span class="string">&quot;修改成功&quot;</span>, <span class="string">&quot;已暂停定时打卡功能&quot;</span>, <span class="literal">null</span>)</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.ServerChan:</span><br><span class="line">                        sendServerChan(<span class="string">&quot;修改成功&quot;</span>, <span class="string">&quot;已暂停定时打卡功能&quot;</span>)</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.PushDeer:</span><br><span class="line">                        sendPushDeer(<span class="string">&quot;修改成功&quot;</span>, <span class="string">&quot;已暂停定时打卡功能&quot;</span>)</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;恢复&quot;</span>: <span class="comment">// 监听文本为 &quot;恢复&quot; 的通知</span></span><br><span class="line">            suspend = <span class="literal">false</span></span><br><span class="line">            <span class="built_in">console</span>.warn(<span class="string">&quot;恢复定时打卡&quot;</span>)</span><br><span class="line">            threads.shutDownAll()</span><br><span class="line">            threads.start(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="keyword">switch</span>(DEFAULT_MESSAGE_DELIVER) &#123;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.QQ:</span><br><span class="line">                        sendQQMsg(<span class="string">&quot;修改成功, 已恢复定时打卡功能&quot;</span>)</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.Email:</span><br><span class="line">                        sendEmail(<span class="string">&quot;修改成功&quot;</span>, <span class="string">&quot;已恢复定时打卡功能&quot;</span>, <span class="literal">null</span>)</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.ServerChan:</span><br><span class="line">                        sendServerChan(<span class="string">&quot;修改成功&quot;</span>, <span class="string">&quot;已恢复定时打卡功能&quot;</span>)</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> PUSH_METHOD.PushDeer:</span><br><span class="line">                        sendPushDeer(<span class="string">&quot;修改成功&quot;</span>, <span class="string">&quot;已恢复定时打卡功能&quot;</span>)</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;日志&quot;</span>: <span class="comment">// 监听文本为 &quot;日志&quot; 的通知</span></span><br><span class="line">            threads.shutDownAll()</span><br><span class="line">            threads.start(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                sendEmail(<span class="string">&quot;获取日志&quot;</span>, globalLogFilePath, globalLogFilePath)</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (text == <span class="literal">null</span>) </span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 监听钉钉返回的考勤结果</span></span><br><span class="line">    <span class="keyword">if</span> (packageId == PACKAGE_ID_DD &amp;&amp; text.indexOf(<span class="string">&quot;考勤打卡&quot;</span>) &gt;= <span class="number">0</span>) &#123; </span><br><span class="line">        setStorageData(<span class="string">&quot;dingding&quot;</span>, <span class="string">&quot;clockResult&quot;</span>, text)</span><br><span class="line">        threads.shutDownAll()</span><br><span class="line">        threads.start(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">switch</span>(DEFAULT_MESSAGE_DELIVER) &#123;</span><br><span class="line">                <span class="keyword">case</span> PUSH_METHOD.QQ:</span><br><span class="line">                    sendQQMsg(text)</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> PUSH_METHOD.Email:</span><br><span class="line">                    sendEmail(<span class="string">&quot;考勤结果&quot;</span>, text, cameraFilePath)</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> PUSH_METHOD.ServerChan:</span><br><span class="line">                    sendServerChan(<span class="string">&quot;考勤结果&quot;</span>, text)</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> PUSH_METHOD.PushDeer:</span><br><span class="line">                    sendPushDeer(<span class="string">&quot;考勤结果&quot;</span>, text)</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>打卡流程</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doClock</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    currentDate = <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;本地时间: &quot;</span> + getCurrentDate() + <span class="string">&quot; &quot;</span> + getCurrentTime())</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;开始打卡流程!&quot;</span>)</span><br><span class="line"></span><br><span class="line">    brightScreen()      <span class="comment">// 唤醒屏幕</span></span><br><span class="line">    unlockScreen()      <span class="comment">// 解锁屏幕</span></span><br><span class="line">    holdOn()            <span class="comment">// 随机等待</span></span><br><span class="line">    signIn()            <span class="comment">// 自动登录</span></span><br><span class="line">    handleLate()        <span class="comment">// 处理迟到</span></span><br><span class="line">    attendKaoqin()      <span class="comment">// 考勤打卡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (currentDate.getHours() &lt;= <span class="number">12</span>) </span><br><span class="line">    clockIn()           <span class="comment">// 上班打卡</span></span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">    clockOut()          <span class="comment">// 下班打卡</span></span><br><span class="line">    </span><br><span class="line">    lockScreen()        <span class="comment">// 关闭屏幕</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>发送邮件流程</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>title 邮件主题</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>message 邮件正文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>attachFilePath 要发送的附件路径</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendEmail</span>(<span class="params">title, message, attachFilePath</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;开始发送邮件流程!&quot;</span>)</span><br><span class="line"></span><br><span class="line">    brightScreen()      <span class="comment">// 唤醒屏幕</span></span><br><span class="line">    unlockScreen()      <span class="comment">// 解锁屏幕</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(attachFilePath != <span class="literal">null</span> &amp;&amp; files.exists(attachFilePath)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.info(attachFilePath)</span><br><span class="line">        app.sendEmail(&#123;</span><br><span class="line">            <span class="attr">email</span>: [EMAILL_ADDRESS], <span class="attr">subject</span>: title, <span class="attr">text</span>: message, <span class="attr">attachment</span>: attachFilePath</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(attachFilePath)</span><br><span class="line">        app.sendEmail(&#123;</span><br><span class="line">            <span class="attr">email</span>: [EMAILL_ADDRESS], <span class="attr">subject</span>: title, <span class="attr">text</span>: message</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;选择邮件应用&quot;</span>)</span><br><span class="line">    waitForActivity(<span class="string">&quot;com.android.internal.app.ChooserActivity&quot;</span>) <span class="comment">// 等待选择应用界面弹窗出现, 如果设置了默认应用就注释掉</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> emailAppName = app.getAppName(PACKAGE_ID_MAIL_163)</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != emailAppName) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != textMatches(emailAppName).findOne(<span class="number">1000</span>)) &#123;</span><br><span class="line">            btn_email = textMatches(emailAppName).findOnce().parent()</span><br><span class="line">            btn_email.click()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(<span class="string">&quot;不存在应用: &quot;</span> + PACKAGE_ID_MAIL_163)</span><br><span class="line">        lockScreen()</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 网易邮箱大师</span></span><br><span class="line">    <span class="keyword">var</span> versoin = getPackageVersion(PACKAGE_ID_MAIL_163)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;应用版本: &quot;</span> + versoin)</span><br><span class="line">    <span class="keyword">var</span> sp = versoin.split(<span class="string">&quot;.&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> (sp[<span class="number">0</span>] == <span class="number">6</span>) &#123;</span><br><span class="line">        <span class="comment">// 网易邮箱大师 6</span></span><br><span class="line">        waitForActivity(<span class="string">&quot;com.netease.mobimail.activity.MailComposeActivity&quot;</span>)</span><br><span class="line">        id(<span class="string">&quot;send&quot;</span>).findOne().click()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 网易邮箱大师 7</span></span><br><span class="line">        waitForActivity(<span class="string">&quot;com.netease.mobimail.module.mailcompose.MailComposeActivity&quot;</span>)</span><br><span class="line">        <span class="keyword">var</span> input_address = id(<span class="string">&quot;input&quot;</span>).findOne()</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == input_address.getText()) &#123;</span><br><span class="line">            input_address.setText(EMAILL_ADDRESS)</span><br><span class="line">        &#125;</span><br><span class="line">        id(<span class="string">&quot;iv_arrow&quot;</span>).findOne().click()</span><br><span class="line">        sleep(<span class="number">1000</span>)</span><br><span class="line">        id(<span class="string">&quot;img_send_bg&quot;</span>).findOne().click()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 内置电子邮件</span></span><br><span class="line">    <span class="comment">// waitForActivity(&quot;com.kingsoft.mail.compose.ComposeActivity&quot;)</span></span><br><span class="line">    <span class="comment">// id(&quot;compose_send_btn&quot;).findOne().click()</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;正在发送邮件...&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    home()</span><br><span class="line">    sleep(<span class="number">2000</span>)</span><br><span class="line">    lockScreen()    <span class="comment">// 关闭屏幕</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>发送QQ消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>message 消息内容</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendQQMsg</span>(<span class="params">message</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;发送QQ消息&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    brightScreen()      <span class="comment">// 唤醒屏幕</span></span><br><span class="line">    unlockScreen()      <span class="comment">// 解锁屏幕</span></span><br><span class="line"></span><br><span class="line">    app.startActivity(&#123; </span><br><span class="line">        <span class="attr">action</span>: <span class="string">&quot;android.intent.action.VIEW&quot;</span>, </span><br><span class="line">        <span class="attr">data</span>:<span class="string">&quot;mqq://im/chat?chat_type=wpa&amp;version=1&amp;src_type=web&amp;uin=&quot;</span> + QQ, </span><br><span class="line">        <span class="attr">packageName</span>: <span class="string">&quot;com.tencent.mobileqq&quot;</span>, </span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// waitForActivity(&quot;com.tencent.mobileqq.activity.SplashActivity&quot;)</span></span><br><span class="line"></span><br><span class="line">    id(<span class="string">&quot;input&quot;</span>).findOne().setText(message)</span><br><span class="line">    id(<span class="string">&quot;fun_btn&quot;</span>).findOne().click()</span><br><span class="line"></span><br><span class="line">    home()</span><br><span class="line">    sleep(<span class="number">1000</span>)</span><br><span class="line">    lockScreen()    <span class="comment">// 关闭屏幕</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>ServerChan推送</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>title 标题</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>message 消息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">sendServerChan</span>(<span class="params">title, message</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;向 ServerChan 发起推送请求&quot;</span>)</span><br><span class="line"></span><br><span class="line">    url = <span class="string">&quot;https://sctapi.ftqq.com/&quot;</span> + SERVER_CHAN + <span class="string">&quot;.send&quot;</span>;</span><br><span class="line"></span><br><span class="line">    res = http.post(<span class="built_in">encodeURI</span>(url), &#123;</span><br><span class="line">        <span class="string">&quot;title&quot;</span>: title,</span><br><span class="line">        <span class="string">&quot;desp&quot;</span>: message</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(res)</span><br><span class="line">    sleep(<span class="number">1000</span>)</span><br><span class="line">    lockScreen()    <span class="comment">// 关闭屏幕</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>PushDeer推送</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>title 标题</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>message 消息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">sendPushDeer</span>(<span class="params">title, message</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;向 PushDeer 发起推送请求&quot;</span>)</span><br><span class="line"></span><br><span class="line">    url = <span class="string">&quot;https://api2.pushdeer.com/message/push&quot;</span></span><br><span class="line"></span><br><span class="line">    res = http.post(<span class="built_in">encodeURI</span>(url), &#123;</span><br><span class="line">        <span class="string">&quot;pushkey&quot;</span>: PUSH_DEER,</span><br><span class="line">        <span class="string">&quot;text&quot;</span>: title,</span><br><span class="line">        <span class="string">&quot;desp&quot;</span>: message,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;markdown&quot;</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(res)</span><br><span class="line">    sleep(<span class="number">1000</span>)</span><br><span class="line">    lockScreen()    <span class="comment">// 关闭屏幕</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>唤醒设备</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">brightScreen</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;唤醒设备&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    device.setBrightnessMode(<span class="number">0</span>) <span class="comment">// 手动亮度模式</span></span><br><span class="line">    device.setBrightness(SCREEN_BRIGHTNESS)</span><br><span class="line">    device.wakeUpIfNeeded() <span class="comment">// 唤醒设备</span></span><br><span class="line">    device.keepScreenOn()   <span class="comment">// 保持亮屏</span></span><br><span class="line">    sleep(<span class="number">1000</span>) <span class="comment">// 等待屏幕亮起</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!device.isScreenOn()) &#123;</span><br><span class="line">        <span class="built_in">console</span>.warn(<span class="string">&quot;设备未唤醒, 重试&quot;</span>)</span><br><span class="line">        device.wakeUpIfNeeded()</span><br><span class="line">        brightScreen()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.info(<span class="string">&quot;设备已唤醒&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">1000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>解锁屏幕</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unlockScreen</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;解锁屏幕&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (isDeviceLocked()) &#123;</span><br><span class="line"></span><br><span class="line">        gesture(</span><br><span class="line">            <span class="number">320</span>, <span class="comment">// 滑动时间：毫秒</span></span><br><span class="line">            [</span><br><span class="line">                device.width  * <span class="number">0.5</span>,    <span class="comment">// 滑动起点 x 坐标：屏幕宽度的一半</span></span><br><span class="line">                device.height * <span class="number">0.9</span>     <span class="comment">// 滑动起点 y 坐标：距离屏幕底部 10% 的位置, 华为系统需要往上一些</span></span><br><span class="line">            ],</span><br><span class="line">            [</span><br><span class="line">                device.width / <span class="number">2</span>,       <span class="comment">// 滑动终点 x 坐标：屏幕宽度的一半</span></span><br><span class="line">                device.height * <span class="number">0.1</span>     <span class="comment">// 滑动终点 y 坐标：距离屏幕顶部 10% 的位置</span></span><br><span class="line">            ]</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        sleep(<span class="number">1000</span>) <span class="comment">// 等待解锁动画完成</span></span><br><span class="line">        home()</span><br><span class="line">        sleep(<span class="number">1000</span>) <span class="comment">// 等待返回动画完成</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isDeviceLocked()) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(<span class="string">&quot;上滑解锁失败, 请按脚本中的注释调整 gesture(time, [x1,y1], [x2,y2]) 方法的参数!&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.info(<span class="string">&quot;屏幕已解锁&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>随机等待</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">holdOn</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!needWaiting) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> randomTime = random(LOWER_BOUND, UPPER_BOUND)</span><br><span class="line">    toastLog(<span class="built_in">Math</span>.floor(randomTime / <span class="number">1000</span>) + <span class="string">&quot;秒后启动&quot;</span> + app.getAppName(PACKAGE_ID_DD) + <span class="string">&quot;...&quot;</span>)</span><br><span class="line">    sleep(randomTime)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>启动并登陆钉钉</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">signIn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    app.launchPackage(PACKAGE_ID_DD)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;正在启动&quot;</span> + app.getAppName(PACKAGE_ID_DD) + <span class="string">&quot;...&quot;</span>)</span><br><span class="line"></span><br><span class="line">    setVolume(<span class="number">0</span>) <span class="comment">// 设备静音</span></span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">10000</span>) <span class="comment">// 等待钉钉启动</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (currentPackage() == PACKAGE_ID_DD &amp;&amp;</span><br><span class="line">        currentActivity() == <span class="string">&quot;com.alibaba.android.user.login.SignUpWithPwdActivity&quot;</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.info(<span class="string">&quot;账号未登录&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> account = id(<span class="string">&quot;et_phone_input&quot;</span>).findOne()</span><br><span class="line">        account.setText(ACCOUNT)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;输入账号&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> password = id(<span class="string">&quot;et_pwd_login&quot;</span>).findOne()</span><br><span class="line">        password.setText(PASSWORD)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;输入密码&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> privacy = id(<span class="string">&quot;cb_privacy&quot;</span>).findOne()</span><br><span class="line">        privacy.click()</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;同意隐私协议&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> btn_login = id(<span class="string">&quot;btn_next&quot;</span>).findOne()</span><br><span class="line">        btn_login.click()</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;正在登陆...&quot;</span>)</span><br><span class="line"></span><br><span class="line">        sleep(<span class="number">3000</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (currentPackage() == PACKAGE_ID_DD &amp;&amp;</span><br><span class="line">        currentActivity() != <span class="string">&quot;com.alibaba.android.user.login.SignUpWithPwdActivity&quot;</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.info(<span class="string">&quot;账号已登录&quot;</span>)</span><br><span class="line">        sleep(<span class="number">1000</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>处理迟到打卡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleLate</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != textMatches(<span class="string">&quot;迟到打卡&quot;</span>).clickable(<span class="literal">true</span>).findOne(<span class="number">1000</span>)) &#123;</span><br><span class="line">        btn_late = textMatches(<span class="string">&quot;迟到打卡&quot;</span>).clickable(<span class="literal">true</span>).findOnce() </span><br><span class="line">        btn_late.click()</span><br><span class="line">        <span class="built_in">console</span>.warn(<span class="string">&quot;迟到打卡&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != descMatches(<span class="string">&quot;迟到打卡&quot;</span>).clickable(<span class="literal">true</span>).findOne(<span class="number">1000</span>)) &#123;</span><br><span class="line">        btn_late = descMatches(<span class="string">&quot;迟到打卡&quot;</span>).clickable(<span class="literal">true</span>).findOnce() </span><br><span class="line">        btn_late.click()</span><br><span class="line">        <span class="built_in">console</span>.warn(<span class="string">&quot;迟到打卡&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>使用 URL Scheme 进入考勤界面</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">attendKaoqin</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> url_scheme = <span class="string">&quot;dingtalk://dingtalkclient/page/link?url=https://attend.dingtalk.com/attend/index.html&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(CORP_ID != <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">        url_scheme = url_scheme + <span class="string">&quot;?corpId=&quot;</span> + CORP_ID</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> a = app.intent(&#123;</span><br><span class="line">        <span class="attr">action</span>: <span class="string">&quot;VIEW&quot;</span>,</span><br><span class="line">        <span class="attr">data</span>: url_scheme,</span><br><span class="line">        <span class="comment">//flags: [Intent.FLAG_ACTIVITY_NEW_TASK]</span></span><br><span class="line">    &#125;);</span><br><span class="line">    app.startActivity(a);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;正在进入考勤界面...&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    textContains(<span class="string">&quot;申请&quot;</span>).waitFor()</span><br><span class="line">    <span class="built_in">console</span>.info(<span class="string">&quot;已进入考勤界面&quot;</span>)</span><br><span class="line">    sleep(<span class="number">1000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>上班打卡 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">clockIn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;上班打卡...&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != textContains(<span class="string">&quot;已打卡&quot;</span>).findOne(<span class="number">1000</span>)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.info(<span class="string">&quot;已打卡&quot;</span>)</span><br><span class="line">        toast(<span class="string">&quot;已打卡&quot;</span>)</span><br><span class="line">        home()</span><br><span class="line">        sleep(<span class="number">1000</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;等待连接到考勤机...&quot;</span>)</span><br><span class="line">    sleep(<span class="number">2000</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != textContains(<span class="string">&quot;未连接&quot;</span>).findOne(<span class="number">1000</span>)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(<span class="string">&quot;未连接考勤机, 重新进入考勤界面!&quot;</span>)</span><br><span class="line">        back()</span><br><span class="line">        sleep(<span class="number">2000</span>)</span><br><span class="line">        attendKaoqin()</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    textContains(<span class="string">&quot;已连接&quot;</span>).waitFor()</span><br><span class="line">    <span class="built_in">console</span>.info(<span class="string">&quot;已连接考勤机&quot;</span>)</span><br><span class="line">    sleep(<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != textMatches(<span class="string">&quot;上班打卡&quot;</span>).clickable(<span class="literal">true</span>).findOne(<span class="number">1000</span>)) &#123;</span><br><span class="line">        btn_clockin = textMatches(<span class="string">&quot;上班打卡&quot;</span>).clickable(<span class="literal">true</span>).findOnce()</span><br><span class="line">        btn_clockin.click()</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;按下打卡按钮&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        click(device.width / <span class="number">2</span>, device.height * <span class="number">0.560</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;点击打卡按钮坐标&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">1000</span>)</span><br><span class="line">    handleLate() <span class="comment">// 处理迟到打卡</span></span><br><span class="line">    </span><br><span class="line">    home()</span><br><span class="line">    sleep(<span class="number">1000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>下班打卡 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">clockOut</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;下班打卡...&quot;</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;等待连接到考勤机...&quot;</span>)</span><br><span class="line">    sleep(<span class="number">2000</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != textContains(<span class="string">&quot;未连接&quot;</span>).findOne(<span class="number">1000</span>)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(<span class="string">&quot;未连接考勤机, 重新进入考勤界面!&quot;</span>)</span><br><span class="line">        back()</span><br><span class="line">        sleep(<span class="number">2000</span>)</span><br><span class="line">        attendKaoqin()</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    textContains(<span class="string">&quot;已连接&quot;</span>).waitFor()</span><br><span class="line">    <span class="built_in">console</span>.info(<span class="string">&quot;已连接考勤机&quot;</span>)</span><br><span class="line">    sleep(<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != textMatches(<span class="string">&quot;下班打卡&quot;</span>).clickable(<span class="literal">true</span>).findOne(<span class="number">1000</span>)) &#123;</span><br><span class="line">        btn_clockout = textMatches(<span class="string">&quot;下班打卡&quot;</span>).clickable(<span class="literal">true</span>).findOnce()</span><br><span class="line">        btn_clockout.click()</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;按下打卡按钮&quot;</span>)</span><br><span class="line">        sleep(<span class="number">1000</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        click(device.width / <span class="number">2</span>, device.height * <span class="number">0.560</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;点击打卡按钮坐标&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != textContains(<span class="string">&quot;早退打卡&quot;</span>).clickable(<span class="literal">true</span>).findOne(<span class="number">1000</span>)) &#123;</span><br><span class="line">        className(<span class="string">&quot;android.widget.Button&quot;</span>).text(<span class="string">&quot;早退打卡&quot;</span>).clickable(<span class="literal">true</span>).findOnce().parent().click()</span><br><span class="line">        <span class="built_in">console</span>.warn(<span class="string">&quot;早退打卡&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    home()</span><br><span class="line">    sleep(<span class="number">1000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>锁屏</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">lockScreen</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;关闭屏幕&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 锁屏方案1：Root</span></span><br><span class="line">    <span class="comment">// Power()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 锁屏方案2：No Root</span></span><br><span class="line">    <span class="comment">// press(Math.floor(device.width / 2), Math.floor(device.height * 0.973), 1000) // 小米的快捷手势：长按Home键锁屏</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 万能锁屏方案：向Tasker发送广播, 触发系统锁屏动作。配置方法见 2021-03-09 更新日志</span></span><br><span class="line">    app.sendBroadcast(&#123;<span class="attr">action</span>: ACTION_LOCK_SCREEN&#125;);</span><br><span class="line"></span><br><span class="line">    device.setBrightnessMode(<span class="number">1</span>) <span class="comment">// 自动亮度模式</span></span><br><span class="line">    device.cancelKeepingAwake() <span class="comment">// 取消设备常亮</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (isDeviceLocked()) &#123;</span><br><span class="line">        <span class="built_in">console</span>.info(<span class="string">&quot;屏幕已关闭&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(<span class="string">&quot;屏幕未关闭, 请尝试其他锁屏方案, 或等待屏幕自动关闭&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ===================== ↓↓↓ 功能函数 ↓↓↓ =======================</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dateDigitToString</span>(<span class="params">num</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> num &lt; <span class="number">10</span> ? <span class="string">&#x27;0&#x27;</span> + num : num</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCurrentTime</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> currentDate = <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">    <span class="keyword">var</span> hours = dateDigitToString(currentDate.getHours())</span><br><span class="line">    <span class="keyword">var</span> minute = dateDigitToString(currentDate.getMinutes())</span><br><span class="line">    <span class="keyword">var</span> second = dateDigitToString(currentDate.getSeconds())</span><br><span class="line">    <span class="keyword">var</span> formattedTimeString = hours + <span class="string">&#x27;:&#x27;</span> + minute + <span class="string">&#x27;:&#x27;</span> + second</span><br><span class="line">    <span class="keyword">return</span> formattedTimeString</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCurrentDate</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> currentDate = <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">    <span class="keyword">var</span> year = dateDigitToString(currentDate.getFullYear())</span><br><span class="line">    <span class="keyword">var</span> month = dateDigitToString(currentDate.getMonth() + <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">var</span> date = dateDigitToString(currentDate.getDate())</span><br><span class="line">    <span class="keyword">var</span> week = currentDate.getDay()</span><br><span class="line">    <span class="keyword">var</span> formattedDateString = year + <span class="string">&#x27;-&#x27;</span> + month + <span class="string">&#x27;-&#x27;</span> + date + <span class="string">&#x27;-&#x27;</span> + WEEK_DAY[week]</span><br><span class="line">    <span class="keyword">return</span> formattedDateString</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通知过滤器</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filterNotification</span>(<span class="params">bundleId, abstract, text</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> check = PACKAGE_ID_WHITE_LIST.some(<span class="function"><span class="keyword">function</span>(<span class="params">item</span>) </span>&#123;<span class="keyword">return</span> bundleId == item&#125;) </span><br><span class="line">    <span class="keyword">if</span> (!NOTIFICATIONS_FILTER || check) &#123;</span><br><span class="line">        <span class="built_in">console</span>.verbose(bundleId)</span><br><span class="line">        <span class="built_in">console</span>.verbose(abstract)</span><br><span class="line">        <span class="built_in">console</span>.verbose(text)</span><br><span class="line">        <span class="built_in">console</span>.verbose(<span class="string">&quot;---------------------------&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span> </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 保存本地数据</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setStorageData</span>(<span class="params">name, key, value</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> storage = storages.create(name)  <span class="comment">// 创建storage对象</span></span><br><span class="line">    storage.put(key, value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取本地数据</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getStorageData</span>(<span class="params">name, key</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> storage = storages.create(name)</span><br><span class="line">    <span class="keyword">if</span> (storage.contains(key)) &#123;</span><br><span class="line">        <span class="keyword">return</span> storage.get(key, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 默认返回undefined</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除本地数据</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">delStorageData</span>(<span class="params">name, key</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> storage = storages.create(name)</span><br><span class="line">    <span class="keyword">if</span> (storage.contains(key)) &#123;</span><br><span class="line">        storage.remove(key)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取应用版本号</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPackageVersion</span>(<span class="params">bundleId</span>) </span>&#123;</span><br><span class="line">    importPackage(android.content)</span><br><span class="line">    <span class="keyword">var</span> pckMan = context.getPackageManager()</span><br><span class="line">    <span class="keyword">var</span> packageInfo = pckMan.getPackageInfo(bundleId, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> packageInfo.versionName</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 屏幕是否为锁定状态</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isDeviceLocked</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    importClass(android.app.KeyguardManager)</span><br><span class="line">    importClass(android.content.Context)</span><br><span class="line">    <span class="keyword">var</span> km = context.getSystemService(Context.KEYGUARD_SERVICE)</span><br><span class="line">    <span class="keyword">return</span> km.isKeyguardLocked()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置媒体和通知音量</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setVolume</span>(<span class="params">volume</span>) </span>&#123;</span><br><span class="line">    device.setMusicVolume(volume)</span><br><span class="line">    device.setNotificationVolume(volume)</span><br><span class="line">    <span class="built_in">console</span>.verbose(<span class="string">&quot;媒体音量:&quot;</span> + device.getMusicVolume())</span><br><span class="line">    <span class="built_in">console</span>.verbose(<span class="string">&quot;通知音量:&quot;</span> + device.getNotificationVolume())</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="📐-工具介绍"><a href="#📐-工具介绍" class="headerlink" title="📐 工具介绍"></a>📐 工具介绍</h2><h3 id="Auto-js"><a href="#Auto-js" class="headerlink" title="Auto.js"></a>Auto.js</h3><p>Auto.js 是利用安卓系统的 「无障碍服务」 实现类似于按键精灵一样，可以通过代码模拟一系列界面动作的辅助工具。</p>
<p>与 「按键精灵」 不同的是，它的模拟动作并不是简单的使用在界面定坐标点来实现，而是找控件来实现的。</p>
<p>免费版：<a target="_blank" rel="noopener" href="https://github.com/georgehuan1994/DingDing-Automatic-Clock-in/raw/master/Autojs%204.1.1a%20Alpha2-armeabi-v7a-release.apk" title="Auto.js 4.1.1a Alpha2-armeabi-v7a-release">Auto.js 4.1.1a Alpha2-armeabi-v7a-release</a></p>
<p>github：<a target="_blank" rel="noopener" href="https://github.com/hyb1996/Auto.js">GitHub - hyb1996/Auto.js</a></p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://hyb1996.github.io/AutoJs-Docs/">首页 - Auto.js</a></p>
<p>推荐使用<a target="_blank" rel="noopener" href="https://github.com/hyb1996/Auto.js-VSCode-Extension">VS Code 插件</a>进行调试，调试完成后，还能通过此插件将脚本保存到手机上。</p>
<h3 id="Tasker"><a href="#Tasker" class="headerlink" title="Tasker"></a>Tasker</h3><p><a target="_blank" rel="noopener" href="https://play.google.com/store/apps/details?id=net.dinglisch.android.taskerm">Tasker</a> 也是一个安卓自动化神器，与 Auto.js 结合使用可胜任日常工作流。</p>
<p>此处仅提供 Tasker 5.0 及以下的官方原版，原版不含正版验证，使用不受限制：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/georgehuan1994/DingDing-Automatic-Clock-in/blob/master/Tasker.4.9u4m.apk">Tasker.4.9u4m.apk</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/georgehuan1994/DingDing-Automatic-Clock-in/blob/master/Tasker.5.0u7m.apk">Tasker.5.0u7m.apk</a></p>
<p>Tasker 定时打卡配置：</p>
<ol>
<li>添加一个 「通知」 操作任务，通知标题修改为 「定时打卡」，通知文字随意，通知优先级设为 1。</li>
<li>添加两个配置文件，使用日期和时间作为条件，分别在上班前和下班后触发。</li>
</ol>
<p>你也可以<a target="_blank" rel="noopener" href="https://github.com/georgehuan1994/DingDing-Automatic-Clock-in/tree/master/Tasker%E9%85%8D%E7%BD%AE">下载配置文件</a>，导入到 Tasker 中使用，方法如下：</p>
<ol>
<li>长按 菜单栏-任务，导入”发送通知.tsk.xml”。</li>
<li>长按 菜单栏-配置文件，导入”上班打卡.prf.xml” 和 “下班打卡.prf.xml”。</li>
<li>在任务编辑界面左下方有一个三角形的播放按钮，点击即可发送通知，方便调试。</li>
</ol>
<h2 id="🕹️-使用方法"><a href="#🕹️-使用方法" class="headerlink" title="🕹️ 使用方法"></a>🕹️ 使用方法</h2><h3 id="远程打卡"><a href="#远程打卡" class="headerlink" title="远程打卡"></a>远程打卡</h3><ul>
<li>向本机的 QQ 发送消息 「打卡」，或回复标题为 「打卡」 的邮件，或向 PushDeer 发送标题为「打卡」 的推送请求，即可触发打卡进程。</li>
<li>向本机的 QQ 发送消息 「查询」，或回复标题为 「查询」 的邮件，或向 PushDeer 发送标题为「查询」 的推送请求，即可查询最新一次打卡结果。</li>
</ul>
<h3 id="暂停-恢复定时打卡"><a href="#暂停-恢复定时打卡" class="headerlink" title="暂停/恢复定时打卡"></a>暂停/恢复定时打卡</h3><ul>
<li>向本机的 QQ 发送消息 「暂停」，或回复标题为 「暂停」 的邮件，或向 PushDeer 发送标题为「暂停」 的推送请求，即可暂停定时打卡功能（仅暂停定时打卡，不影响远程打卡功能）</li>
<li>向本机的 QQ 发送消息 「恢复」，或回复标题为 「恢复」 的邮件，或向 PushDeer 发送标题为「恢复」 的推送请求，即可恢复定时打卡功能。</li>
</ul>
<h2 id="⚠️-注意事项-必读"><a href="#⚠️-注意事项-必读" class="headerlink" title="⚠️ 注意事项 (必读!!!)"></a>⚠️ 注意事项 (必读!!!)</h2><ul>
<li>AutoJs Pro 版本屏蔽了一些主流应用，如果要使用 QQ 作为回复方式，不要使用 AutoJs Pro 版！</li>
<li>首次启动 AutoJs，需要为其开启无障碍权限。</li>
<li>运行脚本前，请在 AutoJs 菜单栏中（从屏幕左边划出），开启 「通知读取权限」。</li>
<li>若无法通过 <code>app.launchPackage()</code> 方法启动应用，请开启该应用的「自启动」「允许后台弹窗」。</li>
<li>AutoJs、Tasker 可息屏运行，需要在系统设置中开启通知亮屏。</li>
<li>为保证 AutoJs、Tasker 进程不被系统清理，可调整它们的电池管理策略、加入管理应用的白名单，为其开启前台服务、添加应用锁…</li>
<li>虽然脚本可执行完整的打卡步骤，但推荐开启钉钉的极速打卡功能，在钉钉启动时即可完成打卡，应把后续的步骤视为极速打卡失败后的保险措施。</li>
</ul>
<h2 id="📜-更新日志"><a href="#📜-更新日志" class="headerlink" title="📜 更新日志"></a>📜 更新日志</h2><h3 id="2022-03-26"><a href="#2022-03-26" class="headerlink" title="2022-03-26"></a>2022-03-26</h3><details open>
<summary></summary>

<ol>
<li>可以通过 PushDeer 接收通知、推送考勤结果</details></li>
</ol>
<h3 id="2022-03-01"><a href="#2022-03-01" class="headerlink" title="2022-03-01"></a>2022-03-01</h3><details open>
<summary></summary>

<ol>
<li>可以通过Server酱来推送考勤结果</details></li>
</ol>
<h3 id="2021-10-23"><a href="#2021-10-23" class="headerlink" title="2021-10-23"></a>2021-10-23</h3><details open>
<summary></summary>

<ol>
<li>适配网易邮箱大师7.0</details></li>
</ol>
<h3 id="2021-09-02"><a href="#2021-09-02" class="headerlink" title="2021-09-02"></a>2021-09-02</h3><details open>
<summary></summary>

<ol>
<li>新增获取日志功能，发送 「日志」，可将运行日志作为邮件附件发送（最好使用内置邮件）</li>
<li>优化通知过滤器，过滤 Tasker 发出的无效通知</details></li>
</ol>
<h3 id="2021-07-07"><a href="#2021-07-07" class="headerlink" title="2021-07-07"></a>2021-07-07</h3><details open>
<summary></summary>

<ol>
<li>登录流程自动同意隐私协议</details></li>
</ol>
<h3 id="2021-05-27"><a href="#2021-05-27" class="headerlink" title="2021-05-27"></a>2021-05-27</h3><details open>
<summary></summary>

<ol>
<li>修改了部分常量的命名</li>
<li>移除了休息日不打卡的判断</li>
<li>在邮件的基础上，增加QQ作为新的通讯方式。除发送考勤结果需要手动指定应用外，使用QQ向本机发送 「查询、暂停、恢复」 指令，则会用QQ来回复查询或操作结果；使用邮件向本机发送指令则用邮件回复。</details></li>
</ol>
<h3 id="2021-05-06"><a href="#2021-05-06" class="headerlink" title="2021-05-06"></a>2021-05-06</h3><details open>
<summary></summary>

<ol>
<li>增加音量上键监听，按下后中断所有子线程，也可以利用回调来进行调试</li>
<li>不再使用考勤机名称来判断连接状态</li>
<li>重新进入打卡界面前，先返回上级菜单，以解决顶号登录无法正常连接到考勤机的问题</li>
<li>启动钉钉时，将媒体音量和通知音量设为0</details></li>
</ol>
<h3 id="2021-03-15"><a href="#2021-03-15" class="headerlink" title="2021-03-15"></a>2021-03-15</h3><details open>
<summary></summary>

<ol>
<li>运行时检查Auto.js版本，脚本需要在Auto.js 4.1.0及以上版本中运行</li>
<li>新增解锁是否成功的判断，若解锁失败则停止运行脚本</li>
<li>优化 <code>signIn()</code> 方法，使用 bundleId + activity 来判断登录情况</li>
<li>优化部分控件和信息的获取方式</details></li>
</ol>
<h3 id="2021-03-09"><a href="#2021-03-09" class="headerlink" title="2021-03-09"></a>2021-03-09</h3><details open>
<summary></summary>

<ol>
<li><p>移除 「结束钉钉」、「检查更新」 这个两个过程，使用最近一次监测到的正在运行的应用的包名进行判断</p>
</li>
<li><p>补充一个万能锁屏方案：向Tasker发送广播，触发Tasker中的系统锁屏操作。</p>
<ul>
<li>在Tasker中添加一个任务，在任务中添加操作 「系统锁屏（关闭屏幕）」</li>
<li>在Tasker中添加一个事件类型的配置文件，事件类别：系统-收到的意图</li>
<li>在事件操作中填写：autojs.intent.action.LOCK_SCREEN ，保持发送方与接收方的action一致即可</li>
</ul>
</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.sendBroadcast(&#123;</span><br><span class="line">        <span class="attr">action</span>: <span class="string">&#x27;autojs.intent.action.LOCK_SCREEN&#x27;</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
</details>

<h3 id="2021-02-07"><a href="#2021-02-07" class="headerlink" title="2021-02-07"></a>2021-02-07</h3><details open>
<summary></summary>

<ol>
<li>防止监听事件被耗时操作阻塞。</details></li>
</ol>
<h3 id="2021-01-15"><a href="#2021-01-15" class="headerlink" title="2021-01-15"></a>2021-01-15</h3><details open>
<summary></summary> 

<ol>
<li>移除 「进入工作台」 以及 「进入考勤打卡界面」 这两个过程</li>
<li>启动并成功登录钉钉后，直接使用intent拉起考勤打卡界面</details></li>
</ol>
<h3 id="2021-01-08"><a href="#2021-01-08" class="headerlink" title="2021-01-08"></a>2021-01-08</h3><details open>
<summary></summary>

<ol>
<li>修复：通知过滤器报错</details></li>
</ol>
<h3 id="2020-12-30"><a href="#2020-12-30" class="headerlink" title="2020-12-30"></a>2020-12-30</h3><details open>
<summary></summary>

<ol>
<li>优化：现在可以通过邮件来 暂停/恢复 定时打卡功能，以应对停工停产，或其他需要暂时停止定时打卡的特殊情况</details></li>
</ol>
<h3 id="2020-12-04"><a href="#2020-12-04" class="headerlink" title="2020-12-04"></a>2020-12-04</h3><details open>
<summary></summary>

<ol>
<li>优化：打卡过程在子线程中执行，钉钉返回打卡结果后，直接中断子线程，减少无效操作</details></li>
</ol>
<h3 id="2020-10-27"><a href="#2020-10-27" class="headerlink" title="2020-10-27"></a>2020-10-27</h3><details open>
<summary></summary>

<ol>
<li>修复：当钉钉的通知文本为null时，indexOf()方法无法正常执行</details></li>
</ol>
<h3 id="2020-09-24"><a href="#2020-09-24" class="headerlink" title="2020-09-24"></a>2020-09-24</h3><details open>
<summary></summary>

<ol>
<li>优化：使用URL Scheme直接拉起考勤打卡界面</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">attendKaoqin</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> a = app.intent(&#123;</span><br><span class="line">        <span class="attr">action</span>: <span class="string">&quot;VIEW&quot;</span>,</span><br><span class="line">        <span class="attr">data</span>: <span class="string">&quot;dingtalk://dingtalkclient/page/link?url=https://attend.dingtalk.com/attend/index.html&quot;</span></span><br><span class="line">      &#125;);</span><br><span class="line">      app.startActivity(a);</span><br><span class="line">      sleep(<span class="number">5000</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="获取URL的方式如下："><a href="#获取URL的方式如下：" class="headerlink" title="获取URL的方式如下："></a>获取URL的方式如下：</h4><ol>
<li>在PC端找到 「智能工作助理」 联系人</li>
<li>发送消息 “打卡” ，点击 「立即打卡」 </li>
<li>弹出一个二维码。此二维码就是拉起考勤打卡界面的 URL，用自带的相机或其他应用扫描，并在浏览器中打开，即可获得完整URL</li>
<li>观察获取到的URL，找到 <code>CorpId=xxxxxxxxxxxxxxxxxxx</code> ，将CorpId的值填写到的脚本开头的CORP_ID这个常量中</li>
<li>仅使用 <code>dingtalk://dingtalkclient/page/link?url=https://attend.dingtalk.com/attend/index.html</code>，也可以拉起旧版打卡界面，钉钉会自动获取企业的CorpId。如果加入了多个组织，且没有填写CorpId，则在拉起考勤界面时会弹出一个选择组织的对话框。</details></li>
</ol>
<h3 id="2020-09-11"><a href="#2020-09-11" class="headerlink" title="2020-09-11"></a>2020-09-11</h3><details open>
<summary></summary>

<ol>
<li>将上次考勤结果储存在本地</li>
<li>将运行日志储存在本地 /sdcard/脚本/Archive/</li>
<li>修复在下班极速打卡之后，重复打卡的问题</details></li>
</ol>
<h3 id="2020-09-04"><a href="#2020-09-04" class="headerlink" title="2020-09-04"></a>2020-09-04</h3><details open>
<summary></summary>

<ol>
<li>将 “打卡” 与 “发送邮件” 分离成两个过程，打卡完成后，将钉钉返回的考勤结果作为邮件正文发送</details open></li>
</ol>
<h3 id="2020-09-02"><a href="#2020-09-02" class="headerlink" title="2020-09-02"></a>2020-09-02</h3><details open>
<summary></summary>

<ol>
<li>改为使用 “去打卡” 文本获取按钮。若找不到 “去打卡” 按钮，则直接点击 “考勤打卡” 的屏幕坐标</details></li>
</ol>
<h2 id="📢-声明"><a href="#📢-声明" class="headerlink" title="📢 声明"></a>📢 声明</h2><p>此仓库及脚本仅供学习交流，欢迎转载。旨在让人们关注996制度的存在和非法性，并尝试改变这种现象。</p>
<p>根据1994年第八届全国人大常委会通过和2018年第十三届全国人大常委会修正的《中华人民共和国劳动法》规定，劳动者<strong>每日工作时间不超过8小时，平均每周工作时间不超过44小时，而996工作制每周至少要工作72个小时</strong>，远超法律标准，因此996工作制度违反劳动法。</p>
<p><font color=red>而钉钉却允许企业管理者违反法律，非法排班！</font> </p>
<blockquote>

<p><strong>第三十六条</strong>　国家实行劳动者每日工作时间不超过八小时、平均每周工作时间不超过四十四小时的工时制度。</p>
<p><strong>第四十一条</strong>　用人单位由于生产经营需要，经与工会和劳动者协商后可以延长工作时间，一般每日不得超过一小时；因特殊原因需要延长工作时间的，在保障劳动者身体健康的条件下延长工作时间每日不得超过三小时，但是每月不得超过三十六小时。</p>
<p><strong>第四十四条</strong>　有下列情形之一的，用人单位应当按照下列标准支付高于劳动者正常工作时间工资的工资报酬：</p>
<p>（一）安排劳动者延长工作时间的，支付不低于工资的百分之一百五十的工资报酬；<br>（二）休息日安排劳动者工作又不能安排补休的，支付不低于工资的百分之二百的工资报酬；<br>（三）法定休假日安排劳动者工作的，支付不低于工资的百分之三百的工资报酬。  </p>
<p><strong>第九十条</strong>　用人单位违反本法规定，延长劳动者工作时间的，由劳动行政部门给予警告，责令改正，并可以处以罚款。</p>
<p><strong>第九十一条</strong>　用人单位有下列侵害劳动者合法权益情形之一的，由劳动行政部门责令支付劳动者的工资报酬、经济补偿，并可以责令支付赔偿金：</p>
<p>（二）拒不支付劳动者延长工作时间工资报酬的；</p>
</blockquote>

<p>相关项目：<a target="_blank" rel="noopener" href="https://github.com/georgehuan1994/996-Salary-Calculator">996 薪资计算助手</a></p>
<hr>
<pre><code>如果觉得还不错的话，就点击右上角, 给我个Star ⭐️ 鼓励一下我吧~
</code></pre>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/09/02/%E9%83%A8%E7%BD%B2%E6%89%8B%E5%86%8C/">hexo 部署手册</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-09-03</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/hexo/">hexo</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/hexo/">hexo</a></span><div class="content"><h1 id="Hexo-部署手册"><a href="#Hexo-部署手册" class="headerlink" title="Hexo 部署手册"></a>Hexo 部署手册</h1><h2 id="Hexo搭建步骤"><a href="#Hexo搭建步骤" class="headerlink" title="Hexo搭建步骤"></a><strong>Hexo搭建步骤</strong></h2><ol>
<li>安装Git</li>
<li>安装Node.js</li>
<li>安装Hexo</li>
<li>GitHub创建个人仓库</li>
<li>生成SSH添加到GitHub</li>
<li>将hexo部署到GitHub</li>
</ol>
<h2 id="1-安装Git"><a href="#1-安装Git" class="headerlink" title="1. 安装Git"></a><strong>1. 安装Git</strong></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install git</span><br></pre></td></tr></table></figure>

<p>安装好后，用<code>git --version</code> 来查看一下版本</p>
<h2 id="2-安装nodejs"><a href="#2-安装nodejs" class="headerlink" title="2. 安装nodejs"></a><strong>2. 安装nodejs</strong></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install nodejs</span><br><span class="line">sudo apt-get install npm</span><br></pre></td></tr></table></figure>

<p>检查一下有没有安装成功</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node -v</span><br><span class="line">npm -v</span><br></pre></td></tr></table></figure>

<p>顺便说一下，windows在git安装完后，就可以直接使用git bash来敲命令行了，不用自带的cmd，cmd有点难用。</p>
<h2 id="3-安装hexo"><a href="#3-安装hexo" class="headerlink" title="3. 安装hexo"></a><strong>3. 安装hexo</strong></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g hexo-cli</span><br></pre></td></tr></table></figure>

<p>依旧用<code>hexo -v</code>查看一下版本，至此就全部安装完了。</p>
<p>接下来初始化一下hexo</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo init myblog</span><br></pre></td></tr></table></figure>

<p>这个myblog可以自己取什么名字都行，然后</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> myblog //进入这个myblog文件夹</span><br><span class="line">npm install</span><br></pre></td></tr></table></figure>

<p>使用命令 <code>hexo server</code> 可缩写<code>hexo s</code>启动服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>部署项目到Github远程仓库</p>
<ul>
<li>修改配置文件 _config.yml</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># Deployment</span><br><span class="line">## Docs: https://hexo.io/docs/one-command-deployment</span><br><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repo: git@github.com:2757412961/2757412961.github.io.git</span><br><span class="line">  branch: web</span><br></pre></td></tr></table></figure>

<ul>
<li>操作命令</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ npm install hexo-deployer-git --save  #安装部署工具</span><br><span class="line">    $ hexo clean                            #清除缓存       可缩写hexo c</span><br><span class="line">    $ hexo generate                         #生成静态文件    可缩写hexo g</span><br><span class="line">    $ hexo deploy                           #部署到Github   可缩写hexo d</span><br><span class="line"># 操作合集</span><br><span class="line">hexo clean &amp;&amp; hexo generate &amp;&amp; hexo deploy</span><br></pre></td></tr></table></figure>

<h2 id="4-GitHub创建个人仓库"><a href="#4-GitHub创建个人仓库" class="headerlink" title="4. GitHub创建个人仓库"></a><strong>4. GitHub创建个人仓库</strong></h2><p>登录Github新建一个仓库，仓库名必须为你的<code>Github用户名.github.io</code>  例如: 我的用户名是:<code>Lete</code> 那么格式因该为：<code>lete.github.io</code></p>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/image-20220903214114617.png" alt="image-20220903214114617"></p>
<p>远程仓库开启 github pages，指定分支为上述提到的web</p>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/image-20220905104750608.png" alt="image-20220905104750608"></p>
<h2 id="5-生成SSH添加到GitHub"><a href="#5-生成SSH添加到GitHub" class="headerlink" title="5. 生成SSH添加到GitHub"></a><strong>5. 生成SSH添加到GitHub</strong></h2><p>安装成功后，将 git 与 GitHub 账号绑定，右键打开 Git Bash，然后设置配置信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 配置用户名和邮箱</span><br><span class="line">git config --global user.name &quot;github 用户名&quot;</span><br><span class="line">git config --global user.email &quot;github 注册邮箱&quot;</span><br></pre></td></tr></table></figure>

<p>比如我的配置就是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.name <span class="string">&quot;2757412961&quot;</span></span><br><span class="line">git config --global user.email <span class="string">&quot;2757412961@qq.com&quot;</span></span><br></pre></td></tr></table></figure>

<p>接着生成 ssh 密钥文件，输入如下命令后直接三次回车即可，一般不需要设置密码；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 生成 ssh 密钥</span><br><span class="line">ssh-keygen -t rsa -C &quot;github 注册邮箱&quot;</span><br></pre></td></tr></table></figure>

<p>我生成秘钥的命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -C <span class="string">&quot;2757412961@qq.com&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/v2-9e2d268a169026242849e2ff5325fcad_r.jpg" alt="img"></p>
<p>一般执行上述命令之后，会生成 <code>id_rsa</code> 和 <code>id_rsa.pub</code> 两个文件，前者是我们私有的，而后者则是对外开放的。接着找到生成的 <code>.ssh</code> 的文件夹中的 id_rsa.pub 密钥，将内容复制；</p>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/image-20220903214402850.png" alt="image-20220903214402850"></p>
<p>然后打开 <a href="https://link.zhihu.com/?target=https://github.com/settings/keys">GitHub-Settings-Keys</a> 页面，创建一个新的 SSH key，填写 <code>Title</code> 和 <code>Key</code>，<code>Title</code> 可以随意，而 <code>Key</code> 的内容则是我们刚才复制的 <code>id_rsa.pub</code> 中的内容，最后点击 <code>Add SSH key</code> 即可；</p>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/v2-fa367eb2c2c4749be656c34d782d6619_r.jpg" alt="img"></p>
<h2 id="6-将hexo部署到GitHub（手动）"><a href="#6-将hexo部署到GitHub（手动）" class="headerlink" title="6. 将hexo部署到GitHub（手动）"></a><strong>6. 将hexo部署到GitHub</strong>（手动）</h2><p>这一步，我们就可以将hexo和GitHub关联起来，也就是将hexo生成的文章部署到GitHub上，打开站点配置文件 <code>_config.yml</code>，翻到最后，修改为 YourgithubName就是你的GitHub账户</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Deployment</span></span><br><span class="line"><span class="comment">## Docs: https://hexo.io/docs/one-command-deployment</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">git@github.com:2757412961/2757412961.github.io.git</span></span><br><span class="line">  <span class="attr">branch:</span> <span class="string">web</span></span><br></pre></td></tr></table></figure>

<p>然后</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo clean &amp;&amp; hexo generate &amp;&amp; hexo deploy</span><br></pre></td></tr></table></figure>

<h2 id="7-GitHub-Actions"><a href="#7-GitHub-Actions" class="headerlink" title="7.GitHub Actions"></a><strong>7.GitHub Actions</strong></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">就是DevOps，可以理解成 GitHub 通过一些流水线的配置（CI/CD），然后在本地推送代码的时候触发流水线执行，自动部署站点。</span><br></pre></td></tr></table></figure>

<h3 id="7-1-新建-github-workflows-pages-yml-文件"><a href="#7-1-新建-github-workflows-pages-yml-文件" class="headerlink" title="7.1 新建 .github/workflows/pages.yml 文件"></a>7.1 新建 .github/workflows/pages.yml 文件</h3><p>修改</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 触发器、分支</span><br><span class="line">on:</span><br><span class="line">  push:</span><br><span class="line">    branches:</span><br><span class="line">      - main  # default branch</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">deploy_key: $&#123;&#123; secrets.ACTIONS_DEPLOY_KEY  &#125;&#125;</span><br><span class="line">user_name: 2757412961</span><br><span class="line">user_email: 2757412961@qq.com</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Pages</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 触发器、分支</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">main</span>  <span class="comment"># default branch</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="comment"># 子任务</span></span><br><span class="line">  <span class="attr">pages:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span> <span class="comment"># 定运行所需要的虚拟机环境</span></span><br><span class="line">    <span class="attr">permissions:</span></span><br><span class="line">      <span class="attr">contents:</span> <span class="string">write</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">        <span class="comment"># with:</span></span><br><span class="line">        <span class="comment">#   submodules: true</span></span><br><span class="line">        <span class="comment">#   fetch-depth: 0</span></span><br><span class="line">      <span class="comment"># 每个name表示一个步骤:step</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Use</span> <span class="string">Node.js</span> <span class="number">16.</span><span class="string">x</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/setup-node@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">node-version:</span> <span class="string">&#x27;16.14.1&#x27;</span> <span class="comment"># 自己正在使用的node版本即可</span></span><br><span class="line">      <span class="comment"># - run: node -v # 查看node版本号</span></span><br><span class="line">      <span class="comment"># 缓存依赖项: https://docs.github.com/cn/actions/using-workflows/caching-dependencies-to-speed-up-workflows</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Cache</span> <span class="string">NPM</span> <span class="string">dependencies</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/cache@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="comment"># npm cache files are stored in `~/.npm` on Linux/macOS</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">~/.npm</span></span><br><span class="line">          <span class="comment"># path: node_modules</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">$&#123;&#123;</span> <span class="string">runner.OS</span> <span class="string">&#125;&#125;-npm-cache</span></span><br><span class="line">          <span class="attr">restore-keys:</span> <span class="string">|</span></span><br><span class="line"><span class="string">            $&#123;&#123; runner.OS &#125;&#125;-npm-cache</span></span><br><span class="line"><span class="string"></span>      <span class="comment"># 查看路径 : /home/runner/work/blog/blog</span></span><br><span class="line">      <span class="comment"># - name: Look Path</span></span><br><span class="line">      <span class="comment">#   run: pwd</span></span><br><span class="line">      <span class="comment"># 查看文件</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Look</span> <span class="string">Dir</span> <span class="string">List</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">tree</span> <span class="string">-L</span> <span class="number">3</span> <span class="string">-a</span></span><br><span class="line">      <span class="comment"># 第一次或者依赖发生变化的时候执行 Install Dependencies，其它构建的时候不需要这一步</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Dependencies</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Look</span> <span class="string">Dir</span> <span class="string">List</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">tree</span> <span class="string">-L</span> <span class="number">3</span> <span class="string">-a</span></span><br><span class="line">      <span class="comment"># - name: clean theme cache</span></span><br><span class="line">      <span class="comment">#   run: git rm -f --cached themes/tenacity</span></span><br><span class="line">        <span class="comment"># run: git submodule deinit themes/tenacity &amp;&amp; git rm themes/tenacity</span></span><br><span class="line">      <span class="comment"># 安装主题</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Theme</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">git</span> <span class="string">submodule</span> <span class="string">add</span> <span class="string">https://github.com/all-smile/tenacity.git</span> <span class="string">themes/tenacity</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Clean</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">clean</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Deploy</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">peaceiris/actions-gh-pages@v3</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">deploy_key:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.ACTIONS_DEPLOY_KEY</span>  <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">user_name:</span> <span class="number">2757412961</span></span><br><span class="line">          <span class="attr">user_email:</span> <span class="number">2757412961</span><span class="string">@qq.com</span></span><br><span class="line">          <span class="comment"># 获取提交文章源码时的commit message，作为发布gh-pages分支的信息</span></span><br><span class="line">          <span class="attr">commit_message:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.head_commit.message</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">full_commit_message:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.head_commit.message</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">github_token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="comment"># GITHUB_TOKEN不是个人访问令牌，GitHub Actions 运行器会自动创建一个GITHUB_TOKEN密钥以在您的工作流程中进行身份验证。因此，您无需任何配置即可立即开始部​​署</span></span><br><span class="line">          <span class="attr">publish_dir:</span> <span class="string">./public</span></span><br><span class="line">          <span class="attr">allow_empty_commit:</span> <span class="literal">true</span> <span class="comment"># 允许空提交</span></span><br><span class="line">      <span class="comment"># Use the output from the `deploy` step(use for test action)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Get</span> <span class="string">the</span> <span class="string">output</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">echo</span> <span class="string">&quot;$<span class="template-variable">&#123;&#123; steps.deploy.outputs.notify &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="7-2-修改-config-yml-文件中的Deploy配置"><a href="#7-2-修改-config-yml-文件中的Deploy配置" class="headerlink" title="7.2 修改 _config.yml 文件中的Deploy配置"></a>7.2 修改 <code>_config.yml</code> 文件中的<code>Deploy</code>配置</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Deployment</span></span><br><span class="line"><span class="comment">## Docs: https://hexo.io/docs/one-command-deployment</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">git@github.com:2757412961/2757412961.github.io.git</span></span><br><span class="line">  <span class="attr">branch:</span> <span class="string">web</span></span><br><span class="line">  <span class="comment"># 默认提交信息： Site updated: &#123;&#123; now(&#x27;YYYY-MM-DD HH:mm:ss&#x27;) &#125;&#125;</span></span><br><span class="line">  <span class="attr">message:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.head_commit.message</span> <span class="string">&#125;&#125;</span> <span class="comment"># 直接将提交消息传输到 GitHub Pages 存储库</span></span><br></pre></td></tr></table></figure>

<h3 id="7-3-设置-deploy-key"><a href="#7-3-设置-deploy-key" class="headerlink" title="7.3 设置 deploy_key"></a>7.3 设置 deploy_key</h3><p>拿到第5步中生成的密钥。</p>
<ul>
<li><code>id_rsa</code> 私钥</li>
<li><code>id_rsa.pub </code>公钥</li>
</ul>
<p>转到<code>Deploy Keys</code>并使用<code>Allow write access</code>添加您的公钥<code>id_rsa.pub</code>，name写为<code>HEXO_ACTIONS_DEPLOY_KEY</code>，指定用途，方便后面维护</p>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/image-20220905113340582.png" alt="image-20220905113340582"></p>
<p>转到<code>Actions secrets</code>并将您的私钥 <code>id_rsa</code>  添加为 <code>ACTIONS_DEPLOY_KEY</code>（这个名称在yml文件中需要使用）</p>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/image-20220905111813096.png" alt="image-20220905111813096"></p>
<h3 id="7-4-启动-Git-Action"><a href="#7-4-启动-Git-Action" class="headerlink" title="7.4 启动 Git Action"></a>7.4 启动 Git Action</h3><p>本地仓库直接<code>push</code>，触发 <code>GitHub Actions</code> 自动构建发布</p>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/image-20220905112116599.png" alt="image-20220905112116599"></p>
<h3 id="7-5-非法输入值"><a href="#7-5-非法输入值" class="headerlink" title="7.5     非法输入值"></a>7.5     非法输入值</h3><p>在 <code>pages.yml</code> 文件的 <code>Deploy</code> 步骤下，发布的时候需要一些参数配置，这些参数名是指定好的，不可以随便写，比如 <code>commit_msg</code>应该使用 <code>commit_message</code></p>
<blockquote>
<p>Warning: Unexpected input(s) ‘commit_msg’, valid inputs are [‘deploy_key’, ‘github_token’, ‘personal_token’, ‘publish_branch’, ‘publish_dir’, ‘destination_dir’, ‘external_repository’, ‘allow_empty_commit’, ‘keep_files’, ‘force_orphan’, ‘user_name’, ‘user_email’, ‘commit_message’, ‘full_commit_message’, ‘tag_name’, ‘tag_message’, ‘enable_jekyll’, ‘disable_nojekyll’, ‘cname’, ‘exclude_assets’]</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/1037867-20220820200146599-1908531800.png" alt="img"></p>
<h2 id="8-参考文献"><a href="#8-参考文献" class="headerlink" title="8 参考文献"></a>8 参考文献</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/all-smile/p/16608503.html">https://www.cnblogs.com/all-smile/p/16608503.html</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/07/java/Java%20%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/">java 动态代理</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-08</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/java/">java</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/">动态代理</a></span><div class="content"><p>[TOC]</p>
<h1 id="一、代理模式简介"><a href="#一、代理模式简介" class="headerlink" title="一、代理模式简介"></a>一、代理模式简介</h1><h2 id="1-1、代理模式"><a href="#1-1、代理模式" class="headerlink" title="1.1、代理模式"></a>1.1、代理模式</h2><p>提供了间接对目标对象进行访问的方式，即通过代理对象访问目标对象。</p>
<h2 id="1-2、代理模式的好处"><a href="#1-2、代理模式的好处" class="headerlink" title="1.2、代理模式的好处"></a>1.2、代理模式的好处</h2><p>在实现目标对象功能的基础上，增加额外的功能，扩充目标对象的功能。符合<strong>开闭原则</strong>：即不改变既有代码的前提下，对功能进行扩展。</p>
<p>例如，需要在所有类的方法执行前后打印日志。</p>
<h1 id="二、JVM-创建对象"><a href="#二、JVM-创建对象" class="headerlink" title="二、JVM 创建对象"></a>二、JVM 创建对象</h1><h2 id="对象创建过程"><a href="#对象创建过程" class="headerlink" title="对象创建过程"></a>对象创建过程</h2><center>
<img style="border-radius: 0.3125em;
box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" 
src="http://msy-test.oss-cn-hangzhou.aliyuncs.com/share/docs/java/dynamicProxy/Java%20%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%20fig001.png">
<br>
<div style="color:orange; border-bottom: 1px solid #d9d9d9;
display: inline-block;
color: #999;
padding: 2px;">对象创建过程</div>


<h2 id="关于-Class-对象和实例对象"><a href="#关于-Class-对象和实例对象" class="headerlink" title="关于 Class 对象和实例对象"></a>关于 Class 对象和实例对象</h2><p><strong>Class 对象</strong>：每个类运行时的类型信息由 Class 对象来表示，Class 对象中包含与这个类有关的信息。</p>
<p><strong>实例对象</strong>：实例对象是由 Class 对象创建的。</p>
<center>
<img style="border-radius: 0.3125em;
box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" 
src="http://msy-test.oss-cn-hangzhou.aliyuncs.com/share/docs/java/dynamicProxy/Java%20%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%20fig002.png">
<br>
<div style="color:orange; border-bottom: 1px solid #d9d9d9;
display: inline-block;
color: #999;
padding: 2px;"> Class 对象和实例对象</div>

<p>Java 程序在开始运行之前并非被完全加载，其各个类都是在必需时才加载的 —— 懒加载</p>
<h2 id="获取-Class-对象的方式"><a href="#获取-Class-对象的方式" class="headerlink" title="获取 Class 对象的方式"></a>获取 Class 对象的方式</h2><blockquote>
<p>Class.forName(“类的全限定名”)</p>
</blockquote>
<blockquote>
<p>实例对象.getClass()</p>
</blockquote>
<blockquote>
<p>类名.class —— 类字面常量</p>
<p>如：</p>
<p>Class clazz = int.class</p>
</blockquote>
<p>如果字段被 <code>static final</code> 修饰，称为“编译时常量”。调用该字段时，不会对类进行初始化。</p>
<p>因为这个字段在编译期就把结果放入常量池中了。</p>
<h1 id="三、静态代理"><a href="#三、静态代理" class="headerlink" title="三、静态代理"></a>三、静态代理</h1><p>静态代理的逻辑：</p>
<center>
<img style="border-radius: 0.3125em;
box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" 
src="http://msy-test.oss-cn-hangzhou.aliyuncs.com/share/docs/java/dynamicProxy/Java%20%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%20fig003.png">
<br>
<div style="color:orange; border-bottom: 1px solid #d9d9d9;
display: inline-block;
color: #999;
padding: 2px;">静态代理的逻辑</div>


<h2 id="静态代理缺陷"><a href="#静态代理缺陷" class="headerlink" title="静态代理缺陷"></a>静态代理缺陷</h2><p>对于每一个目标类都需要写对应的 XXProxy 代理类，如果目标类很多的话，写成百上千个代理类是不切实际的。</p>
<h1 id="四、动态代理"><a href="#四、动态代理" class="headerlink" title="四、动态代理"></a>四、动态代理</h1><h2 id="动态代理的思路"><a href="#动态代理的思路" class="headerlink" title="动态代理的思路"></a>动态代理的思路</h2><center>
<img style="border-radius: 0.3125em;
box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" 
src="http://msy-test.oss-cn-hangzhou.aliyuncs.com/share/docs/java/dynamicProxy/Java%20%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%20fig004.png">
<br>
<div style="color:orange; border-bottom: 1px solid #d9d9d9;
display: inline-block;
color: #999;
padding: 2px;">动态代理的思路</div>

<h2 id="动态代理的优势"><a href="#动态代理的优势" class="headerlink" title="动态代理的优势"></a>动态代理的优势</h2><p>在程序运行时，JVM 才对被代理对象（目标对象）生成代理对象。涉及到反射。</p>
<p><em>注意，动态代理的时候目标对象必须得实现接口，否则动态代理无法使用，原因很明显，因为代理对象本身不用实现接口，它用到的是目标对象的引用，所以如果目标对象不实现接口的话，根本没法进行代理。</em></p>
<p>如何从 interface 创建 Class 对象？</p>
<p>JDK 提供：<code>java.lang.reflect.InvocationHandler</code>接口 + <code>java.lang.reflect.Proxy</code> 类</p>
<p>Proxy 类有一个静态方法： </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; getProxyClass(ClassLoader loader, Class&lt;?&gt;... interfaces)</span><br></pre></td></tr></table></figure>

<p>入参是 ClassLoader 类加载器以及一组接口 Class 对象。出参是 Class 类型，也就是一个 Class 对象，实际就是一个代理 Class，通过这个 Class 可以创建对应入参的代理对象。</p>
<center>
<img style="border-radius: 0.3125em;
box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" 
src="http://msy-test.oss-cn-hangzhou.aliyuncs.com/share/docs/java/dynamicProxy/Java%20%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%20fig005.png">
<br>
<div style="color:orange; border-bottom: 1px solid #d9d9d9;
display: inline-block;
color: #999;
padding: 2px;"> </div>

<h2 id="动态代理的实现"><a href="#动态代理的实现" class="headerlink" title="动态代理的实现"></a>动态代理的实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicProxy</span>  </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="comment">// 通过 Dog 接口创建了一个代理 Class</span></span><br><span class="line">    Class proxyClass = Proxy.getProxyClass(Dog.class.getClassLoader(), Dog.class);</span><br><span class="line">    Constructor constructor = proxyClass.getConstructor(InvocationHandler.class);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 用构造器创建代理实例对象，需要传入 InvocationHandler</span></span><br><span class="line">    Dog dog = (Dog)constructor.newInstance(<span class="keyword">new</span> InvocationHandler() &#123;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 调用代理对象的方法，都会调用 invoke()</span></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="comment">// 代理需要目标对象的引用</span></span><br><span class="line">        <span class="comment">// 手动创建目标对象，硬编码，不推荐</span></span><br><span class="line">        <span class="comment">// 推荐的做法是，将目标对象作为参数传进来</span></span><br><span class="line">        WhiteDog whiteDog = <span class="keyword">new</span> WhiteDog();</span><br><span class="line">        Object result = method.invoke(whiteDog, args);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dog.canRun();</span><br><span class="line">    dog.canBark();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重构之后</span></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicProxy</span>  </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    WhiteDog target = <span class="keyword">new</span> WhiteDog();</span><br><span class="line">    Dog dog = (Dog) getProxy(target);</span><br><span class="line"></span><br><span class="line">    dog.canRun();</span><br><span class="line">    dog.canBark();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 传入目标对象的引用 target  </span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">getProxy</span><span class="params">(<span class="keyword">final</span> Object target)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    Class proxyClass = Proxy.getProxyClass(Dog.class.getClassLoader(), Dog.class);</span><br><span class="line">    Constructor constructor = proxyClass.getConstructor(InvocationHandler.class);</span><br><span class="line">    <span class="comment">// 入参是目标对象 target， 出参是代理对象 proxy， 类型是 Object </span></span><br><span class="line">    <span class="keyword">return</span> constructor.newInstance(<span class="keyword">new</span> InvocationHandler() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(target, args);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>实际使用的是 <code>Proxy.newProxyInstance()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传入目标对象的引用 target  </span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">getProxy2</span><span class="params">(<span class="keyword">final</span> Object target)</span> <span class="keyword">throws</span> Throwable</span>&#123;</span><br><span class="line"><span class="keyword">return</span> Proxy.newProxyInstance(</span><br><span class="line">        target.getClass().getClassLoader(), <span class="comment">// 类加载器</span></span><br><span class="line">        target.getClass().getInterfaces(),	<span class="comment">// 让代理实例对象和原对象实现同一个接口</span></span><br><span class="line">        <span class="comment">// 这么写其实是 匿名内部类 的写法</span></span><br><span class="line">        <span class="keyword">new</span> InvocationHandler() &#123;			<span class="comment">// 代理对象的方法最终会导向 invoke 方法</span></span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> method.invoke(target,args);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="动态代理逻辑图"><a href="#动态代理逻辑图" class="headerlink" title="动态代理逻辑图"></a>动态代理逻辑图</h2><center>
<img style="border-radius: 0.3125em;
box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" 
src="http://msy-test.oss-cn-hangzhou.aliyuncs.com/share/docs/java/dynamicProxy/Java%20%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%20fig006.png">
<br>
<div style="color:orange; border-bottom: 1px solid #d9d9d9;
display: inline-block;
color: #999;
padding: 2px;">动态代理逻辑图</div>


<h1 id="五、Cglib-代理"><a href="#五、Cglib-代理" class="headerlink" title="五、Cglib 代理"></a>五、Cglib 代理</h1><h2 id="Cglib-代理的实现"><a href="#Cglib-代理的实现" class="headerlink" title="Cglib 代理的实现"></a>Cglib 代理的实现</h2><p>前面说的动态代理需要目标类实现接口，但是如果某个类根本不实现接口怎么办呢？这时候就需要 Cglib 代理了，也称 <strong>子类代理</strong>。</p>
<p>逻辑是在内存中构建一个子类对象集成目标对象，实现目标对象的功能扩展。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> net.sf.cglib.proxy.Enhancer;</span><br><span class="line"><span class="keyword">import</span> net.sf.cglib.proxy.MethodInterceptor;</span><br><span class="line"><span class="keyword">import</span> net.sf.cglib.proxy.MethodProxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CglibProxy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 目标： 通过 Cglib 代理 BlackDog</span></span><br><span class="line">    Enhancer enhancer = <span class="keyword">new</span> Enhancer();</span><br><span class="line">    enhancer.setSuperclass(BlackDog.class);</span><br><span class="line">    </span><br><span class="line">    enhancer.setCallback(<span class="keyword">new</span> MethodInterceptor() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object o, Method method, Object[] objects, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="comment">// 此处一定要使用 proxy 的 invokeSuper 方法来调用目标类的方法  </span></span><br><span class="line">        <span class="keyword">return</span> methodProxy.invokeSuper(o, objects);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 生成代理实例  </span></span><br><span class="line">    BlackDog dog = (BlackDog)enhancer.create();</span><br><span class="line">    dog.canBark();</span><br><span class="line">    dog.canRun();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Cglib-代理总结"><a href="#Cglib-代理总结" class="headerlink" title="Cglib 代理总结"></a>Cglib 代理总结</h2><p>在 Spring 的 AOP 编程中: 面向切面编程</p>
<p>如果加入容器的目标对象<strong>有实现接口, 用 JDK 的动态代理</strong></p>
<p>如果目标对象<strong>没有实现接口,用 Cglib 代理</strong>。</p>
<h1 id="六、参考材料"><a href="#六、参考材料" class="headerlink" title="六、参考材料"></a>六、参考材料</h1><p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/20794107">Java 动态代理作用是什么？</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jie-y/p/10732347.html">Java中三种代理模式</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/dufufd/article/details/80537638">Java中Class对象详解</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/11/09/%E8%B0%83%E7%A0%94/%E4%BA%91%E5%8E%9F%E7%94%9F-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%A0%94/">云原生概念和技术路线</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-11-10</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E8%B0%83%E7%A0%94/">调研</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/">云原生</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/%E5%8F%91%E5%B1%95%E8%B6%8B%E5%8A%BF/">发展趋势</a></span><div class="content"><h1 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h1><p><a href="#_Toc78190625">目录    1</a><br><a href="#_Toc78190626">一、    调研方向    2</a><br><a href="#_Toc78190627">二、    云原生的概念    3</a><br><a href="#_Toc78190630">2.1    云原生的诞生    3</a><br><a href="#_Toc78190631">2.2    云原生的发展历程    3</a><br><a href="#_Toc78190632">2.3    Pivotal的云原生定义    4</a><br><a href="#_Toc78190633">2.4    Gartner的云原生定义    5</a><br><a href="#_Toc78190634">2.5    CNCF的云原生定义    5</a><br><a href="#_Toc78190635">2.6    云原生定义概括    5</a><br><a href="#_Toc78190636">三、    CNCF    7</a><br><a href="#_Toc78190638">3.1    云原生计算基金会CNCF    7</a><br><a href="#_Toc78190639">3.2    CNCF云原生路线图（Trail Map）    7</a><br><a href="#_Toc78190640">3.3    CNCF云原生全景图（Trail Map）    8</a><br><a href="#_Toc78190641">四、    相关技术及发展趋势    10</a><br><a href="#_Toc78190644">4.1    CNCF云原生全景图详解    10</a><br><a href="#_Toc78190645"><strong>4.1.1</strong>    <strong>供应层 （Provisioning）</strong>    10</a><br><a href="#_Toc78190646"><strong>4.1.2</strong>    <strong>运行时层（Runtime）</strong>    10</a><br><a href="#_Toc78190647"><strong>4.1.3</strong>    <strong>编排和管理层（Orchestration and Management）</strong>    10</a><br><a href="#_Toc78190648"><strong>4.1.4</strong>    <strong>应用定义和开发层 （Application Definition and Developement)</strong>    11</a><br><a href="#_Toc78190649">4.1.5    贯穿所有层的工具    11</a><br><a href="#_Toc78190650"><strong>4.1.6</strong>    <strong>可观察性和分析（Observability and Analysis）</strong>    12</a><br><a href="#_Toc78190651"><strong>4.1.7</strong>    <strong>平台类（Platform）</strong>    12</a><br><a href="#_Toc78190652"><strong>4.1.8</strong>    <strong>小结</strong>    12</a><br><a href="#_Toc78190653">4.2    云原生核心概念    12</a><br><a href="#_Toc78190654">4.2.1    DevOps与CI/CD    13</a><br><a href="#_Toc78190655">4.2.2    微服务、API管理与集成    14</a><br><a href="#_Toc78190656">4.2.3    容器与Docker    14</a><br><a href="#_Toc78190657">4.2.4    Kubernetes与容器编排之战    15</a><br><a href="#_Toc78190658">4.3    发展趋势和未来展望    15</a><br><a href="#_Toc78190659">4.3.1    机遇和挑战    15</a><br><a href="#_Toc78190660">4.3.2    云原生2.0（华为）    18</a><br><a href="#_Toc78190661">4.3.3    未来发展趋势    18</a><br><a href="#_Toc78190662">五、    参考链接    20</a></p>
<h1 id="1-调研方向"><a href="#1-调研方向" class="headerlink" title="1 调研方向"></a>1 调研方向</h1><p><strong>梳理云原生的概念及相关技术和发展趋势。</strong><br><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/1627293312483-b1fe9a40-7739-4fe9-b0ba-95bd5097721a.png"><br><a target="_blank" rel="noopener" href="https://landscape.cncf.io/">https://landscape.cncf.io/</a><br>图 一.1CNCF云原生全景图（详）</p>
<h1 id="2-云原生的概念"><a href="#2-云原生的概念" class="headerlink" title="2 云原生的概念"></a>2 云原生的概念</h1><ol>
<li></li>
<li><h2 id="2-1-云原生的诞生"><a href="#2-1-云原生的诞生" class="headerlink" title="2.1 云原生的诞生"></a>2.1 云原生的诞生</h2>随着虚拟化技术的成熟和分布式框架的普及，在容器技术、可持续交付、编排系统等开源社区的推动下，以及微服务等开发理念的带动下，应用上云已经是不可逆转的趋势。<br><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/1627293312952-24b4c269-ad7c-4d09-b4ba-3560ce116dde.png"><br>图 二.1云原生的发展史，来自CNCF基金会执行董事Dan Kohn<br>云计算的3层划分，即基础设施即服务(IaaS)、平台即服务(PaaS)、软件即服务(SaaS)为云原生提供了技术基础和方向指引，真正的云化不仅仅是基础设施和平台的变化，应用也需要做出改变，<strong>摈弃传统的土方法，在架构设计、开发方式、部署维护等各个阶段和方面都基于云的特点，重新设计，从而建设全新的云化的应用，即云原生应用</strong>。</li>
</ol>
<h2 id="2-2-云原生的发展历程"><a href="#2-2-云原生的发展历程" class="headerlink" title="2.2 云原生的发展历程"></a>2.2 云原生的发展历程</h2><p>云原生（Cloud Native）最初来描述云上应用的典型架构与特性，随着容器、kubernetes、Serverless、FaaS技术的演进，<strong>CNCF（Cloud Native Computing Foundation ，云原生计算基金会）</strong>把云原生的概念更广泛地定义为“让应用更有弹性、容错性、观测性的基础技术，让应用更容易部署、管理的基础软件、让应用更容易编写、编排的运行框架等”，希望能够让开发者最好的利用云的资源、产品和交付能力。<br>下边大致梳理一下云原生的发展过程。</p>
<ul>
<li>2004 年 ~ 2007 年，Google 已在内部大规模地使用像 Cgroups 这样的容器技术；</li>
<li>2008 年，Google 将 Cgroups 合并进入了 Linux 内核主干。</li>
<li>2013 年，Docker 项目正式发布。</li>
<li>2014 年，Kubernetes 项目也正式发布。</li>
<li>2015 年，CNCF （Cloud Native Computing Foundation）云原生基金会成立，CNCF 是目前云计算领域最成功的开源基金会之一，是 Kubernetes、 etcd、Envoy 等知名开源项目的托管基金会。</li>
<li>2017 年，CNCF 达到 170 个成员和 14 个基金项目。</li>
<li>2018 年，CNCF 成立三周年有了 195 个成员，19 个基金会项目和 11 个孵化项目，如此之快的发展速度在整个云计算领域都是非常罕见的。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/1627293313305-f9446b43-e3d3-4f41-be97-be7c5dc122fc.png"></p>
<h2 id="2-3-Pivotal的云原生定义"><a href="#2-3-Pivotal的云原生定义" class="headerlink" title="2.3 Pivotal的云原生定义"></a>2.3 Pivotal的云原生定义</h2><p>云原生（Cloud Native）这个概念，是由Pivotal的Matt Stine于2013年首次提出，他还在2015年出版了《Migrating to Cloud-Native Application Architectures（迁移到云原生架构）》一书。<br><strong>Pivotal作为云原生（Cloud Native）应用架构中先驱者和探路者</strong>，于2015年提出了云原生应用。同一年Google主导成立了云原生计算基金会（CNCF），起初CNCF对云原生的定义包含三个方面：应用容器化、面向微服务架构、应用支持容器的编排调度。<br>随着科技的发展，CNCF基金会对云原生进行了重新定义：云原生的代表技术包括<strong>容器、服务网格、微服务、不可变基础设施和声明式API</strong>。<br>上面提到云原生的代表技术包括容器、服务网格（Service Mesh）、微服务、不可变基础设施和声明式API。另外一种比较主流的说法是云原生=微服务+DevOps+持续交付+容器化<br><strong>Pivotal最新官网对云原生概括为4个要点：DevOps+持续交付+微服务+容器。</strong><br><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/1627293313678-41e6055a-aa27-4b52-9f8d-9f5a657a697b.jpeg"></p>
<h2 id="2-4-Gartner的云原生定义"><a href="#2-4-Gartner的云原生定义" class="headerlink" title="2.4 Gartner的云原生定义"></a>2.4 Gartner的云原生定义</h2><p>2019年，Gartner曾经发布报告表示云原生时代已经到来，在未来三年中将有75%的全球化企业将在生产中使用容器化的应用。<br>但Gartner提到云原生的定义尚不明确，却含义丰富。云原生对于不同的人和组织来讲，有着不同的理解。众多顶级技术的铸造者、Matt Stine的东家Pivotal<a href="https://link.zhihu.com/?target=https://tanzu.vmware.com/de/cloud-native">如此</a>定义云原生。<br><strong>“Cloud native is an approach to building and running applications that fully exploit the advantages of the cloud computing model.”–云原生是一种构建和运行充分利用云计算模型优势的应用程序的方法。</strong></p>
<h2 id="2-5-CNCF的云原生定义"><a href="#2-5-CNCF的云原生定义" class="headerlink" title="2.5 CNCF的云原生定义"></a>2.5 CNCF的云原生定义</h2><p>CNCF云原生计算基金会<a href="https://link.zhihu.com/?target=https://github.com/cncf/toc/blob/master/DEFINITION.md%25EF%25BC%2589">如此</a>定义云原生：<br><strong>“云原生技术有利于各组织在公有云、私有云和混合云等新型动态环境中，构建和运行可弹性扩展的应用。云原生的代表技术包括<strong><strong>容器、服务网格（Service Mesh）、微服务、不可变基础设施和声明式API</strong></strong>。这些技术能够构建容错性好、易于管理和便于观察的松耦合系统。结合可靠的自动化手段，云原生技术使工程师能够轻松地对系统作出频繁和可预测的重大变更。”</strong><br><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/1627293314003-b21794bd-9807-4fb2-a4ad-5f25193e9b00.jpeg"></p>
<h2 id="2-6-云原生定义概括"><a href="#2-6-云原生定义概括" class="headerlink" title="2.6 云原生定义概括"></a>2.6 云原生定义概括</h2><p>云原生是指从云的原生应用角度出发，一整套设计、开发、部署、运行、维护的流程、技术栈以及背后文化理念的统称。<br><strong>云原生简单来说，摈弃传统的土方法，在架构设计、开发方式、部署维护等各个阶段和方面都基于云的特点，重新设计，从而建设全新的云化的应用，即云原生应用</strong>。</p>
<h1 id="3-CNCF"><a href="#3-CNCF" class="headerlink" title="3 CNCF"></a>3 CNCF</h1><ol>
<li><h2 id="3-1-云原生计算基金会CNCF"><a href="#3-1-云原生计算基金会CNCF" class="headerlink" title="3.1 云原生计算基金会CNCF"></a>3.1 云原生计算基金会CNCF</h2>提到云原生，就不能不介绍云原生计算基金会CNCF（Cloud Native Computing Foundation）。CNCF于2015 年7月<strong>由Google 牵头成立，隶属于 Linux 基金会，初衷是围绕云原生服务云计算，致力于培育和维护一个厂商中立的开源生态系统</strong>，维护和集成开源技术，支持编排容器化微服务架构应用，通过将最前沿的模式民主化，让这些创新为大众所用。<br>CNCF的使命包括以下三点：<br>• 容器化包装<br>• 通过中心编排系统的动态资源管理<br>• 面向微服务<br>全球主流的科技企业和云计算厂商绝大部分都是CNCF会员，其中不乏多家来自中国的科技巨头。<br><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/1627293314250-21eebf4a-5c45-4560-8e75-f7a2f17a0c79.jpeg"><br>图 二.2 CNCF黄金、白金会员</li>
</ol>
<h2 id="3-2-CNCF云原生路线图（Trail-Map）"><a href="#3-2-CNCF云原生路线图（Trail-Map）" class="headerlink" title="3.2 CNCF云原生路线图（Trail Map）"></a>3.2 CNCF云原生路线图（Trail Map）</h2><p>对于企业在复杂的基础架构之上如何推动云原生应用的更好落地，从而更好地适应环境与业务的发展，CNCF给出了<strong>路线图（Trail Map）</strong>用于对用户在整体上给出指导建议，<strong>共分成十个步骤（容器化；CI/CD；应用定义及编排；监控及分析；服务代理、发现和网格；网络、策略及安全；分布式数据库及存储；流与消息；镜像库与运行时；软件分发）</strong>进行实施，而在不同的步骤都可以结合CNCF全景图（Landscape）中列出的产品或服务进行选择。<br><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/1627293314859-633d3653-eca0-4841-979b-a935bc00f32f.png"></p>
<h2 id="3-3-CNCF云原生全景图（Trail-Map）"><a href="#3-3-CNCF云原生全景图（Trail-Map）" class="headerlink" title="3.3 CNCF云原生全景图（Trail Map）"></a>3.3 CNCF云原生全景图（Trail Map）</h2><p><a href="https://link.zhihu.com/?target=https://www.cncf.io/"><strong>CNCF全景图</strong></a><strong>则列举了和云原生相关的产品及服务的完整名单</strong>，这1381个项目共同构成了恢弘庞大的云原生世界。<strong>整个全景图按照功能分为29个模块，分别归属于9种大的类别（应用定义与开发、编排与管理、运行时、配置、平台、可观察性与分析、Serverless、会员和其它）</strong>。值得注意的是其中专门有一种分类是<a href="https://link.zhihu.com/?target=https://landscape.cncf.io/format=card-mode&grouping=headquarters&headquarters=china,hong-kong,taiwan">Cards from China</a>，列举了来自中国的145个项目，其中不乏许多大家耳熟能详的知名项目。<br>从CNCF的理念及野心来看，基于云原生的基础设施正在壮大和蚕食非云的市场，未来极有可能成为整个IT生态事实上的意见领袖和领导者。<br><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/1627293315531-db288421-d207-441f-a4cc-927b5594b786.png"></p>
<h1 id="4-相关技术及发展趋势"><a href="#4-相关技术及发展趋势" class="headerlink" title="4 相关技术及发展趋势"></a>4 相关技术及发展趋势</h1><ol>
<li></li>
<li><h2 id="4-1-CNCF云原生全景图详解"><a href="#4-1-CNCF云原生全景图详解" class="headerlink" title="4.1  CNCF云原生全景图详解"></a>4.1  CNCF云原生全景图详解</h2>首先，我们剥离掉所有单个的技术，仅查看类别（如下图）。图中有不同的“行”，像建筑的不同层，每层都有自己的子类别。最底层提供了构建云原生基础设施的工具。往上，你可以开始添加运行和管理应用程序所需的工具，比如运行时和调度层。在最上层，有定义和开发应用程序的工具，比如数据库、镜像构建和 CI/CD 工具（我们将在后文讨论）。<br>云原生全景图始于基础设施，往上的每一层都更接近实际的应用程序。这就是每层代表的意思（后面我们会讨论上图右边的两“列”）。下面我们就从最底层开始，逐层进行解析。<br><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/1627293315921-c62033a6-4333-4a16-b4e4-da1dc66a5d21.png"></li>
</ol>
<h3 id="4-1-1-供应层-（Provisioning）"><a href="#4-1-1-供应层-（Provisioning）" class="headerlink" title="4.1.1 供应层 （Provisioning）"></a>4.1.1 <strong>供应层 （Provisioning）</strong></h3><p><strong>供应指的是为云原生应用准备标准基础环境所涉及的工具。</strong>它包含了基础设施的创建、管理、配置流程的自动化，以及容器镜像的扫描、签名和存储等。供应层通过提供设置和实施策略，在应用程序和平台中构建身份验证和授权，以及处理密钥分发等等的工具，也拓展到了安全领域。</p>
<ul>
<li><p>自动化和部署工具：帮助工程师在无需人工干预情况下即可构建计算环境；</p>
</li>
<li><p>容器注册表：存储应用程序的可执行文件；</p>
</li>
<li><p>不同安全领域的安全和合规框架；密钥管理解决方案：通过加密确保只有授权的用户才能访问特定的应用程序。</p>
</li>
<li><p>这些工具使工程师可以编写基础设施参数，使系统可以按需搭建新环境，确保了一致性和安全性。</p>
<h3 id="4-1-2-运行时层（Runtime）"><a href="#4-1-2-运行时层（Runtime）" class="headerlink" title="4.1.2 运行时层（Runtime）"></a>4.1.2 <strong>运行时层（Runtime）</strong></h3><p>像很多 IT 术语一样，运行时没有严格的定义，且可以根据语境有不同的用法。狭义上讲，<strong>运行时是特定机器上准备运行应用程序的沙盒——也就是保障应用程序正常运行所需的最低配置</strong>。广义上讲，运行时是运行一个应用程序所需的所有工具。在 CNCF 云原生全景图中，运行时保障了容器化应用程序组件的运行和通信。</p>
</li>
<li><p>云原生存储：为容器化应用提供虚拟磁盘或持久化存储；</p>
</li>
<li><p>容器运行时：为容器提供隔离、资源和安全；</p>
</li>
<li><p>云网络：分布式系统的节点（机器或进程）通过其连接和通信。</p>
<h3 id="4-1-3-编排和管理层（Orchestration-and-Management）"><a href="#4-1-3-编排和管理层（Orchestration-and-Management）" class="headerlink" title="4.1.3 编排和管理层（Orchestration and Management）"></a>4.1.3 <strong>编排和管理层（Orchestration and Management）</strong></h3><p>一旦按照安全和合规性标准（供应层）自动化基础设施供应，并安装了应用程序运行所需的工具（运行时层），工程师就需要弄清楚如何编排和管理应用程序。<strong>编排和管理层将所有容器化服务（应用程序组件）作为一个群组管理</strong>。这些容器化服务需要相互识别和通信，并需要进行协调。这一层可为云原生应用提供自动化和弹性能力，使云原生应用天然具有可扩展性。</p>
</li>
<li><p>编排和调度：部署和管理容器集群，确保它们具有<a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/as?from=10680">弹性伸缩</a>能力，相互之间低耦合，并且可扩展。事实上，编排工具（绝大多数情况下就是 Kubernetes）通过管理容器和操作环境构成了集群；</p>
</li>
<li><p>协调和服务发现：使得服务（应用程序组件）之间可以相互定位和通信；</p>
</li>
<li><p>远程进程调用（RPC）：使跨节点服务间通信的技术；</p>
</li>
<li><p>服务代理：服务间通信的中介。服务代理的唯一目的就是对服务之间的通信进行更多控制，而不会对通信本身添加任何内容。服务代理对下面将提到的服务网格（Service Mesh）至关重要。</p>
</li>
<li><p>API 网关：一个抽象层，外部应用可通过 API 网关进行通信；</p>
</li>
<li><p>Service Mesh：某种程度上类似于 API 网关，它是应用程序进行通信的专用基础架构层，提供基于策略的内部服务间通信。此外，它还可能包含流量加密、服务发现、应用程序监控等内容。</p>
<h3 id="4-1-4-应用定义和开发层-（Application-Definition-and-Developement"><a href="#4-1-4-应用定义和开发层-（Application-Definition-and-Developement" class="headerlink" title="4.1.4 应用定义和开发层 （Application Definition and Developement)"></a>4.1.4 <strong>应用定义和开发层 （Application Definition and Developement)</strong></h3><p>我们来到了<strong>最顶层</strong>。应用定义和开发层，顾名思义，聚集了让工程师构建和运行应用程序的工具。上述所有内容都是关于构建可靠、安全的环境，以及提供全部所需的应用程序依赖。</p>
</li>
<li><p>数据库：使应用程序能以有序的方式收集数据；</p>
</li>
<li><p>流和消息传递：使应用程序能发送和接收消息（事件和流）。它不是网络层，而是让消息成为队列并处理消息的工具；</p>
</li>
<li><p>应用程序定义和镜像构建：用于配置、维护和运行容器镜像（应用程序的可执行文件）的服务；</p>
</li>
<li><p>持续集成和持续交付（CI/CD）：使开发者可自动测试代码是否与代码库（应用程序的其余部分）兼容。如果团队足够成熟，甚至可以自动部署代码到生产环境。</p>
<h3 id="4-1-5-贯穿所有层的工具"><a href="#4-1-5-贯穿所有层的工具" class="headerlink" title="4.1.5 贯穿所有层的工具"></a>4.1.5 贯穿所有层的工具</h3><p>接下来我们将进入到云原生全景图右侧贯穿所有层的两列。<strong>可观察性和分析（Observability&amp;analysis）</strong>是监控各层的工具，<strong>平台（Platforms）</strong>则将各层中不同的技术捆绑为一个解决方案。<br><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/1627293316220-2ac7bde6-6ebf-425e-ba5f-09dfc9ab5202.png"></p>
</li>
</ul>
<h3 id="4-1-6-可观察性和分析（Observability-and-Analysis）"><a href="#4-1-6-可观察性和分析（Observability-and-Analysis）" class="headerlink" title="4.1.6 可观察性和分析（Observability and Analysis）"></a>4.1.6 <strong>可观察性和分析（Observability and Analysis）</strong></h3><p>为了限制服务中断并降低解决问题的平均时间（MRRT），你需要监控和分析应用层序的方方面面，以便在出现异常时可立即发现并纠正。复杂环境中容易出现故障，这些工具可快速识别并解决故障，从而降低故障带来的影响。由于这一类别<strong>贯穿并监控各层</strong>，因此它在侧面，而不是嵌入到某一层中。</p>
<ul>
<li><p>日志工具：收集事件日志（有关进程的信息）；</p>
</li>
<li><p>监控方案：收集指标（以数字表示的系统参数，例如 RAM 可用性）；</p>
</li>
<li><p>追踪工具：追踪比监控更进了一步，它们监控用户请求的传播，与服务网格相关。</p>
</li>
<li><p>混沌工程（Chaos Engineering）：在生产环境中测试软件的工具，可识别缺陷并进行修复，减少其对服务交付的影响。</p>
<h3 id="4-1-7-平台类（Platform）"><a href="#4-1-7-平台类（Platform）" class="headerlink" title="4.1.7 平台类（Platform）"></a>4.1.7 <strong>平台类（Platform）</strong></h3><p>仅有存储并不能提供应用程序所需的全部功能。你还需要编排工具，容器运行时，服务发现，网络，API 网关等等。平台覆盖多层，将不同的工具组合在一起，以解决更大的问题。<br>配置和微调不同的模块使其安全可靠，并确保它利用的技术都能及时更新、所有漏洞都打了补丁，这并不是一件容易的事情。使用平台时，用户不用额外担心这些细节问题。<br>你可能会注意到，<strong>所有的类别都围绕着 Kubernetes 展开。这是因为 Kubernetes 虽然只是云原生景观图这张拼图中的一块，但它却是云原生技术栈的核心。</strong>顺便说一下，CNCF 刚创建时，Kubernetes 就是其中的第一个种子项目，后来才有了其他项目。</p>
</li>
<li><p>Kubernetes 发行版：采用未经修改的开放源代码（尽管有人对其进行了修改），并根据市场需要增加了其他功能；</p>
</li>
<li><p>托管的 Kubernetes：类似于 Kubernetes 发行版，但是由提供商托管；</p>
</li>
<li><p>Kubernetes 安装程序：自动执行 Kubernetes 的安装和配置过程；</p>
</li>
<li><p>PaaS/<a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/tke?from=10680">容器服务</a>：类似于托管的 Kubernetes，但是包含了一套更广泛的应用部署工具（通常是来自云原生景观图）。</p>
<h3 id="4-1-8-小结"><a href="#4-1-8-小结" class="headerlink" title="4.1.8 小结"></a>4.1.8 <strong>小结</strong></h3></li>
</ul>
<p><strong>在每个类别中，针对相同或相似的问题，都有不同的工具可选择。有一些是适用于新现实的预云原生技术，还有一些则是全新的。区别在于它们的实现和设计方法。没有完美的技术符合你的所有需求。大多数情况下，技术受设计和架构选择的限制——始终需要权衡取舍。</strong><br>在选择技术栈时，工程师必须仔细考虑每种能力和需要权衡取舍的地方，以确定最合适的选项。虽然这样会让情况变得更复杂，但在选择应用程序所需的最适合的数据存储、基础设施管理、消息系统等方案时，这样做是最可行的办法。现在，构建一个系统比云原生之前的时代容易多了。如果构建恰当，云原生技术将提供更强大的灵活性。在现如今快速变化的技术生态中，这可能是最重要的能力之一。<br>详细介绍云原生全景图的每一层，见 <a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1851558">https://cloud.tencent.com/developer/article/1851558</a></p>
<h2 id="4-2-云原生核心概念"><a href="#4-2-云原生核心概念" class="headerlink" title="4.2 云原生核心概念"></a>4.2 云原生核心概念</h2><p>下面的表格里代表性的列举了云原生技术层的几个领域及相关项目。<br><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/1627293316551-62a4bbc5-2ea4-40ad-b61c-11dab4af559d.jpeg"></p>
<h3 id="4-2-1-DevOps与CI-CD"><a href="#4-2-1-DevOps与CI-CD" class="headerlink" title="4.2.1 DevOps与CI/CD"></a>4.2.1 DevOps与CI/CD</h3><p><strong>DevOps</strong><br>DevOps（Development &amp; Operations，开发和运维）是09年提出来的概念，但一直没有太火。直到14年，容器与微服务架构的提出，DevOps才得到了快速的发展。DevOps不单是一个实现自动化的工具链，而是组织、流程与技术的结合。组织上强调全栈团队、团队特性专一、团队自治；技术上打通开发与运维；流程上强调端到端、可视化、灰度升级、A/B测试等。<br><strong>持续集成</strong><br>持续集成（CONTINUOUS INTEGRATION，CI）指的是开发人员频繁的（一天多次的）将所有开发者的工作合并到主干上。这些新提交在最终合并到主线之前，都需要通过编译和自动化测试流进行验证，以保障所有的提交在合并主干之后的质量问题，对可能出现的一些问题进行预警。持续集成的核心在于确保新增的代码能够与原先代码正确的集成。<br><strong>持续交付</strong><br>与持续集成相比，持续交付（CONTINUOUS DELIVERY，CD）的侧重点在于交付，其核心对象不在于代码，而在于可交付的产物。由于持续集成仅仅针对于新旧代码的集成过程执行了一定的测试，其变动到持续交付后还需要一些额外的流程。与持续集成相比较，持续交付添加了测试Test-&gt;模拟Staging-&gt;生产Production的流程，也就是为新增的代码添加了一个保证：确保新增的代码在生产环境中是可用的。<br><strong>持续部署</strong><br>持续部署（CONTINUOUS DEPLOYMENT）指的是通过自动化部署的手段将软件功能频繁的进行交付。与持续交付以及持续集成相比，持续部署强调了通过自动部署的手段，对新的软件功能进行集成。同持续交付相比持续集成的区别体现在对生产的自动化。从开发人员提交代码到编译、测试、部署的全流程不需要人工的干预，完全通过自动化的方式执行。这一策略加快了代码提交到功能上线的速度，保证新的功能能够第一时间部署到生产环境并被使用。</p>
<h3 id="4-2-2-微服务、API管理与集成"><a href="#4-2-2-微服务、API管理与集成" class="headerlink" title="4.2.2 微服务、API管理与集成"></a>4.2.2 微服务、API管理与集成</h3><p><strong>微服务</strong><br>微服务（Microservice）概念最早出现于2012年，2015年以后受到越来越多的关注，并且逐渐开始流行开来。其中著名技术大神Martin Fowler功不可没，他于2014年发表的一篇博客《Microservices: a definition of this new architectural term》（微服务：新技术架构的定义）清晰的定义和阐述了微服务概念。<br>微服务架构将单体应用，按照业务领域拆分为多个高内聚低耦合的小型服务，每个服务运行在独立进程，由不同的团队开发和维护，服务间采用轻量级通信机制，如HTTP RESTful API，独立自动部署，可以采用不同的语言及存储方式。微服务体现去中心化、天然分布式，是中台战略落地到IT系统的具体实现方式的技术架构，用来解决企业业务快速发展与创新时面临的系统弹性可扩展、敏捷迭代、技术驱动业务创新等难题。<br><strong>API管理与API集成</strong><br>微服务相关的两个具体领域，API管理与API集成。</p>
<ul>
<li>全生命周期API管理</li>
<li>API网关：微服务基础设施</li>
<li>Kong：API网关独角兽</li>
<li>RapidAPI：全球最大API市场</li>
<li>Mulesoft：API集成/iPaaS/API管理领头羊</li>
</ul>
<p><strong>微服务2.0：服务网格与Serverless</strong><br>微服务2.0的服务网格（Service Mesh）应运而生。服务网格这个词最早由著名开源服务网格项目Linkerd所在的Buoyant公司CEO William Morgan所提出。按照他的定义，服务网格是一个软件基础设施层，用于控制和监视微服务应用程序中的内部、服务到服务的流量。<br>Serverless是一种构建和管理基于微服务架构的完整流程，它与传统架构的不同之处在于，完全由第三方管理，由事件触发，存在于无状态、暂存的计算容器内。Serverless相关的重要概念包括FaaS（Functions as a Service，函数即服务）。开发者把函数上传到云厂商的FaaS平台，函数只在被请求时才实例化运行，然后被销毁，其它时候不占用任何服务器资源，完全实现按需使用，大幅度降低了服务器占用和成本。</p>
<h3 id="4-2-3-容器与Docker"><a href="#4-2-3-容器与Docker" class="headerlink" title="4.2.3 容器与Docker"></a>4.2.3 容器与Docker</h3><p><strong>虚拟化与容器</strong><br>虚拟机虽然可以隔离出很多“子电脑”，但占用空间大，启动慢，虚拟机软件可能还要花钱（例如VMware）。而容器技术恰好没有这些缺点，它不需要虚拟出整个操作系统，只需要虚拟一个小规模的环境（类似“沙箱”），启动时间很快，几秒钟就能完成。而且，它对资源的利用率很高（一台主机可以同时运行几千个Docker容器）。此外它占的空间很小，虚拟机一般要几GB到几十GB的空间，而容器只需要MB级甚至KB级。虚拟机和以Docker为代表的容器都是虚拟化技术，不过容器属于轻量级的虚拟化。<br><strong>Docker</strong><br>而Docker与传统的Linux容器也并不完全一致。Docker技术最初是建立在LXC技术之上的，大多数人都把LXC技术与传统的Linux容器联系在一起，尽管后来它已经摆脱了这种依赖性。LXC作为轻量级虚拟化很有用，但它没有很好的开发人员或用户体验。Docker技术带来的不仅仅是运行容器的能力，它还简化了创建和构建容器、加载镜像和镜像版本控制等过程。传统的Linux容器使用可以管理多个进程的init系统，这意味着整个应用可以作为一个整体运行。Docker鼓励将应用程序分解为它们各自的进程，并提供了实现这一点的工具，这种粒度有不少优点。</p>
<h3 id="4-2-4-Kubernetes与容器编排之战"><a href="#4-2-4-Kubernetes与容器编排之战" class="headerlink" title="4.2.4 Kubernetes与容器编排之战"></a>4.2.4 Kubernetes与容器编排之战</h3><p><strong>容器编排与Kubernetes</strong><br>在单机上运行容器，无法发挥它的最大效能，只有形成集群，才能最大程度发挥容器的良好隔离、资源分配与编排管理的优势。所以企业需要一套管理系统，对Docker及容器进行更高级更灵活的管理，按照用户的意愿和整个系统的规则，完全自动化的处理好容器之间的各种关系，这叫做编排（Orchestration）。<br>Kubernetes是基于Docker的开源容器集群管理系统，为容器化的应用提供资源调度、部署运行、服务发现、扩容缩容等整一套功能，因为容器本身可移植，所以Kubernetes容器集群能跑在私有云、公有云或者混合云上。</p>
<h2 id="4-3-发展趋势和未来展望"><a href="#4-3-发展趋势和未来展望" class="headerlink" title="4.3 发展趋势和未来展望"></a>4.3 发展趋势和未来展望</h2><h3 id="4-3-1-机遇和挑战"><a href="#4-3-1-机遇和挑战" class="headerlink" title="4.3.1 机遇和挑战"></a>4.3.1 机遇和挑战</h3><p><strong>机遇</strong><br>每一次IT产业架构的变革都会带来巨大的机遇和行业洗牌的挑战。过去的三四十年间，IT业经历了多次重大的变革，包括20世纪七八十年代从大型机向小型机的转移、九十年代C/S架构的普及，以及21世纪初互联网的兴起，先后造就了IBM、思科、惠普、Oracle、EMC、SAP等巨头企业。<br>历次IT技术革命还有个共同特点：无论原有的基础软硬件公司此前有多么牢不可破的垄断地位，一旦不能符合新的IT技术变革的趋势，洗牌在所难免。<br>而云原生是一种理念和架构，用于以针对云环境优化的方式组装上述所有基于云的组件。因此云原生也是一个目的地：对于那些希望实现基础设施和流程现代化，甚至组织文化现代化的企业来说，最终的目标是仔细选择最适合其具体情况的云技术。<br><strong>发展趋势</strong><br><strong>从统计数据和发展趋势来看，云原生被接受的程度和普及速度正在大大加快</strong>，例如下图显示，自从2016年以来容器的使用量每年都在快速上升。IDC预计，到2022年90%的应用程序将采用微服务架构和第三方代码，35%的生产应用程序将诞生于云端。由于容器和敏捷方法的采用，预计2018-2023年间将诞生5亿个新应用程序。由数字化转型，以及接受和采用新技术的需求驱动，云原生将更深入地渗透到大型企业组织中。这意味着云原生技术和方法可能会遵循敏捷和DevOps的模式，越来越多地吸引更多的利益相关者，包括管理者和业务线领导人，在未来几年内覆盖一半或更多的组织。<br><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/1627293316953-800bd837-c741-4c82-9c91-214b63f33740.png"><br>    <strong>云原生安全领域</strong><br>据CNCF统计，采用容器技术的挑战中，开发团队面临的文化挑战、安全性、复杂性、就绪性和监控分别排在前五位。<br><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/1627293317288-dfbe013f-8814-470e-8181-ea9c4ba02ae8.jpeg"><br>在云原生架构中，安全问题显得尤其突出的原因有以下几点：<br>1、快速迁移到云原生架构对企业安全状况和运营产生了深远的影响。在容器、微服务和编排框架的世界中，以持久“状态”运行在“服务器”上的“应用程序”的概念已经过时。现在，该应用程序或服务是一个分布式系统，由多个组件组成，这些组件运行在数量可变的节点上，处于几乎恒定的变化状态。依赖于机器隔离和可预测的系统状态的传统安全控制是无效的。对服务到服务的通信视而不见的安全策略以及缺乏水平可扩展的控件，根本无法跟上当今微服务应用程序的步伐。<br>2、随着企业将工作负载从数据中心转移到AWS、Google Cloud Platform和Microsoft Azure，它们已经改变了购买安全性的方式。他们需要独立于平台的安全工具，这样就不会被绑定到特定的云平台中。<br>3、复杂系统可以创建大量的警报和事件日志，这会是一项惊人的任务。安全项目被堆积如山的繁忙工作所淹没，分析师们疲惫不堪。随着分析师对惊人的数据量变得不敏感，真正的问题就从他们的手指间溜走了。<br>4、DevOps是一种协作方法，它将开发人员和IT操作统一起来，以加快应用程序的构建、测试和部署，它也影响了IT安全。当开发人员可以直接将他们的应用程序部署到生产服务器上，因为业务敏捷性需要它时，他们就不能停下来找出安全问题。DevOps提供了一种完全不同的安全方式，安全自动化有很多机会。<br><strong>和云原生安全相关的初创企业</strong><br><strong>1、Capsule8（B轮）</strong><br><strong>2、Aqua Security（C轮）</strong><br><strong>3、Twistlock（被收购）</strong></p>
<h3 id="4-3-2-云原生2-0（华为）"><a href="#4-3-2-云原生2-0（华为）" class="headerlink" title="4.3.2 云原生2.0（华为）"></a>4.3.2 云原生2.0（华为）</h3><p><strong>随着云原生技术的成熟和市场需求的升级，云计算的发展已步入新的阶段。云原生2.0时代已经到来</strong><br>从技术角度看，以容器、微服务以及动态编排为代表的云原生技术蓬勃发展，成为赋能业务创新的重要推动力，并已经应用到企业核心业务。从市场角度看，云原生技术已在金融、制造、互联网等多个行业得到广泛验证，支持的业务场景也愈加丰富，行业生态日渐繁荣。<br><strong>云原生2.0，企业云化从“ON Cloud”走向“IN Cloud“，生于云、长于云且立而不破</strong><br>企业新生能力基于云原生构建，使其生于云；应用、数据和AI的全生命周期云上完成，使其长于云；同时，既有能力通过立而不破的方式继承下来，并与新生能力有机协同。<br><strong>智能升级新阶段，赋能“新云原生企业”</strong><br>云原生2.0是企业智能升级的新阶段，企业云化从“ON Cloud”走向“IN Cloud“，成为”新云原生企业“。新生能力与既有能力立而不破、有机协同，实现资源高效、应用敏捷、业务智能，安全可信。<br><strong>云原生 IN 基础设施</strong><br>华为云基于“云原生 IN 基础设施”的理念，打造了以应用为中心的云原生基础设施。<br>目前，华为云云原生基础设施包含了云容器引擎CCE、云容器实例CCI、容器镜像服务SWR、智能边缘平台IEF、多云容器平台MCP、应用编排服务AOS等8大核心容器产品，并以此为基础构建了云原生裸金属、云原生高性能计算、云原生混合云、云原生边缘计算四大解决方案，满足企业业务智能升级过程中，对高性能基础设施、分布式业务架构、完善的云原生应用生态的诉求。<br><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/1627293317693-db100538-f8a6-4676-9b8f-68eaf25b8f20.png"></p>
<h3 id="4-3-3-未来发展趋势"><a href="#4-3-3-未来发展趋势" class="headerlink" title="4.3.3 未来发展趋势"></a>4.3.3 未来发展趋势</h3><p><strong>1、运维继续下沉，服务网格将成为主流，Serverless逐步推广</strong><br>云计算的一个发展方向就是运维下沉，将和业务无关的管理功能和运维工作尽量下沉到基础设施中，应用可以聚焦在业务能力的开发和运营。这个趋势演化的过程，影响了云计算的发展方向。从一开始的虚拟化，到IaaS，到PaaS都是将应用系统的部分运维职责交给平台运维的过程。<br><strong>2、软硬结合，解决虚拟化性能问题的利器</strong><br>随着云计算的发展，虚拟化技术越来越多的被使用，从计算虚拟化到存储虚拟化到网络虚拟化。虚拟化技术带来了很多的好处，虚拟化是基础设施服务化的基础，通过虚拟化，可以实现基础设施即代码，大大提升了资源的可管理性和自动化程度。但是虚拟化带来了另外一个问题，就是性能的损耗和软件进程之间的相互影响问题。<br>为了解决这两个问题，目前一个解决思路就是软硬结合，讲云平台的管理进程，如调度管理，网络的虚拟交换机，存储的虚拟存储网关从操作系统进程中剥离出来，让这些进程跑在专门设计的服务器板卡上，这些板卡专门设计的，通常含有定制化的芯片（FPGA），可以进行编程，从而可以保持虚拟化话的优势的同时，使的管理进程和业务进程隔离，避免相互影响；同时由于通过定制芯片（如FPGA）来处理，性能会有很大提升，大大降低了虚拟化的损耗。<br><strong>3、容器虚拟机进一步融合</strong><br>容器和虚拟机的优势和劣势，从容器技术诞生的那天起就一直在争论。容器轻量化，良好的封装能力和部署简便的特点，特别是在Kubernetes出现后，大有取代虚拟机的气势。但是在处理重应用（如关系型数据库，大数据等）的这点上，容器技术显得有些力不从心。在这种情况下，如何实现容器技术和虚拟化技术的融合，发挥两者的长处，成为云计算的一个发展课题。目前的技术主要有三种，一种是容器虚拟机的混布；一种是轻量级虚拟机；最后是安全容器。<br><strong>4、运维：可编程的Linux内核</strong><br>由于引入了可扩展的Berkeley数据包过滤器（Extended Berkeley Packet Filter，eBPF），Linux内核在<a target="_blank" rel="noopener" href="https://thenewstack.io/how-ebpf-turns-linux-into-a-programmable-kernel/">使用方式上有了重大变化</a>。<br><strong>5、开发：Rust逐渐替代C++</strong><br>数十年来，我们的操作系统和其他重要的基础架构软件一直使用C或C ++编写，但是，如今，越来越多的系统架构师得出的结论是，由于用不安全的方式来处理内存和其他因素，要完全安全地保护用这些语言编写的程序从根本上来说是困难的。<br>所以最近，越来越多的拥护者选择了新的语言<a target="_blank" rel="noopener" href="https://www.rust-lang.org/">Rust</a>，它不仅具有C/C ++的速度，而且还具有编写安全的应用程序所必需的组件。在2020年的AllThingsOpen虚拟会议上，<a target="_blank" rel="noopener" href="https://www.microsoft.com/">微软</a>云开发倡导者Ryan Levick <a target="_blank" rel="noopener" href="https://youtu.be/NQBVUjdkLAA">解释了</a>为什么Microsoft逐渐改用Rust来构建其基础结构软件，而不再使用C/C ++。并鼓励其他软件行业巨头也考虑相同的问题。</p>
<h1 id="5-参考链接"><a href="#5-参考链接" class="headerlink" title="5 参考链接"></a>5 参考链接</h1><ol>
<li><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/722745">https://developer.aliyun.com/article/722745</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/150190166">https://zhuanlan.zhihu.com/p/150190166</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/390567373">https://zhuanlan.zhihu.com/p/390567373</a></li>
<li><a target="_blank" rel="noopener" href="https://support.huaweicloud.com/productdesc-cce/cce_productdesc_0009.html">https://support.huaweicloud.com/productdesc-cce/cce_productdesc_0009.html</a></li>
<li><a target="_blank" rel="noopener" href="https://landscape.cncf.io/">https://landscape.cncf.io/</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/722745">https://developer.aliyun.com/article/722745</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/149658062">https://zhuanlan.zhihu.com/p/149658062</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1851558">https://cloud.tencent.com/developer/article/1851558</a></li>
<li></li>
</ol>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/08/07/%E6%95%B0%E6%8D%AE%E5%BA%93/NewSQL%E4%B8%BB%E6%B5%81%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%B9%E6%AF%94-GIS%E7%AF%87/">NewSQL主流数据库对比——GIS篇</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-08-08</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/GIS/">GIS</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/NewSQL/">NewSQL</a></span><div class="content"><h1 id="NewSQL主流数据库对比——GIS篇"><a href="#NewSQL主流数据库对比——GIS篇" class="headerlink" title="NewSQL主流数据库对比——GIS篇"></a>NewSQL主流数据库对比——GIS篇</h1><p>[TOC]</p>
<h2 id="NewSQL-简介"><a href="#NewSQL-简介" class="headerlink" title="NewSQL 简介"></a>NewSQL 简介</h2><p>NewSQL 是一种新方式关系数据库，意在整合 RDBMS 所提供的ACID事务特性，以及 NoSQL 提供的横向可扩展性。</p>
<p>大多数 NewSQL 数据库做了全新的设计，或是主要聚焦于 OLTP，或是采用了 OLTP/OLAP 的混合架构载的全新设计。</p>
<ul>
<li>一致性：相对于可用性而言，NewSQL 更重视一致性，即侧重 CAP 中的 C 和 P。</li>
<li>内存数据库：一些 NewSQL 解决方案使用内存（RAM）作为存储介质。</li>
<li>HTAP：HTAP（混合事务 / 分析处理，Hybrid Transactional/Analytical Processing）</li>
</ul>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/1166059074.png" alt="1166059074"></p>
<h2 id="！！！对比分析"><a href="#！！！对比分析" class="headerlink" title="！！！对比分析"></a>！！！对比分析</h2><table>
<thead>
<tr>
<th>NewSQL</th>
<th>开发商</th>
<th>是否开源</th>
<th>特性</th>
<th>分布式</th>
<th>空间支持</th>
<th>社区活跃度</th>
<th>拓展</th>
</tr>
</thead>
<tbody><tr>
<td>Spanner</td>
<td>谷歌</td>
<td>×</td>
<td>存储的数据是Key-value</td>
<td>水平扩展</td>
<td>×</td>
<td>Google社区</td>
<td></td>
</tr>
<tr>
<td>OceanBase</td>
<td>阿里</td>
<td>开源</td>
<td>MySQL/ORACLE兼容、增量数据放在内存、基线数据放在SSD盘、读写分</td>
<td>线性扩展</td>
<td>×</td>
<td>阿里社区、博客</td>
<td></td>
</tr>
<tr>
<td>TDSQL</td>
<td>腾讯</td>
<td>×</td>
<td>提供两种版本MySQL和PostgreSQL</td>
<td>水平扩展</td>
<td>PostGIS</td>
<td>腾讯社区</td>
<td></td>
</tr>
<tr>
<td>Azure Cosmos DB</td>
<td>微软</td>
<td>商业（2RMB/月）</td>
<td>支持键值、列存储、文档和图数据库，并支持通过 SQL 和 NoSQL API 提供数据。</td>
<td>水平扩展</td>
<td>支持</td>
<td>微软社区</td>
<td></td>
</tr>
<tr>
<td>TiDB</td>
<td>PingCAP</td>
<td>开源</td>
<td>兼容 MySQL、TiDB、TiKV计算层与存储层的分离解耦架构</td>
<td>水平扩展</td>
<td>×</td>
<td>社区、博客</td>
<td>TiSpark</td>
</tr>
<tr>
<td>SequoiaDB巨杉数据库</td>
<td>巨杉数据库</td>
<td>开源</td>
<td>国产、金融级分布式关系型数据库</td>
<td>集群</td>
<td>×</td>
<td>社区、博客</td>
<td></td>
</tr>
<tr>
<td>CockroachDB蟑螂数据库</td>
<td>蟑螂实验室</td>
<td>商业来源许可证（BSL）</td>
<td>支持PostgreSQL、去中心化架构、支持kuberneter编排</td>
<td>水平扩展</td>
<td>部分兼容PostGIS</td>
<td>Cockroach Labs 博客</td>
<td></td>
</tr>
<tr>
<td>Citus</td>
<td>微软并购</td>
<td>GPL v3</td>
<td>开源 PostgreSQL <strong>扩展</strong>、并行处理、微软云、简单易用</td>
<td>支持分布式 PostgreSQL</td>
<td>PostGIS</td>
<td>论坛、博客</td>
<td></td>
</tr>
<tr>
<td>ClustrixDB</td>
<td>MariaDB 2018年收购</td>
<td>收费</td>
<td>类MYSQL</td>
<td>分布式</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MemSQL/SingleStore</td>
<td>前 Facebook 工程师创办</td>
<td>开源的社区版</td>
<td><strong>内存数据库</strong>、兼容MySQL、MySQL InnoDB</td>
<td>分布式</td>
<td>地理空间和全文搜索</td>
<td><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/image-20210704154249267.png" alt="image-20210704154249267">社区论坛</td>
<td></td>
</tr>
<tr>
<td>VoltDB</td>
<td>Postgres和Ingres联合</td>
<td>GPLv3、AGPL</td>
<td><strong>内存数据库</strong>、采用类MPP架构、并行的单线程处理方式确保数据一致性</td>
<td>水平扩展</td>
<td>仅支持简单空间查询</td>
<td>博客</td>
<td></td>
</tr>
<tr>
<td>Vitess</td>
<td>CNCF</td>
<td>开源</td>
<td>部署，扩展和管理MySQL实例、支持kuberneter编排</td>
<td>无限水平扩展</td>
<td>MySQL Spatial</td>
<td>博客、社区</td>
<td></td>
</tr>
<tr>
<td>NuoDB</td>
<td>NuoDB</td>
<td>×</td>
<td>去集中化、唯一一个具有专利的、弹性可伸缩的SQL关系数据库</td>
<td></td>
<td></td>
<td>文档都是视频</td>
<td></td>
</tr>
<tr>
<td>Altibase</td>
<td></td>
<td></td>
<td>Hybrid DBMS</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>YugabyteDB</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>GenieDB</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>ScaleDB</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="Azure-Cosmos-DB"><a href="#Azure-Cosmos-DB" class="headerlink" title="Azure Cosmos DB"></a><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/azure/cosmos-db/use-cases">Azure Cosmos DB</a></h3><blockquote>
<p>Azure Cosmos DB 是一种用于现代应用开发的完全托管式 NoSQL 数据库服务。 获得有保证的个位数毫秒级响应时间和 由 SLA 支持的 99.999% 可用性、 自动、即时的可伸缩性 ，以及用于 MongoDB 和 Cassandra 的开放源代码 API。</p>
<p>使用 Azure Synapse Link for Azure Cosmos DB 通过非 ETL 分析从实时数据中获取见解。</p>
</blockquote>
<h4 id="NoSQL-数据库与关系数据库之间的差别"><a href="#NoSQL-数据库与关系数据库之间的差别" class="headerlink" title="NoSQL 数据库与关系数据库之间的差别"></a>NoSQL 数据库与关系数据库之间的差别</h4><ul>
<li>SQL API</li>
<li>Cassandra API<ul>
<li>Azure Cosmos DB Cassandra API 可以充当为 Apache Cassandra 编写的应用的<strong>列族数据存储</strong>。</li>
<li>通过 Cassandra API 可以使用 Cassandra 查询语言 (CQL)、基于 Cassandra 的工具（如 cqlsh）和熟悉的 Cassandra 客户端驱动程序与 Azure Cosmos DB 中存储的数据进行交互。</li>
</ul>
</li>
<li>Gremlin API<ul>
<li>Azure Cosmos DB 通过 Gremlin API 在为任何规模设计的完全托管数据库服务中提供<strong>图形数据库</strong>服务。</li>
<li> 使用 Gremlin 查询语言。</li>
</ul>
</li>
<li>表 API<ul>
<li>类似于CloudTable。</li>
<li>Azure Table Storage  提供的表 API 适用于为 Azure <strong>表存储</strong>。</li>
<li>表 API 包含可用于 .NET、Java、Python 和 Node.js 的客户端 SDK。</li>
</ul>
</li>
<li>Azure Cosmos DB API for MongoDB<ul>
<li>通过用于 MongoDB 的 Azure Cosmos DB API，可以轻松使用 Cosmos DB，就像它是 MongoDB <strong>文档数据库</strong>一样。 </li>
</ul>
</li>
</ul>
<h4 id="Azure-Cosmos-DB-中的地理空间和-GeoJSON-位置数据"><a href="#Azure-Cosmos-DB-中的地理空间和-GeoJSON-位置数据" class="headerlink" title="Azure Cosmos DB 中的地理空间和 GeoJSON 位置数据"></a>Azure Cosmos DB 中的地理空间和 GeoJSON 位置数据</h4><ul>
<li><p>支持两种空间数据类型：geometry 数据类型和 geography 数据类型 。</p>
<ul>
<li>geometry 类型在欧几里得（平面）坐标系统中表示数据</li>
<li><strong>Geography</strong> 类型表示圆形地球坐标系中的数据。</li>
</ul>
</li>
<li><p>支持的空间数据类型</p>
<ul>
<li>Point</li>
<li>LineString</li>
<li>Polygon</li>
<li>MultiPolygon</li>
</ul>
</li>
<li><p>地理空间数据查询</p>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/image-20210704152452747.png" alt="image-20210704152452747"></p>
</li>
<li><p>地理空间数据编制索引</p>
<ul>
<li>简单来说，测地坐标的几何图形会投影在 2D 平面上，并使用 <strong>四叉树</strong> 以渐进方式划分成单元格。 这些单元格会根据 <strong>Hilbert 空间填充曲线</strong> 内的单元格位置映射到 1D，并保留点的位置。 </li>
</ul>
</li>
<li><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/azure/cosmos-db/sql-query-geospatial-intro">https://docs.microsoft.com/zh-cn/azure/cosmos-db/sql-query-geospatial-intro</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/azure/cosmos-db/sql-query-geospatial-query">https://docs.microsoft.com/zh-cn/azure/cosmos-db/sql-query-geospatial-query</a></p>
</li>
</ul>
<h3 id="Altibase（商用收费）"><a href="#Altibase（商用收费）" class="headerlink" title="Altibase（商用收费）"></a><a target="_blank" rel="noopener" href="http://cn.altibase.com/">Altibase（商用收费）</a></h3><h3 id="CockroachDB"><a href="#CockroachDB" class="headerlink" title="CockroachDB"></a><a target="_blank" rel="noopener" href="https://www.cockroachlabs.com/">CockroachDB</a></h3><blockquote>
<p>CockroachDB（<a target="_blank" rel="noopener" href="https://www.cockroachlabs.com)是google备受瞩目的spanner的开源模仿,承诺提供一种高存活性、强一致性,可横向扩展的sql数据库.主要的设计目标是全球一致性和可靠性,从蟑螂(cockroach)的命名上是就能看出这点/">https://www.cockroachlabs.com）是Google备受瞩目的Spanner的开源模仿，承诺提供一种高存活性、强一致性，可横向扩展的SQL数据库。主要的设计目标是全球一致性和可靠性，从蟑螂（cockroach）的命名上是就能看出这点</a> [ 打不死的小强：) ]。Cockroach节点是均衡的，其设计目标是同质部署（只有一个二进制包）且最小配置。CockroachDB的扩展非常容易，只要一行命令，秒级进行。</p>
</blockquote>
<ul>
<li>PostgreSQL生态中的很多工具、程序和应用能够适用于CockroachDB(不用修改或少量修改)。</li>
<li>虽然CockroachDB支持PostgreSQL语法和驱动程序，但它不是完全兼容PostgreSQL。</li>
<li>2020年的20.2版本开始支持<a target="_blank" rel="noopener" href="https://www.cockroachlabs.com/blog/spatial-data/">geospatial</a>，但未完全兼容PostGIS。</li>
<li>采用分层架构，最顶层是SQL层。SQL层构建于分布式KV存储之上</li>
</ul>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/20190413215412940.png" alt="img"></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_34924156/article/details/89236693">https://blog.csdn.net/qq_34924156/article/details/89236693</a></p>
<ul>
<li>用户手册：<a target="_blank" rel="noopener" href="http://doc.cockroachchina.baidu.com/">http://doc.cockroachchina.baidu.com/</a></li>
<li>社区：<a target="_blank" rel="noopener" href="https://www.cockroachlabs.com/blog/">https://www.cockroachlabs.com/blog/</a></li>
</ul>
<h3 id="Citus"><a href="#Citus" class="headerlink" title="Citus"></a><a target="_blank" rel="noopener" href="http://citusdb.cn/">Citus</a></h3><blockquote>
<p>CitusDB采用PostgreSQL的插件形式(not a fork)，即享受PostgreSQL的强大支持，又同时拥有分布式数据库能力</p>
<p>CitusDB 与 HDFS 的分布式非常相似，在 Master 上存储元数据，Work 节点存储分片，同时 1 个分片至少要存储在 2 个 Work 节点（可配置更多）上保障其可用性。</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/image-20210703221436470.png" alt="image-20210703221436470"></p>
<ul>
<li>苏宁citus分布式数据库应用实践</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://itdks.su.bcebos.com/844d50a9b73f4d8283d746cbff23b5e9.pdf">https://itdks.su.bcebos.com/844d50a9b73f4d8283d746cbff23b5e9.pdf</a></p>
<ul>
<li>利用 citus 支持地理大数据。全世界的点状POI，数据量级已达亿级别，存储在单一的PostgreSQL数据表中，若查询涉及到全表扫描，性能会差很多</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.giserdqy.com/secdev/openlayers/21870/">https://www.giserdqy.com/secdev/openlayers/21870/</a></p>
<ul>
<li><code>Citus</code>是一个PostgreSQL的扩展，类似于PostGIS、pgRouting，它主要的作用是将一张大表进行水平分表，每个分表称为“分片（Shard）”，按照一定的规则分布(?)到多台机器上，并且将查询分布到不同节点并行执行，最后汇总结果。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/TUIK%7ES14Z%606A_I%60E%7BFPYT6L.png" alt="img"></p>
<ul>
<li>论坛：<a target="_blank" rel="noopener" href="http://citusdb.cn/?post_type=forum">http://citusdb.cn/?post_type=forum</a></li>
<li>博客：<a target="_blank" rel="noopener" href="http://citusdb.cn/?cat=13">http://citusdb.cn/?cat=13</a></li>
<li>手册：<a target="_blank" rel="noopener" href="http://docs.citusdata.com/en/v10.0/">http://docs.citusdata.com/en/v10.0/</a></li>
</ul>
<h3 id="ClustrixDB-收费"><a href="#ClustrixDB-收费" class="headerlink" title="ClustrixDB(收费)"></a><a target="_blank" rel="noopener" href="https://mariadb.com/products/clustrixdb/">ClustrixDB(收费)</a></h3><h3 id="MemSQL"><a href="#MemSQL" class="headerlink" title="MemSQL"></a><a target="_blank" rel="noopener" href="https://www.memsql.com/software/">MemSQL</a></h3><blockquote>
<p>由前 Facebook 工程师创办的 MemSQL，号称世界上最快的分布式关系型数据库，兼容 MySQL 但快30倍，能实现每秒 150 万次事务。原理是仅用内存并将 SQL 预编译为C++。</p>
</blockquote>
<ul>
<li>MemSQL is Now SingleStore</li>
<li>2018年，MemSQL 搞了个炸裂消息，<a href="https://link.zhihu.com/?target=https://www.memsql.com/blog/memsql67/">宣布</a> MemSQL 6.7 可以免费用于生产环境，没有功能限制，磁盘容量无限制，只限制整个 MemSQL 集群总内存使用不得超过 128 GB，如果做双机备份，那么就是每台机器 64 GB，已经很够用了。</li>
<li>使用ACID事务每秒接收数百万个事件，同时以关系SQL、JSON、地理空间和全文搜索格式分析数十亿行数据。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/image-20210704150733553.png" alt="image-20210704150733553"></p>
<ul>
<li><p>地理空间支持</p>
<ul>
<li><p>SingleStore使用了一个类似于googleearth的球形模型。它假设一个半径为6367444.66米的完美球形地球。</p>
</li>
<li><p>地理数据类型</p>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/image-20210704151619023.png" alt="image-20210704151619023"></p>
</li>
<li><p>空间查询</p>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/image-20210704151741992.png" alt="image-20210704151741992"></p>
</li>
<li><p>GEOJSON。SingleStore 没有本机 GeoJSON 支持。但是，我们有通用的 JSON 支持以及计算列。结合这些功能，您可以使用 SingleStore 的内置 JSON 类型和 GEOGRAPHYPOINT 类型导入 GeoJSON 数据的子集。</p>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/image-20210704151949000.png" alt="image-20210704151949000"></p>
</li>
</ul>
</li>
<li><p>社区网址：<a target="_blank" rel="noopener" href="https://www.singlestore.com/community-hub/">https://www.singlestore.com/community-hub/</a></p>
</li>
<li><p>资源手册：<a target="_blank" rel="noopener" href="https://www.singlestore.com/resources/">https://www.singlestore.com/resources/</a></p>
</li>
</ul>
<h3 id="NuoDB"><a href="#NuoDB" class="headerlink" title="NuoDB"></a><a target="_blank" rel="noopener" href="https://nuodb.com/">NuoDB</a></h3><blockquote>
<p>NuoDB 是newsql数据库的典型代表之一，同时也是世界上首个也是唯一一个具有专利的、弹性可伸缩的SQL关系数据库，主要用于去集中化的计算资源。</p>
</blockquote>
<h3 id="OceanBase"><a href="#OceanBase" class="headerlink" title="OceanBase"></a><a target="_blank" rel="noopener" href="https://open.oceanbase.com/">OceanBase</a></h3><blockquote>
<p>OceanBase 社区版是一款开源分布式 HTAP（Hybrid Transactional/Analytical Processing）数据库管理系统，具有原生分布式架构，支持金融级高可用、透明水平扩展、分布式事务、多租户和语法兼容等企业级特性。</p>
</blockquote>
<blockquote>
<p>2020 年 5 月，OceanBase 以 7.07亿 tpmC 的在线事务处理性能，打破了 OceanBase 自己在 2019 年创造的 6088万 tpmC 的 TPC-C 世界纪录。截止至目前，OceanBase是第一个也是唯一一个上榜的中国数据库。</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/image-20210704164251964.png" alt="image-20210704164251964"></p>
<ul>
<li><p>版本选择</p>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/image-20210704164312198.png" alt="image-20210704164312198"></p>
</li>
<li><p>产品优势</p>
<ul>
<li><strong>高性能</strong>：OceanBase采用了读写分离的架构，把数据分为基线数据和增量数据。其中增量数据放在内存里（MemTable），基线数据放在SSD盘（SSTable）。对数据的修改都是增量数据，只写内存。所以DML是完全的内存操作，性能非常高。</li>
<li><strong>低成本</strong>：OceanBase通过数据编码压缩技术实现高压缩。数据编码是基于数据库关系表中不同字段的值域和类型信息，所产生的一系列的编码方式，它比通用的压缩算法更懂数据，从而能够实现更高的压缩效率。</li>
<li><strong>高兼容</strong>：兼容常用MySQL/ORACLE功能及MySQL/ORACLE前后台协议，业务零修改或少量修改即可从MySQL/ORACLE迁移至OceanBase。</li>
<li><strong>高可用</strong>：数据采用多副本存储，少数副本故障不影响数据可用性。通过“三地五中心”部署实现城市级故障自动无损容灾。</li>
</ul>
</li>
<li><p>定价</p>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/image-20210704164141515.png" alt="image-20210704164141515"></p>
</li>
<li><p>社区：<a target="_blank" rel="noopener" href="https://open.oceanbase.com/community/contribution">https://open.oceanbase.com/community/contribution</a></p>
</li>
<li><p>博客：<a target="_blank" rel="noopener" href="https://open.oceanbase.com/articles">https://open.oceanbase.com/articles</a></p>
</li>
<li><p>文档：<a target="_blank" rel="noopener" href="https://open.oceanbase.com/docs">https://open.oceanbase.com/docs</a></p>
</li>
</ul>
<h3 id="SequoiaDB"><a href="#SequoiaDB" class="headerlink" title="SequoiaDB"></a>SequoiaDB</h3><h3 id="TDSQL"><a href="#TDSQL" class="headerlink" title="TDSQL"></a><a target="_blank" rel="noopener" href="https://intl.cloud.tencent.com/zh/product/dcdb">TDSQL</a></h3><blockquote>
<p>分布式数据库（Tencent Distributed SQL，以下简称 TDSQL）是腾讯打造的一款企业级数据库产品，具备强一致高可用、全球部署架构、高 SQL 兼容度、分布式水平扩展、高性能、完整的分布式事务支持、企业级安全等特性，同时提供智能 DBA、自动化运营、监控告警等配套设施，为客户提供完整的分布式数据库解决方案。</p>
<p>稳定、安全、高性能的分布式数据库，兼容 PostgreSQL 和 MySQL。</p>
</blockquote>
<ol>
<li><p>MySQL 版</p>
<p>高度兼容 MySQL，支持水平拆分（分表）的高性能数据库。部署在腾讯云上的一种支持自动水平拆分、Shared Nothing 架构的分布式数据库。TDSQL MySQL版 默认部署主备架构，提供容灾、备份、恢复、监控、迁移等全套解决方案，适用于 TB 或 PB 级的海量数据库场景。</p>
</li>
</ol>
<ol start="2">
<li><p>PostgreSQL 版 （原 TBase）</p>
<p>稳定、安全、高性能的分布式数据库服务，满足您海量 HTAP 场景。集高扩展性、高SQL兼容度、完整的分布式事务支持、多级容灾能力以及多维度资源隔离等能力于一身。TDSQL PostgreSQL 版采用无共享的集群架构，为用户提供容灾、备份、恢复、监控、安全、审计等全套解决方案，适用于GB～PB级的海量 HTAP 场景。  </p>
<p> 具有丰富的周边生态：</p>
<ul>
<li>支持强大的地理信息系统（GIS）。通过集群化的 PostGis 插件，支持存储空间地理数据，使 TDSQL PostgreSQL版 成为一个空间数据库，能够通过 SQL 语言高效的进行空间数据管理、数量测量和几何拓扑分析。</li>
<li>TDSQL PostgreSQL版 不仅是一个分布式关系型数据库系统，同时还支持非关系数据类型 JSON。</li>
<li>支持 Foreign Data Wrappers（FDW）功能，该功能实现了部分的 SQL/MED 规定，允许用户使用普通 SQL 查询来访问位于 PostgreSQL 之外的数据。<br>FDW 功能提供一套编程接口，用户可进行插件式的二次开发，建立外部数据源和数据库间的数据通道。大多数情况下用户可用 oracle_fdw、mysql_fdw、postgres_fdw，非关系型数据库的 redis_fdw、mongodb_fdw，以及大数据的 hive_fdw、hdfs_fdw 等。基于 FDW 功能和已有插件，TDSQL PostgreSQL版 提供强大的数据库联邦能力，通过 TDSQL PostgreSQL版 能够访问已有的多个数据源的数据。</li>
</ul>
</li>
</ol>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/image-20210704180213145.png" alt="image-20210704180213145"></p>
<ul>
<li><p>价格</p>
<p>​    <img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/image-20210704180327148.png" alt="image-20210704180327148"></p>
</li>
</ul>
<h3 id="TiDB"><a href="#TiDB" class="headerlink" title="TiDB "></a><a target="_blank" rel="noopener" href="https://pingcap.com/">TiDB </a></h3><h3 id="VoltDB"><a href="#VoltDB" class="headerlink" title="VoltDB"></a><a target="_blank" rel="noopener" href="https://www.voltdb.com/">VoltDB</a></h3><h3 id="Vitess"><a href="#Vitess" class="headerlink" title="Vitess"></a><a target="_blank" rel="noopener" href="https://vitess.io/zh/">Vitess</a></h3><p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/image-20210703213038339.png" alt="image-20210703213038339"></p>
<ul>
<li><p>Vitess包括使用与本机查询协议兼容的JDBC和Go数据库驱动。自2011年以来，Vitess一直为YouTube所有的数据库提供服务，现在已被许多企业采用并应用于实际生产。</p>
</li>
<li><p>Vitess是一个用于部署、扩展和管理大型MySQL实例集群的数据库解决方案。Vitess集Mysql数据库的很多重要特性和NoSQL数据库的可扩展性于一体。它的架构设计使得您可以像在物理机上一样在公共云或私有云架构中有效运行。它结合并扩展了许多重要的MySQL功能，同时兼具NoSQL数据库的可扩展性。</p>
</li>
<li><p>一种云原生技术 Cloud-native</p>
<ul>
<li>容器化（Containerized）：每个部分（应用程序，进程等）都封装在自己的容器中。这有助于重复性，透明度和资源隔离。</li>
<li>动态编排（Dynamically orchestrated）：动态的调度和管理容器以优化资源利用。</li>
<li>面向微服务（Microservices oriented）：应用程序基于微服务架构，显著提高架构演进的灵活性和可维护性。</li>
</ul>
</li>
</ul>
<p><strong>CNCF案例研究：京东如何使用Vitess管理超大规模数据库</strong></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1548244">https://cloud.tencent.com/developer/article/1548244</a></p>
<h1 id="NewSQL，NoSQL与OldSQL的混合部署"><a href="#NewSQL，NoSQL与OldSQL的混合部署" class="headerlink" title="NewSQL，NoSQL与OldSQL的混合部署"></a>NewSQL，NoSQL与OldSQL的混合部署</h1><ul>
<li>OldSQL+NewSQL</li>
<li>OldSQL+NoSQL</li>
<li>NewSQL+NoSQL</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://supmarket.net/xy/771126462">https://supmarket.net/xy/771126462</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/07/03/%E8%B0%83%E7%A0%94/PostGIS%E8%B0%83%E7%A0%94/">postgis 相关调研</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-07-04</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E8%B0%83%E7%A0%94/">调研</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/%E5%9C%B0%E5%9B%BE%E6%9C%8D%E5%8A%A1/">地图服务</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/OGC/">OGC</a></span><div class="content"><h1 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h1><h2 id="相关标准化组织机构介绍"><a href="#相关标准化组织机构介绍" class="headerlink" title="相关标准化组织机构介绍"></a>相关标准化组织机构介绍</h2><ul>
<li><p>OGC 表示开放地理空间信息联盟 （Open Geospatial Consortium-OGC） ，致力于提供地理信息行业软件和数据及服务的标准化工作。OGC在1994年到2004年期间机构名为Open GIS Consortium， 后因业务需要更名。</p>
</li>
<li><p>IS0/TC 211(国际标准化组织地理信息技术委员会211)</p>
</li>
<li><p>W3C(World Wide Web onsortium，万维网联盟)</p>
</li>
<li><p>OpenGIS(Open Geodata Interoperation Specification,开放地理数据互操作规范)</p>
</li>
<li><p>GML（Geographic Markup Language）由OGC定义的XML（标准通用标记语言的子集）格式，用来表达地理信息要素。</p>
</li>
</ul>
<h2 id="OpenGIS"><a href="#OpenGIS" class="headerlink" title="OpenGIS"></a>OpenGIS</h2><p>要素（Feature）：几何信息和属性信息</p>
<ul>
<li>OpenGIS定义了一组基于数据的服务，而数据的基础是要素（Feature)。所谓要素，简单地说就是一个独立的对象，在地图中可能表现为一个多边形建筑物，在数据库中即是一个独立的条目。要素具有两个必要的组成部分——几何信息和属性信息。</li>
</ul>
<p>几何信息：点（Point）、边缘（LineString）、面（Polygon）和几何集合（GeometryCollection）</p>
<ul>
<li>OpenGIS将几何信息分为点、边缘、面和几何集合四种： 其中这里熟悉的线（LineString)属于边缘的一个子类，而多边形（Polygon)是面的一个子类。也就是说OpenGIS定义的几何类型并不仅仅是我们常见的点、线、多边形三种，它提供了更复杂更详细的定义，增强了未来的可扩展性。另外，几何类型的设计中采用了组合模式（Composite)，将几何集合（GeometryCollection)也定义为一种几何类型。类似地，要素集合（FeatureCollection)也是一种要素。</li>
</ul>
<p>属性信息（FeatureType）：</p>
<ul>
<li>属性信息没有做太多的限制，可以在实际应用中结合具体的实现进行设置。相同的几何类型、属性类型的组合成为要素类型（FeatureType)，类型相同的要素可以存放在一个数据源中。而一个数据源只能拥有一个要素类型。因此，可以用要素类型来描述一组属性相似的要素。</li>
</ul>
<p>在面向对象的模型中，完全可以把要素类型理解为一个类，而要素则是类的实例。通过GIS中间件可以从数据源中取出数据，供WMS服务器和WFS服务器使用。WMS服务器接收请求，根据请求内容的不同，可以返回不同格式的最终数据。例如，WMS可以返回常用图片格式的地图片段供最终用户阅读（类似GoogleMaps)，其中地图是根据一个样式文件(SLD)生成的，它描述了地图的线的宽度、色彩等；WMS也可以返回GeoRSS和KML用来与其他地图服务互通。WFS服务器也可以接收请求，但WFS将返回GML格式的地理信息数据。GML是一种基于XML的数据格式，它可以完整地再现数据，也是OpenGIS数据源的重要形式。也就是说，WFS返回的GML可以继续作为数据源。在WFS请求中，OpenGIS定义了一个Filter标准，用来实现对数据的筛选，使WFS更加灵活。另一方面，WFS还支持通过WFS-t提交客户端对数据的修改。通俗地说，WMS是只读的，而WFS则是可以读写的。</p>
<h2 id="OGC地图服务标准介绍"><a href="#OGC地图服务标准介绍" class="headerlink" title="OGC地图服务标准介绍"></a>OGC地图服务标准介绍</h2><blockquote>
<p>OGC1999年开始 WMT1（Web Map Tested）和 WMT2 互操作项目。其中著名的GML来自WMT1的成果。在WMT2中OGC定义了三种地理参考信息模型：Web Map Server(WMS) , Web Feature Server(WFS) ，Web Coverage Server(WCS) .</p>
<p>OGC 地图服务协议，包括 WMS、WFS、WCS、WMTS、WPS 。其中比较重要的现在用得比较多的标准是GML、WMS和WFS。</p>
</blockquote>
<h3 id="网络地图服务（WMS）"><a href="#网络地图服务（WMS）" class="headerlink" title="网络地图服务（WMS）"></a>网络地图服务（WMS）</h3><ul>
<li><p>Web Map Server（WMS）能够根据用户的请求返回相应的地图（包括PNG，GIF，JPEG等栅格形式或者是SVG和WEB CGM等矢量形式）。</p>
</li>
<li><p>WMS支持网络协议HTTP，所支持的操作是由URL定义的。有三个重要操作 <code>GetCapabilities</code> ， <code>GetMap</code> ， <code>GetFeatureinfo</code> 。</p>
</li>
</ul>
<h3 id="网络要素服务（WFS）"><a href="#网络要素服务（WFS）" class="headerlink" title="网络要素服务（WFS）"></a>网络要素服务（WFS）</h3><ul>
<li><p>Web 要素服务（WFS）支持对地理要素的插入，更新，删除，检索和发现服务。该服务根据HTTP客户请求返回GML数据。</p>
</li>
<li><p>其基础接口是：GetCapabilities，DescribeFeatureType，GetFeature　 GetCapabilities同上。</p>
</li>
</ul>
<h3 id="网络覆盖服务（WCS）"><a href="#网络覆盖服务（WCS）" class="headerlink" title="网络覆盖服务（WCS）"></a>网络覆盖服务（WCS）</h3><ul>
<li><p>Web地理覆盖服务（WCS）：提供的是包含了地理位置信息或属性的空间栅格图层，而不是静态地图的访问。</p>
</li>
<li><p>根据HTTP客户端要求发送相应数据，包括影像，多光谱影像和其它科学数据. 有二个重要操作GetCapabilities，GetCoverage GetCapabilities返回一个描述服务和XML文档，从中可获取覆盖的数据集合。</p>
</li>
</ul>
<h3 id="切片地图服务（TMS）"><a href="#切片地图服务（TMS）" class="headerlink" title="切片地图服务（TMS）"></a>切片地图服务（TMS）</h3><ul>
<li>切片地图服务（TMS）定义了一些操作，这些操作允许用户访问切片地图。WMTS可能是OGC首个支持RESTful访问的服务标准。</li>
</ul>
<h3 id="WMS和WNTS区别"><a href="#WMS和WNTS区别" class="headerlink" title="WMS和WNTS区别"></a>WMS和WNTS区别</h3><ul>
<li>WMTS服务和WMS服务对客户端请求服务的响应不同，比如在接受客户端请求WMTS服务时，返回给客户端是固定大小的瓦片，客户端根据索引号来获取每一张瓦片，而后拼接成地图进行展示，如图1所示；由于瓦片的规则是固定的，服务端可以预先缓存对应的瓦片，客户端需要时直接返回即可，因而WMTS是可缓存的。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/fig-wmts-server.png" alt="img"></p>
<h1 id="END"><a href="#END" class="headerlink" title="END"></a>END</h1></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/04/03/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E5%8F%82%E8%80%83/">系统架构参考</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-04-04</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E5%85%B6%E4%BB%96/">其他</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/">系统架构</a></span><div class="content"><h1 id="系统架构参考"><a href="#系统架构参考" class="headerlink" title="系统架构参考"></a>系统架构参考</h1><h2 id="企业级分布式应用服务EDAS"><a href="#企业级分布式应用服务EDAS" class="headerlink" title="企业级分布式应用服务EDAS"></a>企业级分布式应用服务EDAS</h2><p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/p232673.png" alt="img"></p>
<h2 id="阿里中台架构图"><a href="#阿里中台架构图" class="headerlink" title="阿里中台架构图"></a>阿里中台架构图</h2><p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/v2-8623f0835181951bc40bcac5ab8713cf_720w.jpg" alt="img"></p>
<h2 id="淘宝服务端高并发分布式架构"><a href="#淘宝服务端高并发分布式架构" class="headerlink" title="淘宝服务端高并发分布式架构"></a>淘宝服务端高并发分布式架构</h2><ul>
<li>架构特点：负载均衡、正向代理和反向代理、分布式、高可用</li>
<li>MPP数据库</li>
<li>使用LVS或F5来使多个Nginx负载均衡（可使用keepalived软件模拟出虚拟IP，然后把虚拟IP绑定到多台LVS服务器上）</li>
<li>通过DNS轮询实现机房间的负载均衡（系统可做到机房级别的水平扩展）</li>
<li><h5 id="引入NoSQL数据库和搜索引擎等技术"><a href="#引入NoSQL数据库和搜索引擎等技术" class="headerlink" title="引入NoSQL数据库和搜索引擎等技术+"></a>引入NoSQL数据库和搜索引擎等技术+</h5></li>
</ul>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/v2-65d4f75b68cd095805bafceb8c2e4a2c_720w.jpg" alt="img"></p>
<h2 id="JUST-DB"><a href="#JUST-DB" class="headerlink" title="JUST-DB"></a>JUST-DB</h2><p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/image-20210701102643136.png" alt="image-20210701102643136"></p>
<h2 id="云原生技术架构"><a href="#云原生技术架构" class="headerlink" title="云原生技术架构"></a>云原生技术架构</h2><p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/v2-4df5f78230cda29a2a28bb789562f522_720w.jpg" alt="img"></p>
<h2 id="全空间混合数据服务引擎"><a href="#全空间混合数据服务引擎" class="headerlink" title="全空间混合数据服务引擎"></a>全空间混合数据服务引擎</h2><p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/image-20210701144211306.png" alt="image-20210701144211306"></p>
<h2 id="Ganos"><a href="#Ganos" class="headerlink" title="Ganos"></a>Ganos</h2><p>Ganos是包含SQL + NoSQL云数据库的时空引擎。</p>
<ul>
<li>公有云原生架构的空间、时空、遥感一体化NoSQL大数据引擎产品，开箱即用；</li>
<li>PB级存储、高并发写入、百亿级时空查询秒级响应；</li>
<li>支持数据冷热分离存储和数据高效压缩算法，海量数据存储成本低；</li>
<li>与云上Spark无缝集成，快速搭建空间大数据仓库和空间大数据分析平台；</li>
<li>基于OGC标准设计，便于系统间的集成与互操作；</li>
<li>基于阿里云HBase、XPack专业运维，全托管方式，提供可靠稳定的服务。</li>
</ul>
<h3 id="Ganos中的时空模型"><a href="#Ganos中的时空模型" class="headerlink" title="Ganos中的时空模型"></a>Ganos中的时空模型</h3><p>除了支持传统的几何模型、栅格模型和拓扑网络模型，还扩充支持了网格模型、时空轨迹模型以及点云模型。</p>
<p><img src="https://ucc.alicdn.com/pic/developer-ecology/6bc55a54abb944289c4ef6d99db99adf.png" alt="image.png"></p>
<h3 id="PG-Ganos"><a href="#PG-Ganos" class="headerlink" title="PG Ganos"></a>PG Ganos</h3><ol>
<li><strong>如何管理PB级遥感影像：PostgresSQL + Ganos + OSS</strong></li>
</ol>
<p>通过“PostgresSQL + Ganos + OSS”组合，可实现 PB级遥感影像的管理。源数据和部分金字塔数据可以存储在数据库内部，遥感原始数据存放在OOS中，由于OOS存储价格低廉，使得用户的使用成本也有所降低。</p>
<ol start="2">
<li><strong>遥感影像注册（入库）</strong></li>
</ol>
<p>需要按照insertSQL语句直接写入到数据库，将OSS地址传给createrast接口即可。</p>
<ol start="3">
<li><strong>矢量数据入库</strong></li>
</ol>
<p>主要依赖空间开源的工具，包括Ogr2ogr、shp2pgsql、QGIS、pg_dump/pg_restore等。</p>
<ol start="4">
<li><strong>PG Ganos如何管理轨迹数据</strong></li>
</ol>
<p>Ganos管理轨迹数据主要通过轨迹构造、轨迹压缩和轨迹相似性判断。</p>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/d83b6862464d47b3959d224890ab323f.png" alt="image.png"></p>
<ol start="5">
<li><strong>Ganos与开源工具</strong></li>
</ol>
<p>Ganos无缝对接兼容PostGIS的各类GIS软件，显示和编辑包括GeoServer、QGIS、uDig、OpenJump等，PGAdmin4。</p>
<h3 id="示例：某位置服务平台"><a href="#示例：某位置服务平台" class="headerlink" title="示例：某位置服务平台"></a>示例：某位置服务平台</h3><p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/4594052-c1342ad1e96c0079.png" alt="img"></p>
<h3 id="示例：遥感大数据管理与智能服务平台"><a href="#示例：遥感大数据管理与智能服务平台" class="headerlink" title="示例：遥感大数据管理与智能服务平台"></a>示例：遥感大数据管理与智能服务平台</h3><p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/184a2ace18314d57a5b3b40b15676cac.png" alt="图片 6.png"></p>
<h2 id="名词解释："><a href="#名词解释：" class="headerlink" title="名词解释："></a>名词解释：</h2><ul>
<li><p>NoSQL</p>
<ul>
<li>\1. 键值数据库：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/crs?from=10680">Redis</a>、Memcached、Riak、Cassandra、LevelDB</li>
<li>\2. 列族数据库：Bigtable、<a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/hbase?from=10680">HBase</a>、Cassandra、Druid</li>
<li>\3. 文档数据库：MongoDB、CouchDB、MarkLogic</li>
<li>\4. 图形数据库：Neo4j（知识图谱）、InfoGrid、ArangoDB</li>
</ul>
</li>
<li><p>MPP (Massively Parallel Processing)大规模并行处理架构。比较流行的有Greenplum、TiDB、Postgresql XC、HAWQ等，商用的如南大通用的GBase、睿帆科技的雪球DB、华为的LibrA</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/148621151">https://zhuanlan.zhihu.com/p/148621151</a></p>
</li>
<li><p>LVS(Linux Virtual Server)：本质上是一个软件。是一种集群(Cluster)技术，采用IP负载均衡技术和基于内容请求分发技术。</p>
<ul>
<li>VS/NAT 负载均衡策略：</li>
<li>VS/TUN 负载均衡策略：</li>
<li>VS/NAT 负载均衡策略：</li>
<li><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/v2-9a56981b5fe5a218bb41a684d96b5d4f_720w.jpg" alt="img"></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/87109094#:~:text=%E9%A6%96%E5%85%88%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D%E4%B8%80%E4%B8%8BLVS%20%28Linux%20Virtual,Server%29%E5%88%B0%E5%BA%95%E6%98%AF%E4%BB%80%E4%B9%88%E4%B8%9C%E8%A5%BF%EF%BC%8C%E5%85%B6%E5%AE%9E%E5%AE%83%E6%98%AF%E4%B8%80%E7%A7%8D%E9%9B%86%E7%BE%A4%20%28Cluster%29%E6%8A%80%E6%9C%AF%EF%BC%8C%E9%87%87%E7%94%A8IP%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%8A%80%E6%9C%AF%E5%92%8C%E5%9F%BA%E4%BA%8E%E5%86%85%E5%AE%B9%E8%AF%B7%E6%B1%82%E5%88%86%E5%8F%91%E6%8A%80%E6%9C%AF%E3%80%82%20%E8%B0%83%E5%BA%A6%E5%99%A8%E5%85%B7%E6%9C%89%E5%BE%88%E5%A5%BD%E7%9A%84%E5%90%9E%E5%90%90%E7%8E%87%EF%BC%8C%E5%B0%86%E8%AF%B7%E6%B1%82%E5%9D%87%E8%A1%A1%E5%9C%B0%E8%BD%AC%E7%A7%BB%E5%88%B0%E4%B8%8D%E5%90%8C%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E6%89%A7%E8%A1%8C%EF%BC%8C%E4%B8%94%E8%B0%83%E5%BA%A6%E5%99%A8%E8%87%AA%E5%8A%A8%E5%B1%8F%E8%94%BD%E6%8E%89%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E6%95%85%E9%9A%9C%EF%BC%8C%E4%BB%8E%E8%80%8C%E5%B0%86%E4%B8%80%E7%BB%84%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%9E%84%E6%88%90%E4%B8%80%E4%B8%AA%E9%AB%98%E6%80%A7%E8%83%BD%E7%9A%84%E3%80%81%E9%AB%98%E5%8F%AF%E7%94%A8%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%8D%E5%8A%A1%E5%99%A8%E3%80%82">链接</a></li>
</ul>
</li>
<li><p>F5是一种负载均衡硬件，与LVS提供的能力类似，性能比LVS更高，但价格昂贵。</p>
</li>
<li><p>如对于海量文件存储，可通过分布式文件系统HDFS解决，对于key value类型的数据，可通过HBase和Redis等方案解决，对于全文检索场景，可通过搜索引擎如ElasticSearch解决，对于多维分析场景，可通过Kylin或Druid等方案解决。</p>
</li>
<li><p>geoTrellis：处理栅格数据。生成金字塔图层、渲染切片、GeoJson的序列化与反序列化</p>
</li>
<li><p>geoMesa：处理矢量数据。由locationtech开源的一套地理大数据处理工具套件。 GeoMesa目前支持的NoSQL数据库包括Accumulo、HBase、Google Bigtable和Cassandra等。</p>
</li>
<li><p>DLI：数据湖探索</p>
</li>
<li><p>DLA：数据湖分析</p>
</li>
<li><p>Apache Kylin™是一个开源的、分布式的分析型数据仓库。提供<code>Hadoop/Spark</code>之上的<code>SQL</code>查询接口及多维分析(<code>OLAP</code>)能力以支持超大规模数据，它能在亚秒内查询巨大的<code>Hive</code>表。其核心是预计算，计算结果存在<code>HBase</code>中。</p>
<p>作为大数据分析神器，它也需要站在巨人的肩膀上，依赖<code>HDFS</code>、<code>MapReduce/Spark</code>、<code>Hive/Kafka</code>、<code>HBase</code>等服务。</p>
</li>
<li><p>Apache Flink并不提供自己的数据存储系统，但为<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Amazon_Web_Services#Analytics">Amazon Kinesis</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Apache_Kafka">Apache Kafka</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Alluxio">Alluxio</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/HDFS">HDFS</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Apache_Cassandra">Apache Cassandra</a>和<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Elasticsearch">Elasticsearch</a>等系统提供了数据源和接收器。</p>
</li>
<li><p><strong>Presto</strong>是一种用于大数据的高性能分布式<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/SQL">SQL</a>查询引擎。其架构允许用户查询各种数据源，如Hadoop、AWS S3、Alluxio、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/MySQL">MySQL</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Cassandra">Cassandra</a>、Kafka和MongoDB。</p>
</li>
<li><p>Drill：<strong>Drill</strong> is an Apache open-source SQL query engine for Big Data exploration. </p>
</li>
<li><p>LSM-tree 最大的特点就是写入速度快，主要利用了磁盘的顺序写，pk掉了需要随机写入的 B-tree。关于磁盘的顺序和随机写可以参考：《硬盘的各种概念》</p>
</li>
</ul>
<h1 id="全时空信息系统架构设计"><a href="#全时空信息系统架构设计" class="headerlink" title="全时空信息系统架构设计"></a>全时空信息系统架构设计</h1><h2 id="数据底层分类"><a href="#数据底层分类" class="headerlink" title="数据底层分类"></a>数据底层分类</h2><h2 id="数据库引擎"><a href="#数据库引擎" class="headerlink" title="数据库引擎"></a>数据库引擎</h2><p>NewSQL 见文档-NewSQL主流数据库对比</p>
<hr>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/clip_image002.jpg" alt="img"></p>
<p><img src="https://raw.githubusercontent.com/2757412961/TyporaImageRepository/master/img/0%7EGT%5D37GOLTO7XQ%5BNKI4%60VQ.png" alt="img"></p>
<h2 id="检索引擎"><a href="#检索引擎" class="headerlink" title="检索引擎"></a>检索引擎</h2><h2 id="计算引擎"><a href="#计算引擎" class="headerlink" title="计算引擎"></a>计算引擎</h2><h2 id="容器化、微服务、DevOps"><a href="#容器化、微服务、DevOps" class="headerlink" title="容器化、微服务、DevOps"></a>容器化、微服务、DevOps</h2><h2 id="可视化引擎"><a href="#可视化引擎" class="headerlink" title="可视化引擎"></a>可视化引擎</h2><h1 id="参考连接"><a href="#参考连接" class="headerlink" title="参考连接"></a>参考连接</h1><h2 id="1-淘宝服务端高并发分布式架构演进之路"><a href="#1-淘宝服务端高并发分布式架构演进之路" class="headerlink" title="1. 淘宝服务端高并发分布式架构演进之路"></a>1. 淘宝服务端高并发分布式架构演进之路</h2><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/69999325">https://zhuanlan.zhihu.com/p/69999325</a></p>
<h2 id="2-微服务网关Zuul、Gateway、nginx的区别"><a href="#2-微服务网关Zuul、Gateway、nginx的区别" class="headerlink" title="2. 微服务网关Zuul、Gateway、nginx的区别"></a>2. 微服务网关Zuul、Gateway、nginx的区别</h2><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/8d82c6c2e5ee">https://www.jianshu.com/p/8d82c6c2e5ee</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/lizz861109/article/details/103575186">https://blog.csdn.net/lizz861109/article/details/103575186</a></p>
<h2 id="3-Hive、Hbase、mysql的区别"><a href="#3-Hive、Hbase、mysql的区别" class="headerlink" title="3. Hive、Hbase、mysql的区别"></a>3. Hive、Hbase、mysql的区别</h2><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/137458844">https://zhuanlan.zhihu.com/p/137458844</a></p>
<h2 id="4-解惑图数据库！你知道什么是图数据库吗？"><a href="#4-解惑图数据库！你知道什么是图数据库吗？" class="headerlink" title="4. 解惑图数据库！你知道什么是图数据库吗？"></a>4. 解惑图数据库！你知道什么是图数据库吗？</h2><p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1634337">https://cloud.tencent.com/developer/article/1634337</a></p>
<h2 id="5-图数据库选型对比：HugeGraph、JanusGraph、Neo4j"><a href="#5-图数据库选型对比：HugeGraph、JanusGraph、Neo4j" class="headerlink" title="5. 图数据库选型对比：HugeGraph、JanusGraph、Neo4j"></a>5. 图数据库选型对比：HugeGraph、JanusGraph、Neo4j</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/hellohiworld/article/details/104824764">https://blog.csdn.net/hellohiworld/article/details/104824764</a></p>
<h2 id="6-JanusGraph-Neo4j-TigerGraph简单对比"><a href="#6-JanusGraph-Neo4j-TigerGraph简单对比" class="headerlink" title="6. JanusGraph/Neo4j/TigerGraph简单对比"></a>6. JanusGraph/Neo4j/TigerGraph简单对比</h2><p>目前TigerGraph的生态不是很全，编程api等能力也有一定限制</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/74424421">https://zhuanlan.zhihu.com/p/74424421</a></p>
<h2 id="7-全文搜索引擎-ElasticSearch-还是-Solr？"><a href="#7-全文搜索引擎-ElasticSearch-还是-Solr？" class="headerlink" title="7. 全文搜索引擎 ElasticSearch 还是 Solr？"></a>7. 全文搜索引擎 ElasticSearch 还是 Solr？</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jajian/p/9801154.html">https://www.cnblogs.com/jajian/p/9801154.html</a></p>
<h2 id="8-9个基于Java的搜索引擎框架-转"><a href="#8-9个基于Java的搜索引擎框架-转" class="headerlink" title="8. 9个基于Java的搜索引擎框架 转"></a>8. 9个基于Java的搜索引擎框架 转</h2><p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1184216?from=article.detail.1178714">https://cloud.tencent.com/developer/article/1184216?from=article.detail.1178714</a></p>
<h2 id="9-什么是CIM？究竟和BIM有什么关系？"><a href="#9-什么是CIM？究竟和BIM有什么关系？" class="headerlink" title="9. 什么是CIM？究竟和BIM有什么关系？"></a>9. 什么是CIM？究竟和BIM有什么关系？</h2><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/359816845">https://zhuanlan.zhihu.com/p/359816845</a></p>
<h2 id="10-BIM-GIS应用的八大挑战"><a href="#10-BIM-GIS应用的八大挑战" class="headerlink" title="10. BIM+GIS应用的八大挑战"></a>10. BIM+GIS应用的八大挑战</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/supermapsupport/article/details/95048023">https://blog.csdn.net/supermapsupport/article/details/95048023</a></p>
<h2 id="11-HBase-Ganos简介"><a href="#11-HBase-Ganos简介" class="headerlink" title="11. HBase Ganos简介"></a>11. HBase Ganos简介</h2><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/cad5467cc67d">https://www.jianshu.com/p/cad5467cc67d</a></p>
<h2 id="12-对比五款数据库，告诉你-NewSQL-的独到之处"><a href="#12-对比五款数据库，告诉你-NewSQL-的独到之处" class="headerlink" title="12. 对比五款数据库，告诉你 NewSQL 的独到之处"></a>12. 对比五款数据库，告诉你 NewSQL 的独到之处</h2><p><a target="_blank" rel="noopener" href="https://www.techug.com/post/what-is-new-about-newsql.html">https://www.techug.com/post/what-is-new-about-newsql.html</a></p>
<h2 id="13-NewSQL究竟新在哪里？"><a href="#13-NewSQL究竟新在哪里？" class="headerlink" title="13. NewSQL究竟新在哪里？"></a>13. NewSQL究竟新在哪里？</h2><p><a target="_blank" rel="noopener" href="http://oserror.com/distributed/newsql/">http://oserror.com/distributed/newsql/</a></p>
<h2 id="14-分布式-NewSQL-对比"><a href="#14-分布式-NewSQL-对比" class="headerlink" title="14. 分布式 NewSQL 对比"></a>14. 分布式 NewSQL 对比</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/GO-NO-1/p/9935195.html">https://www.cnblogs.com/GO-NO-1/p/9935195.html</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/10/17/java/%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F/">高并发系统</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-10-18</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/java/">java</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F/">高并发系统</a></span><div class="content"><h1 id="Java高并发"><a href="#Java高并发" class="headerlink" title="Java高并发"></a>Java高并发</h1><p>[TOC]</p>
<h2 id="业务分析与DAO层"><a href="#业务分析与DAO层" class="headerlink" title="业务分析与DAO层"></a>业务分析与DAO层</h2><h3 id="一、创建项目和依赖"><a href="#一、创建项目和依赖" class="headerlink" title="一、创建项目和依赖"></a>一、创建项目和依赖</h3><p><strong>1.maven命令创建web骨架项目</strong></p>
<p>官网资源地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">logback配置：http://logback.qos.ch/manual/configuration.html</span><br><span class="line">spring配置：http://docs.spring.io/spring/docs/</span><br><span class="line">mybatis配置：http://mybatis.github.io/mybatis-3/zh/index.html </span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn archetype:create -DgroupId=org.seckill -DartifactId=seckill -DarchetypeArtifactId=maven-archetype-webapp</span><br></pre></td></tr></table></figure>
<p>项目依赖</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0.</span>单元测试：junit4</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span>java日志：slf4j,log4j,logback,common-logging</span><br><span class="line">    slf4j是规范/接口 其余是日志实现</span><br><span class="line">    dependency:slf4j-api,logback-core,logback-classic</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>数据库</span><br><span class="line">    数据库驱动 mysql-connector-java</span><br><span class="line">    数据库连接池 c3p0</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>DAO框架：Mybatis依赖</span><br><span class="line">    dependency:mybatis,mybatis-spring</span><br><span class="line">    </span><br><span class="line"><span class="number">4.</span>Servlet Web相关依赖</span><br><span class="line">    dependency:standard,jstl,jackson-databind,javax.servlet-api</span><br><span class="line">    </span><br><span class="line"><span class="number">5.</span>spring依赖</span><br><span class="line">    spring 核心依赖:spring-core,spring-beans,spring-context</span><br><span class="line">    spring DAO依赖:spirng-jdbc,spring-tx</span><br><span class="line">    spring web依赖:spring-web,spring-webmvc</span><br><span class="line">    spring test依赖:spring-test</span><br></pre></td></tr></table></figure>

<h3 id="二、数据库设计与编码"><a href="#二、数据库设计与编码" class="headerlink" title="二、数据库设计与编码"></a>二、数据库设计与编码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">-- 创建数据库</span><br><span class="line">CREATE DATABASE seckill;</span><br><span class="line">--使用数据库</span><br><span class="line">USE seckill;</span><br><span class="line">--创建秒杀库存表</span><br><span class="line"><span class="function">CREATE TABLE <span class="title">seckill</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">seckill_id BIGINT NOT NULL AUTO_INCREMENT COMMENT <span class="string">&#x27;商品库存表&#x27;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">name VARCHAR(<span class="number">120</span>)</span> NOT NULL COMMENT &#x27;商品名称&#x27;,</span></span><br><span class="line"><span class="function">number <span class="keyword">int</span> NOT NULL COMMENT &#x27;库存数量&#x27;,</span></span><br><span class="line"><span class="function">create_time TIMESTAMP NOT NULL DEFAULT current_timestamp COMMENT &#x27;创建时间&#x27;,</span></span><br><span class="line"><span class="function">start_time TIMESTAMP NOT NULL COMMENT &#x27;秒杀开始时间&#x27;,</span></span><br><span class="line"><span class="function">end_time TIMESTAMP NOT NULL COMMENT &#x27;秒杀结束时间&#x27;,</span></span><br><span class="line"><span class="function">PRIMARY <span class="title">KEY</span> <span class="params">(seckill_id)</span>,</span></span><br><span class="line"><span class="function">KEY <span class="title">idx_start_time</span><span class="params">(start_time)</span>,</span></span><br><span class="line"><span class="function">KEY <span class="title">idx_end_time</span><span class="params">(end_time)</span>,</span></span><br><span class="line"><span class="function">KEY <span class="title">idx_create_time</span><span class="params">(create_time)</span></span></span><br><span class="line"><span class="function">)ENGINE</span>=InnoDB AUTO_INCREMENT=<span class="number">1000</span> DEFAULT CHARSET =utf8 COMMENT =<span class="string">&#x27;秒杀库存表&#x27;</span>;</span><br><span class="line">--初始化数据</span><br><span class="line"><span class="function">INSERT INTO <span class="title">seckill</span><span class="params">(name, number, start_time, end_time)</span> <span class="title">VALUES</span><span class="params">()</span></span>;</span><br><span class="line">--秒杀成功明细表</span><br><span class="line"><span class="function">create table <span class="title">success_killed</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">seckill_id BIGINT NOT NULL COMMENT <span class="string">&#x27;秒杀商品id&#x27;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">user_phone BIGINT NOT NULL COMMENT <span class="string">&#x27;用户手机号&#x27;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">state TINYINT NOT NULL  NOT NULL DEFAULT -<span class="number">1</span> COMMENT <span class="string">&#x27;标识状态 -1 无效 0成功 1已付款 2 已发货 &#x27;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">create_time TIMESTAMP NOT NULL COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">PRIMARY KEY (seckill_id,user_phone)</span>,</span></span><br><span class="line"><span class="function">KEY <span class="title">idx_create_time</span><span class="params">(create_time)</span></span></span><br><span class="line"><span class="function">)ENGINE</span>=InnoDB DEFAULT CHARSET =utf8 COMMENT =<span class="string">&#x27;秒杀成功明细&#x27;</span>;</span><br><span class="line">--连接数据库控制台</span><br><span class="line">mysql -uroot -p</span><br></pre></td></tr></table></figure>
<h3 id="三、DAO层实体与编码"><a href="#三、DAO层实体与编码" class="headerlink" title="三、DAO层实体与编码"></a>三、DAO层实体与编码</h3><p>创建对应表的实体类，在java包下创建cn.codingxiaxw.entity包，创建一个Seckill.java实体类，代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Seckill</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> seckillId;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> number;</span><br><span class="line">    <span class="keyword">private</span> Date startTime;</span><br><span class="line">    <span class="keyword">private</span> Date endTime;</span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getSeckillId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSeckillId</span><span class="params">(<span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.seckillId = seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNumber</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.number = number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getStartTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> startTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStartTime</span><span class="params">(Date startTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.startTime = startTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getEndTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> endTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEndTime</span><span class="params">(Date endTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.endTime = endTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getCreateTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCreateTime</span><span class="params">(Date createTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.createTime = createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Seckill&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;seckillId=&quot;</span> + seckillId +</span><br><span class="line">                <span class="string">&quot;, name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, number=&quot;</span> + number +</span><br><span class="line">                <span class="string">&quot;, startTime=&quot;</span> + startTime +</span><br><span class="line">                <span class="string">&quot;, endTime=&quot;</span> + endTime +</span><br><span class="line">                <span class="string">&quot;, createTime=&quot;</span> + createTime +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>和一个SuccessKilled.java，代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SuccessKilled</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> seckillId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> userPhone;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">short</span> state;</span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//多对一，因为一件商品在库存中有很多数量，对应的购买明细也有很多。</span></span><br><span class="line">    <span class="keyword">private</span> Seckill seckill;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getSeckillId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSeckillId</span><span class="params">(<span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.seckillId = seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getUserPhone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userPhone;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserPhone</span><span class="params">(<span class="keyword">long</span> userPhone)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userPhone = userPhone;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">short</span> <span class="title">getState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(<span class="keyword">short</span> state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getCreateTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCreateTime</span><span class="params">(Date createTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.createTime = createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Seckill <span class="title">getSeckill</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> seckill;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSeckill</span><span class="params">(Seckill seckill)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.seckill = seckill;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;SuccessKilled&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;seckillId=&quot;</span> + seckillId +</span><br><span class="line">                <span class="string">&quot;, userPhone=&quot;</span> + userPhone +</span><br><span class="line">                <span class="string">&quot;, state=&quot;</span> + state +</span><br><span class="line">                <span class="string">&quot;, createTime=&quot;</span> + createTime +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>然后针对实体创建出对应dao层的接口，在cn.codingxiaxw.dao包下创建Seckill.java:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SeckillDao</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 减库存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> killTime</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 如果影响行数&gt;1，表示更新库存的记录行数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">reduceNumber</span><span class="params">(<span class="keyword">long</span> seckillId, Date killTime)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id查询秒杀的商品信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Seckill <span class="title">queryById</span><span class="params">(<span class="keyword">long</span> seckillId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据偏移量查询秒杀商品列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> off</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> limit</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;Seckill&gt; <span class="title">queryAll</span><span class="params">(<span class="keyword">int</span> off,<span class="keyword">int</span> limit)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>和SuccessKilled.java:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SuccessKilledDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入购买明细,可过滤重复</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userPhone</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>插入的行数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">insertSuccessKilled</span><span class="params">(<span class="keyword">long</span> seckillId,<span class="keyword">long</span> userPhone)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据秒杀商品的id查询明细SuccessKilled对象(该对象携带了Seckill秒杀产品对象)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">SuccessKilled <span class="title">queryByIdWithSeckill</span><span class="params">(<span class="keyword">long</span> seckillId,<span class="keyword">long</span> userPhone)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="四、基于MyBatis实现DAO理论"><a href="#四、基于MyBatis实现DAO理论" class="headerlink" title="四、基于MyBatis实现DAO理论"></a>四、基于MyBatis实现DAO理论</h3><p><strong>Mybatis 特点</strong></p>
<p>1、参数自由提供</p>
<p>2、mybatis和hibernate最大的区别就是mybatis的sql完全由自己写，所以这就提供了一个非常健壮的灵活性，可以充分的发挥你的sql的技巧。</p>
<p>3、mybatis的sql写在哪？</p>
<pre><code>1.第一个是写在xml的配置文件里

2.第二个是可以通过注解的形式写sql，java5.0之后提供的新特性。
</code></pre>
<p>4、一些简单的sql可以通过注解的形式去实现，但是遇到一些复杂的sql的时候注解来实现的话就会显的很繁琐。xml配置文件为我们提供很多标签，来完成复杂逻辑sql的拼接，可以很方便的去帮我们完成封装。</p>
<p>5、如何实现DAO接口？</p>
<pre><code>1.第一种，mybatis提供了mapper的机制，通过这种机制自动的去实现DAO接口。也就是说DAO接口只需要实现接口，不需要去实现类。

2.第二种那mybatis通过API编程的方式实现DAO接口。mybatis同样也提供了很多的api，这点和其他的ORmapping，JDBC很像，我可以直接通过开启一个connection，创建一个statement，然后那拿到一个resultSet,这是jdbc的API。同样的mybatis也有同样的API去帮我们实现，但是在实际的开发中，我们一般都是通过mapper自动实现DAO接口，这样的话我们就可以只关注我们的sql如何编写，如何去设计我们的DAO接口，帮我们节省了很多需要维护的程序。
</code></pre>
<p>​<br>接下来<strong>基于MyBatis来实现我们之前设计的Dao层接口</strong>。首先需要配置我们的MyBatis，在resources包下创建MyBatis全局配置文件mybatis-config.xml文件，并新建包mapper,在浏览器中输入<a target="_blank" rel="noopener" href="http://mybatis.github.io/mybatis-3/zh/index.html%E6%89%93%E5%BC%80MyBatis%E7%9A%84%E5%AE%98%E7%BD%91%E6%96%87%E6%A1%A3%EF%BC%8C%E7%82%B9%E5%87%BB%E5%B7%A6%E8%BE%B9%E7%9A%84%E2%80%9D%E5%85%A5%E9%97%A8%E2%80%9D%E6%A0%8F%E6%A1%86%EF%BC%8C%E6%89%BE%E5%88%B0mybatis%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%EF%BC%8C%E5%9C%A8%E8%BF%99%E9%87%8C%E6%9C%89xml%E7%9A%84%E4%B8%80%E4%B8%AA%E8%A7%84%E8%8C%83%EF%BC%8C%E4%B9%9F%E5%B0%B1%E6%98%AF%E5%AE%83%E7%9A%84%E4%B8%80%E4%B8%AAxml%E7%BA%A6%E6%9D%9F%EF%BC%8C%E6%8B%B7%E8%B4%9D">http://mybatis.github.io/mybatis-3/zh/index.html打开MyBatis的官网文档，点击左边的”入门”栏框，找到mybatis全局配置文件，在这里有xml的一个规范，也就是它的一个xml约束，拷贝</a>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="line">&lt;!DOCTYPE configuration</span><br><span class="line">  PUBLIC <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span><br><span class="line">  <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>到我们的项目mybatis全局配置文件中，然后在全局配置文件中加入如下配置信息:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="line">&lt;!DOCTYPE configuration</span><br><span class="line">        PUBLIC <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span><br><span class="line">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;!--配置全局属性--&gt;</span><br><span class="line">    &lt;settings&gt;</span><br><span class="line">        &lt;!--使用jdbc的getGeneratekeys获取自增主键值--&gt;</span><br><span class="line">        &lt;setting name=<span class="string">&quot;useGeneratedKeys&quot;</span> value=<span class="string">&quot;true&quot;</span>/&gt;</span><br><span class="line">        &lt;!--使用列别名替换列名　　默认值为<span class="function"><span class="keyword">true</span></span></span><br><span class="line"><span class="function">        select name as <span class="title">title</span><span class="params">(实体中的属性名是title)</span> form table</span>;</span><br><span class="line">        开启后mybatis会自动帮我们把表中name的值赋到对应实体的title属性中</span><br><span class="line">        --&gt;</span><br><span class="line">        &lt;setting name=<span class="string">&quot;useColumnLabel&quot;</span> value=<span class="string">&quot;true&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!--开启驼峰命名转换Table:create_time到 Entity(createTime)--&gt;</span><br><span class="line">        &lt;setting name=<span class="string">&quot;mapUnderscoreToCamelCase&quot;</span> value=<span class="string">&quot;true&quot;</span>/&gt;</span><br><span class="line">    &lt;/settings&gt;</span><br><span class="line"></span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>
<p>配置文件创建好后我们需要关注的是Dao接口该如何实现，mybatis为我们提供了mapper动态代理开发的方式为我们自动实现Dao的接口。在mapper包下创建对应Dao接口的xml映射文件，里面用于编写我们操作数据库的sql语句，SeckillDao.xml和SuccessKilledDao.xml。既然又是一个xml文件，我们肯定需要它的dtd文件，在官方文档中，点击左侧”XML配置”，在它的一些事例中，找到它的xml约束:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE mapper</span><br><span class="line">    PUBLIC <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="line">    <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br></pre></td></tr></table></figure>
<p>加入到两个mapper映射xml文件中，然后对照Dao层方法编写我们的映射文件内容如下:</p>
<p>SeckillDao.xml:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE mapper</span><br><span class="line">        PUBLIC <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="line">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="line">&lt;mapper namespace=<span class="string">&quot;cn.codingxiaxw.dao.SeckillDao&quot;</span>&gt;</span><br><span class="line">    &lt;!--目的:为dao接口方法提供sql语句配置</span><br><span class="line">    即针对dao接口中的方法编写我们的sql语句--&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;update id=<span class="string">&quot;reduceNumber&quot;</span>&gt;</span><br><span class="line">        UPDATE seckill</span><br><span class="line">        SET number = number-<span class="number">1</span></span><br><span class="line">        WHERE seckill_id=#&#123;seckillId&#125;</span><br><span class="line">        AND start_time &lt;![CDATA[ &lt;= ]]&gt; #&#123;killTime&#125;</span><br><span class="line">        AND end_time &gt;= #&#123;killTime&#125;</span><br><span class="line">        AND number &gt; <span class="number">0</span>;</span><br><span class="line">    &lt;/update&gt;</span><br><span class="line"></span><br><span class="line">    &lt;select id=<span class="string">&quot;queryById&quot;</span> resultType=<span class="string">&quot;Seckill&quot;</span> parameterType=<span class="string">&quot;long&quot;</span>&gt;</span><br><span class="line">        SELECT *</span><br><span class="line">        FROM seckill</span><br><span class="line">        WHERE seckill_id=#&#123;seckillId&#125;</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line"></span><br><span class="line">    &lt;select id=<span class="string">&quot;queryAll&quot;</span> resultType=<span class="string">&quot;Seckill&quot;</span>&gt;</span><br><span class="line">        SELECT *</span><br><span class="line">        FROM seckill</span><br><span class="line">        ORDER BY create_time DESC</span><br><span class="line">        limit #&#123;offset&#125;,#&#123;limit&#125;</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line"></span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>
<p>SuccessKilledDao.xml:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE mapper</span><br><span class="line">        PUBLIC <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="line">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="line">&lt;mapper namespace=<span class="string">&quot;cn.codingxiaxw.dao.SuccessKilledDao&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;insert id=<span class="string">&quot;insertSuccessKilled&quot;</span>&gt;</span><br><span class="line">        &lt;!--当出现主键冲突时(即重复秒杀时)，会报错;不想让程序报错，加入ignore--&gt;</span><br><span class="line">        <span class="function">INSERT ignore INTO <span class="title">success_killed</span><span class="params">(seckill_id,user_phone,state)</span></span></span><br><span class="line"><span class="function">        <span class="title">VALUES</span> <span class="params">(#&#123;seckillId&#125;,#&#123;userPhone&#125;,<span class="number">0</span>)</span></span></span><br><span class="line"><span class="function">    &lt;/insert&gt;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    &lt;select id</span>=<span class="string">&quot;queryByIdWithSeckill&quot;</span> resultType=<span class="string">&quot;SuccessKilled&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!--根据seckillId查询SuccessKilled对象，并携带Seckill对象--&gt;</span><br><span class="line">        &lt;!--如何告诉mybatis把结果映射到SuccessKill属性同时映射到Seckill属性--&gt;</span><br><span class="line">        &lt;!--可以自由控制SQL语句--&gt;</span><br><span class="line">        SELECT</span><br><span class="line">            sk.seckill_id,</span><br><span class="line">            sk.user_phone,</span><br><span class="line">            sk.create_time,</span><br><span class="line">            sk.state,</span><br><span class="line">            s.seckill_id <span class="string">&quot;seckill.seckill_id&quot;</span>,</span><br><span class="line">            s.name <span class="string">&quot;seckill.name&quot;</span>,</span><br><span class="line">            s.number <span class="string">&quot;seckill&quot;</span>,</span><br><span class="line">            s.start_time <span class="string">&quot;seckill.start_time&quot;</span>,</span><br><span class="line">            s.end_time <span class="string">&quot;seckill.end_time&quot;</span>,</span><br><span class="line">            s.create_time <span class="string">&quot;seckill.create_time&quot;</span></span><br><span class="line">        FROM success_killed sk</span><br><span class="line">        INNER JOIN seckill s ON sk.seckill_id=s.seckill_id</span><br><span class="line">        WHERE sk.seckill_id=#&#123;seckillId&#125;</span><br><span class="line">        AND sk.user_phone=#&#123;userPhone&#125;</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line"></span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>
<h3 id="五、MyBatis和Spring的整合"><a href="#五、MyBatis和Spring的整合" class="headerlink" title="五、MyBatis和Spring的整合"></a>五、MyBatis和Spring的整合</h3><p>mybatis与Spring的整合目标：</p>
<p>1、更少的编码</p>
<pre><code>1). 只需要接口，不需要实现(Mybatis 自动完成)
</code></pre>
<p>2、更少的配置</p>
<pre><code>1). 别名(Mybatis可以扫描对应包，因此使用一些类的时候不需要使用包名+类名)

2). 配置扫描

3). dao的实现
</code></pre>
<p>3、足够的灵活性</p>
<pre><code>1). 自己定制SQL语句

2). 自由传参
</code></pre>
<p>接下来我们开始MyBatis和Spring的整合，整合目标:1.更少的编码:只写接口，不写实现类。2.更少的配置:别名、配置扫描映射xml文件、dao实现。3.足够的灵活性:自由定制SQL语句、自由传结果集自动赋值。</p>
<p>在resources包下创建一个spring包，里面放置spring对Dao、Service、transaction的配置文件。在浏览器中输入<a target="_blank" rel="noopener" href="http://docs.spring.io/spring/docs/%E8%BF%9B%E5%85%A5%E5%88%B0Spring%E7%9A%84%E5%AE%98%E7%BD%91%E4%B8%AD%E4%B8%8B%E8%BD%BD%E5%85%B6pdf%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%EF%BC%8C%E5%9C%A8%E5%85%B6%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E4%B8%AD%E6%89%BE%E5%88%B0%E5%AE%83%E7%9A%84xml%E7%9A%84%E5%AE%9A%E4%B9%89%E5%86%85%E5%AE%B9%E5%A4%B4%E9%83%A8">http://docs.spring.io/spring/docs/进入到Spring的官网中下载其pdf官方文档，在其官方文档中找到它的xml的定义内容头部</a>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xmlns:context=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span><br></pre></td></tr></table></figure>
<p>在spring包下创建一个spring配置dao层对象的配置文件spring-dao.xml，加入上述dtd约束，然后添加二者整合的配置，内容如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xmlns:context=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--配置整合mybatis过程</span><br><span class="line">    <span class="number">1.</span>配置数据库相关参数--&gt;</span><br><span class="line">    &lt;context:property-placeholder location=<span class="string">&quot;classpath:jdbc.properties&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--<span class="number">2.</span>数据库连接池--&gt;</span><br><span class="line">    &lt;bean id=<span class="string">&quot;dataSource&quot;</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;com.mchange.v2.c3p0.ComboPooledDataSource&quot;</span>&gt;</span><br><span class="line">        &lt;!--配置连接池属性--&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;driverClass&quot;</span> value=<span class="string">&quot;$&#123;driver&#125;&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- 基本属性 url、user、password --&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;jdbcUrl&quot;</span> value=<span class="string">&quot;$&#123;url&#125;&quot;</span> /&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;user&quot;</span> value=<span class="string">&quot;$&#123;username&#125;&quot;</span> /&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;password&quot;</span> value=<span class="string">&quot;$&#123;password&#125;&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!--c3p0私有属性--&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;maxPoolSize&quot;</span> value=<span class="string">&quot;30&quot;</span>/&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;minPoolSize&quot;</span> value=<span class="string">&quot;10&quot;</span>/&gt;</span><br><span class="line">        &lt;!--关闭连接后不自动commit--&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;autoCommitOnClose&quot;</span> value=<span class="string">&quot;false&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!--获取连接超时时间--&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;checkoutTimeout&quot;</span> value=<span class="string">&quot;1000&quot;</span>/&gt;</span><br><span class="line">        &lt;!--当获取连接失败重试次数--&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;acquireRetryAttempts&quot;</span> value=<span class="string">&quot;2&quot;</span>/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--约定大于配置--&gt;</span><br><span class="line">    &lt;!--３.配置SqlSessionFactory对象--&gt;</span><br><span class="line">    &lt;bean id=<span class="string">&quot;sqlSessionFactory&quot;</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span>&gt;</span><br><span class="line">        &lt;!--往下才是mybatis和spring真正整合的配置--&gt;</span><br><span class="line">        &lt;!--注入数据库连接池--&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;dataSource&quot;</span> ref=<span class="string">&quot;dataSource&quot;</span>/&gt;</span><br><span class="line">        &lt;!--配置mybatis全局配置文件:mybatis-config.xml--&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;configLocation&quot;</span> value=<span class="string">&quot;classpath:mybatis-config.xml&quot;</span>/&gt;</span><br><span class="line">        &lt;!--扫描entity包,使用别名,多个用;隔开--&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;typeAliasesPackage&quot;</span> value=<span class="string">&quot;cn.codingxiaxw.entity&quot;</span>/&gt;</span><br><span class="line">        &lt;!--扫描sql配置文件:mapper需要的xml文件--&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;mapperLocations&quot;</span> value=<span class="string">&quot;classpath:mapper/*.xml&quot;</span>/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--４:配置扫描Dao接口包,动态实现DAO接口,注入到spring容器--&gt;</span><br><span class="line">    &lt;bean <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;</span>&gt;</span><br><span class="line">        &lt;!--注入SqlSessionFactory--&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;sqlSessionFactoryBeanName&quot;</span> value=<span class="string">&quot;sqlSessionFactory&quot;</span>/&gt;</span><br><span class="line">        &lt;!-- 给出需要扫描的Dao接口--&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;basePackage&quot;</span> value=<span class="string">&quot;cn.codingxiaxw.dao&quot;</span>/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>
<p>需要我们在resources包下创建jdbc.properties用于配置数据库的连接信息，内容如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">driver=com.mysql.jdbc.Driver</span><br><span class="line">url=jdbc:mysql:<span class="comment">//localhost:3306/seckill?useUnicode=true&amp;characterEncoding=utf-8</span></span><br><span class="line">username=root</span><br><span class="line">password=xiaxunwu1996.</span><br></pre></td></tr></table></figure>
<h3 id="六、DAO单元测试"><a href="#六、DAO单元测试" class="headerlink" title="六、DAO单元测试"></a>六、DAO单元测试</h3><p>这样我们便完成了Dao层编码的开发，接下来就可以利用junit进行我们Dao层编码的测试了。首先测试SeckillDao.java，利用IDEA快捷键shift+command+T对SeckillDao.java进行测试，然后IDEA会自动在test包的java包下为我们生成对SeckillDao.java中所有方法的测试类SeckillDaoTest.java,内容如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillDaoTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduceNumber</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryById</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryAll</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后便可以在这个测试类中对SeckillDao接口的所有方法进行测试了,先测试queryById()方法，在该方法中添加内容:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by codingBoy on 16/11/27.</span></span><br><span class="line"><span class="comment"> * 配置spring和junit整合，这样junit在启动时就会加载spring容器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner.class)</span></span><br><span class="line"><span class="comment">//告诉junit spring的配置文件</span></span><br><span class="line"><span class="meta">@ContextConfiguration(&#123;&quot;classpath:spring/spring-dao.xml&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillDaoTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注入Dao实现类依赖</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SeckillDao seckillDao;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryById</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> seckillId=<span class="number">1000</span>;</span><br><span class="line">        Seckill seckill=seckillDao.queryById(seckillId);</span><br><span class="line">        System.out.println(seckill.getName());</span><br><span class="line">        System.out.println(seckill);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>右键选择”debug queryById()”，测试台成功输入该id为1000的商品信息，证明Dao的该方法正确，然后测试queryAll()方法，在该方法中添加如下内容:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryAll</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">       List&lt;Seckill&gt; seckills=seckillDao.queryAll(<span class="number">0</span>,<span class="number">100</span>);</span><br><span class="line">       <span class="keyword">for</span> (Seckill seckill : seckills)</span><br><span class="line">       &#123;</span><br><span class="line">           System.out.println(seckill);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>然后运行该方法，程序报错，报错信息如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Caused by: org.apache.ibatis.binding.BindingException: Parameter &#x27;offset&#x27; not found. Available parameters are [1, 0, param1, param2</span><br></pre></td></tr></table></figure>
<p>意思就是无法完成offset参数的绑定，这也是我们java编程语言的一个问题，也就是java没有保存行参的记录，java在运行的时候会把<code>List&lt;Seckill&gt; queryAll(int offset,int limit);</code>中的参数变成这样:<code>queryAll(int arg0,int arg1)</code>,这样我们就没有办法去传递多个参数。需要在SeckillDao接口中修改方法:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Seckill&gt; queryAll(@Param(&quot;offset&quot;) int offset,@Param(&quot;limit&quot;) int limit);</span><br></pre></td></tr></table></figure>
<p>这样才能使我们的MyBatis识别offset和limit两个参数，将Dao层方法中的这两个参数与xml映射文件中sql语句的传入参数完成映射。然后重新测试，发现测试通过。然后测试reduceNumber()方法，在该方法中加入如下内容:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduceNumber</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">long</span> seckillId=<span class="number">1000</span>;</span><br><span class="line">      Date date=<span class="keyword">new</span> Date();</span><br><span class="line">      <span class="keyword">int</span> updateCount=seckillDao.reduceNumber(seckillId,date);</span><br><span class="line">      System.out.println(updateCount);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>运行该方法，报错:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Caused by: org.apache.ibatis.binding.BindingException: Parameter &#x27;seckillId&#x27; not found. Available parameters are [1, 0, param1, param2]</span><br></pre></td></tr></table></figure>
<p>发现依然是我们之前那个错误，更改SeckillDao接口的reduceNumber()方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">reduceNumber</span><span class="params">(<span class="meta">@Param(&quot;seckillId&quot;)</span> <span class="keyword">long</span> seckillId, <span class="meta">@Param(&quot;killTime&quot;)</span> Date killTime)</span></span>;</span><br></pre></td></tr></table></figure>
<p>然后重新运行，测试通过，可是我们查询数据库发现该库存表的商品数量没有减少，是因为我们当前时间没有达到秒杀商品要求的时间，所以不会成功秒杀。接下来进行SuccessKilledDao接口相关方法的测试，依旧使用IDEA快捷键<code>shift+command+T</code>快速生成其方法的相应测试类:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public class SuccessKilledDaoTest &#123;</span><br><span class="line">    @Test</span><br><span class="line">    public void insertSuccessKilled() throws Exception 	&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void queryByIdWithSeckill() throws Exception 	&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>依然要在SuccessKilledDao的方法中用@Param注解完成参数的绑定，首先完成insertSuccessKilled()的测试:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner.class)</span></span><br><span class="line"><span class="comment">//告诉junit spring的配置文件</span></span><br><span class="line"><span class="meta">@ContextConfiguration(&#123;&quot;classpath:spring/spring-dao.xml&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SuccessKilledDaoTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SuccessKilledDao successKilledDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertSuccessKilled</span><span class="params">()</span> <span class="keyword">throws</span> Exception 	</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> seckillId=<span class="number">1000</span>;</span><br><span class="line">        <span class="keyword">long</span> userPhone=<span class="number">13476191877L</span>;</span><br><span class="line">        <span class="keyword">int</span> insertCount=successKilledDao.insertSuccessKilled(seckillId,userPhone);</span><br><span class="line">        System.out.println(<span class="string">&quot;insertCount=&quot;</span>+insertCount);</span><br><span class="line">    &#125;</span><br><span class="line">｝</span><br></pre></td></tr></table></figure>
<p>运行成功，测试台打印出insertCount=1的信息，即我们修改了表中的一条记录，这时查看秒杀成功明细表，发现该用户的信息已经被插入。然后再次运行该测试方法，程序没有报主键异常的错，是因为我们在编写我们的明细表的时候添加了一个联合主键的字段，它保证我们明细表中的seckillId和userPhone不能重复插入，另外在SuccessDao.xml中写的插入语句的ignore关键字也保证了这点。控制台输出0，表示没有对明细表做插入操作。然后进行queryByIdWithSeckill()方法的测试,需要在Dao层的方法中添加@Param注解:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SuccessKilled queryByIdWithSeckill(@Param(&quot;seckillId&quot;) long seckillId,@Param(&quot;userPhone&quot;) long userPhone);</span><br></pre></td></tr></table></figure>
<p>然后进行该方法的测试:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryByIdWithSeckill</span><span class="params">()</span> <span class="keyword">throws</span> Exception 	</span>&#123;</span><br><span class="line">        <span class="keyword">long</span> seckillId=<span class="number">1000L</span>;</span><br><span class="line">        <span class="keyword">long</span> userPhone=<span class="number">13476191877L</span>;</span><br><span class="line">        SuccessKilled successKilled=successKilledDao.queryByIdWithSeckill(seckillId,userPhone);</span><br><span class="line">        System.out.println(successKilled);</span><br><span class="line">        System.out.println(successKilled.getSeckill());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>运行，成功查询出我们明细表中id为1000且手机号码为13476191877的用户信息，并将表中对应的信息映射到SuccessKilled对象和Seckill对象的属性中。</p>
<h2 id="Service层"><a href="#Service层" class="headerlink" title="Service层"></a>Service层</h2><p>Dao就是数据访问的缩写，它只进行数据的访问操作，接下来我们便进行Service层代码的编写</p>
<h3 id="一、Service接口设计与实现"><a href="#一、Service接口设计与实现" class="headerlink" title="一、Service接口设计与实现"></a>一、Service接口设计与实现</h3><p>在org.seckill包下创建一个service包用于存放我们的Service接口和其实现类，创建一个exception包用于存放service层出现的异常例如重复秒杀商品异常、秒杀已关闭等异常，一个dto包作为传输层,dto和entity的区别在于:entity用于业务数据的封装，而dto用于完成web和service层的数据传递。</p>
<p><strong>接口设计</strong></p>
<p>首先创建我们Service接口，里面的方法应该是按”使用者”(程序员)的角度去设计，SeckillService.java，代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SeckillService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询全部的秒杀记录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;Seckill&gt; <span class="title">getSeckillList</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *查询单个秒杀记录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Seckill <span class="title">getById</span><span class="params">(<span class="keyword">long</span> seckillId)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//再往下，是我们最重要的行为的一些接口</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在秒杀开启时输出秒杀接口的地址，否则输出系统时间和秒杀时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Exposer <span class="title">exportSeckillUrl</span><span class="params">(<span class="keyword">long</span> seckillId)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行秒杀操作，有可能失败，有可能成功，所以要抛出我们允许的异常</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userPhone</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> md5</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">SeckillExecution <span class="title">executeSeckill</span><span class="params">(<span class="keyword">long</span> seckillId,<span class="keyword">long</span> userPhone,String md5)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> SeckillException,RepeatKillException,SeckillCloseException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该接口中前面两个方法返回的都是跟我们业务相关的对象，而后两个方法返回的对象与业务不相关，这两个对象我们用于封装service和web层传递的数据，方法的作用我们已在注释中给出。相应在的dto包中创建Exposer.java，用于封装秒杀的地址信息，各个属性的作用在代码中已给出注释，代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by codingBoy on 16/11/27.</span></span><br><span class="line"><span class="comment"> * 暴露秒杀地址(接口)DTO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exposer</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//是否开启秒杀</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> exposed;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//对秒杀地址加密措施</span></span><br><span class="line">    <span class="keyword">private</span> String md5;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//id为seckillId的商品的秒杀地址</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> seckillId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//系统当前时间(毫秒)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> now;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//秒杀的开启时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> start;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//秒杀的结束时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> end;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exposer</span><span class="params">(<span class="keyword">boolean</span> exposed, String md5, <span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.exposed = exposed;</span><br><span class="line">        <span class="keyword">this</span>.md5 = md5;</span><br><span class="line">        <span class="keyword">this</span>.seckillId = seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exposer</span><span class="params">(<span class="keyword">boolean</span> exposed, <span class="keyword">long</span> seckillId,<span class="keyword">long</span> now, <span class="keyword">long</span> start, <span class="keyword">long</span> end)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.exposed = exposed;</span><br><span class="line">        <span class="keyword">this</span>.seckillId=seckillId;</span><br><span class="line">        <span class="keyword">this</span>.now = now;</span><br><span class="line">        <span class="keyword">this</span>.start = start;</span><br><span class="line">        <span class="keyword">this</span>.end = end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exposer</span><span class="params">(<span class="keyword">boolean</span> exposed, <span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.exposed = exposed;</span><br><span class="line">        <span class="keyword">this</span>.seckillId = seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isExposed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> exposed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setExposed</span><span class="params">(<span class="keyword">boolean</span> exposed)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.exposed = exposed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMd5</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> md5;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMd5</span><span class="params">(String md5)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.md5 = md5;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getSeckillId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSeckillId</span><span class="params">(<span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.seckillId = seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getNow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> now;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNow</span><span class="params">(<span class="keyword">long</span> now)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.now = now;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> start;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStart</span><span class="params">(<span class="keyword">long</span> start)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.start = start;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getEnd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEnd</span><span class="params">(<span class="keyword">long</span> end)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.end = end;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>和SeckillExecution.java，用于判断秒杀是否成功，成功就返回秒杀成功的所有信息(包括秒杀的商品id、秒杀成功状态、成功信息、用户明细)，失败就抛出一个我们允许的异常(重复秒杀异常、秒杀结束异常),代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 封装执行秒杀后的结果:是否秒杀成功</span></span><br><span class="line"><span class="comment"> * Created by codingBoy on 16/11/27.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillExecution</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> seckillId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//秒杀执行结果的状态</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> state;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//状态的明文标识</span></span><br><span class="line">    <span class="keyword">private</span> String stateInfo;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当秒杀成功时，需要传递秒杀成功的对象回去</span></span><br><span class="line">    <span class="keyword">private</span> SuccessKilled successKilled;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//秒杀成功返回所有信息</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeckillExecution</span><span class="params">(<span class="keyword">long</span> seckillId, <span class="keyword">int</span> state, String stateInfo, SuccessKilled successKilled)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.seckillId = seckillId;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">        <span class="keyword">this</span>.stateInfo = stateInfo;</span><br><span class="line">        <span class="keyword">this</span>.successKilled = successKilled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//秒杀失败</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeckillExecution</span><span class="params">(<span class="keyword">long</span> seckillId, <span class="keyword">int</span> state, String stateInfo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.seckillId = seckillId;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">        <span class="keyword">this</span>.stateInfo = stateInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getSeckillId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSeckillId</span><span class="params">(<span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.seckillId = seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(<span class="keyword">int</span> state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getStateInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stateInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStateInfo</span><span class="params">(String stateInfo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.stateInfo = stateInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SuccessKilled <span class="title">getSuccessKilled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> successKilled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSuccessKilled</span><span class="params">(SuccessKilled successKilled)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.successKilled = successKilled;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后需要创建我们在秒杀业务过程中允许的异常，重复秒杀异常RepeatKillException.java:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 重复秒杀异常，是一个运行期异常，不需要我们手动try catch</span></span><br><span class="line"><span class="comment"> * Mysql只支持运行期异常的回滚操作</span></span><br><span class="line"><span class="comment"> * Created by codingBoy on 16/11/27.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RepeatKillException</span> <span class="keyword">extends</span> <span class="title">SeckillException</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RepeatKillException</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RepeatKillException</span><span class="params">(String message, Throwable cause)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message, cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>秒杀关闭异常SeckillCloseException.java:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 秒杀关闭异常，当秒杀结束时用户还要进行秒杀就会出现这个异常</span></span><br><span class="line"><span class="comment"> * Created by codingBoy on 16/11/27.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillCloseException</span> <span class="keyword">extends</span> <span class="title">SeckillException</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeckillCloseException</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeckillCloseException</span><span class="params">(String message, Throwable cause)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message, cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>和一个异常包含与秒杀业务所有出现的异常SeckillException.java:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 秒杀相关的所有业务异常</span></span><br><span class="line"><span class="comment"> * Created by codingBoy on 16/11/27.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeckillException</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeckillException</span><span class="params">(String message, Throwable cause)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message, cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到此，接口的工作便完成，接下来进行接口实现类的编码工作。</p>
<p><strong>接口实现</strong><br>在service包下创建impl包存放它的实现类，SeckillServiceImpl.java，内容如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillServiceImpl</span> <span class="keyword">implements</span> <span class="title">SeckillService</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">//日志对象</span></span><br><span class="line">    <span class="keyword">private</span> Logger logger= LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加入一个混淆字符串(秒杀接口)的salt，为了我避免用户猜出我们的md5值，值任意给，越复杂越好</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String salt=<span class="string">&quot;shsdssljdd&#x27;l.&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注入Service依赖</span></span><br><span class="line">    <span class="meta">@Autowired</span> <span class="comment">//@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SeckillDao seckillDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span> <span class="comment">//@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SuccessKilledDao successKilledDao;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Seckill&gt; <span class="title">getSeckillList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> seckillDao.queryAll(<span class="number">0</span>,<span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Seckill <span class="title">getById</span><span class="params">(<span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> seckillDao.queryById(seckillId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Exposer <span class="title">exportSeckillUrl</span><span class="params">(<span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        Seckill seckill=seckillDao.queryById(seckillId);</span><br><span class="line">        <span class="keyword">if</span> (seckill==<span class="keyword">null</span>) <span class="comment">//说明查不到这个秒杀产品的记录</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Exposer(<span class="keyword">false</span>,seckillId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//若是秒杀未开启</span></span><br><span class="line">        Date startTime=seckill.getStartTime();</span><br><span class="line">        Date endTime=seckill.getEndTime();</span><br><span class="line">        <span class="comment">//系统当前时间</span></span><br><span class="line">        Date nowTime=<span class="keyword">new</span> Date();</span><br><span class="line">        <span class="keyword">if</span> (startTime.getTime()&gt;nowTime.getTime() || endTime.getTime()&lt;nowTime.getTime())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Exposer(<span class="keyword">false</span>,seckillId,nowTime.getTime(),startTime.getTime(),endTime.getTime());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//秒杀开启，返回秒杀商品的id、用给接口加密的md5</span></span><br><span class="line">        String md5=getMD5(seckillId);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Exposer(<span class="keyword">true</span>,md5,seckillId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getMD5</span><span class="params">(<span class="keyword">long</span> seckillId)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        String base=seckillId+<span class="string">&quot;/&quot;</span>+salt;</span><br><span class="line">        String md5= DigestUtils.md5DigestAsHex(base.getBytes());</span><br><span class="line">        <span class="keyword">return</span> md5;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//秒杀是否成功，成功:减库存，增加明细；失败:抛出异常，事务回滚</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SeckillExecution <span class="title">executeSeckill</span><span class="params">(<span class="keyword">long</span> seckillId, <span class="keyword">long</span> userPhone, String md5)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> SeckillException, RepeatKillException, SeckillCloseException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (md5==<span class="keyword">null</span>||!md5.equals(getMD5(seckillId)))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SeckillException(<span class="string">&quot;seckill data rewrite&quot;</span>);<span class="comment">//秒杀数据被重写了</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//执行秒杀逻辑:减库存+增加购买明细</span></span><br><span class="line">        Date nowTime=<span class="keyword">new</span> Date();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//减库存</span></span><br><span class="line">            <span class="keyword">int</span> updateCount=seckillDao.reduceNumber(seckillId,nowTime);</span><br><span class="line">            <span class="keyword">if</span> (updateCount&lt;=<span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//没有更新库存记录，说明秒杀结束</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SeckillCloseException(<span class="string">&quot;seckill is closed&quot;</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//否则更新了库存，秒杀成功,增加明细</span></span><br><span class="line">                <span class="keyword">int</span> insertCount=successKilledDao.insertSuccessKilled(seckillId,userPhone);</span><br><span class="line">                <span class="comment">//看是否该明细被重复插入，即用户是否重复秒杀</span></span><br><span class="line">                <span class="keyword">if</span> (insertCount&lt;=<span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RepeatKillException(<span class="string">&quot;seckill repeated&quot;</span>);</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//秒杀成功,得到成功插入的明细记录,并返回成功秒杀的信息</span></span><br><span class="line">                    SuccessKilled successKilled=successKilledDao.queryByIdWithSeckill(seckillId,userPhone);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> SeckillExecution(seckillId,<span class="number">1</span>,<span class="string">&quot;秒杀成功&quot;</span>,successKilled);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (SeckillCloseException e1)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> e1;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (RepeatKillException e2)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> e2;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            logger.error(e.getMessage(),e);</span><br><span class="line">            <span class="comment">//所以编译期异常转化为运行期异常</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SeckillException(<span class="string">&quot;seckill inner error :&quot;</span>+e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对上述代码进行分析一下，在<code>return new SeckillExecution(seckillId,1,&quot;秒杀成功&quot;,successKilled);</code>代码中，我们返回的state和stateInfo参数信息应该是输出给前端的，但是我们不想在我们的return代码中硬编码这两个参数，所以我们应该考虑用枚举的方式将这些常量封装起来，在org.seckill包下新建一个枚举包enums，创建一个枚举类型SeckillStatEnum.java，内容如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">SeckillStatEnum</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    SUCCESS(<span class="number">1</span>,<span class="string">&quot;秒杀成功&quot;</span>),</span><br><span class="line">    END(<span class="number">0</span>,<span class="string">&quot;秒杀结束&quot;</span>),</span><br><span class="line">    REPEAT_KILL(-<span class="number">1</span>,<span class="string">&quot;重复秒杀&quot;</span>),</span><br><span class="line">    INNER_ERROR(-<span class="number">2</span>,<span class="string">&quot;系统异常&quot;</span>),</span><br><span class="line">    DATE_REWRITE(-<span class="number">3</span>,<span class="string">&quot;数据篡改&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> state;</span><br><span class="line">    <span class="keyword">private</span> String info;</span><br><span class="line"></span><br><span class="line">    SeckillStatEnum(<span class="keyword">int</span> state, String info) &#123;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">        <span class="keyword">this</span>.info = info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SeckillStatEnum <span class="title">stateOf</span><span class="params">(<span class="keyword">int</span> index)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (SeckillStatEnum state : values())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (state.getState()==index)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> state;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后修改执行秒杀操作的非业务类SeckillExecution.java里面涉及到state和stateInfo参数的构造方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//秒杀成功返回所有信息</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">SeckillExecution</span><span class="params">(<span class="keyword">long</span> seckillId, SeckillStatEnum statEnum, SuccessKilled successKilled)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">this</span>.seckillId = seckillId;</span><br><span class="line">     <span class="keyword">this</span>.state = statEnum.getState();</span><br><span class="line">     <span class="keyword">this</span>.stateInfo = statEnum.getInfo();</span><br><span class="line">     <span class="keyword">this</span>.successKilled = successKilled;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//秒杀失败</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">SeckillExecution</span><span class="params">(<span class="keyword">long</span> seckillId, SeckillStatEnum statEnum)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">this</span>.seckillId = seckillId;</span><br><span class="line">     <span class="keyword">this</span>.state = statEnum.getState();</span><br><span class="line">     <span class="keyword">this</span>.stateInfo = statEnum.getInfo();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>然后便可修改实现类方法中的返回语句为:<code>return new SeckillExecution(seckillId, SeckillStatEnum.SUCCESS,successKilled);</code>，保证了一些常用常量数据被封装在枚举类型里。</p>
<p>目前为止我们Service的实现全部完成，接下来要将Service交给Spring的容器托管，进行一些配置。</p>
<h3 id="二、Spring托管Service实现类"><a href="#二、Spring托管Service实现类" class="headerlink" title="二、Spring托管Service实现类"></a>二、Spring托管Service实现类</h3><p>Spring-IOC注入方式和场景</p>
<pre><code>1、XML方式：主要用于配置第三方类库或需要命名空间配置

2、注解：自己编写的类，直接在代码中使用注解，如@Service，@Controller

3、Java配置类：需要通过代码控制对象创建逻辑的场景，如自定义修改依赖类库
</code></pre>
<p>在spring包下创建一个spring-service.xml文件，内容如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xmlns:context=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/context</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--扫描service包下所有使用注解的类型--&gt;</span><br><span class="line">    &lt;context:component-scan base-<span class="keyword">package</span>=<span class="string">&quot;cn.codingxiaxw.service&quot;</span>/&gt;</span><br><span class="line">    </span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>
<p>然后采用注解的方式将Service的实现类加入到Spring IOC容器中:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@Component @Service @Dao @Controller</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillServiceImpl</span> <span class="keyword">implements</span> <span class="title">SeckillService</span></span></span><br></pre></td></tr></table></figure>
<p>下面我们来运用Spring的声明式事务对我们项目中的事务进行管理。</p>
<h3 id="三、配置并使用spring声明式事务"><a href="#三、配置并使用spring声明式事务" class="headerlink" title="三、配置并使用spring声明式事务"></a>三、配置并使用spring声明式事务</h3><p>声明式事务的使用方式:</p>
<pre><code>1.早期使用的方式:ProxyFactoryBean+XMl.

2.tx:advice+aop命名空间，这种配置的好处就是一次配置永久生效。

3.注解@Transactional的方式。在实际开发中，建议使用第三种对我们的事务进行控制，优点见下面代码中的注释。
</code></pre>
<p> Spring在抛出运行期异常时会回滚事务，两点注意：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> 非运行期异常时要注意，防止出现部分成功部分失败的情况（所以自己封装异常时，在需要的地方要implements RuntimeException）。</span><br><span class="line"></span><br><span class="line"><span class="number">2</span> 小心使用<span class="keyword">try</span>-<span class="keyword">catch</span>：被<span class="keyword">try</span>-<span class="keyword">catch</span>块包裹起来的异常Spring也是感觉不到的   </span><br></pre></td></tr></table></figure>

<p>下面让我们来配置声明式事务，在spring-service.xml中添加对事务的配置:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--配置事务管理器--&gt;</span><br><span class="line">  &lt;bean id=<span class="string">&quot;transactionManager&quot;</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span><br><span class="line">      &lt;!--注入数据库连接池--&gt;</span><br><span class="line">      &lt;property name=<span class="string">&quot;dataSource&quot;</span> ref=<span class="string">&quot;dataSource&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">  &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">  &lt;!--配置基于注解的声明式事务</span><br><span class="line">  默认使用注解来管理事务行为--&gt;</span><br><span class="line">  &lt;tx:annotation-driven transaction-manager=<span class="string">&quot;transactionManager&quot;</span>/&gt;</span><br></pre></td></tr></table></figure>
<p>然后在Service实现类的方法中，在需要进行事务声明的方法上加上事务的注解:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//秒杀是否成功，成功:减库存，增加明细；失败:抛出异常，事务回滚</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用注解控制事务方法的优点:</span></span><br><span class="line"><span class="comment"> * 1.开发团队达成一致约定，明确标注事务方法的编程风格</span></span><br><span class="line"><span class="comment"> * 2.保证事务方法的执行时间尽可能短，不要穿插其他网络操作RPC/HTTP请求或者剥离到事务方法外部</span></span><br><span class="line"><span class="comment"> * 3.不是所有的方法都需要事务，如只有一条修改操作、只读操作不要事务控制</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SeckillExecution <span class="title">executeSeckill</span><span class="params">(<span class="keyword">long</span> seckillId, <span class="keyword">long</span> userPhone, String md5)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> SeckillException, RepeatKillException, SeckillCloseException </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>下面针对我们之前做的业务实现类来做集成测试。</p>
<h3 id="四、完成Service集成测试"><a href="#四、完成Service集成测试" class="headerlink" title="四、完成Service集成测试"></a>四、完成Service集成测试</h3><p>在SeckillService接口中使用IDEA快捷键shift+command+T，快速生成junit测试类。Service实现类中前面两个方法很好实现，获取列表或者列表中的一个商品的信息即可，测试如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner.class)</span></span><br><span class="line"><span class="comment">//告诉junit spring的配置文件</span></span><br><span class="line"><span class="meta">@ContextConfiguration(&#123;&quot;classpath:spring/spring-dao.xml&quot;,</span></span><br><span class="line"><span class="meta">                        &quot;classpath:spring/spring-service.xml&quot;&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillServiceTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger= LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SeckillService seckillService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getSeckillList</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        List&lt;Seckill&gt; seckills=seckillService.getSeckillList();</span><br><span class="line">        System.out.println(seckills);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getById</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> seckillId=<span class="number">1000</span>;</span><br><span class="line">        Seckill seckill=seckillService.getById(seckillId);</span><br><span class="line">        System.out.println(seckill);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重点就是<code>exportSeckillUrl()</code>方法和<code>executeSeckill()</code>方法的测试，接下来我们进行<code>exportSeckillUrl()</code>方法的测试，如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exportSeckillUrl</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> seckillId=<span class="number">1000</span>;</span><br><span class="line">    Exposer exposer=seckillService.exportSeckillUrl(seckillId);</span><br><span class="line">    System.out.println(exposer);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>控制台中输入如下信息:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exposer&#123;exposed=false, md5=&#x27;null&#x27;, seckillId=1000, now=1480322072410, start=1451577600000, end=1451664000000&#125;</span><br></pre></td></tr></table></figure>
<p>没有给我们返回id为1000的商品秒杀地址，是因为我们当前的时间并不在秒杀时间开启之内，所以该商品还没有开启。需要修改数据库中该商品秒杀活动的时间在我们测试时的当前时间之内，然后再进行该方法的测试，控制台中输出如下信息:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exposer&#123;exposed=true, md5=&#x27;bf204e2683e7452aa7db1a50b5713bae&#x27;, seckillId=1000, now=0, start=0, end=0&#125;</span><br></pre></td></tr></table></figure>
<p>可知开启了id为1000的商品的秒杀，并给我们输出了该商品的秒杀地址。而第四个方法的测试就需要传入该地址让用户得到才能判断该用户是否秒杀到该地址的商品，然后进行第四个方法的测试,如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeSeckill</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> seckillId=<span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">long</span> userPhone=<span class="number">13476191876L</span>;</span><br><span class="line">    String md5=<span class="string">&quot;bf204e2683e7452aa7db1a50b5713bae&quot;</span>;</span><br><span class="line"></span><br><span class="line">    SeckillExecution seckillExecution=seckillService.executeSeckill(seckillId,userPhone,md5);</span><br><span class="line"></span><br><span class="line">    System.out.println(seckillExecution);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>控制台输出信息:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SeckillExecution&#123;seckillId=1000, state=1, stateInfo=&#x27;秒杀成功&#x27;, successKilled=SuccessKilled&#123;seckillId=1000, userPhone=13476191876, state=0, createTime=Mon Nov 28 16:45:38 CST 2016&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>证明电话为13476191876的用户成功秒杀到了该商品，查看数据库，该用户秒杀商品的明细信息已经被插入明细表，说明我们的业务逻辑没有问题。但其实这样写测试方法还有点问题，此时再次执行该方法，控制台报错，因为用户重复秒杀了。我们应该在该测试方法中添加try catch,将程序允许的异常包起来而不去向上抛给junit，更改测试代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeSeckill</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">long</span> seckillId=<span class="number">1000</span>;</span><br><span class="line">     <span class="keyword">long</span> userPhone=<span class="number">13476191876L</span>;</span><br><span class="line">     String md5=<span class="string">&quot;bf204e2683e7452aa7db1a50b5713bae&quot;</span>;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         SeckillExecution seckillExecution = seckillService.executeSeckill(seckillId, userPhone, md5);</span><br><span class="line"></span><br><span class="line">         System.out.println(seckillExecution);</span><br><span class="line">     &#125;<span class="keyword">catch</span> (RepeatKillException e)</span><br><span class="line">     &#123;</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">     &#125;<span class="keyword">catch</span> (SeckillCloseException e1)</span><br><span class="line">     &#123;</span><br><span class="line">         e1.printStackTrace();</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>这样再测试该方法，junit便不会再在控制台中报错，而是认为这是我们系统允许出现的异常。由上分析可知，第四个方法只有拿到了第三个方法暴露的秒杀商品的地址后才能进行测试，也就是说只有在第三个方法运行后才能运行测试第四个方法，而实际开发中我们不是这样的，需要将第三个测试方法和第四个方法合并到一个方法从而组成一个完整的逻辑流程:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span><span class="comment">//完整逻辑代码测试，注意可重复执行</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSeckillLogic</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> seckillId=<span class="number">1000</span>;</span><br><span class="line">        Exposer exposer=seckillService.exportSeckillUrl(seckillId);</span><br><span class="line">        <span class="keyword">if</span> (exposer.isExposed())</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            System.out.println(exposer);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">long</span> userPhone=<span class="number">13476191876L</span>;</span><br><span class="line">            String md5=exposer.getMd5();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                SeckillExecution seckillExecution = seckillService.executeSeckill(seckillId, userPhone, md5);</span><br><span class="line">                System.out.println(seckillExecution);</span><br><span class="line">            &#125;<span class="keyword">catch</span> (RepeatKillException e)</span><br><span class="line">            &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;<span class="keyword">catch</span> (SeckillCloseException e1)</span><br><span class="line">            &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//秒杀未开启</span></span><br><span class="line">            System.out.println(exposer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>运行该测试类，控制台成功输出信息，库存会减少，明细表也会增加内容。重复执行，控制台不会报错，只是会抛出一个允许的重复秒杀异常。</p>
<h2 id="Web层"><a href="#Web层" class="headerlink" title="Web层"></a>Web层</h2><h3 id="一、前端交互流程设计"><a href="#一、前端交互流程设计" class="headerlink" title="一、前端交互流程设计"></a>一、前端交互流程设计</h3><p>对于一个系统，需要产品经理、前端工程师和后端工程师的参数，产品经理将用户的需求做成一个开发文档交给前端工程师和后端工程师，前端工程师为系统完成页面的开发，后端工程师为系统完成业务逻辑的开发。对于我们这个秒杀系统，它的前端交互流程设计如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">列表页-&gt;详情页-&gt;login-no-&gt;登录操作-&gt;写入cookie-yes-&gt;展示逻辑</span><br><span class="line">                     -yes-&gt;展示逻辑</span><br><span class="line"></span><br><span class="line">获取标准系统时间-&gt;时间判断（开始时间/结束时间）-结束-&gt;秒杀结束</span><br><span class="line">                                               -未开始-&gt;倒计时\</span><br><span class="line">                                               -已开始-------&gt;秒杀地址-&gt;执行秒杀</span><br><span class="line">                                               </span><br></pre></td></tr></table></figure>

<p>这个流程图就告诉了我们详情页的流程逻辑，前端工程师根据这个流程图设计页面，而我们后端工程师根据这个流程图开发我们对应的代码。前端交互流程是系统开发中很重要的一部分，接下来进行Restful接口设计的学习</p>
<h3 id="二、Restful接口设计"><a href="#二、Restful接口设计" class="headerlink" title="二、Restful接口设计"></a>二、Restful接口设计</h3><p>什么是Restful:</p>
<pre><code>1、很早以前就已经出现的的一个设计理念，真正被发扬广大是通过Ruby on Rails这个框架，他的设计规范里边就非常友好的去把hb,最前端的内个url如何表示、如何提交形成了一个规范，那么这个规范那就是restful。

2、本质上是一个优雅的URL表述方式。

3、他的意义就是他是一种资源的状态或者是状态转移，比如说当我们要去查询一个列表页的时候，其实他就要看这个资源，列表页的状态，我们用get请求去表述；当我们要去查询详情页的时候，也是详情页这个资源的一个状态；当我们要删除一个秒杀或者修改一个相关的操作的时候就涉及到状态的转移，这时候我们需要用到put或者 post这样的方式提交。
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/模块/资源/&#123;标示&#125;/集合1</span><br></pre></td></tr></table></figure>

<h3 id="三、SpringMVC"><a href="#三、SpringMVC" class="headerlink" title="三、SpringMVC"></a>三、SpringMVC</h3><h4 id="SpringMVC理论"><a href="#SpringMVC理论" class="headerlink" title="SpringMVC理论"></a>SpringMVC理论</h4><p>运行流程如下</p>
<p><img src="C:\Users\86187\AppData\Roaming\Typora\typora-user-images\image-20200624090352357.png" alt="image-20200624090352357"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> 1、首先用户会发送一个请求，所有的请求都会映射到DispatcherServlet(中央控制器，SpringMVC的核心)，这个servlet会拦截所有的请求，</span><br><span class="line"></span><br><span class="line">2、默认会用到DefaultAnnotation HandlerMapping，这个的作用是用来映射我们的URL,具体就是我们的内一个URL对应到我们的内个Handler。</span><br><span class="line"></span><br><span class="line">3、映射完了之后那，会默认用到DefaultAnnotation HandlerAdapter，这个的目的那是做handler适配，</span><br><span class="line"></span><br><span class="line">4、然后会衔接到我们的controller。如果其中用到intercept（拦截器）的话他也会把拦截器绑定到我们的流程当中。</span><br><span class="line"></span><br><span class="line">5、最终他的产出就是 ModelAndView,view可以理解成jsp页面，同时他会交付到中央处理器DispatchServlet当中。</span><br><span class="line"></span><br><span class="line">6、他会发现你应用的是一个InternalResource ViewResolver,这个就是默认的jsp的一个view。</span><br><span class="line"></span><br><span class="line">7、他就会把我们的Model和jsp页面相结合，最终返回给我们的用户。</span><br><span class="line"></span><br><span class="line">如果你输出的是json的话，把jsp换成json就可以了。 </span><br></pre></td></tr></table></figure>



<p><strong>HTTP请求地质映射原理</strong></p>
<p><img src="C:\Users\86187\AppData\Roaming\Typora\typora-user-images\image-20200624091145089.png" alt="image-20200624091145089"></p>
<p><strong>注解映射技巧</strong></p>
<p><img src="C:\Users\86187\AppData\Roaming\Typora\typora-user-images\image-20200624091544482.png" alt="image-20200624091544482"></p>
<p><strong>请求方法细节处理</strong></p>
<p><img src="C:\Users\86187\AppData\Roaming\Typora\typora-user-images\image-20200624091715790.png" alt="image-20200624091715790"></p>
<p><img src="C:\Users\86187\AppData\Roaming\Typora\typora-user-images\image-20200624091922286.png" alt="image-20200624091922286"></p>
<p><img src="C:\Users\86187\AppData\Roaming\Typora\typora-user-images\image-20200624092009114.png" alt="image-20200624092009114"></p>
<h4 id="配置SpringMVC"><a href="#配置SpringMVC" class="headerlink" title="配置SpringMVC"></a>配置SpringMVC</h4><p>首先在WEB-INF的web.xml中进行我们前端控制器DispatcherServlet的配置，如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;web-app xmlns=<span class="string">&quot;http://java.sun.com/xml/ns/javaee&quot;</span></span><br><span class="line">         xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">         xsi:schemaLocation=<span class="string">&quot;http://java.sun.com/xml/ns/javaee</span></span><br><span class="line"><span class="string">                      http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span></span><br><span class="line">         version=<span class="string">&quot;3.0&quot;</span></span><br><span class="line">         metadata-complete=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line">&lt;!--用maven创建的web-app需要修改servlet的版本为<span class="number">3.1</span>--&gt;</span><br><span class="line">&lt;!--配置DispatcherServlet--&gt;</span><br><span class="line">    &lt;servlet&gt;</span><br><span class="line">        &lt;servlet-name&gt;seckill-dispatcher&lt;/servlet-name&gt;</span><br><span class="line">        &lt;servlet-<span class="class"><span class="keyword">class</span>&gt;<span class="title">org</span>.<span class="title">springframework</span>.<span class="title">web</span>.<span class="title">servlet</span>.<span class="title">DispatcherServlet</span>&lt;/<span class="title">servlet</span>-<span class="title">class</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;!--</span></span><br><span class="line"><span class="class">            配置<span class="title">SpringMVC</span> 需要配置的文件</span></span><br><span class="line"><span class="class">            <span class="title">spring</span>-<span class="title">dao</span>.<span class="title">xml</span>，<span class="title">spring</span>-<span class="title">service</span>.<span class="title">xml</span>,<span class="title">spring</span>-<span class="title">web</span>.<span class="title">xml</span></span></span><br><span class="line"><span class="class">            <span class="title">Mybatis</span> -&gt; <span class="title">spring</span> -&gt; <span class="title">springMvc</span></span></span><br><span class="line"><span class="class">        --&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">init</span>-<span class="title">param</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">param</span>-<span class="title">name</span>&gt;<span class="title">contextConfigLocation</span>&lt;/<span class="title">param</span>-<span class="title">name</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">param</span>-<span class="title">value</span>&gt;<span class="title">classpath</span>:<span class="title">spring</span>/<span class="title">spring</span>-*.<span class="title">xml</span>&lt;/<span class="title">param</span>-<span class="title">value</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">init</span>-<span class="title">param</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">servlet</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">servlet</span>-<span class="title">mapping</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">servlet</span>-<span class="title">name</span>&gt;<span class="title">seckill</span>-<span class="title">dispatcher</span>&lt;/<span class="title">servlet</span>-<span class="title">name</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;!--默认匹配所有请求--&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">url</span>-<span class="title">pattern</span>&gt;/&lt;/<span class="title">url</span>-<span class="title">pattern</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">servlet</span>-<span class="title">mapping</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">web</span>-<span class="title">app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后在spring容器中进行web层相关bean(即Controller)的配置，在spring包下创建一个spring-web.xml，内容如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xmlns:context=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="line">       xmlns:mvc=<span class="string">&quot;http://www.springframework.org/schema/mvc&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/context </span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/context/spring-context.xsd</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/mvc </span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/mvc/spring-mvc.xsd&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--配置spring mvc--&gt;</span><br><span class="line">    &lt;!--<span class="number">1</span>,开启springmvc注解模式</span><br><span class="line">    a.自动注册DefaultAnnotationHandlerMapping,AnnotationMethodHandlerAdapter</span><br><span class="line">    b.默认提供一系列的功能:数据绑定，数字和日期的format<span class="meta">@NumberFormat</span>,<span class="meta">@DateTimeFormat</span></span><br><span class="line">    c:xml,json的默认读写支持--&gt;</span><br><span class="line">    &lt;mvc:annotation-driven/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--<span class="number">2.</span>静态资源默认servlet配置--&gt;</span><br><span class="line">    &lt;!--</span><br><span class="line">        <span class="number">1</span>).加入对静态资源处理：js,gif,png</span><br><span class="line">        <span class="number">2</span>).允许使用 <span class="string">&quot;/&quot;</span> 做整体映射</span><br><span class="line">    --&gt;</span><br><span class="line">    &lt;mvc:<span class="keyword">default</span>-servlet-handler/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--<span class="number">3</span>：配置JSP 显示ViewResolver--&gt;</span><br><span class="line">    &lt;bean <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span>&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;viewClass&quot;</span> value=<span class="string">&quot;org.springframework.web.servlet.view.JstlView&quot;</span>/&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;prefix&quot;</span> value=<span class="string">&quot;/WEB-INF/jsp/&quot;</span>/&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;suffix&quot;</span> value=<span class="string">&quot;.jsp&quot;</span>/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--<span class="number">4</span>:扫描web相关的bean--&gt;</span><br><span class="line">    &lt;context:component-scan base-<span class="keyword">package</span>=<span class="string">&quot;cn.codingxiaxw.web&quot;</span>/&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>

<p>这样我们便完成了Spring MVC的相关配置(即将Spring MVC框架整合到了我们的项目中)，接下来就要基于Restful接口进行我们项目的Controller开发工作了。</p>
<h3 id="三、Contreller开发"><a href="#三、Contreller开发" class="headerlink" title="三、Contreller开发"></a>三、Contreller开发</h3><p>Controller中的每一个方法都对应我们系统中的一个资源URL，其设计应该遵循Restful接口的设计风格。在cn.codingxiaxw包下创建一个web包用于放web层Controller开发的代码，在该包下创建一个SeckillController.java，内容如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/seckill&quot;)</span><span class="comment">//url:模块/资源/&#123;&#125;/细分</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SeckillService seckillService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/list&quot;,method = RequestMethod.GET)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">list</span><span class="params">(Model model)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//list.jsp+mode=ModelAndView</span></span><br><span class="line">        <span class="comment">//获取列表页</span></span><br><span class="line">        List&lt;Seckill&gt; list=seckillService.getSeckillList();</span><br><span class="line">        model.addAttribute(<span class="string">&quot;list&quot;</span>,list);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;list&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/&#123;seckillId&#125;/detail&quot;,method = RequestMethod.GET)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">detail</span><span class="params">(<span class="meta">@PathVariable(&quot;seckillId&quot;)</span> Long seckillId, Model model)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (seckillId == <span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;redirect:/seckill/list&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Seckill seckill=seckillService.getById(seckillId);</span><br><span class="line">        <span class="keyword">if</span> (seckill==<span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;forward:/seckill/list&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        model.addAttribute(<span class="string">&quot;seckill&quot;</span>,seckill);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;detail&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ajax ,json暴露秒杀接口的方法</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/&#123;seckillId&#125;/exposer&quot;,</span></span><br><span class="line"><span class="meta">                    method = RequestMethod.POST,</span></span><br><span class="line"><span class="meta">                    produces = &#123;&quot;application/json;charset=UTF-8&quot;&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SeckillResult&lt;Exposer&gt; <span class="title">exposer</span><span class="params">(Long seckillId)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        SeckillResult&lt;Exposer&gt; result;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Exposer exposer=seckillService.exportSeckillUrl(seckillId);</span><br><span class="line">            result=<span class="keyword">new</span> SeckillResult&lt;Exposer&gt;(<span class="keyword">true</span>,exposer);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            result=<span class="keyword">new</span> SeckillResult&lt;Exposer&gt;(<span class="keyword">false</span>,e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">     <span class="meta">@RequestMapping(value = &quot;/&#123;seckillId&#125;/&#123;md5&#125;/execution&quot;,</span></span><br><span class="line"><span class="meta">            method = RequestMethod.POST,</span></span><br><span class="line"><span class="meta">            produces = &#123;&quot;application/json;charset=UTF-8&quot;&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SeckillResult&lt;SeckillExecution&gt; <span class="title">execute</span><span class="params">(<span class="meta">@PathVariable(&quot;seckillId&quot;)</span> Long seckillId,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                   <span class="meta">@PathVariable(&quot;md5&quot;)</span> String md5,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                   <span class="meta">@CookieValue(value = &quot;killPhone&quot;,required = false)</span> Long phone)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (phone==<span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;SeckillExecution&gt;(<span class="keyword">false</span>,<span class="string">&quot;未注册&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        SeckillResult&lt;SeckillExecution&gt; result;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            SeckillExecution execution = seckillService.executeSeckill(seckillId, phone, md5);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;SeckillExecution&gt;(<span class="keyword">true</span>, execution);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (RepeatKillException e1)</span><br><span class="line">        &#123;</span><br><span class="line">            SeckillExecution execution=<span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.REPEAT_KILL);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;SeckillExecution&gt;(<span class="keyword">false</span>,execution);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (SeckillCloseException e2)</span><br><span class="line">        &#123;</span><br><span class="line">            SeckillExecution execution=<span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.END);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;SeckillExecution&gt;(<span class="keyword">false</span>,execution);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            SeckillExecution execution=<span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.INNER_ERROR);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;SeckillExecution&gt;(<span class="keyword">false</span>,execution);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取系统时间</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/time/now&quot;,method = RequestMethod.GET)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SeckillResult&lt;Long&gt; <span class="title">time</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Date now=<span class="keyword">new</span> Date();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;Long&gt;(<span class="keyword">true</span>,now.getTime());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Controller开发中的方法完全是对照Service接口方法进行开发的，第一个方法用于访问我们商品的列表页，第二个方法访问商品的详情页，第三个方法用于返回一个json数据，数据中封装了我们商品的秒杀地址，第四个方法用于封装用户是否秒杀成功的信息，第五个方法用于返回系统当前时间。代码中涉及到一个将返回秒杀商品地址封装为json数据的一个Vo类，即SeckillResult.java，在dto包中创建它，内容如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将所有的ajax请求返回类型，全部封装成json数据</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillResult</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> success;</span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line">    <span class="keyword">private</span> String error;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeckillResult</span><span class="params">(<span class="keyword">boolean</span> success, T data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.success = success;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeckillResult</span><span class="params">(<span class="keyword">boolean</span> success, String error)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.success = success;</span><br><span class="line">        <span class="keyword">this</span>.error = error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSuccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSuccess</span><span class="params">(<span class="keyword">boolean</span> success)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.success = success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(T data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getError</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setError</span><span class="params">(String error)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.error = error;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到此，Controller的开发任务完成，接下来进行我们的页面开发。</p>
<h3 id="四、页面开发"><a href="#四、页面开发" class="headerlink" title="四、页面开发"></a>四、页面开发</h3><p>新建Jsp包，使用Bootstrap进行开发即可</p>
<p><img src="C:\Users\86187\AppData\Roaming\Typora\typora-user-images\image-20200624105135131.png" alt="image-20200624105135131"></p>
<p><img src="C:\Users\86187\AppData\Roaming\Typora\typora-user-images\image-20200624105047625.png" alt="image-20200624105047625">·</p>
<p><img src="C:\Users\86187\AppData\Roaming\Typora\typora-user-images\image-20200624105004600.png" alt="image-20200624105004600"></p>
<p><img src="C:\Users\86187\AppData\Roaming\Typora\typora-user-images\image-20200624105022654.png" alt="image-20200624105022654"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//存放主要交互逻辑的js代码</span></span><br><span class="line"><span class="comment">// javascript 模块化(package.类.方法)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> seckill = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装秒杀相关ajax的url</span></span><br><span class="line">    <span class="attr">URL</span>: &#123;</span><br><span class="line">        <span class="attr">now</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;/seckill/time/now&#x27;</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">exposer</span>: <span class="function"><span class="keyword">function</span> (<span class="params">seckillId</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;/seckill/&#x27;</span> + seckillId + <span class="string">&#x27;/exposer&#x27;</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">execution</span>: <span class="function"><span class="keyword">function</span> (<span class="params">seckillId, md5</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;/seckill/&#x27;</span> + seckillId + <span class="string">&#x27;/&#x27;</span> + md5 + <span class="string">&#x27;/execution&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//验证手机号</span></span><br><span class="line">    <span class="attr">validatePhone</span>: <span class="function"><span class="keyword">function</span> (<span class="params">phone</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (phone &amp;&amp; phone.length == <span class="number">11</span> &amp;&amp; !<span class="built_in">isNaN</span>(phone)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;<span class="comment">//直接判断对象会看对象是否为空,空就是undefine就是false; isNaN 非数字返回true</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//详情页秒杀逻辑</span></span><br><span class="line">    <span class="attr">detail</span>: &#123;</span><br><span class="line">        <span class="comment">//详情页初始化</span></span><br><span class="line">        <span class="attr">init</span>: <span class="function"><span class="keyword">function</span> (<span class="params">params</span>) </span>&#123;</span><br><span class="line">            <span class="comment">//手机验证和登录,计时交互</span></span><br><span class="line">            <span class="comment">//规划我们的交互流程</span></span><br><span class="line">            <span class="comment">//在cookie中查找手机号</span></span><br><span class="line">            <span class="keyword">var</span> userPhone = $.cookie(<span class="string">&#x27;userPhone&#x27;</span>);</span><br><span class="line">            <span class="comment">//验证手机号</span></span><br><span class="line">            <span class="keyword">if</span> (!seckill.validatePhone(userPhone)) &#123;</span><br><span class="line">                <span class="comment">//绑定手机 控制输出</span></span><br><span class="line">                <span class="keyword">var</span> killPhoneModal = $(<span class="string">&#x27;#killPhoneModal&#x27;</span>);</span><br><span class="line">                killPhoneModal.modal(&#123;</span><br><span class="line">                    <span class="attr">show</span>: <span class="literal">true</span>,<span class="comment">//显示弹出层</span></span><br><span class="line">                    <span class="attr">backdrop</span>: <span class="string">&#x27;static&#x27;</span>,<span class="comment">//禁止位置关闭</span></span><br><span class="line">                    <span class="attr">keyboard</span>: <span class="literal">false</span><span class="comment">//关闭键盘事件</span></span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">                $(<span class="string">&#x27;#killPhoneBtn&#x27;</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">var</span> inputPhone = $(<span class="string">&#x27;#killPhoneKey&#x27;</span>).val();</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;inputPhone: &quot;</span> + inputPhone);</span><br><span class="line">                    <span class="keyword">if</span> (seckill.validatePhone(inputPhone)) &#123;</span><br><span class="line">                        <span class="comment">//电话写入cookie(7天过期)</span></span><br><span class="line">                        $.cookie(<span class="string">&#x27;userPhone&#x27;</span>, inputPhone, &#123;<span class="attr">expires</span>: <span class="number">7</span>, <span class="attr">path</span>: <span class="string">&#x27;/seckill&#x27;</span>&#125;);</span><br><span class="line">                        <span class="comment">//验证通过　　刷新页面</span></span><br><span class="line">                        <span class="built_in">window</span>.location.reload();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">//todo 错误文案信息抽取到前端字典里</span></span><br><span class="line">                        $(<span class="string">&#x27;#killPhoneMessage&#x27;</span>).hide().html(<span class="string">&#x27;&lt;label class=&quot;label label-danger&quot;&gt;手机号错误!&lt;/label&gt;&#x27;</span>).show(<span class="number">300</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//已经登录</span></span><br><span class="line">            <span class="comment">//计时交互</span></span><br><span class="line">            <span class="keyword">var</span> startTime = params[<span class="string">&#x27;startTime&#x27;</span>];</span><br><span class="line">            <span class="keyword">var</span> endTime = params[<span class="string">&#x27;endTime&#x27;</span>];</span><br><span class="line">            <span class="keyword">var</span> seckillId = params[<span class="string">&#x27;seckillId&#x27;</span>];</span><br><span class="line">            $.get(seckill.URL.now(), &#123;&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">result</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (result &amp;&amp; result[<span class="string">&#x27;success&#x27;</span>]) &#123;</span><br><span class="line">                    <span class="keyword">var</span> nowTime = result[<span class="string">&#x27;data&#x27;</span>];</span><br><span class="line">                    <span class="comment">//时间判断 计时交互</span></span><br><span class="line">                    seckill.countDown(seckillId, nowTime, startTime, endTime);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&#x27;result: &#x27;</span> + result);</span><br><span class="line">                    alert(<span class="string">&#x27;result: &#x27;</span> + result);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="attr">handlerSeckill</span>: <span class="function"><span class="keyword">function</span> (<span class="params">seckillId, node</span>) </span>&#123;</span><br><span class="line">        <span class="comment">//获取秒杀地址,控制显示器,执行秒杀</span></span><br><span class="line">        node.hide().html(<span class="string">&#x27;&lt;button class=&quot;btn btn-primary btn-lg&quot; id=&quot;killBtn&quot;&gt;开始秒杀&lt;/button&gt;&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        $.get(seckill.URL.exposer(seckillId), &#123;&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">result</span>) </span>&#123;</span><br><span class="line">            <span class="comment">//在回调函数种执行交互流程</span></span><br><span class="line">            <span class="keyword">if</span> (result &amp;&amp; result[<span class="string">&#x27;success&#x27;</span>]) &#123;</span><br><span class="line">                <span class="keyword">var</span> exposer = result[<span class="string">&#x27;data&#x27;</span>];</span><br><span class="line">                <span class="keyword">if</span> (exposer[<span class="string">&#x27;exposed&#x27;</span>]) &#123;</span><br><span class="line">                    <span class="comment">//开启秒杀</span></span><br><span class="line">                    <span class="comment">//获取秒杀地址</span></span><br><span class="line">                    <span class="keyword">var</span> md5 = exposer[<span class="string">&#x27;md5&#x27;</span>];</span><br><span class="line">                    <span class="keyword">var</span> killUrl = seckill.URL.execution(seckillId, md5);</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;killUrl: &quot;</span> + killUrl);</span><br><span class="line">                    <span class="comment">//绑定一次点击事件</span></span><br><span class="line">                    $(<span class="string">&#x27;#killBtn&#x27;</span>).one(<span class="string">&#x27;click&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                        <span class="comment">//执行秒杀请求</span></span><br><span class="line">                        <span class="comment">//1.先禁用按钮</span></span><br><span class="line">                        $(<span class="built_in">this</span>).addClass(<span class="string">&#x27;disabled&#x27;</span>);<span class="comment">//,&lt;-$(this)===(&#x27;#killBtn&#x27;)-&gt;</span></span><br><span class="line">                        <span class="comment">//2.发送秒杀请求执行秒杀</span></span><br><span class="line">                        $.post(killUrl, &#123;&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">result</span>) </span>&#123;</span><br><span class="line">                            <span class="keyword">if</span> (result &amp;&amp; result[<span class="string">&#x27;success&#x27;</span>]) &#123;</span><br><span class="line">                                <span class="keyword">var</span> killResult = result[<span class="string">&#x27;data&#x27;</span>];</span><br><span class="line">                                <span class="keyword">var</span> state = killResult[<span class="string">&#x27;state&#x27;</span>];</span><br><span class="line">                                <span class="keyword">var</span> stateInfo = killResult[<span class="string">&#x27;stateInfo&#x27;</span>];</span><br><span class="line">                                <span class="comment">//显示秒杀结果</span></span><br><span class="line">                                node.html(<span class="string">&#x27;&lt;span class=&quot;label label-success&quot;&gt;&#x27;</span> + stateInfo + <span class="string">&#x27;&lt;/span&gt;&#x27;</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;);</span><br><span class="line">                    node.show();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//未开启秒杀(浏览器计时偏差)</span></span><br><span class="line">                    <span class="keyword">var</span> now = exposer[<span class="string">&#x27;now&#x27;</span>];</span><br><span class="line">                    <span class="keyword">var</span> start = exposer[<span class="string">&#x27;start&#x27;</span>];</span><br><span class="line">                    <span class="keyword">var</span> end = exposer[<span class="string">&#x27;end&#x27;</span>];</span><br><span class="line">                    seckill.countDown(seckillId, now, start, end);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&#x27;result: &#x27;</span> + result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="attr">countDown</span>: <span class="function"><span class="keyword">function</span> (<span class="params">seckillId, nowTime, startTime, endTime</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(seckillId + <span class="string">&#x27;_&#x27;</span> + nowTime + <span class="string">&#x27;_&#x27;</span> + startTime + <span class="string">&#x27;_&#x27;</span> + endTime);</span><br><span class="line">        <span class="keyword">var</span> seckillBox = $(<span class="string">&#x27;#seckill-box&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (nowTime &gt; endTime) &#123;</span><br><span class="line">            <span class="comment">//秒杀结束</span></span><br><span class="line">            seckillBox.html(<span class="string">&#x27;秒杀结束!&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nowTime &lt; startTime) &#123;</span><br><span class="line">            <span class="comment">//秒杀未开始,计时事件绑定</span></span><br><span class="line">            <span class="keyword">var</span> killTime = <span class="keyword">new</span> <span class="built_in">Date</span>(startTime + <span class="number">1000</span>);<span class="comment">//todo 防止时间偏移</span></span><br><span class="line">            seckillBox.countdown(killTime, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">                <span class="comment">//时间格式</span></span><br><span class="line">                <span class="keyword">var</span> format = event.strftime(<span class="string">&#x27;秒杀倒计时: %D天 %H时 %M分 %S秒 &#x27;</span>);</span><br><span class="line">                seckillBox.html(format);</span><br><span class="line">            &#125;).on(<span class="string">&#x27;finish.countdown&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="comment">//时间完成后回调事件</span></span><br><span class="line">                <span class="comment">//获取秒杀地址,控制现实逻辑,执行秒杀</span></span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&#x27;______fininsh.countdown&#x27;</span>);</span><br><span class="line">                seckill.handlerSeckill(seckillId, seckillBox);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//秒杀开始</span></span><br><span class="line">            seckill.handlerSeckill(seckillId, seckillBox);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="高并发优化"><a href="#高并发优化" class="headerlink" title="高并发优化"></a>高并发优化</h2><h3 id="一、高并发优化分析"><a href="#一、高并发优化分析" class="headerlink" title="一、高并发优化分析"></a>一、高并发优化分析</h3><p><strong>CDN</strong></p>
<p><img src="D:\ZJU\Notebook\Java\5de0cb5200018d5105000321.jpg" alt="http://img1.sycdn.imooc.com/5de0cb5200018d5108040516.jpg"></p>
<p>CDN只能缓存url固定的资源：</p>
<ul>
<li>秒杀地址是变化的，无法用CDN进行缓存</li>
<li>大部分写操作和最核心的数据的请求，无法用CDN</li>
</ul>
<p>不能在缓存里减库存，因为并发，会有不一致的问题</p>
<p>——&gt;通过mysql的事务来保证数据的一致性；</p>
<p>难点：一瞬间大量用户参与热门商品竞争，MySQL一行数据会有大量竞争，有大量的updata减库存竞争</p>
<p><img src="C:\Users\86187\AppData\Roaming\Typora\typora-user-images\image-20200628101808334.png" alt="image-20200628101808334"></p>
<p>上图使用的方案的缺点：运维成本和稳定性、开发成本、幂等性（重复秒杀问题）、不适合新手</p>
<p><strong>瓶颈分析</strong></p>
<p><img src="C:\Users\86187\AppData\Roaming\Typora\typora-user-images\image-20200628102330027.png" alt="image-20200628102330027"></p>
<p><strong>优化：</strong></p>
<p>前端： 动静态数据做分离，减少请求与响应时间；按钮防重复，防止用户发送无效的重复请求，因为秒杀活动一般都会有购买数量的限制，敲的次数再多，最后还是要查看是否已购。影响了效率，可有前端代为处理并优化</p>
<p>后端：使用CDN换存重要的静态资源等；在后端对活动结束时间、商品选购时间、业务的相关逻辑要求都放在后端代码中，并调用缓存来进行暂存，已减少对DB的直接操作，提高效率</p>
<p><img src="C:\Users\86187\AppData\Roaming\Typora\typora-user-images\image-20200702095239456.png" alt="image-20200702095239456"></p>
<p>  1,前端控制触发次数，比如限制控制按钮的触发</p>
<p>  2,使用CDN和缓存机制达到动静分离</p>
<p>  3,减少行级锁和GC的时间，将事物控制在mysql中进行，比如存储过程</p>
<h3 id="二、redis后端缓存优化编码"><a href="#二、redis后端缓存优化编码" class="headerlink" title="二、redis后端缓存优化编码"></a>二、redis后端缓存优化编码</h3><p>后端缓存流程：先在pom文件中引入相关redis依赖，java一般通过jedis来访问redis，然后创建一个redisDao的类，写入jedispool，从jedispool中获取到jedis对象。主要是在写两个方法，一个是从redis中get对象，另一个是向jedis中存入对象，因为redis并没有实现自动序列化功能，所以实际put对象的时候是将数据库中取到的对象序列化成二级制数组，然后根据对象类的反射得到的scheme序列化对象并存到redis中。同样redis取出对象的时候取到的是一个二进制数组，需要根据scheme和一个空对象将二进制数组转换成相应的对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by codingBoy on 17/2/17.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisDao</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JedisPool jedisPool;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RedisDao</span><span class="params">(String ip, <span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        jedisPool = <span class="keyword">new</span> JedisPool(ip, port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RuntimeSchema&lt;Seckill&gt; schema = RuntimeSchema.createFrom(Seckill.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Seckill <span class="title">getSeckill</span><span class="params">(<span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getSeckill(seckillId, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从redis获取信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 如果不存在，则返回null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Seckill <span class="title">getSeckill</span><span class="params">(<span class="keyword">long</span> seckillId, Jedis jedis)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> hasJedis = jedis != <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//redis操作逻辑</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!hasJedis) &#123;</span><br><span class="line">                jedis = jedisPool.getResource();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String key = getSeckillRedisKey(seckillId);</span><br><span class="line">                <span class="comment">//并没有实现哪部序列化操作</span></span><br><span class="line">                <span class="comment">//采用自定义序列化</span></span><br><span class="line">                <span class="comment">//protostuff: pojo.</span></span><br><span class="line">                <span class="keyword">byte</span>[] bytes = jedis.get(key.getBytes());</span><br><span class="line">                <span class="comment">//缓存重获取到</span></span><br><span class="line">                <span class="keyword">if</span> (bytes != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Seckill seckill = schema.newMessage();</span><br><span class="line">                    ProtostuffIOUtil.mergeFrom(bytes, seckill, schema);</span><br><span class="line">                    <span class="comment">//seckill被反序列化</span></span><br><span class="line">                    <span class="keyword">return</span> seckill;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!hasJedis) &#123;</span><br><span class="line">                    jedis.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从缓存获取，如果没有，则从数据库获取</span></span><br><span class="line"><span class="comment">     * 会用到分布式锁</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId     id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> getDataFromDb 从数据库获取的方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回商品信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Seckill <span class="title">getOrPutSeckill</span><span class="params">(<span class="keyword">long</span> seckillId, Function&lt;Long, Seckill&gt; getDataFromDb)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        String lockKey = <span class="string">&quot;seckill:locks:getSeckill:&quot;</span> + seckillId;</span><br><span class="line">        String lockRequestId = UUID.randomUUID().toString();</span><br><span class="line">        Jedis jedis = jedisPool.getResource();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 循环直到获取到数据</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                Seckill seckill = getSeckill(seckillId, jedis);</span><br><span class="line">                <span class="keyword">if</span> (seckill != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> seckill;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 尝试获取锁。</span></span><br><span class="line">                <span class="comment">// 锁过期时间是防止程序突然崩溃来不及解锁，而造成其他线程不能获取锁的问题。过期时间是业务容忍最长时间。</span></span><br><span class="line">                <span class="keyword">boolean</span> getLock = JedisUtils.tryGetDistributedLock(jedis, lockKey, lockRequestId, <span class="number">1000</span>);</span><br><span class="line">                <span class="keyword">if</span> (getLock) &#123;</span><br><span class="line">                    <span class="comment">// 获取到锁，从数据库拿数据, 然后存redis</span></span><br><span class="line">                    seckill = getDataFromDb.apply(seckillId);</span><br><span class="line">                    putSeckill(seckill, jedis);</span><br><span class="line">                    <span class="keyword">return</span> seckill;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 获取不到锁，睡一下，等会再出发。sleep的时间需要斟酌，主要看业务处理速度</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException ignored) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ignored) &#123;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 无论如何，最后要去解锁</span></span><br><span class="line">            JedisUtils.releaseDistributedLock(jedis, lockKey, lockRequestId);</span><br><span class="line">            jedis.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id获取redis的key</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId 商品id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> redis的key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getSeckillRedisKey</span><span class="params">(<span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;seckill:&quot;</span> + seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">putSeckill</span><span class="params">(Seckill seckill)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> putSeckill(seckill, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">putSeckill</span><span class="params">(Seckill seckill, Jedis jedis)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> hasJedis = jedis != <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!hasJedis) &#123;</span><br><span class="line">                jedis = jedisPool.getResource();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String key = getSeckillRedisKey(seckill.getSeckillId());</span><br><span class="line">                <span class="keyword">byte</span>[] bytes = ProtostuffIOUtil.toByteArray(seckill, schema,</span><br><span class="line">                        LinkedBuffer.allocate(LinkedBuffer.DEFAULT_BUFFER_SIZE));</span><br><span class="line">                <span class="comment">//超时缓存，1小时</span></span><br><span class="line">                <span class="keyword">int</span> timeout = <span class="number">60</span> * <span class="number">60</span>;</span><br><span class="line">                String result = jedis.setex(key.getBytes(), timeout, bytes);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!hasJedis) &#123;</span><br><span class="line">                    jedis.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="三、并发优化"><a href="#三、并发优化" class="headerlink" title="三、并发优化"></a>三、并发优化</h3><p><img src="C:\Users\86187\AppData\Roaming\Typora\typora-user-images\image-20200702103739378.png" alt="image-20200702103739378"></p>
<p><img src="C:\Users\86187\AppData\Roaming\Typora\typora-user-images\image-20200702103807647.png" alt="image-20200702103807647"></p>
<p>insert和update代码调换顺序的原因:insert不涉及到行级锁的竞争，所以可以放在前面执行其实降低了一半的行级锁持有时间，因为行级锁的开始时间是从update语句开始的。同时不用担心insert会先插入大量数据，因为insert和update是控制在一个事务当中的，只有update成功后insert才会真正的插入一条数据。</p>
<p>利用存储过程将执行秒杀的一条事务逻辑放到mysql服务端去执行，减少了客户端和服务端之间的延迟和gc时间，客户端只需要传入参数执行存储过程并根据得到的返回结果做相应的逻辑处理。存储过程比较适合于简单的逻辑。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 秒杀执行存储过程</span></span><br><span class="line">DELIMITER $$ </span><br><span class="line"><span class="comment">--console ; 转换为 $$ 作为结束执行语句的标志</span></span><br><span class="line"><span class="comment">-- 定义存储过程</span></span><br><span class="line"><span class="comment">-- 参数：in 输入参数；out 输出参数</span></span><br><span class="line"><span class="comment">-- row_count();返回上一条修改类型sql(delete,insert,update)的影响行数</span></span><br><span class="line"><span class="comment">-- row_count:return 0:未修改数据 &gt;0:表示修改的行数 &lt;0：sql错误/未执行修改sql</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> <span class="string">&#x27;seckill&#x27;</span>.<span class="string">&#x27;execute_seckill&#x27;</span></span><br><span class="line">(<span class="keyword">in</span> v_seckill <span class="type">bigint</span>, <span class="keyword">in</span> v_phone <span class="type">bigint</span>, <span class="keyword">in</span> v_kill_time <span class="type">timestamp</span>, <span class="keyword">out</span> r_result <span class="type">int</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">DECLARE</span> insert_count <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">START</span> TRANSANCTION;</span><br><span class="line">	<span class="keyword">insert</span> ignore <span class="keyword">into</span> success_killed</span><br><span class="line">		(seckill_id,user_phone,create_time)</span><br><span class="line">		<span class="keyword">values</span>(v_seckill_id,v_phone,v_kill_time);</span><br><span class="line">	<span class="keyword">select</span> row_count() <span class="keyword">into</span> insert_count;</span><br><span class="line">	IF (insert_count <span class="operator">=</span> <span class="number">0</span>) <span class="keyword">THEN</span></span><br><span class="line">    	<span class="keyword">ROLLBACK</span>;</span><br><span class="line">    	<span class="keyword">set</span> r_result <span class="operator">=</span> <span class="number">-1</span>;</span><br><span class="line">    ELSEIF(insert_count <span class="operator">&lt;</span> <span class="number">0</span>) <span class="keyword">THEN</span></span><br><span class="line">    	<span class="keyword">ROLLBACK</span>;</span><br><span class="line">    	<span class="keyword">set</span> r_result <span class="operator">=</span> <span class="number">-2</span>;</span><br><span class="line">    <span class="keyword">ELSE</span></span><br><span class="line">    	update seckill</span><br><span class="line">    	<span class="keyword">set</span> number <span class="operator">=</span> number<span class="number">-1</span></span><br><span class="line">    	<span class="keyword">where</span> seckill_id <span class="operator">=</span> v_seckill_id</span><br><span class="line">    	  <span class="keyword">and</span> end_time <span class="operator">&gt;</span> v_kill_time</span><br><span class="line">    	  <span class="keyword">and</span> start_time <span class="operator">&lt;</span> v_kill_time</span><br><span class="line">    	  <span class="keyword">and</span> number <span class="operator">&gt;</span> <span class="number">0</span>;</span><br><span class="line">    	<span class="keyword">select</span> row_count() <span class="keyword">into</span> insert_count;</span><br><span class="line">    	IF (insert_count <span class="operator">=</span> <span class="number">0</span>) <span class="keyword">THEN</span></span><br><span class="line">    		<span class="keyword">ROLLBACK</span>;</span><br><span class="line">    		<span class="keyword">SET</span> r_result <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    	ELSEIF (insert_count <span class="operator">&lt;</span> <span class="number">0</span>) <span class="keyword">THEN</span></span><br><span class="line">        	<span class="keyword">ROLLBACK</span>;</span><br><span class="line">        	<span class="keyword">set</span> r_result <span class="operator">=</span> <span class="number">-2</span>;</span><br><span class="line">        <span class="keyword">ELSE</span> </span><br><span class="line">        	<span class="keyword">COMMIT</span>;</span><br><span class="line">        	<span class="keyword">set</span> r_result <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">END</span> IF;	</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line">$$</span><br><span class="line"><span class="comment">-- 存储过程定义结束</span></span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> <span class="variable">@r</span>_result <span class="operator">=</span> <span class="number">-3</span>;</span><br><span class="line"><span class="comment">-- 执行存储过程</span></span><br><span class="line"><span class="keyword">call</span> execute_seckill(<span class="number">1003</span>,<span class="number">13567098891</span>,now(),<span class="variable">@r</span>_result)</span><br><span class="line"><span class="comment">--获取结果</span></span><br><span class="line"><span class="keyword">select</span> <span class="variable">@r</span>_result;</span><br></pre></td></tr></table></figure>

<p>在Java中调用事务接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Date killTime = <span class="keyword">new</span> Date();</span><br><span class="line">Map&lt;String,Object&gt; map = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">map.put(<span class="string">&quot;seckillId&quot;</span>,seckillId);</span><br><span class="line">map.put(<span class="string">&quot;phone&quot;</span>,userPhone);</span><br><span class="line">map.put(<span class="string">&quot;killTime&quot;</span>,killTime);</span><br><span class="line">map.put(<span class="string">&quot;result&quot;</span>,<span class="keyword">null</span>);</span><br><span class="line">seckillDao.killByProcedure(map);</span><br><span class="line"><span class="comment">//执行存储过程，result被复制</span></span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    seckillDao.killByProcedure(map);</span><br><span class="line">    <span class="comment">//获取result</span></span><br><span class="line">    <span class="keyword">int</span> result = MapUtils.getInteger(map,<span class="string">&quot;result&quot;</span>,-<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span>(result == <span class="number">1</span>)&#123;</span><br><span class="line">        SuccesssKilled sk = successkilledDao.</span><br><span class="line">            queryByIdWithSeckill(seckillId,userPhone);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.SUCCESS, sk);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.stateOf(result));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">    logger.error(e.getMessage(),e);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.INNER_ERROR);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="四、系统部署架构"><a href="#四、系统部署架构" class="headerlink" title="四、系统部署架构"></a>四、系统部署架构</h3><p>秒杀系统架构：</p>
<p>1、CDN缓存</p>
<p>2、智能DNS解析：Nginx</p>
<p>3、逻辑集群：jetty</p>
<p>4、分库分表：Mycat</p>
<p>5、统计分析：生成报表 </p>
<p>一部分流量已经被cdn缓存锁拦截 不过秒杀的操作,秒杀的地址获取这样的请求不方便放入cdn中,所以访问到我们的服务器 我们的服务器会通过我们的dns查找到我们的地址 一般找到的是nginx地址,nginx一般部署到不同的机房,比如电信,移动,联通 这样的话智能的dns会根据用户的请求ip地址来智能的dns解析来请求最近的Nginx服务器 nginx还会给我们的服务器做负载均衡</p>
</div><hr></div><nav id="pagination"><div class="pagination"><span class="page-number current">1</span></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2023 By ZJH</div><div class="framework-info"><span>驱动 - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.1"></script><script src="/js/fancybox.js?version=1.9.1"></script><script src="/js/sidebar.js?version=1.9.1"></script><script src="/js/copy.js?version=1.9.1"></script><script src="/js/fireworks.js?version=1.9.1"></script><script src="/js/transition.js?version=1.9.1"></script><script src="/js/scroll.js?version=1.9.1"></script><script src="/js/head.js?version=1.9.1"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>